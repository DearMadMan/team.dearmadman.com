<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="php,laravel," />










<meta name="description" content="Laravel Socialite Laravel Socialite provides an expressive, fluent interface to OAuth authentication with Facebook, Twitter, Google, LinkedIn, GitHub and Bitbucket. It handles almost all of the boiler">
<meta name="keywords" content="php,laravel">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 Laravel Socialite 集成微信登录">
<meta property="og:url" content="http://yoursite.com/2016/08/01/using-wechat-authentication-for-login-with-laravel-socialite/index.html">
<meta property="og:site_name" content="Team.dearmadman.com">
<meta property="og:description" content="Laravel Socialite Laravel Socialite provides an expressive, fluent interface to OAuth authentication with Facebook, Twitter, Google, LinkedIn, GitHub and Bitbucket. It handles almost all of the boiler">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://yoursite.com/images/Socialite.png">
<meta property="og:updated_time" content="2017-09-13T15:23:23.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用 Laravel Socialite 集成微信登录">
<meta name="twitter:description" content="Laravel Socialite Laravel Socialite provides an expressive, fluent interface to OAuth authentication with Facebook, Twitter, Google, LinkedIn, GitHub and Bitbucket. It handles almost all of the boiler">
<meta name="twitter:image" content="http://yoursite.com/images/Socialite.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/08/01/using-wechat-authentication-for-login-with-laravel-socialite/"/>





  <title>使用 Laravel Socialite 集成微信登录 | Team.dearmadman.com</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Team.dearmadman.com</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do it.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/01/using-wechat-authentication-for-login-with-laravel-socialite/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">使用 Laravel Socialite 集成微信登录</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-01T14:22:10+08:00">
                2016-08-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Laravel-Socialite"><a href="#Laravel-Socialite" class="headerlink" title="Laravel Socialite"></a>Laravel Socialite</h1><blockquote>
<p>Laravel Socialite provides an expressive, fluent interface to OAuth authentication with Facebook, Twitter, Google, LinkedIn, GitHub and Bitbucket. It handles almost all of the boilerplate social authentication code you are dreading writing.</p>
</blockquote>
<p><a href="https://github.com/laravel/socialite" target="_blank" rel="external">Laravel Socialite</a> 为第三方应用的 OAuth 认证提供了非常丰富友好的接口，我们使用它可以非常方便快捷的对类似微信、微博等第三方登录进行集成。</p>
<h2 id="Open-Authorization"><a href="#Open-Authorization" class="headerlink" title="Open Authorization"></a>Open Authorization</h2><blockquote>
<p>OAuth（开放授权）是一个开放标准，允许用户让第三方应用访问该用户在某一网站上存储的私密的资源（如照片，视频，联系人列表），而无需将用户名和密码提供给第三方应用。</p>
<p>OAuth 允许用户提供一个令牌，而不是用户名和密码来访问他们存放在特定服务提供者的数据。每一个令牌授权一个特定的网站（例如，视频编辑网站)在特定的时段（例如，接下来的 2 小时内）内访问特定的资源（例如仅仅是某一相册中的视频）。这样，OAuth 让用户可以授权第三方网站访问他们存储在另外服务提供者的某些特定信息，而非所有内容。</p>
</blockquote>
<p>我们的应用与使用 OAuth 标准的第三方应用的交互流程一般是这样的：</p>
<ul>
<li>展示跳转到第三方应用登录的链接</li>
<li>用户点击链接跳转到第三方应用登录并进行授权</li>
<li>在用户授权后第三方应用会跳转到我们所指定的应用回调资源地址并伴随用于交互 AccessToken 的 Code</li>
<li>我们的应用拿到 Code 后自主请求第三方应用并使用 Code 获取该用户的 AccessToken</li>
<li>获取 AccessToken 之后的应用即可自主的从第三方应用中获取用户的资源信息</li>
</ul>
<h2 id="Laravel-Socialite-UML"><a href="#Laravel-Socialite-UML" class="headerlink" title="Laravel Socialite UML"></a>Laravel Socialite UML</h2><p><img src="/images/Socialite.png" alt="Socialite"></p>
<h2 id="安装-Laravel-Socialite"><a href="#安装-Laravel-Socialite" class="headerlink" title="安装 Laravel Socialite"></a>安装 Laravel Socialite</h2><p>使用 Composer 进行安装：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">composer <span class="keyword">require</span> laravel/socialite</div></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>你需要在 <code>config/app.php</code> 的 <code>providers</code> 键中追加：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">'providers'</span> =&gt; [</div><div class="line">    <span class="comment">// Other service providers...</span></div><div class="line"></div><div class="line">    Laravel\Socialite\SocialiteServiceProvider::class,</div><div class="line">],</div></pre></td></tr></table></figure>
<p>在 <code>aliasses</code> 键中添加 <code>Socialite</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'Socialite'</span> =&gt; Laravel\Socialite\Facades\Socialite::class,</div></pre></td></tr></table></figure>
<p>在 <code>config/services.php</code> 配置文件中添加驱动器配置项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">'github'</span> =&gt; [</div><div class="line">    <span class="string">'client_id'</span> =&gt; <span class="string">'your-github-app-id'</span>,</div><div class="line">    <span class="string">'client_secret'</span> =&gt; <span class="string">'your-github-app-secret'</span>,</div><div class="line">    <span class="string">'redirect'</span> =&gt; <span class="string">'http://your-callback-url'</span>,</div><div class="line">],</div></pre></td></tr></table></figure>
<p>至此整个流程安装完毕。</p>
<h2 id="集成微信登录"><a href="#集成微信登录" class="headerlink" title="集成微信登录"></a>集成微信登录</h2><p>集成微信我们需要提供一个 <code>WechatServiceProvider</code> 和 一个 <code>WechatProvider</code>，用这两个文件来为微信登录提供驱动，Laravel Socialite 的 SocialiteManager 继承自 <code>Illuminate\Support\Manager</code> 类，而其对自定义驱动提供了友好的接口支持，所以我们可以手动的添加一个 Wechat 驱动器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Crowdfunding</span>\<span class="title">Providers</span>\<span class="title">Socialite</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Socialite</span>\<span class="title">Two</span>\<span class="title">AbstractProvider</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Socialite</span>\<span class="title">Contracts</span>\<span class="title">Provider</span> <span class="title">as</span> <span class="title">ProviderInterface</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Socialite</span>\<span class="title">Two</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">ClientInterface</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WechatProvider</span> <span class="keyword">extends</span> <span class="title">AbstractProvider</span> <span class="keyword">implements</span> <span class="title">ProviderInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">    * openid for get user.</span></div><div class="line"><span class="comment">    * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">protected</span> $openId;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * set Open Id.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $openId</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setOpenId</span><span class="params">($openId)</span> </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;openId = $openId;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> $scopes = [<span class="string">'snsapi_login'</span>];</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAuthUrl</span><span class="params">($state)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;buildAuthUrlFromBase(<span class="string">'https://open.weixin.qq.com/connect/qrconnect'</span>, $state);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">buildAuthUrlFromBase</span><span class="params">($url, $state)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $query = http_build_query(<span class="keyword">$this</span>-&gt;getCodeFields($state), <span class="string">''</span>, <span class="string">'&amp;'</span>, <span class="keyword">$this</span>-&gt;encodingType);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $url.<span class="string">'?'</span>.$query.<span class="string">'#wechat_redirect'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getCodeFields</span><span class="params">($state = null)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> [</div><div class="line">            <span class="string">'appid'</span>         =&gt; <span class="keyword">$this</span>-&gt;clientId, <span class="string">'redirect_uri'</span> =&gt; <span class="keyword">$this</span>-&gt;redirectUrl,</div><div class="line">            <span class="string">'response_type'</span> =&gt; <span class="string">'code'</span>, <span class="string">'scope'</span>                 =&gt; <span class="keyword">$this</span>-&gt;formatScopes(<span class="keyword">$this</span>-&gt;scopes, <span class="keyword">$this</span>-&gt;scopeSeparator),</div><div class="line">            <span class="string">'state'</span>         =&gt; $state,</div><div class="line">        ];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTokenUrl</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'https://api.weixin.qq.com/sns/oauth2/access_token'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUserByToken</span><span class="params">($token)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $response = <span class="keyword">$this</span>-&gt;getHttpClient()-&gt;get(<span class="string">'https://api.weixin.qq.com/sns/userinfo'</span>, [</div><div class="line">            <span class="string">'query'</span> =&gt; [</div><div class="line">                <span class="string">'access_token'</span> =&gt; $token,</div><div class="line">                <span class="string">'openid'</span>       =&gt; <span class="keyword">$this</span>-&gt;openId,</div><div class="line">                <span class="string">'lang'</span>         =&gt; <span class="string">'zh_CN'</span>,</div><div class="line">            ],</div><div class="line">        ]);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> json_decode($response-&gt;getBody(), <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mapUserToObject</span><span class="params">(array $user)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> User())-&gt;setRaw($user)-&gt;map([</div><div class="line">          <span class="string">'openid'</span> =&gt; $user[<span class="string">'openid'</span>], <span class="string">'nickname'</span> =&gt; $user[<span class="string">'nickname'</span>],</div><div class="line">          <span class="string">'avatar'</span> =&gt; $user[<span class="string">'headimgurl'</span>], <span class="string">'name'</span> =&gt; $user[<span class="string">'nickname'</span>],</div><div class="line">          <span class="string">'email'</span>  =&gt; <span class="keyword">null</span>, <span class="string">'unionid'</span>             =&gt; $user[<span class="string">'unionid'</span>]</div><div class="line">        ]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">    * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getTokenFields</span><span class="params">($code)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> [</div><div class="line">            <span class="string">'appid'</span> =&gt; <span class="keyword">$this</span>-&gt;clientId, <span class="string">'secret'</span> =&gt; <span class="keyword">$this</span>-&gt;clientSecret,</div><div class="line">            <span class="string">'code'</span> =&gt; $code, <span class="string">'grant_type'</span> =&gt; <span class="string">'authorization_code'</span>,</div><div class="line">        ];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">    * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAccessTokenResponse</span><span class="params">($code)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $postKey = (version_compare(ClientInterface::VERSION, <span class="string">'6'</span>) === <span class="number">1</span>) ? <span class="string">'form_params'</span> : <span class="string">'body'</span>;</div><div class="line"></div><div class="line">        $response = <span class="keyword">$this</span>-&gt;getHttpClient()-&gt;post(<span class="keyword">$this</span>-&gt;getTokenUrl(), [</div><div class="line">            <span class="string">'headers'</span> =&gt; [<span class="string">'Accept'</span> =&gt; <span class="string">'application/json'</span>],</div><div class="line">            $postKey =&gt; <span class="keyword">$this</span>-&gt;getTokenFields($code),</div><div class="line">        ]);</div><div class="line"></div><div class="line">        $responseBody = json_decode($response-&gt;getBody(), <span class="keyword">true</span>);</div><div class="line">        <span class="keyword">$this</span>-&gt;setOpenId($responseBody[<span class="string">'openid'</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $responseBody;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编写完驱动之后我们需要注册该驱动器到 SocialiteManager 中，因此我们编写一个 WechatServiceProvider:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Crowdfunding</span>\<span class="title">Providers</span>\<span class="title">Socialite</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WechatServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">       <span class="keyword">$this</span>-&gt;app-&gt;make(<span class="string">'Laravel\Socialite\Contracts\Factory'</span>)-&gt;extend(<span class="string">'wechat'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">            $config = $app[<span class="string">'config'</span>][<span class="string">'services.wechat'</span>];</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> WechatProvider(</div><div class="line">                $app[<span class="string">'request'</span>], $config[<span class="string">'client_id'</span>],</div><div class="line">                $config[<span class="string">'client_secret'</span>], $config[<span class="string">'redirect'</span>]</div><div class="line">            );</div><div class="line">       &#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着我们就可以添加配置项及将服务提供者注册到 Laravel 中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// app.php</span></div><div class="line"><span class="string">'providers'</span> =&gt; [</div><div class="line">    <span class="comment">// Other service providers...</span></div><div class="line">    Crowdfunding\Providers\Socialite\WechatServiceProvider::class,</div><div class="line">],</div><div class="line"></div><div class="line"><span class="comment">// services.php</span></div><div class="line"><span class="string">'wechat'</span> =&gt; [</div><div class="line">    <span class="string">'client_id'</span> =&gt; <span class="string">'appid'</span>,</div><div class="line">    <span class="string">'client_secret'</span> =&gt; <span class="string">'appSecret'</span>,</div><div class="line">    <span class="string">'redirect'</span> =&gt; <span class="string">'http://xxxxxx.proxy.qqbrowser.cc/oauth/callback/driver/wechat'</span>,</div><div class="line">]</div></pre></td></tr></table></figure>
<p>紧接着添加路由及控制器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// route.php</span></div><div class="line">Route::group([<span class="string">'middleware'</span> =&gt; <span class="string">'web'</span>], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    Route::get(<span class="string">'oauth/callback/driver/&#123;driver&#125;'</span>, <span class="string">'OAuthAuthorizationController@handleProviderCallback'</span>);</div><div class="line">    Route::get(<span class="string">'oauth/redirect/driver/&#123;driver&#125;'</span>, <span class="string">'OauthAuthorizationController@redirectToProvider'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>控制器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Socialite</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OAuthAuthorizationController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">redirectToProvider</span><span class="params">($driver)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Socialite::driver($driver)-&gt;redirect();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleProviderCallback</span><span class="params">($driver)</span> </span>&#123;</div><div class="line">        $user =  Socialite::driver($driver)-&gt;user();</div><div class="line">        <span class="comment">// dd($user)</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此集成完毕。</p>
<p>PS: 欢迎关注简书 <a href="http://www.jianshu.com/collection/3dff40fa5135" target="_blank" rel="external">Laravel</a> 专题，也欢迎 Laravel 相关文章的投稿 :)，作者知识技能水平有限，如果你有更好的设计方案欢迎讨论交流，如果有错误的地方也请批评指正，在此表示感谢谢谢 :)</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/php/" rel="tag"># php</a>
          
            <a href="/tags/laravel/" rel="tag"># laravel</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/28/introduction-to-laravel-presenter-pattern/" rel="next" title="introduction to laravel presenter pattern">
                <i class="fa fa-chevron-left"></i> introduction to laravel presenter pattern
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/08/08/laravel-cors-enable/" rel="prev" title="laravel 开启跨域功能">
                laravel 开启跨域功能 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Dearmadman</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">100</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Laravel-Socialite"><span class="nav-number">1.</span> <span class="nav-text">Laravel Socialite</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Open-Authorization"><span class="nav-number">1.1.</span> <span class="nav-text">Open Authorization</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Laravel-Socialite-UML"><span class="nav-number">1.2.</span> <span class="nav-text">Laravel Socialite UML</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-Laravel-Socialite"><span class="nav-number">1.3.</span> <span class="nav-text">安装 Laravel Socialite</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置"><span class="nav-number">1.3.1.</span> <span class="nav-text">配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集成微信登录"><span class="nav-number">1.4.</span> <span class="nav-text">集成微信登录</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dearmadman</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
