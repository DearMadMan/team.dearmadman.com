<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Team.dearmadman.com">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Team.dearmadman.com">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Team.dearmadman.com">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>Team.dearmadman.com</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Team.dearmadman.com</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do it.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/30/single-sign-on/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/30/single-sign-on/" itemprop="url">single sign-on</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-30T14:27:50+08:00">
                2016-08-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/13/server-security-best-practice/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/13/server-security-best-practice/" itemprop="url">构建相对安全的服务器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-13T13:02:23+08:00">
                2016-08-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="服务端安全"><a href="#服务端安全" class="headerlink" title="服务端安全"></a>服务端安全</h1><p>服务端安全一直是一个不容忽视却最容易被忽视的问题，本篇将介绍一些使服务端更为安全的最佳实践。此篇使用 Ubuntu 作为服务端操作系统。</p>
<h2 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h2><h3 id="升级软件"><a href="#升级软件" class="headerlink" title="升级软件"></a>升级软件</h3><p>对当前系统中默认安装的软件进行版本更新和安全修补，这一步可以使软件库和系统应用到最新的安全补丁：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt-get update &amp;&amp; apt-get upgrade</div></pre></td></tr></table></figure>
<h3 id="创建新用户"><a href="#创建新用户" class="headerlink" title="创建新用户"></a>创建新用户</h3><p>我们需要创建一个自己的用户来登录和使用服务器资源，而不是 root 这种众所周知的神一般的存在：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">adduser Dearmadman --force-badname</div></pre></td></tr></table></figure>
<p>接着，把 Dearmadman 加入 sodu 用户组，让自己拥有神的能力：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">usermod -a -G sudo Dearmadman</div></pre></td></tr></table></figure>
<h3 id="启用-SSH-密钥对认证"><a href="#启用-SSH-密钥对认证" class="headerlink" title="启用 SSH 密钥对认证"></a>启用 SSH 密钥对认证</h3><p>通常远程连接到服务器时，一般都是用用户名密码的方式进行验证，类似下面这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ssh root@dearmadman.com</div><div class="line"></div><div class="line">password: _</div></pre></td></tr></table></figure>
<p>服务端要求你输入密码进行验证，这种密码验证是有可能被暴力破解的，所以我们可以禁用密码登录功能，使用密钥对来进行认证。</p>
<p>所谓密钥对就是在本地机器中生成一对密钥 —— 公钥和私钥，你需要将公钥存储于服务器中，服务器会在你请求认证时要求你使用私钥对公钥内容进行解密，并把解密后的消息传递到服务器进行验证。这种方式可以有效的杜绝暴力破解的可能，同时也避免了中间人攻击的可能。</p>
<h3 id="生成-SSH-密钥对"><a href="#生成-SSH-密钥对" class="headerlink" title="生成 SSH 密钥对"></a>生成 SSH 密钥对</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh-keygen</div></pre></td></tr></table></figure>
<p>这个命令会生成一对秘钥，存放在 ~/.ssh 目录中，其中 id_rsa.pub 是公钥，你需要将公钥传递到服务端，我们可以使用 <code>scp</code> 命令来复制公钥到服务端：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scp ~/.ssh/id_rsa.pub Dearmadman@dearmadman.com:</div></pre></td></tr></table></figure>
<p>该命令会将公钥传递到服务器的 Dearmadman 用户的根目录中，我们需要确认在用户根目录中是否存在 <code>.ssh</code> 目录，如果不存在则需要手动创建，并在 .ssh 目录中创建一个保存一系列公钥的文件 <code>authorized_keys</code>，然后将上传的公钥追加到文件中:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> /home/Dearmadman</div><div class="line"></div><div class="line">mkdir .ssh</div><div class="line"></div><div class="line">touch .ssh/authorized_keys</div><div class="line"></div><div class="line">cat ~/id_rsa.pub &gt;&gt; /home/Dearmadman/.ssh/authorized_keys</div></pre></td></tr></table></figure>
<p>最后修改目录和文件的访问权限，只让 Dearmadman 用户访问 .ssh 目录和 .ssh/authorized_keys 文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">chwon -R Dearmadman:Dearmadman .ssh</div><div class="line">chmod 700 .ssh</div><div class="line">chmod 600 .ssh/authorized_keys</div></pre></td></tr></table></figure>
<h2 id="SSH-配置"><a href="#SSH-配置" class="headerlink" title="SSH 配置"></a>SSH 配置</h2><p>SSH 的配置信息存放在 /etc/ssh/sshd_config 文件中。</p>
<h3 id="修改默认端口"><a href="#修改默认端口" class="headerlink" title="修改默认端口"></a>修改默认端口</h3><p>SSH 默认监听的是 22 号端口，我们可以转换为监听其他端口:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Port 6293</div></pre></td></tr></table></figure>
<h3 id="禁用密码登录"><a href="#禁用密码登录" class="headerlink" title="禁用密码登录"></a>禁用密码登录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PasswordAuthentication no</div></pre></td></tr></table></figure>
<h3 id="禁用-root-用户"><a href="#禁用-root-用户" class="headerlink" title="禁用 root 用户"></a>禁用 root 用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PermitRootLogin no</div></pre></td></tr></table></figure>
<h3 id="重启-SSh"><a href="#重启-SSh" class="headerlink" title="重启 SSh"></a>重启 SSh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo service ssh restart</div></pre></td></tr></table></figure>
<h2 id="IPTABLES"><a href="#IPTABLES" class="headerlink" title="IPTABLES"></a>IPTABLES</h2><p>利用 IPTABLES 可以对服务端流入和流出的数据包进行有效的管理。</p>
<p>保存原有规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables-save &gt; /etc/iptables.rules</div></pre></td></tr></table></figure>
<p>修改 filter 部分内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">*filter</div><div class="line"><span class="comment"># 设置默认的链策略</span></div><div class="line">-P INPUT DROP</div><div class="line">-P FORWARD DROP</div><div class="line">-P OUTPUT ACCEPT</div><div class="line"></div><div class="line"><span class="comment"># 开放 6293 端口，用于 SSH 认证，默认为 22 端口，前文修改为 6293</span></div><div class="line">-A INPUT -p tcp -m tcp --dport 6293 -j ACCEPT</div><div class="line"></div><div class="line"><span class="comment"># 开放 80 和 443 端口，分别用于 http 和 https 协议</span></div><div class="line">-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT</div><div class="line">-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT</div><div class="line"></div><div class="line"><span class="comment"># 禁止 ping，默认的连策略已经禁止了 ping，这里修改 DROP 为 ACCEPT 将允许 ping</span></div><div class="line"><span class="comment">#-A INPUT -p icmp -m icmp --icmp-type 8 -j DROP</span></div><div class="line">COMMIT</div></pre></td></tr></table></figure>
<p>刷新规则:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables-restore &lt; /etc/iptables.rules</div></pre></td></tr></table></figure>
<p><strong>下面是一些常用 web 服务相关软件，对于这些软件应独立出一个低权限用户来独立运行，并且应禁用该账号的登录权限。在此不做详细说明</strong></p>
<h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><p>修改 php.ini 禁止响应版本号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">expose_php = Off</div></pre></td></tr></table></figure>
<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>修改 nginx.conf 隐藏版本号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">  server_tokens off;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><p>禁用远程访问，如果必要，请选择 ssh 密钥登录</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/08/real-time-laravel-with-socket-io-and-redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/08/real-time-laravel-with-socket-io-and-redis/" itemprop="url">Laravel 即时应用的一种实现方式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-08T10:17:43+08:00">
                2016-08-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="即时交互的应用"><a href="#即时交互的应用" class="headerlink" title="即时交互的应用"></a>即时交互的应用</h2><p>在现代的 Web 应用中很多场景都需要运用到即时通讯，比如说最常见的支付回调，与三方登录。这些业务场景都基本需要遵循以下流程：</p>
<ul>
<li>客户端触发相关业务，并产生第三方应用的操作（比如支付）</li>
<li>客户端等待服务端响应结果（用户完成第三方应用的操作）</li>
<li>第三方应用通知服务端处理结果（支付完成）</li>
<li>服务端通知客户端处理结果</li>
<li>客户端依据结果做出反馈 （跳转到支付成功页面）</li>
</ul>
<p>在过去，为了实现这种即时通讯，能让客户端正确响应处理结果，最为常用的技术就是轮询，因为 HTTP 协议的单向性，客户端只能一遍一遍的主动询问服务端的处理结果。这种方式有显见的缺陷，占用服务端资源不说，还不能实时获得服务端处理结果。</p>
<p>现在，我们可以使用 WebSocket 协议来处理实时交互，它是一种双向协议，允许服务端主动推送信息到客户端。本篇我们将借助 Laravel 强大的事件系统来构建实时的交互。你将需要用到以下知识：</p>
<ul>
<li>Laravel Event</li>
<li>Redis</li>
<li>Socket.io</li>
<li>Node.js</li>
</ul>
<h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><p>在开始之前，我们需要开启一个 redis 服务，并在 Laravel 应用中进行配置启用，因为在整个流程中，我们需要借助 redis 的订阅和发布机制来实现即时通讯。</p>
<p>Redis 是一个开源高效的键值对存储系统。它通常作为一个数据结构服务器来存储键值对，它可以支持字符串，散列，列表，集合和有序结合。在 Laravel 中使用 Redis 你需用通过 Composer 来安装 <code>predis/predis</code> 包文件。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>Redis 在应用中的配置文件存储在 <code>config/database.php</code>，在这个文件中，你可以看到一个包含了 Redis 服务信息的 <code>redis</code> 数组:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="string">'redis'</span> =&gt; [</div><div class="line">  <span class="string">'cluster'</span> =&gt; <span class="keyword">false</span>,</div><div class="line"></div><div class="line">  <span class="string">'default'</span> =&gt; [</div><div class="line">    <span class="string">'host'</span> =&gt; <span class="string">'127.0.0.1'</span>,</div><div class="line">    <span class="string">'port'</span> =&gt; <span class="number">6379</span>,</div><div class="line">    <span class="string">'database'</span> =&gt; <span class="number">0</span>,</div><div class="line">  ],</div><div class="line">]</div></pre></td></tr></table></figure>
<p>如果你修改了 redis 服务的端口，请保持配置文件中的端口一致。</p>
<h2 id="Laravel-Event"><a href="#Laravel-Event" class="headerlink" title="Laravel Event"></a>Laravel Event</h2><p>这里我们需要借助 Laravel 强大的事件广播能力：</p>
<blockquote>
<p><strong>广播事件</strong></p>
<p>很多现代化的应用中，会使用 Web Sockets 来实现实时交互的用户接口。当一些数据在服务端变更时，一条消息会通过 WebSocket 连接来传递到客户端进行处理。<br>为了帮助你构建这种类型的应用。Laravel 使通过 WebSocket 连接进行广播事件变的非常简单。Laravel 允许你广播事件来共享事件的名称到你的服务端和客户端的 JavaScript 框架。</p>
</blockquote>
<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><p>所有的事件广播配置选项都被存储在 <code>config/broadcasting.php</code> 配置文件中。Laravel 附带了几种可用的驱动如 Pusher，Redis，和 Log，我们将使用 Redis 作为广播驱动，这里需要依赖 <code>predis/predis</code> 类库。</p>
<p>由于默认的广播驱动使用的是 <a href="https://pusher.com/" target="_blank" rel="external">pusher</a>，所以我们需要在 <code>.env</code> 文件中设置 <code>BROADCAST_DRIVER=redis</code>。</p>
<p>我们创建一个 <code>WechatLoginedEvent</code> 事件类用来在用户扫描微信登录后进行广播：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Events</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Events</span>\<span class="title">Event</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">SerializesModels</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Broadcasting</span>\<span class="title">ShouldBroadcast</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WechatLoginedEvent</span> <span class="keyword">extends</span> <span class="title">Event</span> <span class="keyword">implements</span> <span class="title">ShouldBroadcast</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">use</span> <span class="title">SerializesModels</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> $token;</div><div class="line">    <span class="keyword">protected</span> $channel;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Create a new event instance.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span>  string $token</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span>  string $channel</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($token, $channel)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;token = $token;</div><div class="line">        <span class="keyword">$this</span>-&gt;channel = $channel;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Get the channels the event should be broadcast on.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastOn</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> [<span class="keyword">$this</span>-&gt;channel];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Get the name the event should be broadcast on.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastAs</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'wechat.login'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中你需要注意 <code>broadcastOn</code> 方法应返回一个数组，它表示所需广播的频道，而 <code>broadcastAs</code> 返回的是一个字符串，它表示广播所触发的事件，Laravel 默认的是返回事件类的全类名，这里是 <code>App\Events\WechatLoginedEvent</code>.</p>
<p>最重要的是你需要手动的让该类实现 <code>ShouldBroadcast</code> 契约。Laravel 在生成事件时，已经自动添加了该命名空间，该契约只约束 <code>broadcastOn</code> 方法。</p>
<p>事件完成接下来就是触发事件了，简单的一行代码就可以：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">event(<span class="keyword">new</span> WechatLoginedEvent($token, $channel));</div></pre></td></tr></table></figure>
<p>这个操作会自动的触发事件的执行并将信息广播出去。该广播操作底层借助了 redis 的订阅和发布机制。<code>RedisBroadcaster</code> 会将事件中的允许公开访问的数据通过给定的频道发布出去。如果你想对公开的数据拥有更多的控制，你可以在事件中添加 <code>broadcastWith</code> 方法，它应该返回一个数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Get the data to broadcast.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastWith</span><span class="params">()</span> </span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">return</span> [<span class="string">'user'</span> =&gt; <span class="keyword">$this</span>-&gt;user-&gt;id];</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="Node-js-和-Socket-io"><a href="#Node-js-和-Socket-io" class="headerlink" title="Node.js 和 Socket.io"></a>Node.js 和 Socket.io</h2><p>对于发布出去的信息，我们需要一个服务来对接，让其能对 redis 的发布能够进行订阅，并且能把信息以 WebSocket 协议转发出去，这里我们可以借用 Node.js 和 socket.io 来非常方便的构建这个服务：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// server.js</span></div><div class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'http'</span>).createServer(handler);</div><div class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">'socket.io'</span>)(app);</div><div class="line"></div><div class="line"><span class="keyword">var</span> Redis = <span class="built_in">require</span>(<span class="string">'ioredis'</span>);</div><div class="line"><span class="keyword">var</span> redis = <span class="keyword">new</span> Redis();</div><div class="line"></div><div class="line">app.listen(<span class="number">6001</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Server is running!'</span>) ;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handler</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.writeHead(<span class="number">200</span>);</div><div class="line">  res.end(<span class="string">''</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">io.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">socket</span>) </span>&#123;</div><div class="line">  socket.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(message)</div><div class="line">  &#125;)</div><div class="line">  socket.on(<span class="string">'disconnect'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'user disconnect'</span>)</div><div class="line">  &#125;)</div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line">redis.psubscribe(<span class="string">'*'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, count</span>) </span>&#123;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">redis.on(<span class="string">'pmessage'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">subscrbed, channel, message</span>) </span>&#123;</div><div class="line">  message = <span class="built_in">JSON</span>.parse(message);</div><div class="line">  io.emit(channel + <span class="string">':'</span> + message.event, message.data);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这里我们使用 Node.js 引入 socket.io 服务端并监听 6001 端口，借用 redis 的 psubscribe 指令使用通配符来快速的批量订阅，接着在消息触发时将消息通过 WebSocket 转发出去。</p>
<h2 id="Socket-io-客户端"><a href="#Socket-io-客户端" class="headerlink" title="Socket.io 客户端"></a>Socket.io 客户端</h2><p>在 web 前端，我们需要引入 Socket.io 客户端开启与服务端 6001 端口的通讯，并订阅频道事件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// client.js</span></div><div class="line"><span class="keyword">let</span> io = <span class="built_in">require</span>(<span class="string">'socket.io-client'</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> socket = io(<span class="string">':6001'</span>)</div><div class="line">      socket.on($channel + <span class="string">':wechat.login'</span>, (data) =&gt; &#123;</div><div class="line">        socket.close()</div><div class="line">        <span class="comment">// save user token and redirect to dashboard</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>至此整个通讯闭环结束，开发流程看起来就是这样的：</p>
<ul>
<li>在 Laravel 中构建一个支持广播通知的事件</li>
<li>设置需要进行广播的频道及事件名称</li>
<li>将广播设置为使用 redis 驱动</li>
<li>提供一个持续的服务用于订阅 redis 的发布，及将发布内容通过 WebSocket 协议推送到客户端</li>
<li>客户端打开服务端 WebSocket 隧道，并对事件进行订阅，根据指定事件的推送进行响应。</li>
</ul>
<p>PS: 欢迎关注简书 <a href="http://www.jianshu.com/collection/3dff40fa5135" target="_blank" rel="external">Laravel</a> 专题，也欢迎 Laravel 相关文章的投稿 :)，作者知识技能水平有限，如果你有更好的设计方案欢迎讨论交流，如果有错误的地方也请批评指正，在此表示感谢 :)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/08/laravel-cors-enable/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/08/laravel-cors-enable/" itemprop="url">laravel 开启跨域功能</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-08T10:09:58+08:00">
                2016-08-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="跨域的请求"><a href="#跨域的请求" class="headerlink" title="跨域的请求"></a>跨域的请求</h1><p>出于安全性的原因，浏览器会限制 Script 中的跨域请求。由于 XMLHttpRequest 遵循同源策略，所有使用 XMLHttpRequest 构造 HTTP 请求的应用只能访问自己的域名，如果需要构造跨域的请求，那么开发者需要配合浏览器做出一些允许跨域的配置。</p>
<p>W3C 应用工作组推荐了一种跨资源共享的机制，这种机制让 Web 应用服务器能支持跨站访问控制，从而使得安全的进行跨站数据传输成为可能，该机制通过几种方式来对原有模式进行了扩展：</p>
<ul>
<li>响应的头部应该追加 <code>Access-Control-Allow-Orign</code>，用来表明哪些请求源被允许访问资源内容</li>
<li>浏览器会对请求源和响应中的值进行匹配验证</li>
<li>对于跨域的请求，浏览器会预发送一个非简单方式的请求，来判断给定资源是否准备接受跨域资源访问</li>
<li>服务端应用通过检查请求头部的 <code>Orign</code> 来判定请求是否跨域。</li>
</ul>
<h2 id="跨源资源共享标准"><a href="#跨源资源共享标准" class="headerlink" title="跨源资源共享标准"></a>跨源资源共享标准</h2><blockquote>
<p>跨源资源共享标准通过新增一系列 HTTP 头，让服务器能声明哪些来源可以通过浏览器访问该服务器上的资源。另外，对哪些会对服务器数据造成破坏性响应的 HTTP 请求方法（特别是 GET 以外的 HTTP 方法，或者搭配某些 MIME 类型的 POST 请求），标准强烈要求浏览器必须先以 OPTIONS 请求方式发送一个预请求（preflight request），从而获取知服务器端对跨源请求所支持 HTTP 方法。在确认服务器允许跨源请求的情况下，以实际的 HTTP 请求方法发送那个真正的请求。服务器端也可以通知客户端，是不是需要随同请求一起发送信用信息（包括 Cookies 和 HTTP 认证相关数据）。</p>
</blockquote>
<p>跨源共享标准需要浏览器和服务端共同配合才能完成，目前浏览器厂商已经可以将请求部分自动完成，所以跨源资源访问的重点还是在于服务器端。</p>
<p>下面列出一些标准中可用的响应头和请求头。</p>
<h2 id="Response-Header"><a href="#Response-Header" class="headerlink" title="Response Header"></a>Response Header</h2><ul>
<li>Access-Control-Allow-Origin      : 指明哪些请求源被允许访问资源，值可以为 “*”，”null”，或者单个源地址。</li>
<li>Access-Control-Allow-Credentials : 指明当请求中省略 creadentials 标识时响应是否暴露。对于预请求来说，它表明实际的请求中可以包含用户凭证。</li>
<li>Access-Control-Expose-Headers    : 指明哪些头信息可以安全的暴露给 CORS API 规范的 API。</li>
<li>Access-Control-Max-Age           : 指明预请求可以在预请求缓存中存放多久。</li>
<li>Access-Control-Allow-Methods     : 对于预请求来说，哪些请求方式可以用于实际的请求。</li>
<li>Access-Control-Allow-Headers     : 对于预请求来说，指明了哪些头信息可以用于实际的请求中。</li>
<li>Origin                           : 指明预请求或者跨域请求的来源。</li>
<li>Access-Control-Request-Method    : 对于预请求来说，指明哪些预请求中的请求方式可以被用在实际的请求中。</li>
<li>Access-Control-Request-Headers   : 指明预请求中的哪些头信息可以用于实际的请求中。</li>
</ul>
<h2 id="Request-Header"><a href="#Request-Header" class="headerlink" title="Request Header"></a>Request Header</h2><ul>
<li>Origin                         : 表明发送请求或预请求的来源。</li>
<li>Access-Control-Request-Method  : 在发送预请求时带该请求头，表明实际的请求将使用的请求方式。</li>
<li>Access-Control-Request-Headers : 在发送预请求时带有该请求头，表明实际的请求将携带的请求头。</li>
</ul>
<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><p>在 Laravel 中允许跨域请求，我们可以构建一个追加响应的中间件，用来添加专门处理跨域的请求的响应头:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> <span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Response</span>;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EnableCrossRequestMiddleware</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Handle an incoming request.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span>  \Closure  $next</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> mixed</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line"></div><div class="line">    $response = $next($request);</div><div class="line">        $response-&gt;header(<span class="string">'Access-Control-Allow-Origin'</span>, config(<span class="string">'app.allow'</span>));</div><div class="line">        $response-&gt;header(<span class="string">'Access-Control-Allow-Headers'</span>, <span class="string">'Origin, Content-Type, Cookie, Accept'</span>);</div><div class="line">        $response-&gt;header(<span class="string">'Access-Control-Allow-Methods'</span>, <span class="string">'GET, POST, PATCH, PUT, OPTIONS'</span>);</div><div class="line">        $response-&gt;header(<span class="string">'Access-Control-Allow-Credentials'</span>, <span class="string">'true'</span>);</div><div class="line">        <span class="keyword">return</span> $response;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中有以下需要注意的地方：</p>
<ul>
<li>对于跨域访问并需要伴随认证信息的请求，需要在 XMLHttpRequest 实例中指定 <code>withCredentials</code> 为 <code>true</code>。</li>
<li>这个中间件你可以根据自己的需求进行构建，如果需要在请求中伴随认证信息（包含 cookie，session）那么你就需要指定 <code>Access-Control-Allow-Credentials</code> 为 <code>true</code>, 因为对于预请求来说如果你未指定该响应头，那么浏览器会直接忽略该响应。</li>
<li>在响应中指定 <code>Access-Control-Allow-Credentials</code> 为 <code>true</code> 时，<code>Access-Control-Allow-Origin</code> 不能指定为 <code>*</code> </li>
<li>后置中间件只有在正常响应时才会被追加响应头，而如果出现异常，这时响应是不会经过中间件的。</li>
</ul>
<p>PS: 欢迎关注简书 <a href="http://www.jianshu.com/collection/3dff40fa5135" target="_blank" rel="external">Laravel</a> 专题，也欢迎 Laravel 相关文章的投稿 :)，作者知识技能水平有限，如果你有更好的设计方案欢迎讨论交流，如果有错误的地方也请批评指正，在此表示感谢 :)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/01/using-wechat-authentication-for-login-with-laravel-socialite/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/01/using-wechat-authentication-for-login-with-laravel-socialite/" itemprop="url">使用 Laravel Socialite 集成微信登录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-08-01T14:22:10+08:00">
                2016-08-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel-Socialite"><a href="#Laravel-Socialite" class="headerlink" title="Laravel Socialite"></a>Laravel Socialite</h1><blockquote>
<p>Laravel Socialite provides an expressive, fluent interface to OAuth authentication with Facebook, Twitter, Google, LinkedIn, GitHub and Bitbucket. It handles almost all of the boilerplate social authentication code you are dreading writing.</p>
</blockquote>
<p><a href="https://github.com/laravel/socialite" target="_blank" rel="external">Laravel Socialite</a> 为第三方应用的 OAuth 认证提供了非常丰富友好的接口，我们使用它可以非常方便快捷的对类似微信、微博等第三方登录进行集成。</p>
<h2 id="Open-Authorization"><a href="#Open-Authorization" class="headerlink" title="Open Authorization"></a>Open Authorization</h2><blockquote>
<p>OAuth（开放授权）是一个开放标准，允许用户让第三方应用访问该用户在某一网站上存储的私密的资源（如照片，视频，联系人列表），而无需将用户名和密码提供给第三方应用。</p>
<p>OAuth 允许用户提供一个令牌，而不是用户名和密码来访问他们存放在特定服务提供者的数据。每一个令牌授权一个特定的网站（例如，视频编辑网站)在特定的时段（例如，接下来的 2 小时内）内访问特定的资源（例如仅仅是某一相册中的视频）。这样，OAuth 让用户可以授权第三方网站访问他们存储在另外服务提供者的某些特定信息，而非所有内容。</p>
</blockquote>
<p>我们的应用与使用 OAuth 标准的第三方应用的交互流程一般是这样的：</p>
<ul>
<li>展示跳转到第三方应用登录的链接</li>
<li>用户点击链接跳转到第三方应用登录并进行授权</li>
<li>在用户授权后第三方应用会跳转到我们所指定的应用回调资源地址并伴随用于交互 AccessToken 的 Code</li>
<li>我们的应用拿到 Code 后自主请求第三方应用并使用 Code 获取该用户的 AccessToken</li>
<li>获取 AccessToken 之后的应用即可自主的从第三方应用中获取用户的资源信息</li>
</ul>
<h2 id="Laravel-Socialite-UML"><a href="#Laravel-Socialite-UML" class="headerlink" title="Laravel Socialite UML"></a>Laravel Socialite UML</h2><p><img src="/images/Socialite.png" alt="Socialite"></p>
<h2 id="安装-Laravel-Socialite"><a href="#安装-Laravel-Socialite" class="headerlink" title="安装 Laravel Socialite"></a>安装 Laravel Socialite</h2><p>使用 Composer 进行安装：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">composer <span class="keyword">require</span> laravel/socialite</div></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>你需要在 <code>config/app.php</code> 的 <code>providers</code> 键中追加：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">'providers'</span> =&gt; [</div><div class="line">    <span class="comment">// Other service providers...</span></div><div class="line"></div><div class="line">    Laravel\Socialite\SocialiteServiceProvider::class,</div><div class="line">],</div></pre></td></tr></table></figure>
<p>在 <code>aliasses</code> 键中添加 <code>Socialite</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'Socialite'</span> =&gt; Laravel\Socialite\Facades\Socialite::class,</div></pre></td></tr></table></figure>
<p>在 <code>config/services.php</code> 配置文件中添加驱动器配置项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">'github'</span> =&gt; [</div><div class="line">    <span class="string">'client_id'</span> =&gt; <span class="string">'your-github-app-id'</span>,</div><div class="line">    <span class="string">'client_secret'</span> =&gt; <span class="string">'your-github-app-secret'</span>,</div><div class="line">    <span class="string">'redirect'</span> =&gt; <span class="string">'http://your-callback-url'</span>,</div><div class="line">],</div></pre></td></tr></table></figure>
<p>至此整个流程安装完毕。</p>
<h2 id="集成微信登录"><a href="#集成微信登录" class="headerlink" title="集成微信登录"></a>集成微信登录</h2><p>集成微信我们需要提供一个 <code>WechatServiceProvider</code> 和 一个 <code>WechatProvider</code>，用这两个文件来为微信登录提供驱动，Laravel Socialite 的 SocialiteManager 继承自 <code>Illuminate\Support\Manager</code> 类，而其对自定义驱动提供了友好的接口支持，所以我们可以手动的添加一个 Wechat 驱动器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Crowdfunding</span>\<span class="title">Providers</span>\<span class="title">Socialite</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Socialite</span>\<span class="title">Two</span>\<span class="title">AbstractProvider</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Socialite</span>\<span class="title">Contracts</span>\<span class="title">Provider</span> <span class="title">as</span> <span class="title">ProviderInterface</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Socialite</span>\<span class="title">Two</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">ClientInterface</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WechatProvider</span> <span class="keyword">extends</span> <span class="title">AbstractProvider</span> <span class="keyword">implements</span> <span class="title">ProviderInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">    * openid for get user.</span></div><div class="line"><span class="comment">    * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">protected</span> $openId;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * set Open Id.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $openId</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setOpenId</span><span class="params">($openId)</span> </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;openId = $openId;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> $scopes = [<span class="string">'snsapi_login'</span>];</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAuthUrl</span><span class="params">($state)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;buildAuthUrlFromBase(<span class="string">'https://open.weixin.qq.com/connect/qrconnect'</span>, $state);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">buildAuthUrlFromBase</span><span class="params">($url, $state)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $query = http_build_query(<span class="keyword">$this</span>-&gt;getCodeFields($state), <span class="string">''</span>, <span class="string">'&amp;'</span>, <span class="keyword">$this</span>-&gt;encodingType);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $url.<span class="string">'?'</span>.$query.<span class="string">'#wechat_redirect'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getCodeFields</span><span class="params">($state = null)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> [</div><div class="line">            <span class="string">'appid'</span>         =&gt; <span class="keyword">$this</span>-&gt;clientId, <span class="string">'redirect_uri'</span> =&gt; <span class="keyword">$this</span>-&gt;redirectUrl,</div><div class="line">            <span class="string">'response_type'</span> =&gt; <span class="string">'code'</span>, <span class="string">'scope'</span>                 =&gt; <span class="keyword">$this</span>-&gt;formatScopes(<span class="keyword">$this</span>-&gt;scopes, <span class="keyword">$this</span>-&gt;scopeSeparator),</div><div class="line">            <span class="string">'state'</span>         =&gt; $state,</div><div class="line">        ];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTokenUrl</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'https://api.weixin.qq.com/sns/oauth2/access_token'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUserByToken</span><span class="params">($token)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $response = <span class="keyword">$this</span>-&gt;getHttpClient()-&gt;get(<span class="string">'https://api.weixin.qq.com/sns/userinfo'</span>, [</div><div class="line">            <span class="string">'query'</span> =&gt; [</div><div class="line">                <span class="string">'access_token'</span> =&gt; $token,</div><div class="line">                <span class="string">'openid'</span>       =&gt; <span class="keyword">$this</span>-&gt;openId,</div><div class="line">                <span class="string">'lang'</span>         =&gt; <span class="string">'zh_CN'</span>,</div><div class="line">            ],</div><div class="line">        ]);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> json_decode($response-&gt;getBody(), <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">mapUserToObject</span><span class="params">(array $user)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> User())-&gt;setRaw($user)-&gt;map([</div><div class="line">          <span class="string">'openid'</span> =&gt; $user[<span class="string">'openid'</span>], <span class="string">'nickname'</span> =&gt; $user[<span class="string">'nickname'</span>],</div><div class="line">          <span class="string">'avatar'</span> =&gt; $user[<span class="string">'headimgurl'</span>], <span class="string">'name'</span> =&gt; $user[<span class="string">'nickname'</span>],</div><div class="line">          <span class="string">'email'</span>  =&gt; <span class="keyword">null</span>, <span class="string">'unionid'</span>             =&gt; $user[<span class="string">'unionid'</span>]</div><div class="line">        ]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">    * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getTokenFields</span><span class="params">($code)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> [</div><div class="line">            <span class="string">'appid'</span> =&gt; <span class="keyword">$this</span>-&gt;clientId, <span class="string">'secret'</span> =&gt; <span class="keyword">$this</span>-&gt;clientSecret,</div><div class="line">            <span class="string">'code'</span> =&gt; $code, <span class="string">'grant_type'</span> =&gt; <span class="string">'authorization_code'</span>,</div><div class="line">        ];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">    * &#123;<span class="doctag">@inheritdoc</span>&#125;.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAccessTokenResponse</span><span class="params">($code)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        $postKey = (version_compare(ClientInterface::VERSION, <span class="string">'6'</span>) === <span class="number">1</span>) ? <span class="string">'form_params'</span> : <span class="string">'body'</span>;</div><div class="line"></div><div class="line">        $response = <span class="keyword">$this</span>-&gt;getHttpClient()-&gt;post(<span class="keyword">$this</span>-&gt;getTokenUrl(), [</div><div class="line">            <span class="string">'headers'</span> =&gt; [<span class="string">'Accept'</span> =&gt; <span class="string">'application/json'</span>],</div><div class="line">            $postKey =&gt; <span class="keyword">$this</span>-&gt;getTokenFields($code),</div><div class="line">        ]);</div><div class="line"></div><div class="line">        $responseBody = json_decode($response-&gt;getBody(), <span class="keyword">true</span>);</div><div class="line">        <span class="keyword">$this</span>-&gt;setOpenId($responseBody[<span class="string">'openid'</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $responseBody;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编写完驱动之后我们需要注册该驱动器到 SocialiteManager 中，因此我们编写一个 WechatServiceProvider:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Crowdfunding</span>\<span class="title">Providers</span>\<span class="title">Socialite</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WechatServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">       <span class="keyword">$this</span>-&gt;app-&gt;make(<span class="string">'Laravel\Socialite\Contracts\Factory'</span>)-&gt;extend(<span class="string">'wechat'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">            $config = $app[<span class="string">'config'</span>][<span class="string">'services.wechat'</span>];</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> WechatProvider(</div><div class="line">                $app[<span class="string">'request'</span>], $config[<span class="string">'client_id'</span>],</div><div class="line">                $config[<span class="string">'client_secret'</span>], $config[<span class="string">'redirect'</span>]</div><div class="line">            );</div><div class="line">       &#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着我们就可以添加配置项及将服务提供者注册到 Laravel 中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// app.php</span></div><div class="line"><span class="string">'providers'</span> =&gt; [</div><div class="line">    <span class="comment">// Other service providers...</span></div><div class="line">    Crowdfunding\Providers\Socialite\WechatServiceProvider::class,</div><div class="line">],</div><div class="line"></div><div class="line"><span class="comment">// services.php</span></div><div class="line"><span class="string">'wechat'</span> =&gt; [</div><div class="line">    <span class="string">'client_id'</span> =&gt; <span class="string">'appid'</span>,</div><div class="line">    <span class="string">'client_secret'</span> =&gt; <span class="string">'appSecret'</span>,</div><div class="line">    <span class="string">'redirect'</span> =&gt; <span class="string">'http://xxxxxx.proxy.qqbrowser.cc/oauth/callback/driver/wechat'</span>,</div><div class="line">]</div></pre></td></tr></table></figure>
<p>紧接着添加路由及控制器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// route.php</span></div><div class="line">Route::group([<span class="string">'middleware'</span> =&gt; <span class="string">'web'</span>], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    Route::get(<span class="string">'oauth/callback/driver/&#123;driver&#125;'</span>, <span class="string">'OAuthAuthorizationController@handleProviderCallback'</span>);</div><div class="line">    Route::get(<span class="string">'oauth/redirect/driver/&#123;driver&#125;'</span>, <span class="string">'OauthAuthorizationController@redirectToProvider'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>控制器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Socialite</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OAuthAuthorizationController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">redirectToProvider</span><span class="params">($driver)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Socialite::driver($driver)-&gt;redirect();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleProviderCallback</span><span class="params">($driver)</span> </span>&#123;</div><div class="line">        $user =  Socialite::driver($driver)-&gt;user();</div><div class="line">        <span class="comment">// dd($user)</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此集成完毕。</p>
<p>PS: 欢迎关注简书 <a href="http://www.jianshu.com/collection/3dff40fa5135" target="_blank" rel="external">Laravel</a> 专题，也欢迎 Laravel 相关文章的投稿 :)，作者知识技能水平有限，如果你有更好的设计方案欢迎讨论交流，如果有错误的地方也请批评指正，在此表示感谢谢谢 :)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/28/introduction-to-laravel-presenter-pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/28/introduction-to-laravel-presenter-pattern/" itemprop="url">introduction to laravel presenter pattern</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-28T17:28:12+08:00">
                2016-07-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/27/get-express-info-from-kuaidi-100/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/27/get-express-info-from-kuaidi-100/" itemprop="url">简单的从快递 100 中获取快递信息</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-27T13:24:19+08:00">
                2016-07-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="快递查询"><a href="#快递查询" class="headerlink" title="快递查询"></a>快递查询</h1><p>经常有应用需求能根据单号查询快递状态，大多数时候都需求快递的运输信息。我们可以从 <a href="http://www.kuaidi100.com/" target="_blank" rel="external">快递 100</a> 中快速的获取到快递的物流信息。</p>
<h2 id="接口分析"><a href="#接口分析" class="headerlink" title="接口分析"></a>接口分析</h2><p>快递 100 中提供了两个接口用来结合查询物流信息：</p>
<ul>
<li>根据单号智能识别物流方式（顺丰、韵达、申通等）</li>
<li>根据单号及物流方式获取物流信息</li>
</ul>
<h3 id="智能识别接口"><a href="#智能识别接口" class="headerlink" title="智能识别接口"></a>智能识别接口</h3><p>接口地址： <a href="http://www.kuaidi100.com/autonumber/autoComNum?text=单号" target="_blank" rel="external">http://www.kuaidi100.com/autonumber/autoComNum?text=单号</a><br>请求方式： GET</p>
<p>成功返回：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"comCode"</span>: <span class="string">""</span>,</div><div class="line">  <span class="string">"num"</span>: <span class="string">"3310479082803"</span>,</div><div class="line">  <span class="string">"auto"</span>: [</div><div class="line">    &#123;</div><div class="line">    <span class="string">"comCode"</span>: <span class="string">"shentong"</span>,</div><div class="line">    <span class="string">"id"</span>: <span class="string">""</span>,</div><div class="line">    <span class="string">"noCount"</span>: <span class="number">94165</span>,</div><div class="line">    <span class="string">"noPre"</span>: <span class="string">"331047"</span>,</div><div class="line">    <span class="string">"startTime"</span>: <span class="string">""</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果是不能识别的单号那么将返回：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"comCode"</span>: <span class="string">""</span>,</div><div class="line">  <span class="string">"num"</span>: <span class="string">"xxx51017908280"</span>,</div><div class="line">  <span class="string">"auto"</span>: []</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="物流详情接口"><a href="#物流详情接口" class="headerlink" title="物流详情接口"></a>物流详情接口</h3><p>接口地址： <a href="http://www.kuaidi100.com/query?type=comCode&amp;postid=单号&amp;id=1&amp;valicode=&amp;temp=时间戳" target="_blank" rel="external">http://www.kuaidi100.com/query?type=comCode&amp;postid=单号&amp;id=1&amp;valicode=&amp;temp=时间戳</a><br>请求方式： GET</p>
<p>接口返回信息：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"message"</span>: <span class="string">"ok"</span>,</div><div class="line">    <span class="string">"nu"</span>: <span class="string">"3310479082803"</span>,</div><div class="line">    <span class="string">"ischeck"</span>: <span class="string">"0"</span>,</div><div class="line">    <span class="string">"com"</span>: <span class="string">"shentong"</span>,</div><div class="line">    <span class="string">"updatetime"</span>: <span class="string">"2016-07-27 13:15:45"</span>,</div><div class="line">    <span class="string">"status"</span>: <span class="string">"200"</span>,</div><div class="line">    <span class="string">"condition"</span>: <span class="string">"00"</span>,</div><div class="line">    <span class="string">"data"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="string">"time"</span>: <span class="string">"2016-06-30 03:17:28"</span>,</div><div class="line">            <span class="string">"location"</span>: <span class="string">""</span>,</div><div class="line">            <span class="string">"context"</span>: <span class="string">"快件已到达 湖北武汉武隆分部"</span>,</div><div class="line">            <span class="string">"ftime"</span>: <span class="string">"2016-06-30 03:17:28"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="string">"time"</span>: <span class="string">"2016-06-29 16:35:02"</span>,</div><div class="line">            <span class="string">"location"</span>: <span class="string">""</span>,</div><div class="line">            <span class="string">"context"</span>: <span class="string">"由 浙江杭州中转部 发往 安徽黄山公司"</span>,</div><div class="line">            <span class="string">"ftime"</span>: <span class="string">"2016-06-29 16:35:02"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="string">"time"</span>: <span class="string">"2016-06-29 16:22:00"</span>,</div><div class="line">            <span class="string">"location"</span>: <span class="string">""</span>,</div><div class="line">            <span class="string">"context"</span>: <span class="string">"由 湖北武汉航空部 发往 湖北武汉武隆分部"</span>,</div><div class="line">            <span class="string">"ftime"</span>: <span class="string">"2016-06-29 16:22:00"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="string">"time"</span>: <span class="string">"2016-06-28 23:09:29"</span>,</div><div class="line">            <span class="string">"location"</span>: <span class="string">""</span>,</div><div class="line">            <span class="string">"context"</span>: <span class="string">"由 湖北武汉航空部 发往 浙江杭州中转部"</span>,</div><div class="line">            <span class="string">"ftime"</span>: <span class="string">"2016-06-28 23:09:29"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="string">"time"</span>: <span class="string">"2016-06-28 20:03:09"</span>,</div><div class="line">            <span class="string">"location"</span>: <span class="string">""</span>,</div><div class="line">            <span class="string">"context"</span>: <span class="string">"由 湖北武汉航空部 发往 浙江杭州中转部"</span>,</div><div class="line">            <span class="string">"ftime"</span>: <span class="string">"2016-06-28 20:03:09"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="string">"time"</span>: <span class="string">"2016-06-28 20:03:09"</span>,</div><div class="line">            <span class="string">"location"</span>: <span class="string">""</span>,</div><div class="line">            <span class="string">"context"</span>: <span class="string">"湖北武汉航空部 正在进行 装袋 扫描"</span>,</div><div class="line">            <span class="string">"ftime"</span>: <span class="string">"2016-06-28 20:03:09"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="string">"time"</span>: <span class="string">"2016-06-28 20:02:52"</span>,</div><div class="line">            <span class="string">"location"</span>: <span class="string">""</span>,</div><div class="line">            <span class="string">"context"</span>: <span class="string">"由 湖北武汉航空部 发往 浙江杭州中转部"</span>,</div><div class="line">            <span class="string">"ftime"</span>: <span class="string">"2016-06-28 20:02:52"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="string">"time"</span>: <span class="string">"2016-06-28 19:58:24"</span>,</div><div class="line">            <span class="string">"location"</span>: <span class="string">""</span>,</div><div class="line">            <span class="string">"context"</span>: <span class="string">"快件已到达 湖北武汉航空部"</span>,</div><div class="line">            <span class="string">"ftime"</span>: <span class="string">"2016-06-28 19:58:24"</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="string">"time"</span>: <span class="string">"2016-06-28 17:12:28"</span>,</div><div class="line">            <span class="string">"location"</span>: <span class="string">""</span>,</div><div class="line">            <span class="string">"context"</span>: <span class="string">"湖北武汉公司(027-83225888) 的收件员 汉口吴燕飞 已收件"</span>,</div><div class="line">            <span class="string">"ftime"</span>: <span class="string">"2016-06-28 17:12:28"</span></div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    <span class="string">"state"</span>: <span class="string">"0"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>异常返回：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"status"</span>: <span class="string">"403"</span>,</div><div class="line">  <span class="string">"message"</span>: <span class="string">"快递公司参数异常：单号格式错误"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/20/mail-verifier-design/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/20/mail-verifier-design/" itemprop="url">邮箱有效性验证模块的设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-20T10:17:42+08:00">
                2016-07-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="邮箱验证设计"><a href="#邮箱验证设计" class="headerlink" title="邮箱验证设计"></a>邮箱验证设计</h1><p>在应用开发中，邮件验证是一个常用的功能，它要求用户对其邮箱地址的有效性进行验证，一般流程为：</p>
<ul>
<li>用户在注册时填写邮箱地址</li>
<li>在注册成功时，应用自动发送一封确认邮箱有效性的邮件，在邮件中附上效验地址 </li>
<li>用户访问效验地址以验证邮箱有效性</li>
</ul>
<h2 id="功能需求"><a href="#功能需求" class="headerlink" title="功能需求"></a>功能需求</h2><ul>
<li>用户注册时对用户的邮箱地址发送效验邮件</li>
<li>需要对用户和邮箱以及校验码进行映射以验证用户邮箱的有效性</li>
</ul>
<h2 id="功能分析"><a href="#功能分析" class="headerlink" title="功能分析"></a>功能分析</h2><ul>
<li>应该具有邮件发送的功能</li>
<li>效验的邮件应该具有时效性</li>
<li>需要一张邮箱效验的表，用于存储用户和邮箱及校验码</li>
</ul>
<h2 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h2><figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">`mail_verifies`: </div><div class="line">  -<span class="ruby"> integer <span class="string">`id`</span> increments</span></div><div class="line"><span class="ruby">  - integer <span class="string">`user_id`</span></span></div><div class="line"><span class="ruby">  - string <span class="string">'mail'</span></span></div><div class="line"><span class="ruby">  - string <span class="string">`code`</span></span></div><div class="line"><span class="ruby">  - boolean <span class="string">`expired`</span> <span class="symbol">default:</span><span class="literal">false</span></span></div><div class="line"><span class="ruby">  - datetime <span class="string">`created_at`</span></span></div><div class="line"><span class="ruby">  - datetime <span class="string">`updated_at`</span></span></div></pre></td></tr></table></figure>
<h2 id="职责分析"><a href="#职责分析" class="headerlink" title="职责分析"></a>职责分析</h2><p>我们分析整个流程应该不难发现，整个流程突出几个职责：</p>
<ul>
<li>唯一效验码的生成</li>
<li>发邮件</li>
<li>对效验码进行验证</li>
</ul>
<p>我们将生成校验码和对校验码进行验证的职责封装到 MailVerifier 类中，发邮件就直接使用 Laravel 中的邮件服务</p>
<h2 id="编码设计"><a href="#编码设计" class="headerlink" title="编码设计"></a>编码设计</h2><p>我们先设计用于效验邮件的路由：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'mail-verification/&#123;userId&#125;/&#123;code&#125;'</span>, <span class="string">'MailController@verify'</span>);</div></pre></td></tr></table></figure>
<p>我们需要在用户对象中设计一个发送验证邮件的方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">Class</span> <span class="title">User</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendEmailVerification</span> <span class="params">(Mailer $mailer, MailVerifier $mailVerifier)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;eamil_verified) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $data = [</div><div class="line">    <span class="string">'user'</span> =&gt; <span class="keyword">$this</span>, </div><div class="line">    <span class="string">'code'</span> =&gt; $mailVerifier-&gt;create(<span class="keyword">$this</span>-&gt;id, <span class="keyword">$this</span>-&gt;email)-&gt;code</div><div class="line">    ];</div><div class="line">    $mailer-&gt;send(<span class="string">'mail-verifier'</span>, $data, <span class="function"><span class="keyword">function</span> <span class="params">($message)</span> </span>&#123;</div><div class="line">      <span class="comment">// ...</span></div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setMailVerified</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;email_verified = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">$this</span>-&gt;save();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们需要一个验证器类来进行校验码的生成和对效验码进行验证:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MailVerifier</span> </span>&#123;</div><div class="line">  <span class="keyword">protected</span> $mailVerify;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(MailVerify $mailVerify)</span> </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;$mailVerify = $mailVerify </div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span> <span class="params">($userId, $mail)</span> </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;mailVerify-&gt;expiredAll($userId);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;mailVerify-&gt;create([</div><div class="line">            <span class="string">'user_id'</span> =&gt; $userId,</div><div class="line">            <span class="string">'mail'</span> =&gt; $mail,</div><div class="line">            <span class="string">'code'</span> =&gt; <span class="keyword">$this</span>-&gt;generateCode($userId)</div><div class="line">          ]);</div><div class="line">  &#125; </div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">generateCode</span><span class="params">($userId)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> md5(time() . $userId . str_pod(rand(<span class="number">0</span>, <span class="number">999999</span>), <span class="number">6</span>, <span class="string">'0'</span>));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify</span> <span class="params">($mail, $code)</span> </span>&#123;</div><div class="line">    $finder = <span class="keyword">$this</span>-&gt;mailVerify-&gt;where([</div><div class="line">      <span class="string">'mail'</span> =&gt; $mail,</div><div class="line">      <span class="string">'code'</span> =&gt; $code,</div><div class="line">      <span class="string">'expired'</span> =&gt; <span class="keyword">false</span></div><div class="line">      ])-&gt;where(<span class="string">'created_at'</span>, <span class="string">'&gt;'</span>, Carbon::now()-&gt;subMinute(<span class="number">10</span>))-&gt;first();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($finder) &#123;</div><div class="line">      $finder-&gt;setExpired();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> !!$finder;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着就是控制器了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MailController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">protected</span> $mailVerifier;</div><div class="line">  <span class="keyword">protected</span> $user;</div><div class="line"></div><div class="line">  pbulic <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(User $user, MailVerifier $mailVerifier)</span> </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;user = $user;</div><div class="line">    <span class="keyword">$this</span>-&gt;mailVerifier = $mailVerifier; </div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify</span> <span class="params">($userId, $code)</span> </span>&#123;</div><div class="line">    $user = <span class="keyword">$this</span>-&gt;uesr-&gt;find($userId);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!$user) &#123;</div><div class="line">      <span class="keyword">return</span> redirect(<span class="string">'404'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $result = <span class="keyword">$this</span>-&gt;mailVerifier-&gt;verify($user-&gt;eamil, $code);</div><div class="line">    <span class="keyword">if</span> ($result) &#123;</div><div class="line">      $user-&gt;setMailVerified();</div><div class="line">      <span class="keyword">return</span> view(<span class="string">'mail-verified'</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> redirect(<span class="string">'404'</span>);</div><div class="line"></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/19/analyze-laravel-source-code-single-reponsibility-principle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/19/analyze-laravel-source-code-single-reponsibility-principle/" itemprop="url">Laravel 源码分析系列 —— 单一职责</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-19T13:29:22+08:00">
                2016-07-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="面向对象设计原则"><a href="#面向对象设计原则" class="headerlink" title="面向对象设计原则"></a>面向对象设计原则</h1><p>在正式分析 Laravel 源码之前，我们应该先来回顾一下面向对象的基本设计原则，这个由 罗伯特·C·马丁 所提及的 SOLID 原则可以帮助我们很好的应对代码的扩展与维护，这也是 Laravel 源码如此优雅的关键。</p>
<p>你一定听说过“代码的坏味道”，没错，使用这些设计原则，你可以很好的扫清代码中的坏味道，那么接下来，我们就来聊一聊这五个设计原则：</p>
<ul>
<li>Single Reponsibility Principle 单一职责原则</li>
<li>Open Closed Principle 开放封闭原则</li>
<li>Liskov Substitution Principle 里氏替换原则</li>
<li>Interface Segregation Principle 接口隔离原则</li>
<li>Dependency Invertion Principle 依赖反转原则</li>
</ul>
<h2 id="单一职责"><a href="#单一职责" class="headerlink" title="单一职责"></a>单一职责</h2><blockquote>
<p>它规定一个类，只能有一个引起变化的原因。</p>
</blockquote>
<p>你可能不太理解这个变化具体指的是什么，我们可以理解为这个变化就指这个类的职责，它的意思就是一个类，应该只有一个职责，只有这个职责变化时才能引起它的变化，也就是只有职能改变的时候，你才能修改这个类。</p>
<p>一个类的耦合度，是判断一个类设计好坏的标准。如果说一个类它的职责高度集中，那么我们就说它是一个高内聚的类，而如果一个类包含了太多的职责，那么它就是一个具有耦合性的类。通常我们希望一个类它是高内聚低耦合的。</p>
<blockquote>
<p>如果一个类承担的职责过多，就等于把这些职责耦合在一起了。一个职责的变化可能会削弱或者抑制这个类完成其他职责的能力。这种耦合会导致脆弱的设计，当发生变化时，设计会遭受到意想不到的破坏。而如果想要避免这种现象的发生，就要尽可能的遵守单一职责原则。此原则的核心就是解耦和增强内聚性。</p>
</blockquote>
<p>那么为什么要遵循单一职责呢？</p>
<p>我们都知道，软件开发的过程中大多数时候都是类与类之间的交互，那么在理想情况下，我们一定会希望当一个类改变时，不会引起其它类的连锁变化。如果说类 A 具有职能 A，类 B 具有职能 B，那么理想情况下，如果类 A 根据需求的变化而进行了修改，类 B 是不应该也同时被修改的。如果说 A 修改了，我们也必须要修改 B，那么说明这个类 B 肯定具有太多的职责，而导致它违背了单一职责原则。</p>
<p>所以你应该能看的出，单一职责其实是要求一个类的功能边界和它的职责应该是非常狭窄和紧凑的，它应该只做它该做的事情，并且它不应该被它所依赖的类的任何变化所影响。如果它的依赖变化时它也必须要跟着变化，那说明它知道的太多了。</p>
<blockquote>
<p><strong>你知道的太多了</strong></p>
<p>一只猫拿着把枪追杀一只老鼠<br>老鼠求它别杀它<br>猫说 可以 但你要回答我一个问题 1加1等于几<br>等于二 老鼠说<br>猫一枪把老鼠打死了<br>老鼠垂死挣扎问道 我答对了为什么还要杀我<br>猫回答道 你知道的太多了</p>
</blockquote>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>为了更好的理解这个原则，我们来举个例子看一下，考察一下下面的类：</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/18/analyze-laravel-source-code-the-point/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/18/analyze-laravel-source-code-the-point/" itemprop="url">Laravel 源码分析系列 —— 单一入口</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-18T11:31:11+08:00">
                2016-07-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="单一入口"><a href="#单一入口" class="headerlink" title="单一入口"></a>单一入口</h1><blockquote>
<p>单一入口的概念其实很好理解，我们可以把整个应用想象为一个黑色的盒子，整个盒子只有一个入口，这个入口由一个文件把守，它要求所有的请求必须通过这个入口文件检验才能进入。</p>
</blockquote>
<p>在聊单一入口的应用之前，我们先来看一看传统应用的多入口模式，这里我们参考一下 ecshop 的网站根目录的部分目录结构：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">- article.php 文章内容          </div><div class="line">- article_cat.php文章分类     </div><div class="line">- auction.php 拍卖前台文件    </div><div class="line">- brand.php 品牌列表     </div><div class="line">- captcha.php 生成验证码     </div><div class="line">- catalog.php 列出所以分类及品牌   </div><div class="line">- category.php 商品分类 </div><div class="line">- comment.php 提交用户评论          </div><div class="line">- compare.php 商品比较程序      </div><div class="line">- cycle_image.php   轮播图片程序        </div><div class="line">- feed.php RSS Feed 生成程序   </div><div class="line">- flow.php 购物流程      </div><div class="line">- gallery.php 商品相册          </div><div class="line">- goods.php 商品详情     </div><div class="line">- goods_script.php 生成商品列表          </div><div class="line">- group_buy.php 团购商品前台文件    </div><div class="line">- index.php 首页文件         </div><div class="line">- myship.php 支付配送DEMO       </div><div class="line">- pick_out.php 选购中心  </div><div class="line">- receive.php 处理收回确认的页面</div><div class="line">- index.php 首页文件</div></pre></td></tr></table></figure>
<p>你可以看到上述目录就是网站的根目录，这个目录下存放着相应页面的响应代码，如果我们想要访问首页，我们就在网址中访问 <code>index.php</code>，如果我们想要访问商品页，那么我们就需要访问 <code>goods.php</code> 文件，这就是传统应用的多入口模式，我们可以通过不同的文件入口来得到应用响应。</p>
<p>谈到这里，你应该意识到了 <code>网站的根目录</code> 和 <code>应用的根目录</code> 是两个不同的定义，我们还是回到 Laravel 中吧，Laravel 应用的根目录下包含了多个目录，其目录结构如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">- app</div><div class="line">- bootstrap</div><div class="line">- config</div><div class="line">- database</div><div class="line">- <span class="keyword">public</span></div><div class="line">  - index.php</div><div class="line">- resources</div><div class="line">- storage</div><div class="line">- tests</div><div class="line">- vendor</div></pre></td></tr></table></figure>
<p>这其中 <code>public</code> 目录才是网站的根目录，<code>index.php</code> 就是整个应用的守卫，它需要视察所有进入应用的请求。</p>
<h2 id="单一入口的优势"><a href="#单一入口的优势" class="headerlink" title="单一入口的优势"></a>单一入口的优势</h2><p>聊到这里，你一定会有所疑惑，Laravel 为何要采用单一入口的模式，这种单一入口有什么优势？ok，别着急，我们将会一一谈起。</p>
<p>如果说这种单一入口目录结构的优势，那么我们不得不提及应用核心代码与静态资源的分离，你看，使用这种方式，我们可以非常完美的将服务端核心代码与静态资源完全分离开来，这就意味着如果你想要访问 <code>public</code> 目录外的资源都必须要经过守卫的审查。这就为统一的安全性提供了便利。</p>
<p>我曾经见到过这么一个有趣的情况，某人在 eshop 程序的配置文件目录下拷贝了一份配置并重命名为 <code>config.php.bak</code>，原意可能是为了防止自己忘记数据库的密码，但是这就意味着任何用户都可以通过浏览器访问到这个文件了，因为对于 Nginx 或者 Apache 来说这些 HTTP 请求只要路径正确，如果不是 PHP 程序的话，他们就会以静态资源的方式进行输出，当然，这只是个个例，但却足以让你明白动静分离的好处了。</p>
<p>那么我们现在穿透到黑盒的内部看一下，如果说黑盒是一个工厂，守卫把一个请求交由工厂来处理，那么它一定需要通过一定的流程来产出一个响应。那么它的流程一般是这样的：</p>
<ul>
<li>初始化应用所需的模块资源</li>
<li>根据不同的请求类型将其导向相应的业务</li>
<li>业务处理</li>
<li>返回响应</li>
</ul>
<p>那么我们应该可以看出，其实单一入口最大的优势就是规范了开发流程。</p>
<p>我们可能很难想象规范化的流程能带来多大的开发效率上的提升，但是它确实能最大化的提升效率。还记得 <code>DRY（Don&#39;t Repeat Yourself)</code> 原则吗？</p>
<p>基于传统的多入口应用中，如果我们想要保存一个用户的认证状态，那么我们一定会使用服务端的 session 功能。所以你会在这些应用的每个牵涉到用户相关的入口页面的 PHP 文件中发现被引入了相关的 session 实现。这样，每次我们增加一个页面就要手动的引入一次，这完全背离的 DRY 原则。</p>
<p>而在单入口应用中，如果抽象度非常高的话，那么我们完全可以把 session 实现抽象为其中的一个中间件，这样，我们也完全可以在请求被守卫进行分发时由程序自动的判断是否需要启用 session 功能，这完全可以是自动化的。</p>
<p>再比如说，如果我们想对应用的请求启用日志功能，那么基于传统的多入口应用，我们需要在每一个入口中都加入日志功能，才能达到记录所有日志的效果，而在单入口应用中我们只需要添加一个日志中间件就可以让它来记录所有的日志了。</p>
<p>你能想象的到吗，对于多入口的应用每当我增加一个入口页面时，我一定不能忘记引入基层的组件库。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Dearmadman</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">100</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dearmadman</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
