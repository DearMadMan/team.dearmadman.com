<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Team.dearmadman.com">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Team.dearmadman.com">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Team.dearmadman.com">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>Team.dearmadman.com</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Team.dearmadman.com</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do it.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/14/using-supervisor-to-manage-process/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/14/using-supervisor-to-manage-process/" itemprop="url">使用 Supervisor 进行进程管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-14T10:34:53+08:00">
                2016-07-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="使用-Supervisor-进行进程管理"><a href="#使用-Supervisor-进行进程管理" class="headerlink" title="使用 Supervisor 进行进程管理"></a>使用 Supervisor 进行进程管理</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote>
<p><strong>Supervisor</strong></p>
<p>Supervisor 是可以在类 UNIX 系统中进行管理和监控各种进程的小型系统。它自带了客户端和服务端工具。它可以通过用户所定义的配置文件来管理和监控单个或多个进程，并且它可以根据配置来对异常崩溃的进程进行重启操作。</p>
</blockquote>
<p>我们可以使用 Supervisor 来轻松的管理和维护 nginx redis node 的进程，当这些进程因为某些原因出现异常而崩溃时，Supervisor 会自动的帮助它重新启动。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>如果你安装了 Python 的 <a href="http://peak.telecommunity.com/DevCenter/EasyInstall#installation-instructions" target="_blank" rel="external">setuptools</a> 模块，那么你就可以使用 <code>easy_install</code> 来进行安装，这是首选的安装方式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">easy_install supervisor</div></pre></td></tr></table></figure>
<p>或者你也可以通过 <code>pip</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install supervisor</div></pre></td></tr></table></figure>
<h2 id="生成配置文件"><a href="#生成配置文件" class="headerlink" title="生成配置文件"></a>生成配置文件</h2><p>当你安装完成 Supervisor 之后，你就可以使用 <code>echo_supervisord_conf</code> 命令来输出一个配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo_supervisord_conf &gt; /etc/supervisord.conf</div></pre></td></tr></table></figure>
<p>当然你可以将配置文件生成到任意位置，但是你需要在启动时使用 <code>-c</code> 选项来指定配置文件的路径。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>配置选项:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div></pre></td><td class="code"><pre><div class="line">; Sample supervisor config file.</div><div class="line">;</div><div class="line">; For more information on the config file, please see:</div><div class="line">; http://supervisord.org/configuration.html</div><div class="line">;</div><div class="line">; Notes:</div><div class="line">;  - Shell expansion (<span class="string">"~"</span> or <span class="string">"<span class="variable">$HOME</span>"</span>) is not supported.  Environment</div><div class="line">;    variables can be expanded using this syntax: <span class="string">"%(ENV_HOME)s"</span>.</div><div class="line">;  - Comments must have a leading space: <span class="string">"a=b ;comment"</span> not <span class="string">"a=b;comment"</span>.</div><div class="line"></div><div class="line">[unix_http_server]</div><div class="line">file=/tmp/supervisor.sock   ; (the path to the socket file)</div><div class="line">;chmod=0700                 ; socket file mode (default 0700)</div><div class="line">;chown=nobody:nogroup       ; socket file uid:gid owner </div><div class="line">;username=user              ; (default is no username (open server)) </div><div class="line">;password=123               ; (default is no password (open server))</div><div class="line"></div><div class="line">;[inet_http_server]         ; inet (TCP) server disabled by default</div><div class="line">;port=127.0.0.1:9001        ; (ip_address:port specifier, *:port <span class="keyword">for</span> all iface)</div><div class="line">;username=user              ; (default is no username (open server))</div><div class="line">;password=123               ; (default is no password (open server))</div><div class="line"></div><div class="line">[supervisord]</div><div class="line">logfile=/tmp/supervisord.log ; (main <span class="built_in">log</span> file;default <span class="variable">$CWD</span>/supervisord.log)</div><div class="line">logfile_maxbytes=50MB        ; (max main logfile bytes b4 rotation;default 50MB)</div><div class="line">logfile_backups=10           ; (num of main logfile rotation backups;default 10)</div><div class="line">loglevel=info                ; (<span class="built_in">log</span> level;default info; others: debug,warn,trace)</div><div class="line">pidfile=/tmp/supervisord.pid ; (supervisord pidfile;default supervisord.pid)</div><div class="line">nodaemon=<span class="literal">false</span>               ; (start <span class="keyword">in</span> foreground <span class="keyword">if</span> <span class="literal">true</span>;default <span class="literal">false</span>)</div><div class="line">minfds=1024                  ; (min. avail startup file descriptors;default 1024)</div><div class="line">minprocs=200                 ; (min. avail process descriptors;default 200)</div><div class="line">;<span class="built_in">umask</span>=022                   ; (process file creation <span class="built_in">umask</span>;default 022)</div><div class="line">;user=chrism                 ; (default is current user, required <span class="keyword">if</span> root)</div><div class="line">;identifier=supervisor       ; (supervisord identifier, default is <span class="string">'supervisor'</span>)</div><div class="line">;directory=/tmp              ; (default is not to <span class="built_in">cd</span> during start)</div><div class="line">;nocleanup=<span class="literal">true</span>              ; (don<span class="string">'t clean up tempfiles at start;default false)</span></div><div class="line"><span class="string">;childlogdir=/tmp            ; ('</span>AUTO<span class="string">' child log dir, default $TEMP)</span></div><div class="line"><span class="string">;environment=KEY="value"     ; (key value pairs to add to environment)</span></div><div class="line"><span class="string">;strip_ansi=false            ; (strip ansi escape codes in logs; def. false)</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">; the below section must remain in the config file for RPC</span></div><div class="line"><span class="string">; (supervisorctl/web interface) to work, additional interfaces may be</span></div><div class="line"><span class="string">; added by defining them in separate rpcinterface: sections</span></div><div class="line"><span class="string">[rpcinterface:supervisor]</span></div><div class="line"><span class="string">supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">[supervisorctl]</span></div><div class="line"><span class="string">serverurl=unix:///tmp/supervisor.sock ; use a unix:// URL  for a unix socket</span></div><div class="line"><span class="string">;serverurl=http://127.0.0.1:9001 ; use an http:// url to specify an inet socket</span></div><div class="line"><span class="string">;username=chris              ; should be same as http_username if set</span></div><div class="line"><span class="string">;password=123                ; should be same as http_password if set</span></div><div class="line"><span class="string">;prompt=mysupervisor         ; cmd line prompt (default "supervisor")</span></div><div class="line"><span class="string">;history_file=~/.sc_history  ; use readline history if available</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">; The below sample program section shows all possible program subsection values,</span></div><div class="line"><span class="string">; create one or more '</span>real<span class="string">' program: sections to be able to control them under</span></div><div class="line"><span class="string">; supervisor.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">;[program:theprogramname]</span></div><div class="line"><span class="string">;command=/bin/cat              ; the program (relative uses PATH, can take args)</span></div><div class="line"><span class="string">;process_name=%(program_name)s ; process_name expr (default %(program_name)s)</span></div><div class="line"><span class="string">;numprocs=1                    ; number of processes copies to start (def 1)</span></div><div class="line"><span class="string">;directory=/tmp                ; directory to cwd to before exec (def no cwd)</span></div><div class="line"><span class="string">;umask=022                     ; umask for process (default None)</span></div><div class="line"><span class="string">;priority=999                  ; the relative start priority (default 999)</span></div><div class="line"><span class="string">;autostart=true                ; start at supervisord start (default: true)</span></div><div class="line"><span class="string">;startsecs=1                   ; # of secs prog must stay up to be running (def. 1)</span></div><div class="line"><span class="string">;startretries=3                ; max # of serial start failures when starting (default 3)</span></div><div class="line"><span class="string">;autorestart=unexpected        ; when to restart if exited after running (def: unexpected)</span></div><div class="line"><span class="string">;exitcodes=0,2                 ; '</span>expected<span class="string">' exit codes used with autorestart (default 0,2)</span></div><div class="line"><span class="string">;stopsignal=QUIT               ; signal used to kill process (default TERM)</span></div><div class="line"><span class="string">;stopwaitsecs=10               ; max num secs to wait b4 SIGKILL (default 10)</span></div><div class="line"><span class="string">;stopasgroup=false             ; send stop signal to the UNIX process group (default false)</span></div><div class="line"><span class="string">;killasgroup=false             ; SIGKILL the UNIX process group (def false)</span></div><div class="line"><span class="string">;user=chrism                   ; setuid to this UNIX account to run the program</span></div><div class="line"><span class="string">;redirect_stderr=true          ; redirect proc stderr to stdout (default false)</span></div><div class="line"><span class="string">;stdout_logfile=/a/path        ; stdout log path, NONE for none; default AUTO</span></div><div class="line"><span class="string">;stdout_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)</span></div><div class="line"><span class="string">;stdout_logfile_backups=10     ; # of stdout logfile backups (default 10)</span></div><div class="line"><span class="string">;stdout_capture_maxbytes=1MB   ; number of bytes in '</span>capturemode<span class="string">' (default 0)</span></div><div class="line"><span class="string">;stdout_events_enabled=false   ; emit events on stdout writes (default false)</span></div><div class="line"><span class="string">;stderr_logfile=/a/path        ; stderr log path, NONE for none; default AUTO</span></div><div class="line"><span class="string">;stderr_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)</span></div><div class="line"><span class="string">;stderr_logfile_backups=10     ; # of stderr logfile backups (default 10)</span></div><div class="line"><span class="string">;stderr_capture_maxbytes=1MB   ; number of bytes in '</span>capturemode<span class="string">' (default 0)</span></div><div class="line"><span class="string">;stderr_events_enabled=false   ; emit events on stderr writes (default false)</span></div><div class="line"><span class="string">;environment=A="1",B="2"       ; process environment additions (def no adds)</span></div><div class="line"><span class="string">;serverurl=AUTO                ; override serverurl computation (childutils)</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">; The below sample eventlistener section shows all possible</span></div><div class="line"><span class="string">; eventlistener subsection values, create one or more '</span>real<span class="string">'</span></div><div class="line"><span class="string">; eventlistener: sections to be able to handle event notifications</span></div><div class="line"><span class="string">; sent by supervisor.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">;[eventlistener:theeventlistenername]</span></div><div class="line"><span class="string">;command=/bin/eventlistener    ; the program (relative uses PATH, can take args)</span></div><div class="line"><span class="string">;process_name=%(program_name)s ; process_name expr (default %(program_name)s)</span></div><div class="line"><span class="string">;numprocs=1                    ; number of processes copies to start (def 1)</span></div><div class="line"><span class="string">;events=EVENT                  ; event notif. types to subscribe to (req'</span>d)</div><div class="line">;buffer_size=10                ; event buffer queue size (default 10)</div><div class="line">;directory=/tmp                ; directory to cwd to before <span class="built_in">exec</span> (def no cwd)</div><div class="line">;<span class="built_in">umask</span>=022                     ; <span class="built_in">umask</span> <span class="keyword">for</span> process (default None)</div><div class="line">;priority=-1                   ; the relative start priority (default -1)</div><div class="line">;autostart=<span class="literal">true</span>                ; start at supervisord start (default: <span class="literal">true</span>)</div><div class="line">;startsecs=1                   ; <span class="comment"># of secs prog must stay up to be running (def. 1)</span></div><div class="line">;startretries=3                ; max <span class="comment"># of serial start failures when starting (default 3)</span></div><div class="line">;autorestart=unexpected        ; autorestart <span class="keyword">if</span> exited after running (def: unexpected)</div><div class="line">;exitcodes=0,2                 ; <span class="string">'expected'</span> <span class="built_in">exit</span> codes used with autorestart (default 0,2)</div><div class="line">;stopsignal=QUIT               ; signal used to <span class="built_in">kill</span> process (default TERM)</div><div class="line">;stopwaitsecs=10               ; max num secs to <span class="built_in">wait</span> b4 SIGKILL (default 10)</div><div class="line">;stopasgroup=<span class="literal">false</span>             ; send stop signal to the UNIX process group (default <span class="literal">false</span>)</div><div class="line">;killasgroup=<span class="literal">false</span>             ; SIGKILL the UNIX process group (def <span class="literal">false</span>)</div><div class="line">;user=chrism                   ; setuid to this UNIX account to run the program</div><div class="line">;redirect_stderr=<span class="literal">false</span>         ; redirect_stderr=<span class="literal">true</span> is not allowed <span class="keyword">for</span> eventlisteners</div><div class="line">;stdout_logfile=/a/path        ; stdout <span class="built_in">log</span> path, NONE <span class="keyword">for</span> none; default AUTO</div><div class="line">;stdout_logfile_maxbytes=1MB   ; max <span class="comment"># logfile bytes b4 rotation (default 50MB)</span></div><div class="line">;stdout_logfile_backups=10     ; <span class="comment"># of stdout logfile backups (default 10)</span></div><div class="line">;stdout_events_enabled=<span class="literal">false</span>   ; emit events on stdout writes (default <span class="literal">false</span>)</div><div class="line">;stderr_logfile=/a/path        ; stderr <span class="built_in">log</span> path, NONE <span class="keyword">for</span> none; default AUTO</div><div class="line">;stderr_logfile_maxbytes=1MB   ; max <span class="comment"># logfile bytes b4 rotation (default 50MB)</span></div><div class="line">;stderr_logfile_backups=10     ; <span class="comment"># of stderr logfile backups (default 10)</span></div><div class="line">;stderr_events_enabled=<span class="literal">false</span>   ; emit events on stderr writes (default <span class="literal">false</span>)</div><div class="line">;environment=A=<span class="string">"1"</span>,B=<span class="string">"2"</span>       ; process environment additions</div><div class="line">;serverurl=AUTO                ; override serverurl computation (childutils)</div><div class="line"></div><div class="line">; The below sample group section shows all possible group values,</div><div class="line">; create one or more <span class="string">'real'</span> group: sections to create <span class="string">"heterogeneous"</span></div><div class="line">; process groups.</div><div class="line"></div><div class="line">;[group:thegroupname]</div><div class="line">;programs=progname1,progname2  ; each refers to <span class="string">'x'</span> <span class="keyword">in</span> [program:x] definitions</div><div class="line">;priority=999                  ; the relative start priority (default 999)</div><div class="line"></div><div class="line">; The [include] section can just contain the <span class="string">"files"</span> setting.  This</div><div class="line">; setting can list multiple files (separated by whitespace or</div><div class="line">; newlines).  It can also contain wildcards.  The filenames are</div><div class="line">; interpreted as relative to this file.  Included files *cannot*</div><div class="line">; include files themselves.</div><div class="line"></div><div class="line">;[include]</div><div class="line">;files = relative/directory/*.ini</div></pre></td></tr></table></figure>
<p>我们只需要关注 <code>program</code> 配置项，每个 <code>program</code> 代表了一个要进行管理的进程，我们可以在这里进行进程的相关配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">; * 为必选项</div><div class="line">;[program:theprogramname]</div><div class="line">;<span class="built_in">command</span>=/bin/cat              ; * 要执行的命令路径（可以是相对与 PATH 的路径）也可带参数</div><div class="line">;process_name=%(program_name)s ; 当进程数为 1 时 为 %(program_name)s 当进程数 &gt;1 时 应配置为 %(program_name)s_%(process_num)02d</div><div class="line">;numprocs=1                    ; 进程数量 (默认 1)</div><div class="line">;directory=/tmp                ; 在执行运行前切换到目录 (def no cwd)</div><div class="line">;<span class="built_in">umask</span>=022                     ; 掩码 (default None)</div><div class="line">;priority=999                  ; 优先级，数值越低越先启动而越后关闭 (default 999)</div><div class="line">;autostart=<span class="literal">true</span>                ; 在 supervisord 启动时即启动 (default: <span class="literal">true</span>)</div><div class="line">;startsecs=1                   ; 需要考虑进程启动成功的时间, 当 running 状态超过该值时，表明启动成功 (def. 1)</div><div class="line">;startretries=3                ; 在启动时状态为失败时的最大尝试重启次数 (default 3)</div><div class="line">;autorestart=unexpected        ; 当进程退出时是否应该重启，可选值为 <span class="literal">false</span> <span class="literal">true</span> unexpected ，为 <span class="literal">false</span> 时表示不重启，为 <span class="literal">true</span> 表示重启，为 unexpected 时，如果退出状态码不是 exitcodes 中之一时进行重启 (def: unexpected)</div><div class="line">;exitcodes=0,2                 ; 用来重启的状态码 (default 0,2)</div><div class="line">;stopsignal=QUIT               ; 进程停止信号，当用设定的信号去干掉进程，退出码会被认为是 expected (default TERM)</div><div class="line">;stopwaitsecs=10               ; 这个是当我们向子进程发送 stopsignal 信号后，到系统返回信息给 supervisord，所等待的最大时间。超过这个时间，supervisord会向该子进程发送一个强制 <span class="built_in">kill</span> 的信号。 (default 10)</div><div class="line">;stopasgroup=<span class="literal">false</span>             ; 如果设置为 <span class="literal">true</span> 那么将会终止该进程下的所有子进程 (default <span class="literal">false</span>)</div><div class="line">;killasgroup=<span class="literal">false</span>             ; 当进程关闭时向该进程的子进程发送的是 <span class="built_in">kill</span> 信号 (def <span class="literal">false</span>)</div><div class="line">;user=chrism                   ; 可以管理该 program 的用户</div><div class="line">;redirect_stderr=<span class="literal">true</span>          ; 如果为 <span class="literal">true</span>，那么 stderr 将会被写入 stdout 日志文件中 (default <span class="literal">false</span>)</div><div class="line">;stdout_logfile=/a/path        ; 日志文件路径， NONE <span class="keyword">for</span> none; default AUTO</div><div class="line">;stdout_logfile_maxbytes=1MB   ; 日志文件的最大大小 (default 50MB)</div><div class="line">;stdout_logfile_backups=10     ; 日志文件的最大数量 (default 10)</div><div class="line">;stdout_capture_maxbytes=1MB   ; capture 管道的大小，当值不为 0 时，子进程可以从 stdout 发送信息，而 supervisor 可以根据信息，发送相应的 event (default 0)</div><div class="line">;stdout_events_enabled=<span class="literal">false</span>   ; 当设置为 ture 的时候，当子进程由 stdout 向文件描述符中写日志的时候，将触发 supervisord 发送 PROCESS_LOG_STDOUT 类型的 event (default <span class="literal">false</span>)</div><div class="line">;stderr_logfile=/a/path        ; stderr <span class="built_in">log</span> path, NONE <span class="keyword">for</span> none; default AUTO</div><div class="line">;stderr_logfile_maxbytes=1MB   ; max <span class="comment"># logfile bytes b4 rotation (default 50MB)</span></div><div class="line">;stderr_logfile_backups=10     ; <span class="comment"># of stderr logfile backups (default 10)</span></div><div class="line">;stderr_capture_maxbytes=1MB   ; number of bytes <span class="keyword">in</span> <span class="string">'capturemode'</span> (default 0)</div><div class="line">;stderr_events_enabled=<span class="literal">false</span>   ; emit events on stderr writes (default <span class="literal">false</span>)</div><div class="line">;environment=A=<span class="string">"1"</span>,B=<span class="string">"2"</span>       ; 子进程共享的环境变量 (def no adds)</div><div class="line">;serverurl=AUTO                ; override serverurl computation (childutils)</div></pre></td></tr></table></figure>
<p>常用配置可以像下面一样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[program:node]</div><div class="line"><span class="built_in">command</span>=node server.js</div><div class="line">process_name=%(program_name)s</div><div class="line">numprocs=1</div><div class="line">directory=%(here)s/server</div><div class="line">autostart=<span class="literal">true</span></div><div class="line">autorestart=<span class="literal">true</span></div><div class="line">redirect_stderr=<span class="literal">true</span></div><div class="line">stdout_logfile=%(here)s/node-server.log</div><div class="line">priority=999</div></pre></td></tr></table></figure>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>配置完成之后使用 <code>supervisord</code> 命令来启动服务端监控：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">supervisord -c /etc/supervisord.conf</div></pre></td></tr></table></figure>
<p>如果不指定 <code>-c</code> 选项，那么会使用以下顺序路径进行检索 <code>supervisord.conf</code> 文件</p>
<ul>
<li>$CWD/supervisord.conf</li>
<li>$CWD/etc/supervisord.conf</li>
<li>/etc/supervisord.conf</li>
<li>/etc/supervisor/supervisord.conf</li>
<li>../etc/supervisord.conf</li>
<li>../supervisord.conf</li>
</ul>
<h2 id="使用-supervisorctl-管理"><a href="#使用-supervisorctl-管理" class="headerlink" title="使用 supervisorctl 管理"></a>使用 supervisorctl 管理</h2><p>启动 supervisorctl 时需要指定配置文件路径，否则它将和 supervisord 使用相同的配置文件检索方式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">supervisorctl -c /etc/supervisord.conf</div></pre></td></tr></table></figure>
<p>在 supervisorctl 的 shell 命令中可以使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; status       <span class="comment"># 查询进程状态</span></div><div class="line">&gt; stop node    <span class="comment"># 关闭 [program:node] 的进程</span></div><div class="line">&gt; start node   <span class="comment"># 启动 [program:node] 的进程</span></div><div class="line">&gt; restart node <span class="comment"># 重启 [program:node] 的进程</span></div><div class="line">&gt; stop all     <span class="comment"># 关闭所有进程</span></div><div class="line">&gt; start all    <span class="comment"># 启动所有进程</span></div><div class="line">&gt; reread       <span class="comment"># 重新读取配置文件,读取有更新（增加）的配置文件，不会启动新添加的程序</span></div><div class="line">&gt; update       <span class="comment"># 重启配置文件修改过的程序</span></div></pre></td></tr></table></figure>
<p>除了在 shell 中使用命令，你也可以在命令行工具中直接输入 supervisorctl 命令:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">supervisorctl stop all</div><div class="line">supervisorctl reload</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/10/laravel-from-apprentice-to-artisan-dependency-inversion-principle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/10/laravel-from-apprentice-to-artisan-dependency-inversion-principle/" itemprop="url">从百草园到三味书屋 —— 依赖反转原则</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-10T22:08:00+08:00">
                2016-07-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Dependency-Inversion-Principle-依赖反转原则"><a href="#Dependency-Inversion-Principle-依赖反转原则" class="headerlink" title="Dependency Inversion Principle 依赖反转原则"></a>Dependency Inversion Principle 依赖反转原则</h1><h2 id="Introduction-介绍"><a href="#Introduction-介绍" class="headerlink" title="Introduction 介绍"></a>Introduction 介绍</h2><p>在整个“坚实”原则概述的旅途中，我们到达最后一站了！最后的原则是依赖反转原则，它规定高等级的代码不应该依赖低等级的代码。首先，高等级的代码应该依赖着抽象层，抽象层就像是“中间人”一样，负责连接着高等级和低等级的代码。其次，抽象定义不应该依赖着具体实现，但具体实现应该依赖着抽象定义。如果这些东西让你极度困惑，别担心。接下来我们会将这两方面统统介绍给你。</p>
<blockquote>
<p><strong>Dependency Inversion Principle 依赖反转原则</strong></p>
<p>该原则要求高等级代码不应该依赖低等级代码，抽象定义不应该依赖具体实现。</p>
</blockquote>
<h2 id="In-Active-实践"><a href="#In-Active-实践" class="headerlink" title="In Active 实践"></a>In Active 实践</h2><p>如果你已经读过了本书前面几个章节，你就已经很好掌握了依赖反转原则！为了说明本原则，让我们考虑下面这个类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Authenticator</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(DatabaseConnection $db)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;db = $db;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findUser</span><span class="params">($id)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;db-&gt;exec(<span class="string">'select * from users where id = ?'</span>, <span class="keyword">array</span>($id));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authenticate</span><span class="params">($credentials)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="comment">// Authenticate the user...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可能猜到了，<code>Authenticator</code> 就是用来查找和验证用户的。继续研究它的构造函数。我们发现它使用了类型提示，要求传入一个 <code>DatabaseConnection</code> 对象，所以该验证类和数据库被紧密的联系在一起。而且基础上讲，这个数据库还只能是关系数据库。从而可知，我们的高级代码（<code>Authenticator</code>）直接的依赖着低级代码（<code>DatabaseConnection</code>)。</p>
<p>首先我们来谈谈“高级代码”和“低级代码”。低级代码用于实现基本的操作，比如从磁盘读文件，操作数据库等。高级代码用于封装复杂的逻辑，它们依靠低级代码来达到功能目的，但不能直接和低级代码耦合在一起。取而代之的是高级代码应该依赖着低级代码的顶层抽象，比如接口。不仅如此，低级代码也应当依赖着抽象。所以我们来写个 <code>Authenticator</code> 可以用的接口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UserProviderInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">($id)</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findByUsername</span><span class="params">($username)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来我们将该接口注入到 <code>Authenticator</code> 里面：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Authenticator</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UserProviderInterface $users, HasherInterface $hash)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;hash = $hash;</div><div class="line">    <span class="keyword">$this</span>-&gt;users = $users;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findUser</span><span class="params">($id)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;users-&gt;find($id);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authenticate</span><span class="params">($credentials)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $user = <span class="keyword">$this</span>-&gt;users-&gt;findByUsername($credentials[<span class="string">'username'</span>]);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hash-&gt;make($credentials[<span class="string">'password'</span>]) == $user-&gt;password;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>做了这些小改动后，<code>Authenticator</code> 现在依赖于两个高级抽象：<code>UserProviderInterface</code> 和 <code>HasherInterface</code>。我们可以向 <code>Authenticator</code> 自由的注入这两个接口的任何实现类。比如，如果我们的用户存储在 Redis 里面，我们只需要写一个 <code>RedisUserProvider</code> 来实现 <code>UserProviderInterface</code> 接口即可。<code>Authenticator</code> 不再依赖着具体的低级别的存储操作了。</p>
<p>此外，由于我们的低级别代码实现了 <code>UserProviderInterface</code> 接口，则我们说该低级代码依赖着这个接口。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisUserProvider</span> <span class="keyword">implements</span> <span class="title">UserProviderInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(RedisConnection $redis)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;redis = $redis;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">($id)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;redis-&gt;get(<span class="string">'users:'</span>. $id);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findByUsername</span><span class="params">($username)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $id = <span class="keyword">$this</span>-&gt;redis-&gt;get(<span class="string">'user:id:'</span>. $username);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;find($id);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>Inverted Thinking 反转的思维</strong></p>
<p>贯彻这一原则会反转好多开发者设计应用的方式。不再将高级代码直接和低级代码以“自上而下”的方式耦合在一起，这个原则提出无论高级还是低级代码都要依赖于一个高层次的抽象。</p>
</blockquote>
<p>在我们没有反转 <code>Authenticator</code> 的依赖之前，它除了使用数据库存储系统别无选择。如果我们改变了存储系统，<code>Authenticator</code> 也需要被修改，这就违背了开放封闭原则。我们又一次看到，这些设计原则通常一荣俱荣一损俱损。</p>
<p>通过强制让 <code>Authenticator</code> 依赖着一个存储抽象层，我们就可以使用任何实现了 <code>UserProviderInterface</code> 接口的存储系统，且不用对 <code>Authenticator</code> 本身做任何修改。传统的依赖关系链已经被反转了，代码变的更灵活，更加无惧变化！</p>
<p>完。</p>
<p>译文地址：<a href="http://my.oschina.net/zgldh/blog/389246" target="_blank" rel="external">http://my.oschina.net/zgldh/blog/389246</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/10/laravel-from-apprentice-to-artisan-interface-segregation-principle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/10/laravel-from-apprentice-to-artisan-interface-segregation-principle/" itemprop="url">从百草园到三味书屋 —— 接口隔离原则</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-10T21:37:57+08:00">
                2016-07-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Interface-Segregation-Principle-接口隔离原则"><a href="#Interface-Segregation-Principle-接口隔离原则" class="headerlink" title="Interface Segregation Principle 接口隔离原则"></a>Interface Segregation Principle 接口隔离原则</h1><h2 id="Introduction-介绍"><a href="#Introduction-介绍" class="headerlink" title="Introduction 介绍"></a>Introduction 介绍</h2><p>接口隔离原则规定在实现接口的时候，不能强迫去实现没有用处的方法。你是否曾被迫去实现一些接口里你用不到的方法？如果答案是肯定的，那你可能创建了一个空方法放在那里。被迫去实现用不到的函数，这就是一个违背了接口隔离原则的例子。</p>
<p>在实际操作中，该原则要求接口必须粒度很细，且专注于一个领域。听起来很耳熟？记住，所有五个“坚实”原则都是相关的，也就是说当打破一个原则时，你通常肯定打破了其他的原则。在这里当你违背了接口隔离原则后，肯定也违背了单一职责原则。</p>
<p>“臃肿”的接口，有着很多不是所有的实现类都需要的方法。与其写这样的接口，不如将其拆分成多个小巧的接口，里面的方法都是各自领域所需要的。这样将臃肿接口拆成小巧、功能集中的接口后，我们就可以使用小接口来编码，而不必为我们不需要的功能买单。</p>
<blockquote>
<p><strong>Interface Segregation Principle 接口隔离原则</strong></p>
<p>该原则规定，一个接口的一个实现类，不应该去实现那些自己用不到的方法。如果需要，那就是接口设计有问题，违背了接口隔离原则。</p>
</blockquote>
<h2 id="In-Action-实践"><a href="#In-Action-实践" class="headerlink" title="In Action 实践"></a>In Action 实践</h2><p>为了说明该原则，我们来思考一个关于会话处理的类库。实际上我们将要考察 PHP 自己的 <code>SessionHandlerInterface</code>。下面是该接口定义的方法，他们是从 PHP 5.4 版才开始有的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SessionHandlerInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">destroy</span><span class="params">($sessionId)</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">gc</span><span class="params">($maxLifetime)</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($savePath, $name)</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($sessionId)</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($sessionId, $sessionData)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们知道接口里面都是什么方法了，我们打算用 Memcached 来实现它。Memcached 需要实现这个接口里的所有方法么？不，里面一半的方法对于 Memcached 来说都是不需要实现的！</p>
<p>因为 Memcached 会自动清除存储的过期数据，我们不需要实现 <code>gc</code> 方法。我们也不需要实现 <code>open</code> 和 <code>close</code> 方法。所以我们被迫去写空方法来占着位子。为了解决这个问题，我们来定义一个小巧的专门用来垃圾回收的接口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">GarbageCollectorInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">gc</span><span class="params">($maxLifetime)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们有了一个小巧的接口，功能单一而专注。需要垃圾清理的只用依赖这个接口即可，而不必去依赖整个会话处理。</p>
<p>为了更深入理解该原则，我们用另一个例子来强化理解。想象我们有一个名为 <code>Contact</code> 的 Eloquent 类，定义成这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Contract</span> <span class="keyword">extends</span> <span class="title">Eloquent</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNameAttribute</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;attributes[<span class="string">'name'</span>];</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getEmailAtribute</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;attributes[<span class="string">'email'</span>];</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们再假设我们应用里还有一个叫 <code>PasswordReminder</code> 的类来负责给用户发送密码找回邮件。下面是 <code>PasswordReminder</code> 的定义方式的一种：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PasswordReminder</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">remind</span><span class="params">(Contact $contact, $view)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="comment">// Send password reminder e-mail...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可能注意到了，<code>PasswordReminder</code> 依赖着 <code>Contract</code> 类，也就是依赖着 Eloquent ORM。对于一个密码找回系统来说，依赖着一个特定的 ORM 实在是没必要，也是不可取的。切断对该 ORM 的依赖，我们就可以自由的改变我们后台存储机制或 ORM，同时不会影响到我们的密码找回组件。重申一遍，违背了“坚实”原则的任何一条，就意味着有个类它知道的太多了。</p>
<p>要切断这种依赖，我们来创建一个 <code>RemindableInterface</code> 接口。事实上 Laravel 已经有了这个接口，并且默认由 <code>User</code> 模型实现了该接口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">RemindableInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getReminderEmail</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一旦接口定义好了，我们就可以在模型上实现它：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Contact</span> <span class="keyword">extends</span> <span class="title">Eloquent</span> <span class="keyword">implements</span> <span class="title">RemindableInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getReminderEmail</span><span class="params">()</span> </span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;email;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终我们可以在 <code>passwordReminder</code> 里面依赖这样一个小巧且专注的接口了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PasswordReminder</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">remind</span><span class="params">(RemindableInterface $remindable, $view)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="comment">// Send password reminder e-mail...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过这小小的改动，我们已经移除了密码找回组件里不必要的依赖，并且使它足够灵活能使任何实现了 <code>RemindableInterface</code> 的类或 ORM。这其实正是 Laravel 的密码找回组件如何保持与数据库 ORM 无关的秘诀！</p>
<blockquote>
<p><strong>Knowledge Is Power 知识就是力量</strong></p>
<p>我们再次发现了一个使类知道太多东西的陷阱。通过小心留意是否让一个类知道了太多，我们就可以遵守所有的“坚实”原则。</p>
</blockquote>
<p>译文地址：<a href="http://my.oschina.net/zgldh/blog/389246" target="_blank" rel="external">http://my.oschina.net/zgldh/blog/389246</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/10/laravel-from-apprentice-to-artisan-liskov-substitution-principle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/10/laravel-from-apprentice-to-artisan-liskov-substitution-principle/" itemprop="url">从百草园到三味书屋 —— 里氏替换原则</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-10T21:08:22+08:00">
                2016-07-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Introduction-介绍"><a href="#Introduction-介绍" class="headerlink" title="Introduction 介绍"></a>Introduction 介绍</h1><p>别担心，里氏替换原则读起来吓人学起来简单。该原则要求：一个抽象的任意一个实现，可以被用来任何需要该抽象的地方。读起来绕口，用普通人的话来解释一下。该原则规定：如果一个类使用了一个接口的一个实现类，那么该接口的任何其他实现类也可以被这个类直接使用，不用做出任何修改。</p>
<blockquote>
<p><strong>Liskov Substitution Principle 里氏替换原则</strong></p>
<p>该原则规定对象应该可以被该对象子类的实例所替换，并且不会影响到程序的正确性。</p>
</blockquote>
<h2 id="In-Action-实践"><a href="#In-Action-实践" class="headerlink" title="In Action 实践"></a>In Action 实践</h2><p>为了说明该原则，我们继续编写上一章节的 <code>OrderProcessor</code>。看下面的方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">(Order $order)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="comment">// Validate order...</span></div><div class="line">  <span class="keyword">$this</span>-&gt;orders-&gt;logOrder($order);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意当我们的 <code>Order</code> 通过了验证，就被 <code>OrderRepositoryInterface</code> 的实现对象存储起来了。假设当我们的业务刚起步时，我们将订单存储在 CSV 格式的文件系统中。我们的 <code>OrderRepositoryInterface</code> 的实现类是 <code>CsvOrderRepository</code>。现在，随着我们订单增多，我们想用一个关系数据库来存储订单。那么我们来看看新的订单资料库类该怎么编写吧：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatabaseOrderRepository</span> <span class="keyword">implements</span> <span class="title">OrderRepositoryInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">protected</span> $connection;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">($username, $password)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;connection = <span class="keyword">new</span> DatabaseConnection($username, $password);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logOrder</span><span class="params">(Order $order)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;connection-&gt;run(<span class="string">'insert into orders values (?, ?)'</span>, <span class="keyword">array</span>($order-&gt;id, $order-&gt;amount));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们来研究如何使用这个实现类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">(Order $order)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="comment">// validate order...</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;repository <span class="keyword">instanceof</span> DatabaseOrderRepository) &#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;repository-&gt;connect(<span class="string">'root'</span>, <span class="string">'password'</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">$this</span>-&gt;repository-&gt;logOrder($order);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意这段代码中，我们必须在资料库外部检查 <code>OrderRepositoryInterface</code> 的实例对象是不是用数据库实现的。如果是的话，则必须先连接数据库。在很小的应用中这可能不算什么问题，但如果 <code>OrderRepositoryInterface</code> 被几十个类调用呢？我们可能就要把这段“启动”代码在每一个调用的地方复制一遍又一遍。这让人非常头疼难以维护，非常容易出错误。一旦我们忘了将所有调用的地方进行同步修改，那程序恐怕就会出问题。</p>
<p>很明显，上面的例子没有遵循里氏替换原则。如果不附加“启动”代码来调用 <code>connect</code> 方法，则这段代码就没法用。好了，我们已经找到问题所在，咱们修好它。下面就是新的 <code>DatabaseOrderRepository</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatabaseOrderRepository</span> <span class="keyword">implements</span> <span class="title">OrderRepositoryInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">protected</span> $connector;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(DatabaseConnector $connector)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;connector = $connector;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;connector-&gt;bootConnection();</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logOrder</span><span class="params">(Order $order)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $connection = <span class="keyword">$this</span>-&gt;connect();</div><div class="line">    $connection-&gt;run(<span class="string">'insert into orders values (?, ?)'</span>, <span class="keyword">array</span>($order-&gt;id, $order-&gt;amount));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在 <code>DatabaseOrderRepository</code> 掌管了数据库连接，我们可以把“启动”代码从 <code>OrderProcessor</code> 移除了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">(Order $order)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="comment">// Validate order...</span></div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;repository-&gt;logOrder($order);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样一改，我们就可以想用 <code>CsvOrderRepository</code> 也行，想用 <code>DatabaseOrderRepository</code> 也行，不用改 <code>OrderProcessor</code> 一行代码。我们的代码终于实现了里氏替换原则！要注意，我们讨论过的许多架构概念都和知识相关。具体讲，知识就是一个类和它所具有的周边领域，比如用来帮助类完成任务的外围代码和依赖。当你要制作一个容错性强大的应用架构时，限制类的知识是一种常用且重要的手段。</p>
<p>还要注意如果不遵守里氏替换原则，那后果可能会影响到我们之前已经讨论过的其他原则。不遵守里氏替换原则，那么开放封闭原则也一定会被打破。因为，如果调用者必须检查实例属于哪一个子类的，那一旦有个新的子类，调用者就得做出改变。（译者注：这就违背了对修改封闭的原则。）</p>
<blockquote>
<p><strong>Watch For Leaks 小心遗漏</strong></p>
<p>你可能注意到这个原则和上一章节提到的“抽象的漏洞”密切相关。我们的数据库资料库的抽象漏洞就是没有遵守里氏替换原则的第一迹象。要留意那些漏洞！</p>
</blockquote>
<p>译文地址：<a href="http://my.oschina.net/zgldh/blog/389246" target="_blank" rel="external">http://my.oschina.net/zgldh/blog/389246</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/10/laravel-from-apprentice-to-artisan-open-closed-principle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/10/laravel-from-apprentice-to-artisan-open-closed-principle/" itemprop="url">从百草堂到三味书屋 —— 开放封闭原则</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-10T20:36:21+08:00">
                2016-07-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Open-Closed-Principle-开放封闭原则"><a href="#Open-Closed-Principle-开放封闭原则" class="headerlink" title="Open Closed Principle 开放封闭原则"></a>Open Closed Principle 开放封闭原则</h1><h2 id="Introduction-介绍"><a href="#Introduction-介绍" class="headerlink" title="Introduction 介绍"></a>Introduction 介绍</h2><p>在一个应用的生命周期里，大部分时间都花在了向现有代码库增加功能，而非一直从零开始写新功能。正像你所想的那样，这会是一个繁琐且令人痛苦的过程。当你修改代码的时候，你可能引入新的程序错误，或者将原来管用的功能搞坏掉。理想情况下，我们应该可以像写全新的代码一样，来快速且简单的修改现有的代码。只要采用开放封闭原则来正确的设计我们的应用程序，那么这是可以做到的！</p>
<blockquote>
<p><strong>Open Closed Principle 开放封闭原则</strong></p>
<p>开放封闭原则规定代码对扩展是开放的，对修改是封闭的。</p>
</blockquote>
<h2 id="In-Action-实践"><a href="#In-Action-实践" class="headerlink" title="In Action 实践"></a>In Action 实践</h2><p>为了演示开放封闭原则，我们来继续编写上一章节的 <code>OrderProcecssor</code>。考虑下面的 <code>process</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$recent = <span class="keyword">$this</span>-&gt;orders-&gt;getRecentOrderCount($order-&gt;account);</div><div class="line"></div><div class="line"><span class="keyword">if</span> ($recent &gt; <span class="number">0</span>) &#123;</div><div class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Duplicate order likely.'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码可读性很高，且因为我们使用了依赖注入，变得很容易测试。然而，如果我们判断订单的规则改变了呢？如果我们又有新的规则了呢？更进一步，如果随着我们的业务发展，要增加一大堆新规则？那我们的 <code>process</code> 方法会很快变成一坨难以维护的浆糊。因为这段代码必须随着每次业务逻辑的改变而跟着改变，它对修改是开放的，这违反了开放封闭原则。记住，我们希望代码对扩展开放，而不是修改。</p>
<p>不必再把订单验证直接写在 <code>process</code> 方法里面，我们来定义一个新的接口 <code>OrderValidator</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">OrderValidatorInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validate</span><span class="params">(Order $order)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下一步我们来定义一个实现接口的类，来预防重复订单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RecentOrderValidator</span> <span class="keyword">implements</span> <span class="title">OrderValidatorInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(OrderRepository $orders)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;orders = $orders;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validate</span><span class="params">(order $order)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $recent = <span class="keyword">$this</span>-&gt;orders-&gt;getRecentOrderCount($order-&gt;account);</div><div class="line">    <span class="keyword">if</span> ($recent &gt; <span class="number">0</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Duplicate order likely.'</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很好！我们封装了一个小巧的、可测试的单一业务逻辑。咱们来再创建一个来验证账号是否停用吧：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SuspendedAccountValidator</span> <span class="keyword">implements</span> <span class="title">OrderValidatorInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validate</span><span class="params">(Order $order)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">if</span> ($order-&gt;account-&gt;isSuspended()) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Suspended accounts may not order.'</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们有两个不同的类实现了 <code>OrderValidatorInterface</code> 接口。咱们将在 <code>OrderProcessor</code> 里面使用它们。我们只需简单的将一个验证器数组注入进订单处理器实例中。这将使我们以后修改代码时能轻松的添加和删除验证器规则。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderProcessor</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(BillerInterface $biller, OrderRepository $orders, array $validators = array<span class="params">()</span>)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;biller = $biller;</div><div class="line">    <span class="keyword">$this</span>-&gt;orders = $orders;</div><div class="line">    <span class="keyword">$this</span>-&gt;validators = $validators;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后我们只要在 <code>process</code> 方法里面循环这个验证器数组即可：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">(Order $order)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;validators <span class="keyword">as</span> $validator) &#123;</div><div class="line">    $validator-&gt;validate($order);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Process valid order...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后我们在 IoC 容器里面注册 <code>OrderProcessor</code> 类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">App::bind(<span class="string">'OrderProcessor'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> OrderProcessor(</div><div class="line">    App::make(<span class="string">'BillerInterface'</span>),</div><div class="line">    App::make(<span class="string">'OrderRepository'</span>),</div><div class="line">    <span class="keyword">array</span>(</div><div class="line">      App::make(<span class="string">'RecentOrderValidator'</span>),</div><div class="line">      App::make(<span class="string">'SuspendedAccountValidator'</span>)</div><div class="line">    )</div><div class="line">  );</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在现有代码里付出些小努力，做一些小改动之后，我们现在可以添加删除新的验证规则而不必修改任何一行现有代码了。每一个新的验证规则就是对 <code>OrderValidatorInterface</code> 的一个实现类，然后注册进 IoC 容器里。不必再为那个又大又笨的 <code>process</code> 方法做单元测试了，我们现在可以单独测试每一个验证规则。现在，我们的代码对扩展是开放的，对修改是封闭的。</p>
<blockquote>
<p><strong>Leaky Abstractions 抽象的漏洞</strong></p>
<p>小心那些缺少实现细节的依赖（译者注：比如上面的 RecentOrderValidator）。当一个依赖的实现需要改变时，不应该要求它的调用者做任何修改。当需要调用者进行修改时，这就意味着该依赖遗漏了一些实现的细节。当你的抽象有漏洞的话，开放封闭原则就不管用了。</p>
</blockquote>
<p>在我们继续学习前，要记住这些原则不是法律。这不是说你应用中每一块代码都应该是“热插拔”式的。例如，一个仅仅从 MySQL 检索几条记录的小应用程序，不值得去严格遵守每一条你想到的设计原则。不要盲目的应用设计原则，那样你会造出一个“过度设计”的繁琐的系统。记住这些设计原则是用来解决通用的架构问题，制造大型容错能力强的应用。我就这么一说，你可别把它当做懒惰的借口！</p>
<p>译文地址：<a href="http://my.oschina.net/zgldh/blog/389246" target="_blank" rel="external">http://my.oschina.net/zgldh/blog/389246</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/10/laravel-from-apprentice-to-artisan-single-responsibility-principle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/10/laravel-from-apprentice-to-artisan-single-responsibility-principle/" itemprop="url">从百草堂到三味书屋 —— 单一职责</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-10T19:52:21+08:00">
                2016-07-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Single-Responsibility-Principle-单一职责原则"><a href="#Single-Responsibility-Principle-单一职责原则" class="headerlink" title="Single Responsibility Principle 单一职责原则"></a>Single Responsibility Principle 单一职责原则</h1><h2 id="Introduction-介绍"><a href="#Introduction-介绍" class="headerlink" title="Introduction 介绍"></a>Introduction 介绍</h2><p>罗伯特“鲍勃叔叔”马丁阐述了名为“坚实”的一些设计原则（译者注：看下面五个原则的首个字母正是 SOLID）。这些都是制作完善的程序设计的优秀的基础，一共有五个原则：</p>
<ul>
<li>The Single Responsibility Principle 单一职责原则</li>
<li>The Open Closed Principle 开放封闭原则</li>
<li>The Liskov Substitution Principle 里氏替换原则</li>
<li>The Interface Segregation Principle 接口隔离原则</li>
<li>The Dependency Inversion Principle 依赖反转原则</li>
</ul>
<p>让我们深入探索一下，再看点代码样例来说明各个原则。我们将看到，每个原则都对其他原则有增益作用。如果其中一个原则没有被遵循，那么其他大部分（可能不会是全部）的原则依然可以工作的很好。</p>
<h2 id="In-Action-实践"><a href="#In-Action-实践" class="headerlink" title="In Action 实践"></a>In Action 实践</h2><p>单一职责原则规定一个类有且仅有一个理由使其改变。换句话说，一个类的功能边界和职责应当是十分狭窄且集中的。我们之前就提到过，在类的职责问题上，无知是福。一个类应当做它该做的事儿，并且不应当被它的依赖的任何变化所影响到。</p>
<p>考虑下列类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderProcessor</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(BillerInterface $biller)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;biller = $biller;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">(Order $order)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $recent = <span class="keyword">$this</span>-&gt;getRecentOrderCount($order);</div><div class="line">    <span class="keyword">if</span> ($recent &gt; <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Duplicate order likely.'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;biller-&gt;bill($order-&gt;account-&gt;id, $order-&gt;amount);</div><div class="line"></div><div class="line">    DB::table(<span class="string">'orders'</span>)-&gt;insert(<span class="keyword">array</span>(</div><div class="line">      <span class="string">'account'</span> =&gt; $order-&gt;account-&gt;id,</div><div class="line">      <span class="string">'amount'</span> =&gt; $order-&gt;amount,</div><div class="line">      <span class="string">'created_at'</span> =&gt; Carbon::now()</div><div class="line">    ));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRecentOrderCount</span><span class="params">(Order $order)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $timestamp = Carbon::now()-&gt;subMinutes(<span class="number">5</span>);</div><div class="line">    <span class="keyword">return</span> DB::table(<span class="string">'orders'</span>)-&gt;where(<span class="string">'account'</span>, $order-&gt;account-&gt;id)</div><div class="line">             -&gt;where(<span class="string">'created_at'</span>, <span class="string">'&gt;='</span>, $timestamps)</div><div class="line">             -&gt;count();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面这个类的职责是什么？很显然顾名思义，它是用来处理订单的。不过由于 <code>getRecentOrderCount</code> 这个方法的存在，这个类就有了在数据库中审查某账号订单历史来看有没有重复订单的职责。这个额外的验证职责意味着当我们的存储方式改变或当订单验证规则改变时，我们的这个订单处理器也要跟着改变。</p>
<p>我们必须将这个职责抽离出来放到另外的类里面，比如放到 <code>OrderRepository</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderRepository</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRecentOrderCount</span><span class="params">(Account $account)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $timestamp = Carbon::now()-&gt;subMinutes(<span class="number">5</span>);</div><div class="line">    <span class="keyword">return</span> DB::table(<span class="string">'orders'</span>)-&gt;where(<span class="string">'account'</span>, $account-&gt;id)</div><div class="line">             -&gt;where(<span class="string">'created_at'</span>, <span class="string">'&gt;='</span>, $timestamp)</div><div class="line">             -&gt;count();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logOrder</span><span class="params">(Order $order)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    DB::table(<span class="string">'orders'</span>)-&gt;insert(<span class="keyword">array</span>(</div><div class="line">      <span class="string">'account'</span> =&gt; $order-&gt;account-&gt;id,</div><div class="line">      <span class="string">'amount'</span> =&gt; $order-&gt;amount,</div><div class="line">      <span class="string">'created_at'</span> =&gt; Carbon::now()</div><div class="line">    ));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后我们可以将我们的资料库（译者注：OrderRepository）注入到 <code>orderProcessor</code> 里，帮后者承担起对账户订单历史的处理责任：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderProcessor</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(BillerInterface $biller, OrderRepository $orders)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;biller = $biller;</div><div class="line">    <span class="keyword">$this</span>-&gt;orders = $orders;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">(Order $order)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $recent = <span class="keyword">$this</span>-&gt;orders-&gt;getRecentOrderCount($order-&gt;account);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ($recent &gt; <span class="number">0</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Duplicate order likely.'</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;biller-&gt;bill($order-&gt;account-&gt;id, $order-&gt;amount);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;orders-&gt;logOrder($order);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们提取出了收集订单数据的责任，当读取和写入订单的方式改变时，我们不再需要修改 <code>OrderProcessor</code> 这个类了。我们的类的职责更加的专注和精确，这提供了一个更干净、更有表现力的代码，同时也是更容易维护的代码。</p>
<p>请记住，单一职责原则的关键不仅仅是让函数变短，而是写出职责更精确更高内聚的类，所以要确保类里面所有的方法都属于该类的职责之下的。在建立一个小巧、清晰且职责明确的类库以后，我们的代码会更加解耦，更容易测试，并且更易于更改。</p>
<p>译文地址：<a href="http://my.oschina.net/zgldh/blog/389246" target="_blank" rel="external">http://my.oschina.net/zgldh/blog/389246</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/10/laravel-from-apprentice-to-artisan-extending-the-framework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/10/laravel-from-apprentice-to-artisan-extending-the-framework/" itemprop="url">从百草堂到三味书屋 —— 扩展框架</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-10T17:51:19+08:00">
                2016-07-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Extending-The-Framework-扩展框架"><a href="#Extending-The-Framework-扩展框架" class="headerlink" title="Extending The Framework 扩展框架"></a>Extending The Framework 扩展框架</h1><h2 id="Introduction-介绍"><a href="#Introduction-介绍" class="headerlink" title="Introduction 介绍"></a>Introduction 介绍</h2><p>为了方便你自定义框架核心组件，Laravel 提供了大量可以扩展的地方。你甚至可以完全替换掉旧组件。例如：哈希器遵守了 <code>HasherInterface</code> 接口，你可以按照你自己应用的需求来重新实现。你也可以扩展 <code>Request</code> 对象，添加你自己用的顺手的“helper”方法。你甚至可以添加全新的身份认证、缓存和会话机制。</p>
<p>Laravel 组件通常有两种扩展方式：在 IoC 容器里面绑定新实现，或者用 <code>Manager</code> 类注册一个扩展，该扩展采用了工厂模式实现。在本章中我们将探索不同的扩展方式并检查我们都需要些什么代码。</p>
<blockquote>
<p><strong>Methods Of Extension 扩展方式</strong></p>
<p>要记住 Laravel 通常有以下两种扩展方式：通过 IoC 绑定和通过 <code>Manager</code> 类（下文译作“管理类”）。其中管理类实现了工厂设计模式，负责组件的实例化。比如缓存和会话机制。</p>
</blockquote>
<h2 id="Manager-amp-Factoriers-管理者和工厂"><a href="#Manager-amp-Factoriers-管理者和工厂" class="headerlink" title="Manager &amp; Factoriers 管理者和工厂"></a>Manager &amp; Factoriers 管理者和工厂</h2><p>Laravel 有好多 <code>Manager</code> 类用来管理基于驱动的组件的生成过程。基于驱动的组件包括：缓存、会话、身份认证、队列组件等。管理类负责根据应用程序的配置，来生成特定的驱动实例。比如：<code>CacheManager</code> 可以创建 APC、Memcached、Native、还有其他不同的缓存驱动的实现。</p>
<p>每个管理类都包含名为 <code>extend</code> 的方法，该方法可用于将新功能注入到管理类中。下面我们将逐个介绍管理类，为你展示如何注入自定义的驱动。</p>
<blockquote>
<p><strong>Learn About Your Managers 如何了解你的管理类</strong></p>
<p>请花点时间看看 Laravel 中各个 <code>Manager</code> 类的代码，比如 <code>CacheManager</code> 和 <code>SessionManager</code>。通过阅读这些代码能让你对 Laravel 的管理类机制更加清楚透彻。所有的管理类都继承自 <code>Illuminate\Support\Manager</code> 基类，该基类为每一个管理类提供了一些有效且通用的功能。</p>
</blockquote>
<h2 id="Cache-缓存"><a href="#Cache-缓存" class="headerlink" title="Cache 缓存"></a>Cache 缓存</h2><p>要扩展 Laravel 的缓存机制，我们将使用 <code>CacheManager</code> 里的 <code>extend</code> 方法来绑定我们自定义的缓存驱动。扩展其他的管理类也是类似的。比如，我们想注册一个新的缓存驱动，名叫“mongo”，代码可以这样写：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Cache::extend(<span class="string">'mongo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">  <span class="comment">// Return Illuminate\Cache\Repository instance... </span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>extend</code> 方法的第一个参数是你要定义的驱动的名字。该名字对应着 <code>app/config/cache.php</code> 配置文件中的 <code>driver</code> 项。第二个参数是一个匿名函数（闭包），该匿名函数有一个 <code>$app</code> 参数是 <code>Illuminate\Foundation\Application</code> 的实例也是一个 IoC 容器，该匿名函数要返回一个 <code>Illuminate\Cache\Repository</code> 的实例。</p>
<p>要创建我们自己的缓存驱动，首先要实现 <code>Illuminate\Cache\StoreInterface</code> 接口。所以我们用 MongoDB 来实现的缓存驱动就可能看上去是这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MongoStore</span> <span class="keyword">implements</span> <span class="title">Illuminate</span>\<span class="title">Cache</span>\<span class="title">StoreInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">put</span><span class="params">($key, $value, $minutes)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">increment</span><span class="params">($key, $value = <span class="number">1</span>)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decrement</span><span class="params">($key, $value = <span class="number">1</span>)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">forever</span><span class="params">($key, $value)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">forget</span><span class="params">($key)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">flush</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们只需使用 MongoDB 链接来实现上面的每一个方法即可。一旦实现完毕，就可以照下面这样完成该驱动的注册：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Cache</span>\<span class="title">Repository</span>;</div><div class="line"></div><div class="line">Cache::extend(<span class="string">'mongo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Repository(<span class="keyword">new</span> MongoStore);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可以像上面的例子那样来创建 <code>Illuminate\Cache\Repository</code> 的实例。也就是说通常你不需要创建你自己的仓库类（Repository)。</p>
<p>如果你不知道把自定义缓存驱动代码放到哪儿，可以考虑放到 Packagist 里！或者你也可以在你应用的主目录下创建一个 <code>Extensions</code> 目录。比如，你的应用叫 <code>Snappy</code>，你可以将缓存扩展代码放到 <code>app/Snappy/Extensions/MongoStore.php</code>。不过请记住 Laravel 没有对应用程序的结构做硬性规定，所以你可以按任意你喜欢的方式组织你的代码。</p>
<blockquote>
<p><strong>Where To Extend 在哪儿调用 Extend 方法？</strong></p>
<p>如果你还发愁在哪儿放注册代码，先考虑放到服务提供者里吧。我们之前就讲过，使用服务提供者是一种非常棒的管理你应用代码的途径。</p>
</blockquote>
<h2 id="Session-会话"><a href="#Session-会话" class="headerlink" title="Session 会话"></a>Session 会话</h2><p>扩展 Laravel 的会话机制和上文的缓存机制一样简单。和刚才一样，我们使用 <code>extend</code> 方法来注册自定义的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Session::extend(<span class="string">'mongo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span></span>&#123;</div><div class="line">  <span class="comment">// Return implementation of SessionHandlerInterface </span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>注意我们自定义的会话驱动（译者注：原文是 cache driver,应该是笔误。正确应为 session driver）实现的是 <code>SessionHandlerInterface</code> 接口。这个接口在 PHP 5.4 以上版本才有。但如果你用的是 PHP 5.3 也别担心，Laravel 会自动帮你定义这个接口。该接口要实现的方法不多也不难。我们用 MongoDB 来实现就像下面这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MongoHandler</span> <span class="keyword">implements</span> <span class="title">SessionHandlerInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($savePath, $sessionName)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($sessionId)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($sessionId, $data)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">destroy</span><span class="params">($sessionId)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">gc</span><span class="params">($lifetime)</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这些方法不像刚才的 <code>StoreInterface</code> 接口定义的那么容易理解。我们来挨个简单讲讲这些方法都是干啥的：</p>
<ul>
<li><code>open</code> 方法一般在基于文件的会话系统中才会用到。Laravel 已经自带了一个 <code>native</code> 的会话驱动，使用的就是 PHP 自带的基于文件的会话系统，你可能永远也不需要在这个方法里写东西。所以留空就好。另外这也是一个接口设计的反面教材（稍后我们会继续讨论这一点）。</li>
<li><code>close</code> 方法和 <code>open</code> 方法通常都不是必须的。对大部分驱动来说都不必要实现。</li>
<li><code>read</code> 方法应该根据 <code>$sessionId</code> 参数来返回对应的会话数据的字符串形式。在你的会话驱动里，不论读写都不需要做任何数据序列化工作。因为 Laravel 会负责数据序列化的。</li>
<li><code>write</code> 方法应该将 <code>$sessionId</code> 对应的 <code>$data</code> 字符串放置在一个持久化存储系统中。比如 MongoDB，Dynamo 等等。</li>
<li><code>destroy</code> 方法应该将 <code>$sessionId</code> 对应的数据从持久化存储系统中删除。</li>
<li><code>gc</code> 方法应该将所有时间超过参数 <code>$lifetime</code> 的数据全都删除，该参数是一个 UNIX 时间戳。如果你使用的是类似 Memcached 或 Redis 这种有自主到期功能的存储系统，那该方法可以留空。</li>
</ul>
<p>一旦 <code>SessionHandlerInterface</code> 实现完毕，我们就可以将其注册进会话管理器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Session::extend(<span class="string">'mongo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> MongoHandler;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>注册完毕后，我们就可以在 <code>app/config/session.php</code> 配置文件里使用 <code>mongo</code> 驱动了。</p>
<blockquote>
<p><strong>Share Your Knowledege 分享你的知识</strong></p>
<p>你要是写了个自定义的会话处理器，别忘了在 Packagist 上分享啊！</p>
</blockquote>
<h2 id="Authentication-身份认证"><a href="#Authentication-身份认证" class="headerlink" title="Authentication 身份认证"></a>Authentication 身份认证</h2><p>身份认证模块的扩展方式和缓存与会话的扩展方式一样：使用我们熟悉的 <code>extend</code> 方法就可以进行扩展：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Auth::extend(<span class="string">'riak'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">  <span class="comment">// Return implementation of Illuminate\Auth\UserProviderInterface </span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>接口 <code>UserProviderInterface</code> 负责从各种持久化存储系统——如 MySQL，Riak 等——中获取数据，然后得到接口 <code>UserInterface</code> 的实现对象。有了这两个接口，Laravel 的身份认证机制就可以不用管用户数据是如何存储的、究竟哪个类代表用户对象这种事儿，从而继续专注于身份认证本身的实现。</p>
<p>咱们来看一看 <code>UserProviderInterface</code> 接口的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UserProviderInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">retrieveById</span><span class="params">($identifier)</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">retrieveByCredentials</span><span class="params">(array $credentials)</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validateCredentials</span><span class="params">(UserInterface $user, array $credentials)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>方法 <code>retrieveById</code> 通常接受一个数字参数用来表示一个用户，比如 MySQL 数据库的自增 ID。该方法要找到匹配该 ID 的 <code>UserInterface</code> 的实现对象，并且将该对象返回。</p>
<p><code>retrieveByCredentials</code> 方法接受一个参数作为登录账号。该参数是在尝试登录系统时从 <code>Auth::attempt</code> 方法传来的。那么该方法应该“查询”底层的持久化存储系统，来找到那些匹配到该账号的用户。通常该方法会执行一个带有“where”条件的查询来匹配参数里的 <code>$credentials[&#39;username&#39;]</code>。该方法不应该做任何密码验证。</p>
<p><code>validateCredentials</code> 方法会通过比较 <code>$user</code> 参数和 <code>$credentials</code> 参数来检测用户是否通过认证。比如，该方法会调用 <code>$user-&gt;getAuthPassword()</code> 方法，将得到的字符串 <code>$credentials[&#39;password&#39;]</code> 经过 <code>Hash::make</code> 处理后的结构进行比对。</p>
<p>现在我们探索了 <code>UserProviderInterface</code> 接口的每一个方法，接下来咱们看一看 <code>UserInterface</code> 接口。别忘了 <code>UserInterface</code> 的实例应当是 <code>retrieveById</code> 和 <code>retrieveByCredentials</code> 方法的返回值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UserInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAuthIdentifier</span><span class="params">()</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAuthPassword</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个接口很简单。<code>getAuthIdentifier</code> 方法应当返回用户的“主键”。就像刚才提到的，在 MySQL 中可能就是自增主键了。<code>getAuthPassword</code> 方法应当返回经过散列处理的用户密码。有了这个接口，身份认证系统就可以不用关心用户类到底使用了什么 ORM 或者什么存储方式。Laravel 已经在 <code>app/models</code> 目录下，包含了一个默认的 <code>User</code> 类且实现了该接口。所以你可以参考这个类当例子。</p>
<p>当我们最后实现了 <code>UserProviderInterface</code> 接口后，我们可以将该扩展注册进 <code>Auth</code> 里面：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Auth::extend(<span class="string">'riak'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> RiakUserProvider($app[<span class="string">'riak.connection'</span>]); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>使用 <code>extend</code> 方法来注册好驱动以后，你就可以在 <code>app/config/auth.php</code> 配置文件里面切换到新的驱动了。</p>
<h2 id="IoC-Based-Extendsion-使用容器进行扩展"><a href="#IoC-Based-Extendsion-使用容器进行扩展" class="headerlink" title="IoC Based Extendsion 使用容器进行扩展"></a>IoC Based Extendsion 使用容器进行扩展</h2><p>Laravel 框架内几乎所有的服务提供者都会绑定一些对象到 IoC 容器里。你可以在 <code>app/config/app.php</code> 文件里找到服务提供者列表。如果你有时间的话，你应该大致过一遍每个服务提供者的源码。这么做你便可以对每个服务提供者有更深的理解，明白他们都往框架里加了什么东西，对应的什么键。那些键就用来联系着各种各样的服务。</p>
<p>举个例子，<code>PaginationServiceProvider</code> 向容器内绑定了一个 <code>paginator</code> 键，对应着一个 <code>Illuminate\Pagination\Environment</code> 实例。你可以很容易的通过覆盖容器绑定来扩展重写该类。比如，你可以创建一个扩展自 <code>Environment</code> 类的子类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">Snappy</span>\<span class="title">Extensions</span>\<span class="title">Pagination</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Environment</span> <span class="keyword">extends</span> \<span class="title">Illuminate</span>\<span class="title">Pagination</span>\<span class="title">Environment</span> </span>&#123;</div><div class="line">  <span class="comment">//  </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>子类写好以后，你可以再创建个新的 <code>SnappyPaginationProvider</code> 服务提供者来扩展其 <code>boot</code> 方法，在里面覆盖 paginator：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnappyPaginationProvider</span> <span class="keyword">extends</span> <span class="title">PaginationServiceProvider</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    App:bind(<span class="string">'paginator'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Snappy\Extensions\Pagination\Environment;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">parent</span>::boot();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意这里我们继承了 <code>PaginationServiceProvider</code>，而非默认的基类 <code>ServiceProvider</code>。扩展的服务提供者编写完毕后，就可以在 <code>app/config/app.php</code> 文件里将 <code>PaginationServiceProvider</code> 替换为你刚扩展的那个类了。</p>
<p>这就是扩展绑定进容器的核心类的一般方法。基本上每一个核心类都以这种方式绑定进了容器，都可以被重写。还是那一句话，读一遍框架内的服务提供者源码吧。这有助于你熟悉各种类是怎么绑定进容器的，都绑定的是哪些键。这是学习 Laravel 框架到底如何运转的好方法。</p>
<h2 id="Request-Extension-请求的扩展"><a href="#Request-Extension-请求的扩展" class="headerlink" title="Request Extension 请求的扩展"></a>Request Extension 请求的扩展</h2><p>由于这玩意儿是框架里面非常基础的部分，并且在请求流程中很早就被实例化，所以要扩展 <code>Reqeust</code> 类的方法与之前相比是有些许不同的。</p>
<p>首先还是要写个子类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">namespace</span> <span class="title">QuickBill</span>\<span class="title">Extensions</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span> <span class="keyword">extends</span> \<span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span> </span>&#123;</div><div class="line">  <span class="comment">// Custom, helpful methods here...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>子类写好后，打开 <code>bootstrap/start.php</code> 文件。该文件是应用的请求流程中最早被载入的几个文件之一。要注意被执行的第一个动作是创建 Laravel 的 <code>$app</code> 实例:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$app = <span class="keyword">new</span> \Illuminate\Foundation\Application;</div></pre></td></tr></table></figure>
<p>当新的应用实例创建后，它将会创建一个 <code>Illuminate\Http\Request</code> 的实例并且将其绑定到 IoC 容器里，键名为 <code>request</code>。所以我们需要找个方法来将一个自定义的类指定为“默认的”请求类，对不对？而且幸运的是，应用实例有一个名为 <code>requestClass</code> 的方法就是用来干这事儿的！所以我们只需要在 <code>bootstrap/start.php</code> 文件最上面加一行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Application</span>;</div><div class="line"></div><div class="line">Application::requestClass(<span class="string">'QuickBill\Extensions\Request'</span>);</div></pre></td></tr></table></figure>
<p>一旦你指定了自定义的请求类，Laravel 将在任何时候都可以使用这个 <code>Request</code> 类的实例。并使你很方便的能随时访问到他，甚至单元测试也不例外！</p>
<p>译文地址：<a href="http://my.oschina.net/zgldh/blog/389246" target="_blank" rel="external">http://my.oschina.net/zgldh/blog/389246</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/10/laravel-from-apprentice-to-artisan-applied-architecture-decoupling-handlers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/10/laravel-from-apprentice-to-artisan-applied-architecture-decoupling-handlers/" itemprop="url">从百草园到三味书屋 —— 解耦处理函数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-10T16:46:49+08:00">
                2016-07-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Applied-Architecture-Decoupling-Handlers-使用做法：解耦处理函数"><a href="#Applied-Architecture-Decoupling-Handlers-使用做法：解耦处理函数" class="headerlink" title="Applied Architecture: Decoupling Handlers 使用做法：解耦处理函数"></a>Applied Architecture: Decoupling Handlers 使用做法：解耦处理函数</h1><h2 id="Introduction-介绍"><a href="#Introduction-介绍" class="headerlink" title="Introduction 介绍"></a>Introduction 介绍</h2><p>我们已经讨论了用 Laravel 4 制作优美的程序架构的各个方面，让我们再深入一些细节。在本章，我们将讨论如何解耦各种处理函数：队列处理函数、事件处理函数，甚至其他“事件型”的结构如路由过滤器。</p>
<blockquote>
<p><strong>Don’t Clog Your Transport Layer 不要堵塞传输层</strong></p>
<p>大部分的“处理函数”可以被当作传输层组件。也就是说，队列触发器、被触发的事件、或者外部发来的请求等都可能调用处理函数。可以把处理函数理解为控制器，避免在里面堆积太多具体业务逻辑实现。</p>
</blockquote>
<h2 id="Decoupling-Handlers-解耦处理函数"><a href="#Decoupling-Handlers-解耦处理函数" class="headerlink" title="Decoupling Handlers 解耦处理函数"></a>Decoupling Handlers 解耦处理函数</h2><p>接下来我们看一个例子。考虑有一个队列处理函数用来给用户发送手机短信。信息发送后，处理函数还要记录消息日志来保存给用户发送的消息历史。代码应该看起来是这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendSMS</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fire</span><span class="params">($job, $data)</span> </span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $twilio = <span class="keyword">new</span> Twilio_SMS($apiKey);</div><div class="line">    $twilio-&gt;sendTextMessage(<span class="keyword">array</span>(</div><div class="line">      <span class="string">'to'</span> =&gt; $data[<span class="string">'user'</span>][<span class="string">'phone_number'</span>],</div><div class="line">      <span class="string">'message'</span> =&gt; $data[<span class="string">'message'</span>],</div><div class="line">    ));</div><div class="line">    $user = User::find($data[<span class="string">'user'</span>][<span class="string">'id'</span>]);</div><div class="line">    $user-&gt;messages()-&gt;create(<span class="keyword">array</span>(</div><div class="line">      <span class="string">'to'</span> =&gt; $data[<span class="string">'user'</span>][<span class="string">'phone_number'</span>],</div><div class="line">      <span class="string">'message'</span> =&gt; $data[<span class="string">'message'</span>],</div><div class="line">    ));</div><div class="line">    $job-&gt;delete();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简单审查下这个类，你可能会发现一些问题。首先，它难以测试。在 <code>fire</code> 方法里直接使用了 <code>Twillio_SMS</code> 类，意味着我们没法注入一个模拟的服务（译者注：即一旦测试则必须发送一条真实的短信）。第二，我们直接使用了 Eloquent，导致在测试时肯定会对数据库造成影响。第三，我们没法在队列外面发送短信，想在队列外面发还要重写一遍代码。也就是说我们的短信发送逻辑和 Laravel 的队列耦合太多了。</p>
<p>将里面的逻辑抽出成为一个单独的“服务”类，我们即可将短信发送逻辑和 Laravel 的队列解耦。这样我们就可以在应用的任何位置发送短信了。我们将其解耦的过程，也令其变得更易于测试。</p>
<p>那么我们来稍微改一改：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Eloquent</span> </span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Send the User an SMS message</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> SmsCourierInterface $courier</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> string $message</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> SmsMessage</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendSmsMessage</span><span class="params">(SmsCourierInterface $courier, $message)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $courier-&gt;sendMessage(<span class="keyword">$this</span>-&gt;phone_number, $message);</div><div class="line">     <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;sms()-&gt;create(<span class="keyword">array</span>(</div><div class="line">      <span class="string">'to'</span> =&gt; <span class="keyword">$this</span>-&gt;phone_number,</div><div class="line">      <span class="string">'message'</span> =&gt; $message,</div><div class="line">     ));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在本重构的例子中，我们将短信发送逻辑抽出到 <code>User</code> 模型里。同时我们将 <code>SmsCourierInterface</code> 的实现注入到该方法里，这样我们可以更容易对该方法进行测试。现在我们已经重构了短信发送逻辑，让我们再重写队列处理函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendSMS</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UserRepository $users, SmsCourierInterface $courier)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;users = $users;</div><div class="line">    <span class="keyword">$this</span>-&gt;courier = $courier;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fire</span><span class="params">($job, $data)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $user = <span class="keyword">$this</span>-&gt;users-&gt;find($data[<span class="string">'user'</span>][<span class="string">'id'</span>]);</div><div class="line">    $user-&gt;sendSmsMessage(<span class="keyword">$this</span>-&gt;courier, $data[<span class="string">'message'</span>]);</div><div class="line">    $job-&gt;delete();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可以看到我们重构了代码，使得队列处理函数更轻量化了。它本质上变成了队列系统和你真正的业务逻辑之间的转换层。这可是很了不起！这意味着我们可以很轻松的脱离队列系统来发送短信息。最后，让我们为短信发送逻辑写一些测试代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SmsTest</span> <span class="keyword">extends</span> <span class="title">PHPUnit_Framework_TestCase</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testUserCanBeSentSmsMessages</span> <span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Arrage ...</span></div><div class="line"><span class="comment">     */</span></div><div class="line">     $user = Mockery::mock(<span class="string">'User[sms]'</span>);</div><div class="line">     $relation = Mockery::mock(<span class="string">'StdClass'</span>);</div><div class="line">     $courier = Mockery::mock(<span class="string">'SmsCourierInterface'</span>);</div><div class="line"></div><div class="line">     $user-&gt;shouldReceive(<span class="string">'sms'</span>)-&gt;once()-&gt;andReturn($relation);</div><div class="line"></div><div class="line">     $relation-&gt;shouldReceive(<span class="string">'create'</span>)-&gt;once()-&gt;with(<span class="keyword">array</span>(</div><div class="line">       <span class="string">'to'</span> =&gt; <span class="string">'555-555-555'</span>,</div><div class="line">       <span class="string">'message'</span> =&gt; <span class="string">'Test'</span>,</div><div class="line">     ));</div><div class="line"></div><div class="line">     $courier-&gt;shouldReceive(<span class="string">'sendMessage'</span>)-&gt;once()-&gt;with(</div><div class="line">       <span class="string">'555-555-555'</span>, <span class="string">'Test'</span></div><div class="line">     );</div><div class="line"></div><div class="line">     <span class="comment">/**</span></div><div class="line"><span class="comment">      * Act ...</span></div><div class="line"><span class="comment">      */</span></div><div class="line">     $user-&gt;sms_number = <span class="string">'555-555-555'</span>;</div><div class="line">     $user-&gt;sendMessage($courier, <span class="string">'Test'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Other-Handlers-其他处理函数"><a href="#Other-Handlers-其他处理函数" class="headerlink" title="Other Handlers 其他处理函数"></a>Other Handlers 其他处理函数</h2><p>使用类似的方式，我们可以改进和解耦很多其他类型的“处理函数”。将这些处理函数限制在转换层的状态，你可以将你庞大的业务逻辑和框架解耦，并保持整洁的代码结构。为了巩固这种思想，我们来看看一个路由过滤器。该过滤器用来验证当前用户是否是交过钱的高级用户套餐。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Route::filter(<span class="string">'premium'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> Auth::user() &amp;&amp; Auth::user()-&gt;plan == <span class="string">'premium'</span>; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>猛一看这路由过滤器没什么问题啊。这么简单的过滤器能有什么错误？然而就是这么小小的过滤器，我们却将我们应用实现的细节暴露了出来。要注意我们在该过滤器里写明了要检查 <code>plan</code> 变量。这使得将“套餐方案”在我们应用中的代表值（译者注：即 <code>plan</code> 变量的值）暴露在了路由/传输层里面。现在我们若想调整“高级套餐”在数据库或用户模型的代表值，我们竟然就需要改这个路由过滤器！</p>
<p>让我们简单改一点儿：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Route::filter(<span class="string">'premium'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> Auth::uesr() &amp;&amp; Auth::user()-&gt;isPremium(); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>小小的改变就带来巨大的效果，并且代价也很小。我们将判断用户是否使用高级套餐的逻辑放在了用户模型里，这样就从路由过滤器里去掉了对套餐判断的实现细节。我们的过滤器不再需要知道具体怎么判断用户是不是高级套餐了，它只要简单的把这个问题交给用户模型。现在如果我们想调整高级套餐在数据库里的细节，也不必再去改动路由过滤器了！</p>
<blockquote>
<p><strong>Who Is Responsible？谁负责？</strong></p>
<p>在这里我们又一次讨论了责任的概念。记住，始终保持一个类应该有什么样的责任，应该知道什么。避免在处理函数这种传输层直接编写太多你应用的业务逻辑。</p>
</blockquote>
<p>译者注：本文多次出现 transport layer，translation layer，分别译作传输层和转换层。其实他们应当指代的同一种东西。</p>
<p>译文地址：<a href="http://my.oschina.net/zgldh/blog/389246" target="_blank" rel="external">http://my.oschina.net/zgldh/blog/389246</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/10/laravel-from-apprentice-to-artisan-application-structure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/10/laravel-from-apprentice-to-artisan-application-structure/" itemprop="url">从百草园到三味书屋 —— 应用结构</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-10T15:11:54+08:00">
                2016-07-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Application-Structure-应用结构"><a href="#Application-Structure-应用结构" class="headerlink" title="Application Structure 应用结构"></a>Application Structure 应用结构</h1><h2 id="Introduction-介绍"><a href="#Introduction-介绍" class="headerlink" title="Introduction 介绍"></a>Introduction 介绍</h2><p>这个类要写到哪儿？这是一个在用框架写应用程序时十分常见的问题。大量的开发人员都有这个疑问。他们被灌输“Model”就是“Database”，在控制器里面到处 HTTP 请求，在模型里操作数据库，视图里包含了要显示的 HTML。不过，发送电子邮件的类要写到哪儿？数据验证的类要写到哪儿？调用外部 API 的类要写到哪儿？在这一章节，我们将学习如何写结构优美的 Laravel 应用，打破长久以来掣肘开发人员的普遍思维惯性这个拦路虎，最终做出好的设计。</p>
<h2 id="MVC-Is-Killing-You"><a href="#MVC-Is-Killing-You" class="headerlink" title="MVC Is Killing You"></a>MVC Is Killing You</h2><p>为了做出好的程序设计，最大的拦路虎就是一个简单的缩写词：M-V-C。模型、视图、控制器主宰了 Web 框架的思想已经好多年了。这种思想的流行某种程度上是托了 Ruby on Rails 愈加流行的福。然而，如果你问一个开发人员“模型”的定义是什么。通常你会听到他嘟哝着什么“数据库”之类的东西。这么说，模型就是数据库了。不管这意味着什么，模型里包含了关于数据库的一切。但是，你很快就会知道，你的应用程序需要的不仅仅是一个简单的数据库访问类。他需要更多的逻辑如：数据验证、调用外部服务、发送电子邮件，等等更多。</p>
<blockquote>
<p><strong>What Is A Model？模型是啥？</strong></p>
<p>单词“model”的含义太模糊了，很难说其具体的含义。更具体来讲，模型是用来将我们的应用划分成更小、更清晰的类，使得各代码部分有着明确的权责。</p>
</blockquote>
<p>所以怎么解决这个问题（译者注：上文中“更多的业务逻辑”）呢？很多开发者开始将业务逻辑包装到控制器里面。当控制器庞大到一定规模，他们将会需要重用业务逻辑。大部分开发人员没有将这些业务逻辑提取到别的类里面，而是错误的臆想他们需要在控制器里面调用别的控制器。这种模式通常被称为“HMVC”。不幸的是，这种模式通常也预示着糟糕的程序设计，并且控制器已经太复杂了。</p>
<blockquote>
<p><strong>HMVC（Usually）Indicates Poor Design HMVC （通常）预示着糟糕的设计</strong></p>
<p>你觉得需要在控制器里面调用其他的控制器？这通常预示着糟糕的程序设计并且你的控制器里面业务逻辑太多了。把业务逻辑抽出来放到一个新的类里面，这样你就可以在其他任何控制器里面调用了。</p>
</blockquote>
<p>有一种更好的程序结构。但首先我们要忘掉以往我们被灌输的关于“模型”的一切。干脆点，让我们直接删掉 model 目录，重新开始吧！</p>
<h2 id="Bye-Bye-Models-再见，模型"><a href="#Bye-Bye-Models-再见，模型" class="headerlink" title="Bye, Bye Models 再见，模型"></a>Bye, Bye Models 再见，模型</h2><p>删掉你的 <code>modles</code> 目录了么？还没删就赶紧删了！我们将要在 <code>app</code> 目录下创建个新的目录，目录名就以我们这个应用的名字来命名，这次我们就叫 <code>QuickBill</code> 吧。在后续的讨论中，我们在前面写的那些接口和类都会出现。</p>
<blockquote>
<p><strong>Remember The Context 注意使用场景</strong></p>
<p>记住，如果你在写一个很小的 Laravel 应用，那在 <code>models</code> 目录下写几个 Eloquent 模型其实挺合适的。但在本章节，我们主要关注如何开发更有合适“层次”架构的大型复杂项目。</p>
</blockquote>
<p>这样我们现在有了个 <code>app/QuickBill</code> 目录，它和应用目录下的其他目录如 <code>controllers</code> 还有 <code>views</code> 都是平级的。在 <code>QuickBill</code> 目录下我们还可以创建几个其他的目录。我们来在里面创建个 <code>Repositories</code> 和 <code>Billing</code> 目录。目录都创建好以后，别忘了在 <code>composer.json</code> 文件里加入 PSR-0 的自动载入机制：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">"autoload"</span>: &#123;</div><div class="line">  <span class="string">"psr-o"</span> : &#123;</div><div class="line">    <span class="string">'QuickBill'</span>: <span class="string">"app/"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>译者注：PSR-0 也可以改成 PSR-4，PSR-0 标准目前已经废弃。</p>
</blockquote>
<p>现在我们把继承自 Eloquent 的模型类都放到 <code>QuickBill</code> 目录下面。这样我们就能很方便的以 <code>QuickBill\User</code>，<code>QuickBill\Payment</code> 的方式来使用它们。<code>Repositories</code> 目录属于 <code>paymentRepository</code> 和 <code>UserRepository</code> 这种类，里面包含了所有对数据的访问功能比如 <code>getRecentPayments</code> 和 <code>getRichestUser</code>。<code>Billing</code> 目录应当包含调用第三方支付服务（如 Stripe 和 Balanced）的类。整个目录结构应该类似这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// app</span></div><div class="line">  <span class="comment">// QuickBill</span></div><div class="line">    <span class="comment">// Repositories</span></div><div class="line">      -&gt; UserRepository.php</div><div class="line">      -&gt; PaymentRepository.php</div><div class="line">    <span class="comment">// Billing</span></div><div class="line">      -&gt; BillerInterface.php</div><div class="line">      -&gt; StripeBiller.php</div><div class="line">    <span class="comment">// Notifications</span></div><div class="line">      -&gt; BillingNotifierInterface.php</div><div class="line">      -&gt; SmsBillingNotifier.php</div><div class="line">    User.php</div><div class="line">    Payment.php</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>What About Validation 数据验证怎么办？</strong></p>
<p>在哪儿进行数据验证常常困扰着开发人员。可以考虑将数据验证方法写进你的“实体”类里面（好比 <code>User.php</code> 和 <code>Payment.php</code>）。方法名可以设为 <code>validForCreation</code> 或 <code>hasValidDomain</code>。或者你也可以专门创建个验证器类 <code>UserValidator</code>，放到 <code>Validation</code> 命名空间下，然后将这个验证器类注入到你的 repository 类里面。两种方式你都可以试试，看哪个你更喜欢！</p>
</blockquote>
<p>摆脱了 <code>models</code> 目录后，你通常就能克服心理障碍，实现好的设计。使你能创建一个更合适的目录结构来为你的应用服务。当然，你建立的每一个应用程序都会有一定的相似之处，因为每个复杂的应用程序都需要一个数据访问（repository）层，一些外部服务层等等。</p>
<blockquote>
<p><strong>Don’t Fear Directories 别害怕目录</strong></p>
<p>不要惧怕建立目录来管理应用。要常常将你的应用切割成小组件，每一个组件都要有十分专注的职责。跳出“模型”的框框来思考。比如我们之前就说过，你可以创建个 <code>Repositories</code> 目录来存放你所有的数据访问类。</p>
</blockquote>
<h2 id="It’s-All-About-The-Layers-核心思想就是分层"><a href="#It’s-All-About-The-Layers-核心思想就是分层" class="headerlink" title="It’s All About The Layers 核心思想就是分层"></a>It’s All About The Layers 核心思想就是分层</h2><p>你可能注意到，优化应用的设计结构的关键就是责任划分，或者说是创建不同的责任层次。控制器只负责接收和响应 HTTP 请求然后调用合适的业务逻辑层的类。你的业务逻辑/领域逻辑层才是你真正的程序。你的程序包含了读取数据，验证数据，执行支付，发送电子邮件，还有你程序里任何其他的功能。事实上你的领域逻辑层不需要知道任何关于“网络”的事情！网络仅仅是个访问你程序的传输机制，关于网络和 HTTP 请求的一切不应该超出路由和控制器层。做出好的设计的确很有挑战性，但好的设计也会带来可持续发展的清晰的好代码。</p>
<p>举个例子。与其在你的业务逻辑类里面直接获取网络请求，不如你直接把网络请求从控制器传给你的业务逻辑类。这个简单的改动将你的业务逻辑类和“网络”分离开了，并且不必担心怎么去模拟网络请求，你的业务逻辑类就可以简单的测试了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingController</span> <span class="keyword">extends</span> <span class="title">BaseController</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(BillerInterface $biller)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;biller = $biller;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">postCharge</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;biller-&gt;chargeAccount(Auth::user(), Input::get(<span class="string">'amount'</span>));</div><div class="line">    <span class="keyword">return</span> View::make(<span class="string">'charege.success'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在 <code>chargeAccount</code> 方法更容易测试了。我们把 <code>Request</code> 和 <code>Input</code> 从 <code>BillingInterface</code> 里提出来，然后在控制器里把方法需要的支付金额直接传过去。</p>
<p>编写拥有高可维护性应用程序的关键之一，就是责任分割。要时常检查一个类是否管得太宽。你要常常问自己“这个类需不需要关心 XXX 呢？”如果答案是否定的，那么把这块逻辑抽出来放到另一个类里面，然后用依赖注入的方式进行处理。（译者注：依赖注入的不同方式还记得么？调用方法传参、构造函数传参、从 IoC 容器获取等等。）</p>
<blockquote>
<p>Single Reason To Change</p>
<p>如何判断一个类是否管得太宽，有一个有用的方法就是检查你为什么要改这块儿代码。举个例子：当我们想调整通知逻辑的时候，我们需要修改 <code>Biller</code> 的实现代码么？当然不需要，<code>Biller</code> 的实现仅仅需要考虑支付，它与通知逻辑应该仅通过约定来进行交互。使用这种思路过一遍代码，会让你很快找出应用中需要改进的地方。</p>
</blockquote>
<h2 id="Where-To-Put-“Stuff”-东西都放哪儿？"><a href="#Where-To-Put-“Stuff”-东西都放哪儿？" class="headerlink" title="Where To Put “Stuff” 东西都放哪儿？"></a>Where To Put “Stuff” 东西都放哪儿？</h2><p>当用 Laravel 开发应用时，你可能迷惑于应该把各种“东西”都放在哪儿。比如，辅助函数要放在哪儿？事件监听器要放在哪儿？视图组件要放在哪儿？答案可能会出乎你的意料 —— “想放哪儿都行！”Laravel 并没有很多在文件系统上的约定。不过这个答案的确不能让人满意，所以下面我们就这个问题展开探索，探索这些“东西”究竟可以放在哪儿。</p>
<h3 id="Helper-Functions-辅助函数"><a href="#Helper-Functions-辅助函数" class="headerlink" title="Helper Functions 辅助函数"></a>Helper Functions 辅助函数</h3><p>Laravel 有一个文件（<code>support/helpers.php</code>）里面都是辅助函数。你或许希望创建一个类似的文件来存储你自己的辅助函数。“start”文件是个不错的入口，该文件会在应用的每一次请求时被访问。在 <code>start/global.php</code> 里，你可以引入你自己写的 <code>helpers.php</code> 文件，就像这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Within app/start/global.php</span></div><div class="line"></div><div class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/../helpers.php'</span>;</div><div class="line"><span class="comment">// 译者注： 该 helpers.php 文件位于 app 目录下，需要你自己创建，你想放到别的地方也可以。</span></div></pre></td></tr></table></figure>
<h3 id="Event-Listeners-事件监听器"><a href="#Event-Listeners-事件监听器" class="headerlink" title="Event Listeners 事件监听器"></a>Event Listeners 事件监听器</h3><p>事件监听器当然不该放到 <code>routes.php</code> 文件里面，若直接放到“start”目录下的文件里会比较乱，所以我们要找另外的地方来存放。服务提供者是个好地方。我们之前了解到，服务提供者可不仅仅是用来做依赖注入绑定，还可以干其他事儿。可以将事件监听器用服务提供者来管理起来，让代码更整洁，不至于影响到你应用的主要逻辑代码。视图组件其实和事件差不多，也可以类似的放到服务提供者里面。</p>
<p>例如使用服务提供者进行事件注册可以这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">namespace</span> <span class="title">QuickBill</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServicePorivder</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BillingEventsProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span> <span class="params">()</span> </span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    Event::listen(<span class="string">'billing.failed'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($bill)</span> </span>&#123;</div><div class="line">      <span class="comment">// Handle failed billing event...</span></div><div class="line">    &#125;)</div><div class="line">  &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建好服务提供者后，就可以将它加入到 <code>app/config/app.php</code> 配置文件的 <code>providers</code> 数组里。</p>
<blockquote>
<p><strong>Wear The Boot 注意启动流程</strong></p>
<p>记住在上面的例子里面，我们在 <code>boot</code> 方法里进行编写是有原因的。<code>register</code> 方法只能用来进行依赖注入绑定。</p>
</blockquote>
<h3 id="Error-Handlers-错误处理"><a href="#Error-Handlers-错误处理" class="headerlink" title="Error Handlers 错误处理"></a>Error Handlers 错误处理</h3><p>如果你的应用里面有很多自定义的错误处理方法，那你的“启动”文件可能会很臃肿。和刚才的事件监听器一样，错误处理方法也最好放到服务提供者里面。这种服务提供者可以命名为像 <code>QuickBillErrorProvider</code> 这种。然后你在 <code>boot</code> 方法里想注册多少错误处理方法都可以了。重申一下精神：让呆板的代码离你应用的业务逻辑越远越好。下方展示了这种服务提供者的一种可能的书写方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="keyword">namespace</span> <span class="title">QuickBill</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuickBillErrorProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    App::error(<span class="function"><span class="keyword">function</span><span class="params">(BillingFailedException $e)</span> </span>&#123;</div><div class="line">      <span class="comment">// Handle failed billing exceptions ...</span></div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><strong>The Small Solution 简便做法</strong></p>
<p>当然如果你只有一两条简单的处理错误方法，那么都写在“启动”文件里面也是一种又快又好的简便做法。</p>
</blockquote>
<h3 id="The-Rest-其他"><a href="#The-Rest-其他" class="headerlink" title="The Rest 其他"></a>The Rest 其他</h3><p>通常只要遵循 PSR-0（译者注：或 PSR-4）就可以保持类的整洁。命令式的代码比如事件监听器、错误处理器还有其他“注册”性质的操作都可以放在服务提供者里面。对于什么代码要放在什么地方这个问题，结合你目前为止学到的知识，应当可以给出一个有理有据的答案了。但永远不要害怕试验。</p>
<p>Laravel 最美妙之处就是你可以做出最适合你自己的风格。去探索和发现最适合你自己应用的结构吧，别忘了和他人分享你的见解！</p>
<p>例如你可能注意到我们上面的例子，你可以创建个 <code>Providers</code> 的命名空间来存放你自己写的服务提供者，目录就类似于这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// app</span></div><div class="line">  <span class="comment">// QuickBill</span></div><div class="line">    <span class="comment">// Billing</span></div><div class="line">    <span class="comment">// Extensions</span></div><div class="line">      <span class="comment">//Pagination</span></div><div class="line">        -&gt; Environment.php</div><div class="line">    <span class="comment">// Providers</span></div><div class="line">      -&gt; EventPusherServiceProvider.php</div><div class="line">    <span class="comment">// Repositories</span></div><div class="line">    User.php</div><div class="line">    Payment.php</div></pre></td></tr></table></figure>
<p>看上面的例子我们有 <code>Providers</code> 和 <code>Extensions</code> 两个命名空间（译者注：分别对应两个同名目录）。你自己写的服务提供者可以放到 <code>Providers</code> 命名空间下。那个 <code>Extensions</code> 命名空间可以用来存放你对框架核心进行扩展的类。</p>
<p>译文地址：<a href="http://my.oschina.net/zgldh/blog/389246" target="_blank" rel="external">http://my.oschina.net/zgldh/blog/389246</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/10/laravel-from-apprentice-to-artisan-service-providers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/10/laravel-from-apprentice-to-artisan-service-providers/" itemprop="url">从百草园到三味书屋 —— 服务提供者</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-10T12:39:24+08:00">
                2016-07-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Service-Providers-服务提供者"><a href="#Service-Providers-服务提供者" class="headerlink" title="Service Providers 服务提供者"></a>Service Providers 服务提供者</h1><h2 id="As-Bootstrapper-他是引导程序"><a href="#As-Bootstrapper-他是引导程序" class="headerlink" title="As Bootstrapper 他是引导程序"></a>As Bootstrapper 他是引导程序</h2><p>一个 Laravel 服务提供者就是一个用来进行 IoC 绑定的类。事实上，Laravel 有好几十个服务提供者，用于管理框架核心组件的容器绑定。几乎框架里每一个组件的 IoC 绑定都是靠服务提供者来做的。你可以在 <code>app/config/app.php</code> 这个文件里查看目前有哪些服务提供者。</p>
<p>一个服务提供者必须有一个 <code>register</code> 方法。你可以在这个方法里写 IoC 绑定。当一个请求发过来，程序框架刚启动时，所有在你配置文件里的服务提供者的 <code>register</code> 方法就会被调用。这在程序周期的很早的地方就会执行，所以在你自己的引导程序（比如那些在 <code>start</code> 目录里的文件）里所有的服务已经准备好了。</p>
<blockquote>
<p><strong>Register Vs. Boot 注册 Vs 引导代码</strong></p>
<p>永远不要在 <code>register</code> 方法里面使用任何服务。该方法只是用来进行 IoC 绑定的地方。所有关于绑定类后续的判断、交互都要在 <code>boot</code> 方法里进行。</p>
</blockquote>
<p>你用 Composer 安装的一些第三方包也会有服务提供者。在第三方包的安装说明里一般都会告诉你要在 <code>provider</code> 数组里加上一行。一旦你加上了，那这个服务就算安装好了。</p>
<blockquote>
<p><strong>Package Providers 包提供者</strong></p>
<p>不是所有的第三方包都需要服务提供者。事实上一个包并不需要服务提供者。因为服务提供者只是一个用来自动初始化服务组件的地方，一个方便管理引导代码和容器绑定的地方。</p>
</blockquote>
<h2 id="Deferred-Providers-延迟加载的服务提供者"><a href="#Deferred-Providers-延迟加载的服务提供者" class="headerlink" title="Deferred Providers 延迟加载的服务提供者"></a>Deferred Providers 延迟加载的服务提供者</h2><p>并非在你配置文件中的 <code>providers</code> 数组里的所有提供者在每次请求都会被实例化。否则会对性能不利，尤其是这个服务的功能用不到的情况下。比如，<code>QueueServiceProvider</code> 服务就不是每次都用得到。</p>
<p>为了达到只实例化需要的服务的提供者，Laravel 生成了“服务清单”并且存储在 <code>app/storage/meta</code> 目录下。这份清单列出了应用里所有的服务提供者，包括容器绑定的名字也记录了。这样，当应用想让容器取出一个名为 <code>queue</code> 的绑定时，Laravel 知道需要先实例化并运行 <code>QueueServiceProvider</code> 因为在服务清单里记录着该服务提供者能提供 <code>queue</code> 的绑定。如此这般框架就能够延迟加载每个请求需要的服务了，性能大大提高。</p>
<blockquote>
<p><strong>Mainifest Generation 如何生成服务清单</strong></p>
<p>当你在 <code>providers</code> 数组里新增一条，Laravel 在下一次请求时就会自动重新生成服务清单。</p>
</blockquote>
<p>如果你有时间，去看看服务清单文件里面的内容。理解这个文件的结构有助于你对服务进行排错。</p>
<h2 id="As-Organizer-作为管理工具"><a href="#As-Organizer-作为管理工具" class="headerlink" title="As Organizer 作为管理工具"></a>As Organizer 作为管理工具</h2><p>想制作一个结构优美的 Laravel 应用的话，就要去学习如何用服务提供者来管理代码。当你在注册 IoC 绑定的时候，所有代码都杂乱的塞进了 <code>app/start</code> 路径下的文件里。别再这样做了，使用服务提供者来注册这些吧。</p>
<blockquote>
<p><strong>Get It Started 万物之初</strong></p>
<p>你应用的“启动”文件都储存在 <code>app/start</code> 目录下。根据不同的请求入口，系统会载入不同的启动文件。在全局的 <code>start.php</code> 文件加载后，系统会根据执行环境的不同来加载不同的启动文件。此外，在执行命令行程序时，<code>artisan.php</code> 文件会被载入。</p>
</blockquote>
<p>咱们来考虑这个例子。也许我们的应用正在使用 Pusher 来作为客户推送消息。为了将我们的应用和 Pusher 解耦，我们要定义 <code>EventPusherInterface</code> 接口会对应的实现类 <code>PusherEventPusher</code>。这样在需求变化和应用改进时，我们就可以随时轻松的改变推送服务提供商。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">EventPusherInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">push</span><span class="params">($message, array $data = array<span class="params">()</span>)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PusherEventPusher</span> <span class="keyword">implements</span> <span class="title">EventPusherInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(PusherSdk $pusher)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;pusher = $pusher;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">push</span><span class="params">($message, array $data = array<span class="params">()</span>)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="comment">// Push message via the Pusher SDK...</span></div><div class="line">  &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来我们创建一个 <code>EventPusherServiceProvider</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventPusherServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;app-&gt;singleton(<span class="string">'PusherSdk'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> PusherSdk(<span class="string">'app-key'</span>, <span class="string">'secret-key'</span>); </div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;app-&gt;singleton(<span class="string">'EventPusherInterface'</span>, <span class="string">'PusherEventPusher'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很好！我们对事件推送进行了清晰的抽象，同时我们也有了一个很不错的地方进行注册、绑定其他相关的东西到容器里。最后一步只需要将 <code>EventPusherServiceProvider</code> 写入 <code>app/config/app.php</code> 文件内的 <code>provider</code> 数组里就可以了。现在这个应用里的 <code>EventPusherInterface</code> 已经被绑定到了正确的实现类上。</p>
<blockquote>
<p><strong>Should You Singleton？要使用单例么？</strong></p>
<p>用不用单例可以这样来考虑：如果在一次请求周期中该类只需要有一个实例，就使用 <code>singleton</code>；否则就使用 <code>bind</code>。</p>
</blockquote>
<p>你也可以使用 <code>App</code> facade：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">App::singleton(<span class="string">'EventPusherInterface'</span>, <span class="string">'PusherEventPusher'</span>);</div></pre></td></tr></table></figure>
<p>当然服务提供者的功能不仅仅局限于消息推送。像是云存储、数据库访问、自定义的视图引擎比如 Twig 等等都可以用这种模式来设置。服务提供者就是你的应用里的启动代码和管理工具，没什么神器的。</p>
<p>所以大胆的去创建你自己的服务提供者。并不是你非要发布个什么软件包才需要服务提供者，他们只是非常好的管理代码的工具。使用它们的力量去管理好应用中的各个组件吧。</p>
<h2 id="Booting-Providers-服务提供者的启动过程"><a href="#Booting-Providers-服务提供者的启动过程" class="headerlink" title="Booting Providers 服务提供者的启动过程"></a>Booting Providers 服务提供者的启动过程</h2><p>在所有服务提供者都注册以后，他们就进入了“启动”过程。该过程会触发每个服务提供者的 <code>boot</code> 方法。这里会发生一种常见的错误用法：在 <code>register</code> 方法里面调用其他的服务。由于在 <code>register</code> 方法里我们不能保证所有其他服务都已经被加载，所以在该方法里调用别的服务有可能会出错。所以如果你想在服务提供者里调用别的服务，请在 <code>boot</code> 方法里做这种事儿。<code>register</code> 方法只能进行容器注册。</p>
<p>在启动方法里面，你想做什么都可以：注册事件监听，引入路由文件，注册过滤器，或者其他你能想象到的事儿。再强调一下，要发挥服务提供者的管理功能。可能你想将相关的多个事件监听归为一组？将他们放到一个服务提供者的 <code>boot</code> 方法里，这会很管用的！或者你也可以引入单独的 “events”、”routes” PHP 文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/events.php'</span>;</div><div class="line">  <span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/routes.php'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们已经学习了依赖注入以及如何使用服务提供者来组织管理我们的项目。这样我们的 Laravel 应用就有了一个很好的基础，它结构优美且易于维护和测试。接下来，我们将探索 Laravel 框架本身是如何使用服务提供者的，并且深究其原理！</p>
<blockquote>
<p><strong>Don’t Box Yourself In 不要让条条框框限制你自己</strong></p>
<p>记住，服务提供者不仅仅是专业的软件包才能使用。请大胆的使用它来组织管理你的应用服务吧。</p>
</blockquote>
<h2 id="Providing-The-Core-核心也是服务提供者的模式"><a href="#Providing-The-Core-核心也是服务提供者的模式" class="headerlink" title="Providing The Core 核心也是服务提供者的模式"></a>Providing The Core 核心也是服务提供者的模式</h2><p>你可能已经注意到，在 <code>app</code> 配置文件里面已经有了很多服务提供者。每一个都负责启动框架核心的一部分。比如 <code>MigrationServiceProvider</code> 负责启动数据库迁移的类，包括 Artisan 里面的命令。<code>EventServiceProvider</code> 负责启动和注册事件调度机制。不同的服务提供者有着不同的复杂度，但他们都负责启动核心的一部分。</p>
<blockquote>
<p><strong>Meet Your Providers 和服务提供者们见见面</strong></p>
<p>理解 Laravel 核心的最好方法是去读它的核心服务源码。如果你对这些服务的源码、容器注册等都很熟悉，那么你对 Laravel 是如何工作的将会有十分深刻的理解。</p>
</blockquote>
<p>大部分的服务提供者是延迟加载的，意味着并非所有请求都会调用他们；然而又一些很基础的服务是每一次请求都会被加载的，比如 <code>FilesystemServiceProvider</code> 和 <code>ExceptionServiceProvider</code>。有人会说核心服务提供者和应用程序容器就是 Laravel。Laravel 其实是将这么多不同部分联系起来，形成一个单一的、内聚的整体的这么一个机制。拿建筑来比喻，那些服务提供者就是框架的预制模块。</p>
<p>正如之前提到的那样，如果你想更深的了解框架是如何运行的，请读 Laravel 的核心服务的源码吧。读过之后，你会对框架如何将各个部分组合在一起、每一个服务是如何为你所有这些机制有更坚实的理解。此外，有了这些进一步的理解，你也可以为 Laravel 添砖加瓦！</p>
<p>译文地址：<a href="http://my.oschina.net/zgldh/blog/389246" target="_blank" rel="external">http://my.oschina.net/zgldh/blog/389246</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Dearmadman</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">100</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dearmadman</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
