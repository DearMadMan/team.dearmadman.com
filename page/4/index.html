<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Team.dearmadman.com">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="Team.dearmadman.com">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Team.dearmadman.com">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/"/>





  <title>Team.dearmadman.com</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Team.dearmadman.com</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do it.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/10/laravel-from-apprentice-to-artisan-interface-as-contract/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/10/laravel-from-apprentice-to-artisan-interface-as-contract/" itemprop="url">从百草园到三味书屋 —— 接口约定</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-10T08:59:51+08:00">
                2016-07-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Interface-As-Contract-接口约定"><a href="#Interface-As-Contract-接口约定" class="headerlink" title="Interface As Contract 接口约定"></a>Interface As Contract 接口约定</h1><h2 id="Strong-Typing-amp-Water-Fowl-强类型和小鸭子"><a href="#Strong-Typing-amp-Water-Fowl-强类型和小鸭子" class="headerlink" title="Strong Typing &amp; Water Fowl 强类型和小鸭子"></a>Strong Typing &amp; Water Fowl 强类型和小鸭子</h2><p>在之前的章节里，涵盖了依赖注入的基础知识：什么是依赖注入；如何实现依赖注入；依赖注入有什么好处。之前章节里面的例子也模拟了将 interface 注入到 classes 里面的过程。在我们继续学习之前，有必要深入讲解一下接口，而这正是很多 PHP 开发者所不熟悉的。</p>
<p>在我成为 PHP 程序员之前，我是写 .NET 的。你觉得我是 M 吗？在 .NET 里可到处都是接口。事实上很多接口是定义在 .NET 框架核心中了，一个好的理由是：很多 .NET 语言比如 C# 和 VB.NET 都是强类型的。也就是说，你在给一个函数传值，要么传原生类型对象，要么就必须给这个对象一个明确的类型定义。比如考虑以下 C# 方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public int BillUser(User user) &#123;</div><div class="line">  this.biller.bill(user.GetId(), this.amount)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意在这里，我们不仅要定义传进去的参数是什么类型的，还要定义这个方法返回值是什么类型的。C# 鼓励类型安全。除了指定的 <code>User</code> 对象，它不允许我们传递其他类型的对象到 <code>BillUser</code> 方法中。</p>
<p>然而 PHP 是一种鸭子类型的语言。所谓鸭子类型的语言，一个对象可用的方法取决于使用方式，而非这个方法从哪儿继承或实现。来看个例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">billUser</span><span class="params">($user)</span> </span>&#123;</div><div class="line">  <span class="keyword">$this</span>-&gt;biller-&gt;bill($user-&gt;getId(), <span class="keyword">$this</span>-&gt;amount);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 PHP 里面，我们不必告诉一个方法需要什么类型的参数。实际上我们传递任何类型的对象都可以，只要这个对象能响应 <code>getId</code> 的调用。这里有个关于鸭子类型（下文译作：弱类型）的解释：如果一个东西看起来像个鸭子，叫声也像鸭子叫，那他就是个鸭子。换言之在程序里，一个对象看上去是个 User，方法响应也像个 User，那他就是个 User。</p>
<p>不过 PHP 到底有没有任何强类型功能呢？当然有！PHP 混合了强类型和弱类型的结构。为了说明这点，咱们来重写一下 <code>billUser</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">billUser</span><span class="params">(User $user)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">$this</span>-&gt;biller-&gt;bill($user-&gt;getId(), $amount);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>给方法加上了 <code>User</code> 类型提示后，我们可以确信的说所有传入 <code>billUser</code> 方法的参数，都是 <code>User</code> 类或是继承自 <code>User</code> 类的一个实例。</p>
<p>强类型和弱类型各有优劣。在强类型语言中，编译器通常能提供编译时错误检查的功能，这功能可是非常有用的。方法的输入和输出也更加明确。</p>
<p>与此同时，强类型的特性也使得程序僵化。比如 Eloquent ORM 中，类似 <code>whereEmailOrName</code> 的动态方法就不可能在 C# 这样的强类型语言里实现。我们不讨论强类型弱类型哪种更好，而是要记住他们分别的优劣之处。在 PHP 里面使用强类型标记不是错误，使用弱类型特性也不是错误。但是不加思索，不管实际情况去使用一种模式，这么固执的使用就是错的。</p>
<h2 id="A-Contract-Example-约定的范例"><a href="#A-Contract-Example-约定的范例" class="headerlink" title="A Contract Example 约定的范例"></a>A Contract Example 约定的范例</h2><p>接口就是约定。接口不包含任何代码实现，只是定义了一个对象应该实现的一系列方法。如果一个对象实现了一个接口，那么我们就能确信这个接口所定义的一系列方法都能在这个对象上使用。因为有约定保证了特定方法的实现标准，通过多态也能使类型安全的语言变得更灵活。</p>
<blockquote>
<p>Polywhat？多什么态？</p>
<p>多态含义很广，其本质上是说一个实体拥有多种形式。在本书中，我们讲多态是一个接口有着多种实现。比如 <code>UserRepositoryInterface</code> 可以有 MySQL 和 Redis 两种实现，每一种实现都是 <code>UserRepositoryInterface</code> 的一个实例。</p>
</blockquote>
<p>为了说明在强类型语言中接口的灵活性，咱们来写一个酒店客房预订的代码。考虑以下接口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ProviderInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getLowestPrice</span><span class="params">($location)</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">book</span><span class="params">($location)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当用户订房间时，我们需要将此事记录在系统里。所以在 <code>User</code> 类里面写点方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bookLocation</span><span class="params">(ProviderInterface $provider, $location)</span> </span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $amountCharged = $provider-&gt;book($location);</div><div class="line">    <span class="keyword">$this</span>-&gt;logBookedLocation($location, $amountCharged);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为我们写出了 <code>ProviderInterface</code> 的类型提示，该 <code>User</code> 类的就可以放心大胆的认为 <code>book</code> 方法是可以调用的。这使得 <code>bookLocation</code> 方法有了重用性。当用户想要换一家酒店提供商时也就更灵活。最后咱们来写点代码来强化他的灵活性。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$location = <span class="string">'Hilton, Dallas'</span>;</div><div class="line"></div><div class="line">$cheapestProvider = <span class="keyword">$this</span>-&gt;findCheapest($location, <span class="keyword">array</span>(</div><div class="line">  <span class="keyword">new</span> PricelineProvider,</div><div class="line">  <span class="keyword">new</span> OrbitzProvider,</div><div class="line">));</div><div class="line"></div><div class="line">$user-&gt;bookLocation($cheapestProvider, $location);</div></pre></td></tr></table></figure>
<p>太棒了！不管哪家是最便宜的，我们都能够将他传入 <code>User</code> 对象来预订房间了。由于 <code>User</code> 对象只需要有一个符合 <code>ProviderInterface</code> 约定的实例就可以预订房间，所以未来有更多的酒店供应商我们的代码也可以很好的工作。</p>
<blockquote>
<p>Forget The Details 忘掉细节</p>
<p>记住，接口实际上不真正做任何事情。它只是简单的定义了类们必须实现的一系列方法。</p>
</blockquote>
<h2 id="Interfaces-amp-Team-Development-接口与团队开发"><a href="#Interfaces-amp-Team-Development-接口与团队开发" class="headerlink" title="Interfaces &amp; Team Development 接口与团队开发"></a>Interfaces &amp; Team Development 接口与团队开发</h2><p>当你的团队在开发大型应用时，不同的部分有着不同的开发速度。比如一个开发人员在制作数据层，另一个开发人员在做前端和网站控制器层。前端开发者想测试他的控制器，不过后端开发较慢没法同步测试。那如果两个开发者能以接口的方式达成协议，后台开发的各种类都遵循这种协议，就像这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">OrderRepositoryInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getMostRecent</span><span class="params">(User $user)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一旦建立了约定，就算约定还没实现，前端开发者也可以测试他的控制器了！这样应用中的不同组件就可以按不同的速度开发，并且单元测试也可以做。而且这种处理方法还可以使组件内部的改动不会影响到其他不相关组件。要记着无知是福。我们写的那些类们不用知道别的类如何实现，只要知道它们能实现什么。这下咱们有了定义好的约定，再来写控制器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(OrderRepositoryInterface $orders)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;orders = $orders;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRecent</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $recent = <span class="keyword">$this</span>-&gt;orders-&gt;getMostRecent(Auth::user());</div><div class="line">    <span class="keyword">return</span> View::make(<span class="string">'orders.recent'</span>, compact(<span class="string">'recent'</span>));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>前端开发者甚至可以为这接口写个“假”实现，然后这个应用的视图就可以用假数据填充了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DummyOrderRepository</span> <span class="keyword">implements</span> <span class="title">OrderRepositoryInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getMostRecent</span><span class="params">(User $user)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">'Order 1'</span>, <span class="string">'Order 2'</span>, <span class="string">'Order 3'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一旦假实现写好了，就可以被绑定到 IoC 容器里，然后整个程序都可以调用他了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">App::bind(<span class="string">'OrderRepositoryInterface'</span>, <span class="string">'DummyOrderRepository'</span>);</div></pre></td></tr></table></figure>
<p>接下来一旦后台开发者写完了真正的实现代码，比如叫 <code>RedisOrderRepository</code>。那么 IoC 容器就可以轻易的切换到真正的实现上。整个应用就会使用 Redis 读出来的数据。</p>
<blockquote>
<p>Interface As Schematic 接口就是大纲</p>
<p>接口在开发程序的“骨架”时非常有用。在设计组件时，使用接口进行设计和讨论都是对你的团队有益处的。比如定义一个 <code>BillingNotifierInterface</code> 然后讨论他有什么方法。在写任何实现代码前先用接口讨论好一套好的 API！</p>
</blockquote>
<p>译文地址：<a href="http://my.oschina.net/zgldh/blog/389246" target="_blank" rel="external">http://my.oschina.net/zgldh/blog/389246</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/08/larave-from-apprentice-to-artisan-the-ioc-container/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/08/larave-from-apprentice-to-artisan-the-ioc-container/" itemprop="url">从百草堂到三味书屋 —— 控制反转容器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-08T17:28:17+08:00">
                2016-07-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="The-IoC-Container-控制反转容器"><a href="#The-IoC-Container-控制反转容器" class="headerlink" title="The IoC Container 控制反转容器"></a>The IoC Container 控制反转容器</h1><h2 id="Basic-Binding-基础绑定"><a href="#Basic-Binding-基础绑定" class="headerlink" title="Basic Binding 基础绑定"></a>Basic Binding 基础绑定</h2><p>我们已经学习了依赖注入，接下来咱们一起来探索“控制反转容器”（IoC）。IoC 容器可以使你更容易管理依赖注入，Laravel 框架拥有一个很强大的 IoC 容器。Laravel 的核心就是这个 IoC 容器，这个 IoC 容器使得框架各个组件能很好的在一起工作。事实上 Laravel 的 Application 类就是继承自 Container 类！</p>
<blockquote>
<p><strong>IoC Container 控制反转容器</strong></p>
<p>控制反转容器使得依赖注入更方便。当一个类或接口在容器里定义以后，如何处理它们——如何在应用中管理、注入这些对象？</p>
</blockquote>
<p>在 Laravel 应用里，你可以通过 App 来访问控制反转容器。容器有很多方法，不过我们从最基础的开始。让我们继续使用上一章写的 <code>BillerInterface</code> 和 <code>BillingNotifierInterface</code>，且假设我们使用了 Stripe 来进行支付操作。我们可以将 Stripe 的支付实现绑定到容器里，就像这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">App::bind(<span class="string">'BillerInterface'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> StripeBiller(App::make(<span class="string">'BillingNotifierInterface'</span>));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>注意在我们处理 <code>BillingInterface</code> 时，我们额外需要一个 <code>BillingNotifierInterface</code> 的实现，也就是再来一个 bind:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">App::bind(<span class="string">'BillingNotifierInterface'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> EmailBillingNotifier; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>如你所见，这个容器就是个用来存储各种绑定的地方（译者注：这么理解简单点。再扯匿名函数、闭包就扯远了。）。一旦一个类在容器里绑定了以后，我们可以很容易的在应用的任何位置调用它。我们甚至可以在 bind 函数内写另外的 bind。</p>
<blockquote>
<p><strong>Have Acne?</strong></p>
<p>Laravel 框架的 Illuminate 容器和另一个名为 <a href="https://github.com/fabpot/pimple" target="_blank" rel="external">Pimple</a> 的 IoC 容器是可替换的。所以如果你之前用的是 Pimple，你尽可以大胆的升级为 <a href="https://github.com/jilluminate/container" target="_blank" rel="external">Illuminate Container</a>，后者还有更多新功能!</p>
</blockquote>
<p>一旦我们使用了容器，切换接口的实现就是一行代码的事儿。比如考虑以下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BaseController</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(BillerInterface $biller)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;biller = $biller;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当这个控制器通过被容器实例化后，包含着 <code>EmailBillingNotifier</code> 的 <code>StripeBiller</code> 会被注入到这个控制器中（译者注：见上文的两个 bind）。如果我们现在想要换一种提示方式，我们可以简单的将代码改为这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">App::bind(<span class="string">'BillingNotifierInterface'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> SmsBillingNotifier; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>现在不管在应用的哪里需要一个提示器，我们总会得到 <code>SmsBillingNotifier</code> 的对象。利用这种结构，我们的应用可以在不同的实现方式之间快速切换。</p>
<p>只改一行就能切换代码实现，这可是很厉害的能力。比如我们想把短信服务从原来的提供商替换为 Twilio。我们可以开发一个新的 Twilio 的提示器类（译者注：当然要继承自 <code>BillingNotifierInterface</code>）然后修改绑定语句。如果 Twilio 有任何闪失，我们只需修改一行代码就可以快速的切换回原来的短信提供商。看到了吧，依赖注入的好处多得很呢。你能再想出几个使用依赖注入和控制反转容器的好处么？</p>
<p>想在应用中只实例化某类一次？没问题，使用 <code>singleton</code> 方法吧：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">App::singleton(<span class="string">'BillingNotifierInterface'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> SmsBillingNotifier; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这样只要这个容器生成了这个提示器对象一次，在接下来的生成请求中容器都只会提供这同样的一个对象。</p>
<p>容器的 <code>instance</code> 方法和 <code>singleton</code> 方法很类似，区别是 <code>instance</code> 可以绑定一个已经存在的对象。然后容器每次返回的都是这个对象了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$notifier = <span class="keyword">new</span> SmsBillingNotifier;</div><div class="line">App::instance(<span class="string">'BillingNotifierInterface'</span>, $notifier);</div></pre></td></tr></table></figure>
<p>现在我们熟悉了容器的基础用法，让我们深入发掘它更强大的功能：依靠反射来处理类和接口。</p>
<blockquote>
<p><strong>Stand Alone Container 容器独立运行</strong></p>
<p>你的项目中没有使用 Laravel？但你依然可以使用 Laravel 的 IoC 容器！只要用 Composer 安装 <code>illuminate/container</code> 包就可以了。</p>
</blockquote>
<h2 id="Reflect-Resolution-反射解决方案"><a href="#Reflect-Resolution-反射解决方案" class="headerlink" title="Reflect Resolution 反射解决方案"></a>Reflect Resolution 反射解决方案</h2><p>用反射来自动处理依赖是 Laravel 容器的一个最强大的特性。反射是一种运行时探测类和方法的能力。比如，PHP 的 <code>ReflectionClass</code> 可以探测一个类的方法。<code>method_exists</code> 某种意义上说也是一种反射。我们来把玩一下 PHP 的反射类，试试下面的代码吧（StripeBiller 换成你自己定义好的类）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$reflection = <span class="keyword">new</span> ReflectionClass(<span class="string">'StripeBiller'</span>);</div><div class="line">var_dump($reflection-&gt;getMethods());</div><div class="line">var_dump($reflection-&gt;getConstans());</div></pre></td></tr></table></figure>
<p>依靠这个强大的 PHP 特性，Laravel 的 IoC 容器可以实现很有趣的功能！考虑接下来这个类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(StripBiller $biller)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;biller = $biller;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意这个控制器的构造函数暗示着有一个 <code>StripBiller</code> 类型的参数。使用反射就可以检测到这种类型暗示。当 Laravel 的容器无法解决一个类型的明显绑定时，容器会试着使用反射来解决。程序流程类似于这样的：</p>
<ul>
<li>已经有一个 <code>StripBiller</code> 的绑定了么？</li>
<li>没绑定？那用反射来探测一下 <code>StripBiller</code> 吧。看看他都需要什么依赖。</li>
<li>解决 <code>StripBiller</code> 需要的所有依赖（递归处理）</li>
<li>使用 <code>ReflectionClass-&gt;newInstanceArgs()</code> 来实例化 <code>StripBiller</code></li>
</ul>
<p>如你所见，容器替我们做了好多重活，这能帮你省去写大量绑定的麻烦。这就是 Laravel 容器最强大也最独特的特性。熟练掌握这种能力对构建大型 Laravel 应用是十分有益的。</p>
<p>下面我们修改一下控制器，改成这样会发生什么事儿呢？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(BillerInterface $biller)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;biller = $biller;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>假设我们没有为 <code>BillerInterface</code> 做任何绑定，容器该怎么知道要注入什么类呢？要知道，interface 不能被实例化，因为它只是个约定。如果我们不提供更多信息的话，容器是无法实例化这个依赖的。我们需要明确指出哪个类需要实现这个接口，这就需要用到 <code>bind</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">App::bind(<span class="string">'BillerInterface'</span>, <span class="string">'StripBiller'</span>);</div></pre></td></tr></table></figure>
<p>这里我们只传了一个字符串进去，而不是一个匿名函数。这个字符串告诉容器总是使用 <code>StripBiller</code> 来作为 <code>BillerInterface</code> 的实现类。此外我们也获得了只改一行代码即可轻松改变实现的能力。比如，假设我们需要切换到 Balanced Payments 作为我们的支付提供商，我们只需要新写一个 <code>BalancedBiller</code> 来实现 <code>BillerInterface</code> 接口，然后这样修改容器代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">App::bind(<span class="string">'BillerInterface'</span>, <span class="string">'BalancedBiller'</span>);</div></pre></td></tr></table></figure>
<p>我们的应用程序就装上了新的支付实现代码了！</p>
<p>你也可以使用 <code>singleton</code> 方法来实现单例模式。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">App::singleton(<span class="string">'BillerInterface'</span>, <span class="string">'StripBiller'</span>);</div></pre></td></tr></table></figure>
<blockquote>
<p>Master The Container 掌握容器</p>
<p>想了解更多关于容器的知识？去读源码！容器只有一个类 <code>Illuminate\Container\Container</code>。读完了你就对容器有更深入的认识了。</p>
</blockquote>
<p>译文地址：<a href="http://my.oschina.net/zgldh/blog/389246" target="_blank" rel="external">http://my.oschina.net/zgldh/blog/389246</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/08/laravel-from-apprentice-to-artisan-dependency-injection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/08/laravel-from-apprentice-to-artisan-dependency-injection/" itemprop="url">从百草堂到三味书屋 —— 依赖注入</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-08T15:38:47+08:00">
                2016-07-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Dependency-Injection-依赖注入"><a href="#Dependency-Injection-依赖注入" class="headerlink" title="Dependency Injection 依赖注入"></a>Dependency Injection 依赖注入</h1><p>Laravel 框架的基础是一个功能强大的控制反转容器（IoC container）。为了真正理解本框架，需要好好掌握该容器。然而我们需要了解，控制反转容器只是一种用于方便实现“依赖注入”的工具。但要实现依赖注入并不一定需要控制反转容器，只是用容器会更方便和容易一点。</p>
<p>首先来看看我们为何要使用依赖注入，它能带来什么好处。考虑下列代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BaseController</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getIndex</span><span class="params">()</span> </span>&#123;</div><div class="line">    $user = User::all();</div><div class="line">    <span class="keyword">return</span> View::make(<span class="string">'users.index'</span>, compact(<span class="string">'users'</span>));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码很简短，但我们要想测试这段代码的话就一定会和实际的数据库发生联系。也就是说，Eloquent ORM（译者注：Laravel 的数据库对象模型库）和该控制器有着紧耦合。如果不使用 Eloquent ORM，不连接到实际数据库，我们就没有办法运行或者测试这段代码。这段代码同时也违背了“关注分离”这个软件设计原则。简单讲：这个控制器知道的太多了。控制器不需要去了解数据是从哪儿来的，只要知道如何访问就行。控制器也不需要知道这数据是从 MySQL 或哪儿来的，只需要知道这数据目前是可用的。</p>
<blockquote>
<p>Separation Of Concerns 关注分离<br>每一个类都应该有单独的职责，并且该职责应完全被这个类封装。（译者注：我认为就是不要让多个类负责同样的职责）</p>
</blockquote>
<p>关注分离的好处就是能让 Web 控制器和数据访问解耦。这会使得实现存储迁移更容易，测试也会更容易。“Web”就仅仅是为你真正的应用做数据的传输了。</p>
<p>想象一下你有一个类似于监视器的程序，有着很多的线缆接口（HDMI，VGA，DVI 等等）。你可以通过不同的接口访问不同的监视器。把 Internet 想象成另一个插进你进程线缆接口。大部分显示器的功能是与线缆接口互相独立的。线缆接口只是一种传输机制就像 HTTP 是你程序的一种传输机制一样。所以我们不想把传输机制（控制器）和业务逻辑混在一起。这样的好处是很多其他的传输机制比如 API 调用、移动应用等都可以访问我们的业务逻辑。</p>
<p>那么我们就别再将控制器和 Eloquent ORM 耦合在一起了。咱们注入一个资料类库。</p>
<h2 id="Build-A-Contract-建立约定"><a href="#Build-A-Contract-建立约定" class="headerlink" title="Build A Contract 建立约定"></a>Build A Contract 建立约定</h2><p>首先我们定义一个接口，然后实现该接口。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UserRepositoryInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">all</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DbUserRepository</span> <span class="keyword">implements</span> <span class="title">UserRepositoryInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">all</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> User::all()-&gt;toArray();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后我们将该接口的实现注入我们的控制器。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UserRepositoryInterface $users)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;users = $users;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getIndex</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $user = <span class="keyword">$this</span>-&gt;users-&gt;all();</div><div class="line">    <span class="keyword">return</span> View::make(<span class="string">'users.index'</span>, compact(<span class="string">'users'</span>));</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们的控制器就完全和数据层面无关了。在这里无知是福！我们的数据可能来自 MySQL，MongoDB 或者 Redis。我们的控制器不知道也不需要知道他们的区别。仅仅做出了这么小小的改变，我们就可以独立于数据层来测试 Web 层了，将来切换存储实现也会很容易。</p>
<blockquote>
<p>Respect Boundaries 严守边界<br>记得要保持清醒的责任边界。控制器和路由是作为 HTTP 和你的应用程序之间的中间件来用的。当编写大型应用程序时，不要将你的领域逻辑混杂在其中（控制器、路由）。</p>
</blockquote>
<p>为了巩固学到的知识，咱们来写一个测试案例。首先，我们要模拟一个资料库然后绑定到应用的 IoC 容器里。然后，我们要保证控制器正确的调用了这个资料库：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testIndexActionBindsUsersFromRepository</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="comment">// Arrange...</span></div><div class="line">  $repository = Mockery::mock(<span class="string">'UserRepositoryInterface'</span>);</div><div class="line">  $repository-&gt;shouldReceive(<span class="string">'all'</span>)-&gt;once()-&gt;andReturn(<span class="keyword">array</span>(<span class="string">'foo'</span>));</div><div class="line">  App::instance(<span class="string">'UserRepositoryInterface'</span>, $repository);</div><div class="line">  <span class="comment">// Act...</span></div><div class="line">  $response = <span class="keyword">$this</span>-&gt;action(<span class="string">'GET'</span>, <span class="string">'UserController@getIndex'</span>);</div><div class="line"></div><div class="line">  <span class="comment">// Assert...</span></div><div class="line">  <span class="keyword">$this</span>-&gt;assertResponseOk();</div><div class="line">  <span class="keyword">$this</span>-&gt;assertViewHas(<span class="string">'users'</span>, <span class="keyword">array</span>(<span class="string">'foo'</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Are you Mocking Me 你在模仿我么？<br>在上面的例子里，我们使用了名为 <code>Mockery</code> 的模仿库。这个库提供了一套整洁且富有表达力的方法，用来模仿你写的类。Mockery 可以通过 Composer 安装。</p>
</blockquote>
<h2 id="Taking-It-Further-更进一步"><a href="#Taking-It-Further-更进一步" class="headerlink" title="Taking It Further 更进一步"></a>Taking It Further 更进一步</h2><p>让我们考虑另一个例子来巩固理解。可能我们想要去提醒用户该交钱了。我们会定义两个接口，或者约定。这些约定使我们在更改实际实现时更加灵活。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">BillerInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bill</span><span class="params">(array $user, $amount)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">BillingNotifierInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">notify</span><span class="params">(array $user, $amount)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接下来我们要写一个 <code>BillerInterface</code> 的实现：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StripeBiller</span> <span class="keyword">implements</span> <span class="title">BillerInterface</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(BillingNotifierInterface $notifier)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;notifier = $notifier;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bill</span><span class="params">(array $user, $amount)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="comment">// Bill the user via Stripe...</span></div><div class="line">    <span class="keyword">$this</span>-&gt;notifier-&gt;notify($user, $amount);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>只要遵守了每个类的职责划分，我们很容易将不同的提示器（notifier）注入到账单类里面。比如，我们可以注入一个 <code>SmsNotifier</code> 或者 <code>EmailNotifier</code>。账单类只要遵守了约定，就不用再考虑如何实现提示功能。只要是遵守约定（接口）的类，账单类都能用。这不仅仅是方便了我们的开发，而且我们还可以通过模拟 <code>BillingNotifierInterface</code> 来进行无痛测试。</p>
<blockquote>
<p>Be The Interface 使用接口<br>写接口可能看上去挺麻烦，但实际上能加速你的开发。你不用实现任何接口，就能使用模拟库来模拟你的接口，进而测试整个后台逻辑！</p>
</blockquote>
<p>那我们如何做依赖注入呢？很简单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$biller = <span class="keyword">new</span> StripeBiller(<span class="keyword">new</span> SmsNotifier);</div></pre></td></tr></table></figure>
<p>这就是依赖注入。biller 不需再考虑提醒用户的事儿，我们直接传给他一个提示器（notifier）。这种微小的改动能使你的应用焕然一新。你的代码马上就变得更容易维护，因为明确指定了类的职责边界。并且更容易测试，你只需使用模拟依赖即可。</p>
<p>那 IoC 容器呢？难道依赖注入不需要 IoC 容器么？当然不需要！在接下来的章节里面你会了解到，容器使得依赖注入更易于管理，但是容器不是依赖注入所必须的。只要遵循本章提出的原则，你可以在你任何的项目里面实施依赖注入，而不必管该项目是否使用了容器。</p>
<h2 id="Too-Much-Java？太像-Java-了？"><a href="#Too-Much-Java？太像-Java-了？" class="headerlink" title="Too Much Java？太像 Java 了？"></a>Too Much Java？太像 Java 了？</h2><p>有人会说使用接口让 PHP 代码看上去太像 Java 了 —— 即代码太啰嗦了 —— 你必须定义接口然后实现它，要多按好多下键盘。</p>
<p>对于小而简单的应用来说，以上说法也对。接口通常是不必要的。将代码耦合到那些你认为不会改变的地方也是可以的。在你确信不会改变的地方就没有必要使用接口了。架构师说“不会改变的地方是不存在的”。不过话说回来，有时候的确不会改。</p>
<p>在大型应用中接口是很有帮助的。和提升的代码灵活性、可测试性比起来，多敲键盘费的功夫就微不足道了。当你迅速的切换了代码实现的时候，你的经理一定会被你的神速吓一跳的。你也可以写出更适应变化的代码。</p>
<p>总而言之，记住本书提倡“简单”架构。如果你在写小程序的时候无法遵守接口原则，别觉得不好意思。要记住我们写代码是要快乐的写。如果你不喜欢写接口，那就先简单的写代码吧。日后再精进即可。</p>
<p>译文地址：<a href="http://my.oschina.net/zgldh/blog/389246" target="_blank" rel="external">http://my.oschina.net/zgldh/blog/389246</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/07/redirect-data-by-php-curl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/07/redirect-data-by-php-curl/" itemprop="url">使用 PHP Curl 做数据中转</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-07-07T16:55:34+08:00">
                2016-07-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="使用-PHP-Curl-做数据中转"><a href="#使用-PHP-Curl-做数据中转" class="headerlink" title="使用 PHP Curl 做数据中转"></a>使用 PHP Curl 做数据中转</h1><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><ul>
<li>收集头部信息</li>
<li>收集请求数据</li>
<li>转换头部信息为 CURL 头部请求格式</li>
<li>使用 Curl 进行转发</li>
</ul>
<h2 id="收集-HTTP-头信息"><a href="#收集-HTTP-头信息" class="headerlink" title="收集 HTTP 头信息"></a>收集 HTTP 头信息</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAllHeaders</span><span class="params">()</span> </span>&#123;</div><div class="line">    $headers = [];</div><div class="line">    <span class="keyword">foreach</span> ($_SERVER <span class="keyword">as</span> $name =&gt; $value) &#123;</div><div class="line">        <span class="keyword">if</span> (substr($name, <span class="number">0</span>, <span class="number">5</span>) == <span class="string">'HTTP_'</span>) &#123;</div><div class="line">            $headers[str_replace(<span class="string">' '</span>, <span class="string">'-'</span>, ucwords(strtolower(str_replace(<span class="string">'_'</span>, <span class="string">' '</span>, substr($name, <span class="number">5</span>)))))] = $value;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> $headers;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="使用-PHP-封装协议获取输入数据"><a href="#使用-PHP-封装协议获取输入数据" class="headerlink" title="使用 PHP 封装协议获取输入数据"></a>使用 PHP 封装协议获取输入数据</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$content = file_get_contents(<span class="string">'php://input'</span>)</div></pre></td></tr></table></figure>
<h2 id="转换头信息为-Curl-请求格式"><a href="#转换头信息为-Curl-请求格式" class="headerlink" title="转换头信息为 Curl 请求格式"></a>转换头信息为 Curl 请求格式</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$headers = getAllHeaders();</div><div class="line">$header_joins = [];</div><div class="line"><span class="keyword">foreach</span> ($headers <span class="keyword">as</span> $k =&gt; $v) &#123;</div><div class="line">    <span class="keyword">if</span> ($k == <span class="string">'X-Pingplusplus-Signature'</span> || $k == <span class="string">'Content-Type'</span>)</div><div class="line">    array_push($header_joins, $k . <span class="string">': '</span> . $v);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="使用-Curl-进行转发"><a href="#使用-Curl-进行转发" class="headerlink" title="使用 Curl 进行转发"></a>使用 Curl 进行转发</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">post</span><span class="params">($url, $headers, $raw_data)</span> </span>&#123;</div><div class="line">    $ch = curl_init();</div><div class="line">    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, <span class="string">"POST"</span>);  <span class="comment">// POST </span></div><div class="line">    curl_setopt($ch, CURLOPT_POSTFIELDS, $raw_data);  <span class="comment">// Post Data</span></div><div class="line">    curl_setopt($ch, CURLOPT_URL, $url);<span class="comment">//设置要访问的 URL</span></div><div class="line">    curl_setopt($ch, CURLOPT_USERAGENT, $user_agent); <span class="comment">//模拟用户使用的浏览器</span></div><div class="line">    @curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="number">1</span> );  <span class="comment">// 使用自动跳转</span></div><div class="line">    curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">60</span>);  <span class="comment">//设置超时时间</span></div><div class="line">    curl_setopt($ch, CURLOPT_AUTOREFERER, <span class="number">1</span> ); <span class="comment">// 自动设置Referer</span></div><div class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>); <span class="comment">// 收集结果而非直接展示</span></div><div class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers); <span class="comment">// 自定义 Headers</span></div><div class="line">    $result = curl_exec($ch);</div><div class="line">    curl_close($ch);</div><div class="line">    <span class="keyword">return</span> $result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// $result = post($url, $headers, $raw_data);</span></div></pre></td></tr></table></figure>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">// @ini_set('display_errors', 1);</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAllHeaders</span><span class="params">()</span> </span>&#123;</div><div class="line">    $headers = [];</div><div class="line">    <span class="keyword">foreach</span> ($_SERVER <span class="keyword">as</span> $name =&gt; $value) &#123;</div><div class="line">        <span class="keyword">if</span> (substr($name, <span class="number">0</span>, <span class="number">5</span>) == <span class="string">'HTTP_'</span>) &#123;</div><div class="line">            $headers[str_replace(<span class="string">' '</span>, <span class="string">'-'</span>, ucwords(strtolower(str_replace(<span class="string">'_'</span>, <span class="string">' '</span>, substr($name, <span class="number">5</span>)))))] = $value;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> $headers;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$content = file_get_contents(<span class="string">'php://input'</span>);</div><div class="line"></div><div class="line">$headers = getAllHeaders();</div><div class="line">$header_joins = [];</div><div class="line"><span class="keyword">foreach</span> ($headers <span class="keyword">as</span> $k =&gt; $v) &#123;</div><div class="line">    <span class="keyword">if</span> ($k == <span class="string">'X-Pingplusplus-Signature'</span> || $k == <span class="string">'Content-Type'</span>)</div><div class="line">    array_push($header_joins, $k . <span class="string">': '</span> . $v);</div><div class="line">&#125;</div><div class="line"></div><div class="line"> <span class="comment">// print_r($header_joins);die();</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">post</span><span class="params">($url, $headers, $raw_data)</span> </span>&#123;</div><div class="line">    $ch = curl_init();</div><div class="line">    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, <span class="string">"POST"</span>);  <span class="comment">// POST </span></div><div class="line">    curl_setopt($ch, CURLOPT_POSTFIELDS, $raw_data);  <span class="comment">// Post Data</span></div><div class="line">    curl_setopt($ch, CURLOPT_URL, $url);<span class="comment">//设置要访问的 URL</span></div><div class="line">    curl_setopt($ch, CURLOPT_USERAGENT, $user_agent); <span class="comment">//模拟用户使用的浏览器</span></div><div class="line">    @curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="number">1</span> );  <span class="comment">// 使用自动跳转</span></div><div class="line">    curl_setopt($ch, CURLOPT_TIMEOUT, <span class="number">60</span>);  <span class="comment">//设置超时时间</span></div><div class="line">    curl_setopt($ch, CURLOPT_AUTOREFERER, <span class="number">1</span> ); <span class="comment">// 自动设置Referer</span></div><div class="line">    curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>); <span class="comment">// 收集结果而非直接展示</span></div><div class="line">    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers); <span class="comment">// 自定义 Headers</span></div><div class="line">    $result = curl_exec($ch);</div><div class="line">    curl_close($ch);</div><div class="line">    <span class="keyword">return</span> $result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">$result = post(<span class="string">'http://rgjc6z4v2x.proxy.qqbrowser.cc/api/pingxx'</span>, $header_joins, $content);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> $result;</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/27/use-eslint-with-sublime-text/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/27/use-eslint-with-sublime-text/" itemprop="url">Sublime Text 中配置 ESLint</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-27T16:02:40+08:00">
                2016-06-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ESLint"><a href="#ESLint" class="headerlink" title="ESLint"></a>ESLint</h1><p>ESLint 是一个有效的代码质量控制工具，它可以根据预先制定的代码规范来避免低级代码错误的出现，以及保证代码样式风格的统一。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>你可以使用 npm 来安装 ESLint:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install eslint -g</div></pre></td></tr></table></figure>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><p>如果你首次使用 ESLint，那么你需要先设置一个配置文件，你可以在项目根目录下使用 <code>--init</code> 选项来生成:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">eslint --init</div></pre></td></tr></table></figure>
<p>如果项目根目录下没有 <code>package.json</code> 文件，它会提示你先使用 <code>npm init</code> 来初始化一个 <code>package.json</code> 文件。</p>
<p><code>eslint --init</code> 会提示你选择使用的代码样式，你可以根据需求进行选择，这里推荐如下选择：</p>
<ul>
<li>Use a popular style guide</li>
<li>Standard</li>
<li>JavaScript</li>
</ul>
<p>在这个过程中 eslint 会自主的进行 npm install 操作来安装相关依赖，在安装完成之后请注意是否有 <code>UNMET PEER DEPENDENCY</code> 项的依赖，这表示 NPM 无法自动的进行这个依赖的安装，你需要手动的去进行安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ├── UNMET PEER DEPENDENCY eslint-plugin-promise@^1.0.8</span></div><div class="line">npm install eslint-plugin-promise --save-dev</div></pre></td></tr></table></figure>
<h2 id="集成-Sublime-Text"><a href="#集成-Sublime-Text" class="headerlink" title="集成 Sublime Text"></a>集成 Sublime Text</h2><p>在 Sublime Text 中你需要安装两个插件：</p>
<ul>
<li>SublimeLinter</li>
<li>SublimeLinter-contrib-eslint</li>
</ul>
<p>然后通过 <code>Preferences-&gt;Package Settings-&gt;SublimeLinter-&gt;Settings - User</code> 进行集成：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"user"</span>: &#123;</div><div class="line">        "debug": true, # 开启 debug 选项</div><div class="line">        "delay": 0.25,</div><div class="line">        "error_color": "D02000",</div><div class="line">        "gutter_theme": "Packages/SublimeLinter/gutter-themes/Default/Default.gutter-theme",</div><div class="line">        "gutter_theme_excludes": [],</div><div class="line">        "lint_mode": "background",</div><div class="line">        "linters": &#123;</div><div class="line">            "eslint": &#123;</div><div class="line">                "@disable": false,</div><div class="line">                "args": [],</div><div class="line">                "excludes": []</div><div class="line">            &#125;,</div><div class="line">            "jshint": &#123;</div><div class="line">                "@disable": false,</div><div class="line">                "args": [],</div><div class="line">                "excludes": []</div><div class="line">            &#125;,</div><div class="line">            "php": &#123;</div><div class="line">                "@disable": false,</div><div class="line">                "args": [],</div><div class="line">                "excludes": []</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        "mark_style": "outline",</div><div class="line">        "no_column_highlights_line": false,</div><div class="line">        "passive_warnings": false,</div><div class="line">        "paths": &#123;</div><div class="line">            "linux": [],</div><div class="line">            "osx": [</div><div class="line">                "/Users/wang/.nvm/versions/node/v5.0.0/bin" # 设置 node 路径</div><div class="line">            ],</div><div class="line">            "windows": []</div><div class="line">        &#125;,</div><div class="line">        "python_paths": &#123;</div><div class="line">            "linux": [],</div><div class="line">            "osx": [],</div><div class="line">            "windows": []</div><div class="line">        &#125;,</div><div class="line">        "rc_search_limit": 3,</div><div class="line">        "shell_timeout": 10,</div><div class="line">        "show_errors_on_save": false,</div><div class="line">        "show_marks_in_minimap": true,</div><div class="line">        "syntax_map": &#123;</div><div class="line">            "html (django)": "html",</div><div class="line">            "html (rails)": "html",</div><div class="line">            "html 5": "html",</div><div class="line">            "javascript (babel)": "javascript",</div><div class="line">            "magicpython": "python",</div><div class="line">            "php": "html",</div><div class="line">            "python django": "python",</div><div class="line">            "pythonimproved": "python"</div><div class="line">        &#125;,</div><div class="line">        "warning_color": "DDB700",</div><div class="line">        "wrap_find": true</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>到这里，集成完成，如果你项目中的 JavaScript 代码风格不符合 <a href="https://github.com/feross/standard" target="_blank" rel="external">JavaScript Standard Style</a> 的话，Sublime Text 会给出异常提示。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/26/laravel-from-scratch-serialization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/26/laravel-from-scratch-serialization/" itemprop="url">laravel 基础教程 —— 序列化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-26T20:49:47+08:00">
                2016-06-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Eloquent-序列化"><a href="#Eloquent-序列化" class="headerlink" title="Eloquent: 序列化"></a>Eloquent: 序列化</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>当构建 JSON APIs 时，你需要经常的将你的模型和关联转换为数组或者 JSON 格式。Eloquent 包含了便捷的方法来进行这些转换，以及控制哪些属性应该包含在序列化之中。</p>
<h2 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h2><p><strong>转换模型到数组</strong></p>
<p>为了将一个模型和其关联加载的数据转换为数组，你需要使用 <code>toArray</code> 方法。这个方法是一个递归的方法，所以所有的属性和所有的关联（包括关联的关联）都会被转换为数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = App\User::with(<span class="string">'roles'</span>)-&gt;first();</div><div class="line"></div><div class="line"><span class="keyword">return</span> $user-&gt;toArray();</div></pre></td></tr></table></figure>
<p>你也可以将集合转换为数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$users = App\User::all();</div><div class="line"></div><div class="line"><span class="keyword">return</span> $users-&gt;toArray();</div></pre></td></tr></table></figure>
<p><strong>转换模型到 JSON</strong></p>
<p>你可以使用 <code>toJson</code> 方法来将一个模型转换为 JSON。就像 <code>toArray</code> 方法，<code>toJson</code> 方法也是递归方法，所以所有的属性和其关联将会被转换为 JSON：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="keyword">return</span> $user-&gt;toJson();</div></pre></td></tr></table></figure>
<p>另外，你可以转换模型或者集合到一个字符串中，它将会自动的调用 <code>toJson</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="keyword">return</span> (string) $user;</div></pre></td></tr></table></figure>
<p>由于模型和集合都会在转换为字符串时被自动的转换为 JSON。所以你可以直接在应用的路由或者控制器中返回 Eloquent 对象：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> App\User::all(); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="从-JSON-中隐藏属性"><a href="#从-JSON-中隐藏属性" class="headerlink" title="从 JSON 中隐藏属性"></a>从 JSON 中隐藏属性</h2><p>有时候你可能会选择限制一些属性的展示，比如，密码，这些本应包含在模型中的数值或者 JSON 中的属性。你可以在模型中定义 <code>$hidden</code> 属性来选择隐藏它们：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The attributes that should be hidden for arrays.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">protected</span> $hidden = [<span class="string">'password'</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：当隐藏一些关联时，你应该使用关联模型的名字，而不是动态属性的名字。</p>
</blockquote>
<p>另外，你也可以使用 <code>visible</code> 属性来定义一个白名单属性集来指明这些属性应该被包含在模型的数组或者 JSON 里：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The attributes that should be visible in arrays.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">protected</span> $visible = [<span class="string">'first_name'</span>, <span class="string">'last_name'</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>临时的修改属性的可见性</strong></p>
<p>如果你希望在给定的模型实例中来设置一些通常隐藏的属性为可见，你可以使用 <code>makeVisible</code> 方法。<code>makeVisible</code> 方法将返回模型实例，这样有利于链式调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> $user-&gt;makeVisible(<span class="string">'attribute'</span>)-&gt;toArray();</div></pre></td></tr></table></figure>
<p>同样，如果你希望在给定的模型实例中设置通常可见的属性为不可见，那么你可以使用 <code>makeHidden</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> $user-&gt;makeHidden(<span class="string">'attribute'</span>)-&gt;toArray();</div></pre></td></tr></table></figure>
<h2 id="追加值到-JSON"><a href="#追加值到-JSON" class="headerlink" title="追加值到 JSON"></a>追加值到 JSON</h2><p>偶尔，你可能需要在模型中添加一些数据库中不存在的字段的属性。那么，你需要先为这个值定义一个访问器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get the administrator flag for the user.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> bool</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getIsAdminAttribute</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;attributes[<span class="string">'admin'</span>] == <span class="string">'yes'</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当你创建完访问器之后，将其属性的名称添加到模型的 <code>appends</code> 属性中:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The accessors to append to the model's array form.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">protected</span> $appends = [<span class="string">'is_admin'</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当你在 <code>appends</code> 列表中加入属性之后，它就会被加入到模型的数组和 JSON 形式中。在 <code>appends</code> 数组中的属性也受到模型中的 <code>visible</code> 和 <code>hidden</code> 设置的约束。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/26/laravel-from-scratch-eloquent-mutators/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/26/laravel-from-scratch-eloquent-mutators/" itemprop="url">laravel 基础教程 —— 存取器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-26T19:55:45+08:00">
                2016-06-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Eloquent-存取器"><a href="#Eloquent-存取器" class="headerlink" title="Eloquent: 存取器"></a>Eloquent: 存取器</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>访问器和存储器允许你在获取或者设置 Eloquent 模型属性值时对其进行格式化操作。比如，你可能希望当一个值存储进数据库之前先对其进行 <a href="https://laravel.com/docs/5.2/encryption" target="_blank" rel="external">Laravel encrypter</a> 进行加密操作，并且可以在你通过模型访问的时候自动的进行该属性的解密。</p>
<p>除了可自定义的的访问器和存储器，Eloquent 也可以自动的将日期字段转换为 <a href="https://github.com/briannesbitt/Carbon" target="_blank" rel="external">Carbon</a> 实例，或者甚至是将字符串字段转换为 JSON。</p>
<h2 id="访问器-amp-存取器"><a href="#访问器-amp-存取器" class="headerlink" title="访问器 &amp; 存取器"></a>访问器 &amp; 存取器</h2><p><strong>定义一个访问器</strong></p>
<p>为了定义一个访问器，你需要在你的模型上创建一个 <code>getFooAttribute</code> 方法，其中的 <code>Foo</code> 是你需要进行访问的列名的驼峰方式的命名。在这个例子中，我们将定义一个 <code>first_name</code> 属性的访问器。这个访问器会在 Eloquent 尝试获取 <code>first_name</code> 属性值时触发：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get the user's first name.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> string $value</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> string</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFirstNameAttribute</span><span class="params">($value)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> ucfirst($value);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就如你所看到的，属性原始的值会被传递到访问器中，这允许你对原始值进行操作及返回格式化后的值。你只需要简单的访问 <code>first_name</code> 属性就可以从存取器中访问该值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$firstName = $user-&gt;first_name;</div></pre></td></tr></table></figure>
<p><strong>定义一个存储器</strong></p>
<p>为了定义一个存储器，你需要在你的模型上定义一个 <code>setFooAttribute</code> 方法，其中的 <code>Foo</code> 是你期望访问的列的驼峰样式的名称。那么，这一次，让我们为 <code>first_name</code> 属性定义一个存储器。这个存储器会在模型尝试设置 <code>first_name</code> 属性的值时进行调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Set the user's first name.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> string $value</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> string</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setFirstNameAttribute</span><span class="params">($value)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;attributes[<span class="string">'first_name'</span>] = strtolower($value);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>存储器会接收即将设置到属性中的值，这允许你对这个值进行操作，并将其设置到模型内部的 <code>$attributes</code> 属性中。所以，举个示例，如果我们尝试将 <code>first_name</code> 属性设置为 <code>Sally</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$user-&gt;first_name = <span class="string">'Sally'</span>;</div></pre></td></tr></table></figure>
<p>在这个例子中，<code>setFirstNameAttribute</code> 方法会被调用并伴随 <code>Sally</code> 值。存储器会应用 <code>strtolower</code> 方法将名字小写化然后将值设置到内部的 <code>$attributes</code> 数组中。</p>
<h2 id="日期存取器"><a href="#日期存取器" class="headerlink" title="日期存取器"></a>日期存取器</h2><p>默认的，Eloquent 会转换 <code>created_at</code> 和 <code>updated_at</code> 列为 <a href="https://github.com/briannesbitt/Carbon" target="_blank" rel="external">Carbon</a> 实例，这个实例可以提供多种有用的方法，并且它继承自原生 PHP 的 <code>DataTime</code> 类。</p>
<p>你可以自定义哪些字段可以进行自动的转换，甚至是完全禁用这种转换，你需要在你的模型中复写 <code>$dates</code> 属性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The attributes that should be mutated to dates</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">protected</span> $dates = [<span class="string">'created_at'</span>, <span class="string">'updated_at'</span>, <span class="string">'deleted_at'</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当一列被认为是日期时，你可以将其设置为 UNIX 时间戳，日期字符串（<code>Y-m-d</code>），时间字符串，和 <code>DateTime</code> / <code>Carbon</code> 实例，并且日期的值会自动的正确的存储到数据库中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$user-&gt;deleted_at = Carbon::now();</div><div class="line"></div><div class="line">$user-&gt;save();</div></pre></td></tr></table></figure>
<p>就如上面所述，当获取的属性是 <code>$dates</code> 属性所列出的值之一时，它会自动的被转换为 <code>Carbon</code> 实例，这允许你在属性上使用 Carbon 的一些方法:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="keyword">return</span> $user-&gt;deleted_at-&gt;getTimestamp();</div></pre></td></tr></table></figure>
<p>默认的，时间戳被格式化为 <code>Y-m-d H:i:s</code> 的格式。如果你希望自定义时间戳的格式，你需要在你的模型中设置 <code>$dateFormat</code> 属性。该属性将确定日期属性将如何存储到数据库中以及当模型进行序列化或者 JSON 化时如何展示：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The storage format of the model's date columns.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">protected</span> $dateFormat = <span class="string">'U'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="属性转换"><a href="#属性转换" class="headerlink" title="属性转换"></a>属性转换</h2><p>你可以在你的模型中定义 <code>$casts</code> 属性来提供一种方便的方式将属性转换为通用的数据类型。<code>$casts</code> 属性应该是一个数组，并且其每一项的键应该是需要进行转换的属性名，而其键所对应的值应该是你需要属性转换到的类型。支持的转换类型有：<code>integer</code>，<code>real</code>，<code>float</code>，<code>double</code>，<code>string</code>，<code>boolean</code>，<code>object</code>，<code>array</code>，<code>coolection</code>，<code>date</code>，<code>datetime</code>，和 <code>timestamp</code>。</p>
<p>比如，让我们转换 <code>is_admin</code> 属性，它在数据库中存储的值为一个整型（<code>0</code> 或者 <code>1</code>），我们将其转换为布尔值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The attributes that should be casted to native types.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">protected</span> $casts = [</div><div class="line">    <span class="string">'is_admin'</span> =&gt; <span class="string">'boolean'</span>,</div><div class="line">  ];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在，每当你访问 <code>is_admin</code> 属性时，其值都会被转换为布尔值，即使其在数据库中存储的整型值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="keyword">if</span> ($user-&gt;is_admin) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>数组转换</strong></p>
<p><code>array</code> 转换的类型对于存储序列化 JSON 值的列尤其有用。比如，如果数据库有一个 <code>TEXT</code> 类型的字段，并且其存储的是序列化的 JSON，如果你添加该属性的 <code>array</code> 转换，那么当你在 Eloquent 模型上访问这个属性时，它将会自动的进行反序列化为 PHP 的数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The attributes that should be casted to native types.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">protected</span> $casts = [</div><div class="line">    <span class="string">'options'</span> =&gt; <span class="string">'array'</span></div><div class="line">  ];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当你转义定义完成之后，你可以访问 <code>options</code> 属性，并且它会自动的被从 JSON 反序列化为 PHP 数组。当你设置值到 <code>options</code> 属性时，所给定的数组会自动的序列化为 JSON 格式，然后进行存储：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$options = $user-&gt;options;</div><div class="line"></div><div class="line">$options[<span class="string">'key'</span>] = <span class="string">'value'</span>;</div><div class="line"></div><div class="line">$user-&gt;options = $options;</div><div class="line"></div><div class="line">$user-&gt;save();</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/26/laravel-from-scratch-eloquent-collection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/26/laravel-from-scratch-eloquent-collection/" itemprop="url">laravel 基础教程 —— Eloquent 集合</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-26T19:23:09+08:00">
                2016-06-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Eloquent-集合"><a href="#Eloquent-集合" class="headerlink" title="Eloquent: 集合"></a>Eloquent: 集合</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>通过 Eloquent 来返回的多结果集是一个 <code>Illuminate\Database\Eloquent\Collection</code> 对象，这包括通过使用 <code>get</code> 方法或者通过访问关联模型所获得的结果。Eloquent 的集合对象继承自 Laravel 的 <a href="https://laravel.com/docs/5.2/collections" target="_blank" rel="external">基础集合</a>，所以它自然地继承了几十种流畅执行的方法来与 Eloquent 模型的底层数组进行交互。</p>
<p>当然，所有的集合都可作为迭代器使用，这允许你像普通数组一样对他们进行循环操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$users = App\User::where(<span class="string">'active'</span>, <span class="number">1</span>)-&gt;get();</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($users <span class="keyword">as</span> $user) &#123;</div><div class="line">  <span class="keyword">echo</span> $user-&gt;name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>事实上，集合要比数组强大的多，它提供了多种强大的接口方法可以直观的链式调用。比如，让我们删除所有未激活的用户，并且收集所有保留用户的首个名字：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$users = App\User::where(<span class="string">'active'</span>, <span class="number">1</span>)-&gt;get();</div><div class="line"></div><div class="line">$names = $users-&gt;regect(<span class="function"><span class="keyword">function</span> <span class="params">($user)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $user-&gt;active === <span class="keyword">false</span>; </div><div class="line">&#125;)</div><div class="line">-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($user)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $user-&gt;name;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：大多数的 Eloquent 集合方法都会返回一个 Eloquent 集合的实例，而 <code>pluck</code>，<code>keys</code>，<code>zip</code>，<code>collapse</code>，<code>flatten</code> 和 <code>flip</code> 方法返回基础集合的实例。</p>
</blockquote>
<h2 id="可用的方法"><a href="#可用的方法" class="headerlink" title="可用的方法"></a>可用的方法</h2><p>所有的 Eloquent 集合都继承自 <a href="https://laravel.com/docs/5.2/collections" target="_blank" rel="external">Laravel Collection</a> 对象。因此，所有继承自基础集合类的强大方法都是可用的。</p>
<h2 id="自定义集合"><a href="#自定义集合" class="headerlink" title="自定义集合"></a>自定义集合</h2><p>如果你需要使用自定义的 <code>Collection</code> 对象和自己的扩展方法，你需要在你的模型中复写 <code>newCollection</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">CustomCollection</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Create a new Eloquent Collection instance.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> array $models</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Collection</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">newCollection</span><span class="params">(array $models = [])</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CustomCollection($models);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一旦你定义完成 <code>newCollection</code> 方法，那么无论什么时候，Eloquent 返回的模型的 <code>Collection</code> 实例都会获取都你所自定义的集合。如果你想要应用中所有的模型都使用自定义的集合，那么你需要在所有模型所继承的基类中复写 <code>newCollection</code> 方法。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/25/laravel-from-scratch-eloquent-relationships/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/25/laravel-from-scratch-eloquent-relationships/" itemprop="url">laravel 基础教程 —— 关联模型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-25T22:55:22+08:00">
                2016-06-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Eloquent-关联模型"><a href="#Eloquent-关联模型" class="headerlink" title="Eloquent: 关联模型"></a>Eloquent: 关联模型</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>数据库中的表经常性的关联其它的表。比如，一个博客文章可以有很多的评论，或者一个订单会关联一个用户。Eloquent 使管理和协作这些关系变的非常的容易，并且支持多种不同类型的关联：</p>
<ul>
<li>一对一</li>
<li>一对多</li>
<li>多对多</li>
<li>远程一对多</li>
<li>多态关联</li>
<li>多态多对多关联</li>
</ul>
<h2 id="定义关联"><a href="#定义关联" class="headerlink" title="定义关联"></a>定义关联</h2><p>Eloquent 关联可以像定义方法一样在 Eloquent 模型类中进行定义。同时，它就像 Eloquent 模型自身一样也提供了强大的查询生成器。这允许关联模型可以链式的执行查询能力。比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$user-&gt;posts()-&gt;where(<span class="string">'active'</span>, <span class="number">1</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p>但是，在更深入的使用关联之前，让我们先来学习一下如何定义各种类型的关联。</p>
<h3 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h3><p>一对一的关联是最基础的关联。比如，一个 <code>User</code> 模型可能关联一个 <code>Phone</code>。我们需要在 <code>User</code> 模型上放置一个 <code>phone</code> 方法来定义这种关联。<code>phone</code> 方法应该返回一个基类 Eloquent 模型上 <code>hasOne</code> 方法的结果：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get the phone record associated with the user.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">phone</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasOne(<span class="string">'App\Phone'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>传递到 <code>hasOne</code> 方法的第一个参数应该是关联模型的名称。一旦关联被定义完成，我们可以使用 Eloquent 的动态属性来访问关联模型的记录。动态属性允许你访问关联函数，就像是它们是定义在模型中的属性一样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$phone = User::find(<span class="number">1</span>)-&gt;phone;</div></pre></td></tr></table></figure>
<p>Eloquent 假定所关联的外键是基于模型的名称的。在这个前提下，<code>Phone</code> 模型会自动的假定其拥有一个 <code>user_id</code> 外键。如果你希望修改这个惯例，你可以传递第二个参数到 <code>hasOne</code> 方法中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasOne(<span class="string">'App\Phone'</span>, <span class="string">'foreign_key'</span>);</div></pre></td></tr></table></figure>
<p>另外，Eloquent 也会假定外键应该在其上层模型上拥有一个匹配的 <code>id</code>（或者自定义的 <code>$primaryKey</code>）值。换句话说，Eloquent 会查询 <code>Phone</code> 记录中的 <code>user_id</code> 列所对应的用户的 <code>id</code> 列的记录。如果你希望关联使用 <code>id</code> 以外的值，你可以传递第三个参数到 <code>hasOne</code> 方法来指定自定义的键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasOne(<span class="string">'App\Phone'</span>, <span class="string">'foreign_key'</span>, <span class="string">'local_key'</span>);</div></pre></td></tr></table></figure>
<p><strong>定义相对的关联</strong></p>
<p>那么，我们可以从我们的 <code>User</code> 中访问 <code>Phone</code> 模型。现在，让我们在 <code>Phone</code> 模型上定义一个关联，让我们可以从 <code>Phone</code> 模型中访问其所属的 <code>User</code>。我们使用 <code>belongsTo</code> 方法来定义 <code>hasOne</code> 相对的关联：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Phone</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get the user that owns the phone.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsTo(<span class="string">'App\User'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在上面的例子中，Eloquent 将会尝试从 <code>Phone</code> 模型中的 <code>user_id</code> 字段中匹配查找 <code>id</code> 相同的 <code>User</code>。Eloquent 会依据所关联的模型的蛇形命名和 <code>_id</code> 来假定默认的外键名。事实上，如果在 <code>Phone</code> 模型上的外键不是 <code>user_id</code>，那么你可以传递自定义的外键名到 <code>belongsTo</code> 方法的第二个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Get the user that owns the phone.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsTo(<span class="string">'App\User'</span>, <span class="string">'foreign_key'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你的上级模型并没有使用 <code>id</code> 作为主键名，或者你希望下级模型关联一个不同的列。你可以传递第三个参数到 <code>belongsTo</code> 方法来指定上级模型表中的自定义键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Get the user that owns the phone.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsTo(<span class="string">'App\User'</span>, <span class="string">'foreign_key'</span>, <span class="string">'other_key'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h3><p>一个一对多的关联常常用来定义一个模型拥有其他任意数目的模型。比如，一个博客文章可以拥有很多条评论。就像其他的 Eloquent 关联一样，一对多关联在 Eloquent 模型中通过方法来进行定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get the comments for the blog post.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">comments</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasMany(<span class="string">'App\Comment'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>记住，Eloquent 会自动的根据 <code>Comment</code> 模型来判断合适的外键。依据惯例，Eloquent 会使用自身模型的蛇形命名和 <code>_id</code> 来作为外键。所以，在这个例子中，Eloquent 会假定 <code>Comment</code> 模型的外键是 <code>post_id</code>。</p>
<p>一旦关联定义完成之后，我们可以通过 <code>comments</code> 属性来访问所有关联的评论的集合。记住，由于 Eloquent 提供了动态属性，我们可以对关联函数进行访问，就像他们是在模型中定义的属性一样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$comments = App\Post::find(<span class="number">1</span>)-&gt;comments;</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($comments <span class="keyword">as</span> $comment) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，由于所有的关联都提供了查询生成器的功能，所以你可以在调用 <code>comments</code> 方法时继续的添加一些限制条件，你可以通过链式的调用进行查询条件的添加：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$comments = App\Post::find(<span class="number">1</span>)-&gt;comments()-&gt;where(<span class="string">'title'</span>, <span class="string">'foo'</span>)-&gt;first();</div></pre></td></tr></table></figure>
<p>就像 <code>hasOne</code> 方法，你可以通过添加额外的参数到 <code>hasMany</code> 方法中来重置外键和主键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasMany(<span class="string">'App\Comment'</span>, <span class="string">'foreign_key'</span>);</div><div class="line"></div><div class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasMany(<span class="string">'App\Comment'</span>, <span class="string">'foreign_key'</span>, <span class="string">'local_key'</span>);</div></pre></td></tr></table></figure>
<p><strong>定义相对的关联</strong></p>
<p>现在我们可以访问文章中所有的评论了，让我们为评论定义一个关联使其可以访问它的上层文章模型。为了定义一个 <code>hasMany</code> 相对的关联，你需要在下层模型中定义一个关联方法并调用 <code>belongsTo</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get the post that owns the comment.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsTo(<span class="string">'App\Post'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一旦关联被定义完成，我们就可以通过 <code>Comment</code> 模型的 <code>post</code> 动态属性来检索到其对应的 <code>Post</code> 模型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$comment = App\Comment::find(<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> $comment-&gt;post-&gt;title;</div></pre></td></tr></table></figure>
<p>在上面的例子中，Eloquent 会尝试从 <code>Comment</code> 模型中的 <code>post_id</code> 字段检索与其相对应 <code>id</code> 的 <code>Post</code> 模型。Eloquent 会使用关联模型的蛇形命名和 <code>_id</code> 来作为默认的外键。如果 <code>Comment</code> 模型的外键不是 <code>post_id</code>，你可以传递一个自定义的键名到 <code>belongsTo</code> 方法的第二个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Get the post that owns the comment.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsTo(<span class="string">'App\Post'</span>, <span class="string">'foreign_key'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果上层模型并没有使用 <code>id</code> 作为主键，或者你想在下层模型中关联其他的列，你可以传递第三个参数到 <code>belongsTo</code> 方法中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Get the post that owns the comment.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsTo(<span class="string">'App\Post'</span>, <span class="string">'foreign_key'</span>, <span class="string">'other_key'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h3><p>多对多的关联比 <code>hasOne</code> 和 <code>hasMany</code> 关联要稍微复杂一些。假如一个用户拥有多个角色，而角色又可以被其他的用户所共享。比如，多个用户可以拥有管理员的角色。如果定义这种关联，我们需要定义三个数据库表：<code>users</code>，<code>roles</code>，和 <code>role_user</code>。<code>role_user</code> 表的命名是以相关联的两个模型数据表来依照字母顺序命名，并且表中包含了 <code>user_id</code> 和 <code>role_id</code> 列。</p>
<p>多对多关联需要编写一个方法调用基础 Eloquent 类 <code>belongsToMany</code> 方法。比如，让我们在 <code>User</code> 模型中定义一个 <code>roles</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The roles that belong to the user.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">roles</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(<span class="string">'App\Role'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一旦关联被定义，你可以通过 <code>roles</code> 动态属性来访问用户的角色：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($user-&gt;roles <span class="keyword">as</span> $role) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，就像其他类型的关联，你可以调用 <code>roles</code> 方法并且链式调用查询条件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$roles = App\User::find(<span class="number">1</span>)-&gt;roles()-&gt;orderBy(<span class="string">'name'</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p>就如先前所提到的，Eloquent 会合并两个关联模型并依照字母顺序进行命名。当然你也可以随意的重写这个约定，你可以传递第二个参数到 <code>belongsToMany</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(<span class="string">'App\Role'</span>, <span class="string">'role_user'</span>);</div></pre></td></tr></table></figure>
<p>除了自定义合并数据表的名称之外，你也可以通过往 <code>belongsToMany</code> 方法传传递额外参数来自定义数据表里的键的字段名称。第三个参数是你定义在关联中模型外键的名称。第四个参数则是你要合并的模型外键的名称：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(<span class="string">'App\Role'</span>, <span class="string">'role_user'</span>, <span class="string">'user_id'</span>, <span class="string">'role_id'</span>);</div></pre></td></tr></table></figure>
<p><strong>定义相对关联</strong></p>
<p>你只需要在相对应的关联模型里放置其他的方法来调用 <code>belongsToMany</code> 方法就可以定义相对关联。继续我们上面的用户角色示例，让我们在 <code>Role</code> 模型中定义一个 <code>users</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The users that belongs to the role.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">users</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(<span class="string">'App\User'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就如你所看到的，这个关联的定义与用户的关联定义完全相同。因为我们重复的使用了 <code>belongsToMany</code> 方法，当定义相对于多对多的关联时，所有常用的自定义数据表和键的选项都是可用的。</p>
<p><strong>检索中间表字段</strong></p>
<p>正如你已经了解到的。定义多对多的关联需要引入一个中间表。Eloquent 提供了几种非常有帮助的方式来与这个表进行交互。比如，让我们假定我们的 <code>User</code> 对象关联到了很多 <code>Role</code> 对象。在访问这些关联对象时，我们可以通过在模型上使用 <code>pivot</code> 属性来访问中间表：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($user-&gt;roles <span class="keyword">as</span> $role) &#123;</div><div class="line">  <span class="keyword">echo</span> $role-&gt;pivot-&gt;created_at;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意我们取出的每个 <code>Role</code> 对象，都会被自动的分配 <code>pivot</code> 属性。这个属性包含了一个代表中间表的模型，并且可以像其他 Eloquent 模型一样被使用。</p>
<p>默认的，只有模型的键会被 <code>pivot</code> 对象提供，如果你的中间表包含了额外的属性，你必须在定义关联时指定它们：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(<span class="string">'App\Role'</span>)-&gt;withPivot(<span class="string">'column1'</span>, <span class="string">'column2'</span>);</div></pre></td></tr></table></figure>
<p>如果你想要中间表自动维护 <code>created_at</code> 和 <code>updated_at</code> 时间戳，你可以在定义关联时使用 <code>withTimestamps</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(<span class="string">'App\Role'</span>)-&gt;withTimestamps();</div></pre></td></tr></table></figure>
<p><strong>通过中间表字段过滤关系</strong></p>
<p>你可以通过在定义关联时使用 <code>wherePrivot</code> 和 <code>wherePivotIn</code> 方法来在返回的结果中进行过滤：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(<span class="string">'App\Role'</span>)-&gt;wherePivot(<span class="string">'approved'</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsToMany(<span class="string">'App\Role'</span>)-&gt;wherePivotIn(<span class="string">'approved'</span>, [<span class="number">1</span>, <span class="number">2</span>]);</div></pre></td></tr></table></figure>
<h3 id="远程一对多"><a href="#远程一对多" class="headerlink" title="远程一对多"></a>远程一对多</h3><p>远程一对多关联提供了简短便捷的方法通过中间关联件来访问远端的关联。比如，一个 <code>Country</code> 模型应该通过 <code>User</code> 模型可以拥有很多的 <code>Post</code> 模型。在这个例子中，你可以非常容易的就检索出一个国家中的所有的文章。让我们来看一下定义这些关联所需要的表:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">countries</div><div class="line">  id - integer</div><div class="line">  name - string</div><div class="line"></div><div class="line">users</div><div class="line">  id - integer</div><div class="line">  country_id - integer</div><div class="line">  name - string</div><div class="line"></div><div class="line">posts</div><div class="line">  id - integer</div><div class="line">  user_id - integer</div><div class="line">  title - string</div></pre></td></tr></table></figure>
<p>远端的 <code>posts</code> 并没有包含 <code>country_id</code> 列，<code>hasManyThrough</code> 关联可以通过 <code>$country-&gt;posts</code> 来访问一个国家的文章。为了执行这个查询，Eloquent 会通过中间表 <code>users</code> 的 <code>country_id</code> 来检索 <code>posts</code> 表中用户 ID 相匹配的记录。</p>
<p>现在我们已经明确了关联表的结构，那么让我们来在 <code>Country</code> 模型上定义关联：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Country</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get all of the posts for the country.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">posts</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasManyThrough(<span class="string">'App\Post'</span>, <span class="string">'App\User'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>传递到 <code>hasManyThrough</code> 方法的第一个参数是我们最终想要访问到的模型，而第二个参数则是中间层的模型名称。</p>
<p>当使用关联查询时，通常 Eloquent 会遵循外键约定。如果你希望对关联的键进行自定义，你可以传递第三和第四个参数到 <code>hasManyThrough</code> 方法。第三个参数是中间层模型的外键名称，第四个参数是最终想要获取的模型中的所对应的中间层的外键, 而第五个参数则是当前模型的主键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Country</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">posts</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasManyThrough(</div><div class="line">      <span class="string">'App\Post'</span>, <span class="string">'App\User'</span>,</div><div class="line">      <span class="string">'country_id'</span>, <span class="string">'user_id'</span>, <span class="string">'id'</span></div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="多态关联"><a href="#多态关联" class="headerlink" title="多态关联"></a>多态关联</h3><p><strong>表结构</strong></p>
<p>多态关联允许一个模型在单个关联中从属一个或多个其它模型。比如，想象一下应用中的用户可以喜欢文章及其评论。如果使用多态关联，那么你就可以使用一个单独的 <code>likes</code> 表来关联这两个场景。首先，让我们确定定义这种关联所需要的表结构：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">posts</div><div class="line">  id - integer</div><div class="line">  title - string</div><div class="line">  body - text</div><div class="line"></div><div class="line">comments</div><div class="line">  id - integer</div><div class="line">  post_id - integer</div><div class="line">  body - text</div><div class="line"></div><div class="line">likes</div><div class="line">  id - integer</div><div class="line">  likeable_id - integer</div><div class="line">  likeable_type - string</div></pre></td></tr></table></figure>
<p>你需要注意到的两个在 <code>likes</code> 表中重要的字段 <code>likeable_id</code> 和 <code>likeable_type</code>。<code>likeable_id</code> 字段会包含文章或者评论的 ID 值，而 <code>likeable_type</code> 字段会包含其所属的模型的类名。<code>likeable_type</code> 就是当访问 <code>likeable</code> 关联时 ORM 用来判断所属的模型是哪个类型。</p>
<p><strong>模型结构</strong></p>
<p>接着，让我们检查一下这个关联所需要的模型定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">like</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get all of the owning likeable models.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">likeable</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;morphTo();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get all of the post's likes.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">likes</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;morphMany(<span class="string">'App\Like'</span>, <span class="string">'likeable'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get all of the comment's likes.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">likes</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;morphMany(<span class="string">'App\Like'</span>, <span class="string">'likeable'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>获取多态关联</strong></p>
<p>一旦数据库表和模型都定义完成，你就可以在你的模型中访问这些关联。比如，你可以使用 <code>likes</code> 动态属性来访问文章中所有关联的 likes 模型:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$post = App\Post::find(<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($post-&gt;likes <span class="keyword">as</span> $like) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你也可以通过在模型上调用提供 <code>morphTo</code> 的方法来获取多态模型其关系所有者。在上面的例子中，指的就是 <code>Like</code> 模型中的 <code>likeable</code> 方法。所以，我们可以像使用动态属性一样使用方法来进行访问：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$like = App\Like::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$likeable = $like-&gt;likeable;</div></pre></td></tr></table></figure>
<p><code>Like</code> 模型的 <code>likeable</code> 关联将会返回一个 <code>Post</code> 或者 <code>Comment</code> 实例，这取决于其所属者的类型。</p>
<p><strong>自定义多态类型</strong></p>
<p>默认的，Laravel 会使用包完全限定类名来存储所关联模型的类型。比如，上面的例子中 <code>Like</code> 可以属于 <code>Post</code> 或者 <code>Comment</code>。默认的 <code>likeable_type</code> 应该是 <code>App\Post</code> 或者 <code>App\Comment</code>。事实上，你可能希望从你的应用程序的内部结构分离数据库。在这个例子中，你可以定义一个关联的多态映射来指导 Eloquent 使用模型关联的表名称来替代类名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Relations</span>\<span class="title">Relation</span>;</div><div class="line"></div><div class="line">Relation::morphMap([</div><div class="line">  App\Post::class,</div><div class="line">  App\Comment::class,</div><div class="line">]);</div></pre></td></tr></table></figure>
<p>或者，你可以指定一个自定的字符串与每个模型进行关联：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Relations</span>\<span class="title">Relation</span>;</div><div class="line"></div><div class="line">Relation::morphMap([</div><div class="line">  <span class="string">'posts'</span> =&gt; App\Post::class,</div><div class="line">  <span class="string">'likes'</span> =&gt; App\Like::class,</div><div class="line">]);</div></pre></td></tr></table></figure>
<p>你可以在你的 <code>AppServiceProvider</code> 或者一个分离的服务提供者的 <code>boot</code> 方法中注册你的 <code>morphMap</code>。</p>
<h3 id="多态多对多关联"><a href="#多态多对多关联" class="headerlink" title="多态多对多关联"></a>多态多对多关联</h3><p><strong>表结构</strong></p>
<p>除了传统的多态关联，你也可以定义多对多的多态关联。比如，一个博客的 <code>Post</code> 和 <code>Video</code> 模型应该可以共享一个多态关联的 <code>Tag</code> 模型。使用多对多的多态关联可以允许你的博客文章和视频能够共享独特标签的单个列表。首先，让我们来看一下表结构：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">posts</div><div class="line">  id - integer</div><div class="line">  name - string</div><div class="line"></div><div class="line">videos</div><div class="line">  id - integer</div><div class="line">  name - string</div><div class="line"></div><div class="line">tags</div><div class="line">  id - integer</div><div class="line">  name - string</div><div class="line"></div><div class="line">taggables</div><div class="line">  tag_id - integer</div><div class="line">  taggable_id - integer</div><div class="line">  taggable_type - string</div></pre></td></tr></table></figure>
<p><strong>模型结构</strong></p>
<p>接着，我们来定义模型中的关联。<code>Post</code> 和 <code>Video</code> 模型将都会包含调用基础 Eloquent 类的 <code>morphToMany</code> 方法的 <code>tags</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Post</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get all of the tags for the post.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">tags</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;morphToMany(<span class="string">'App\Tag'</span>, <span class="string">'taggable'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>定义相对的关联</strong></p>
<p>接着，在 <code>Tag</code> 模型中，你应该为所有关联模型定义相应的方法。所以，在这个例子中，我们将定义 <code>posts</code> 方法和 <code>videos</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get all of the posts that are assigned this tag.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">posts</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;morphedByMany(<span class="string">'App\Post'</span>, <span class="string">'taggable'</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get all of the videos that are assigned this tag.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">videos</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;morphedByMany(<span class="string">'App\Video'</span>, <span class="string">'taggable'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>获取关联</strong></p>
<p>当定义完成数据表和模型之后，你就可以通过模型来访问其关联。比如，你可以简单的使用 <code>tags</code> 动态属性来访问文章的所有标签模型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$post = App\Post::find(<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($post-&gt;tags <span class="keyword">as</span> $tag) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你也可以通过访问模型中提供执行 <code>morphedByMany</code> 方法的方法来获取关联模型的所属模型。在上面的例子中，就是 <code>Tag</code> 模型上的 <code>posts</code> 或者 <code>videos</code> 方法。所以，你可以像动态属性一样访问这些方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$tab = App\Tag::find(<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($tag-&gt;videos <span class="keyword">as</span> $video) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="关联查询"><a href="#关联查询" class="headerlink" title="关联查询"></a>关联查询</h2><p>由于所有的 Eloquent 关联类型都是通过方法定义的，所以你可以调用这些方法来获取所关联的模型的实例而无需实际的执行关联查询。另外，所有的 Eloquent 关联也都提供了查询生成器服务，这允许你可以继续的链式执行查询操作。</p>
<p>比如，想象一下博客系统中 <code>User</code> 模型拥有很多 <code>Post</code> 关联的模型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?</span>ph</div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get all of the posts for the user.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">posts</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasMany(<span class="string">'App\Post'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可以查询 <code>posts</code> 关联的同时添加一些额外的查询约束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$user-&gt;posts()-&gt;where(<span class="string">'active'</span>, <span class="number">1</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p>你应该注意到了，你可以在关联中使用任何的查询生成器的方法。</p>
<p><strong>关联方法 Vs. 动态属性</strong></p>
<p>如果你不需要在进行 Eloquent 关联查询时添加额外的约束，你可以简单的像它的属性一样进行访问。比如，我们继续使用 <code>User</code> 和 <code>Post</code> 示例模型。我们可以像这样来访问用户的所有文章：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($user-&gt;posts <span class="keyword">as</span> $post) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>动态属性是惰性加载的，这意味着在你实际访问他们之前，其关联数据是不会加载的。正因为如此，开发的时候通常使用预加载来进行加载一些即将用到的关联模型。预加载要求必须加载一个模型的关系，这有效的减少了查询的次数。</p>
<p><strong>查询关联是否存在</strong></p>
<p>当访问一个模型的记录时，你可能会希望基于关联的记录是否存在来对结果进行限制。比如，想象一下你希望获取最少有一条评论的博客文章。你可以传递关联的名称到 <code>has</code> 方法来做这些：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Retrieve all posts that have at least one comment...</span></div><div class="line">$posts = App\Post::has(<span class="string">'comments'</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p>你也可以指定操作符，和数量来进一步定制查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Retrieve all posts that have three or more comments...</span></div><div class="line">$posts = Post::has(<span class="string">'comments'</span>, <span class="string">'&gt;='</span>, <span class="number">3</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p>你也可以使用 <code>.</code> 语法来构造嵌套的 <code>has</code> 语句。比如，你可以获取所有包含至少一条评论和投票的文章：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Retrieve all posts that hava at least one comment with votes...</span></div><div class="line">$posts = Post::has(<span class="string">'comments.votes'</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p>如果你需要更高的控制，你可以使用 <code>whereHas</code> 和 <code>orWhereHas</code> 方法来在 <code>has</code> 查询中插入 <code>where</code> 子句。这些方法允许你为关联进行自定义的约束查询。比如检查评论的内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Retrieve all posts with at least one comment containing words like foo%</span></div><div class="line">$posts = Post::whereHas(<span class="string">'comments'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">  $query-&gt;where(<span class="string">'content'</span>, <span class="string">'like'</span>, <span class="string">'foo%'</span>); </div><div class="line">&#125;)-&gt;get();</div></pre></td></tr></table></figure>
<p><strong>统计关联结果</strong></p>
<p>如果你希望统计关联的结果而不实际的加载它们，你可以使用 <code>withCount</code> 方法，这将在你的结果模型中添加 <code>{relation}_count</code> 列。比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$posts = App\Post::withCount(<span class="string">'comments'</span>)-&gt;get();</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($posts <span class="keyword">as</span> $post) &#123;</div><div class="line">  <span class="keyword">echo</span> $post-&gt;comments_count;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你也可以同时检索多个关联的统计，以及添加查询约束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$posts = Post::withCount([<span class="string">'votes'</span>, <span class="string">'comments'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">  $query-&gt;where(<span class="string">'content'</span>, <span class="string">'like'</span>, <span class="string">'foo%'</span>);</div><div class="line">&#125;])-&gt;get();</div><div class="line"></div><div class="line"><span class="keyword">echo</span> $posts[<span class="number">0</span>]-&gt;votes_count;</div><div class="line"><span class="keyword">echo</span> $posts[<span class="number">0</span>]-&gt;comments_count;</div></pre></td></tr></table></figure>
<h3 id="预加载"><a href="#预加载" class="headerlink" title="预加载"></a>预加载</h3><p>当通过属性访问 Eloquent 关联时，该关联的数据会被延迟加载。这意味着该关联数据只有在你真实的访问属性时才会进行加载。事实上，Eloquent 可以在上层模型中一次性预加载的。预加载有效避免了 N + 1 的查找问题。要说明 N + 1 查找问题，我们可以来看一个 <code>Author</code> 关联 <code>Book</code> 的示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get the author that wrote the book.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">author</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsTo(<span class="string">'App\Author'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在，让我们检索所有的书籍和他们的作者：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$books = App\Book::all();</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($books <span class="keyword">as</span> $book) &#123;</div><div class="line">  <span class="keyword">echo</span> $book-&gt;author-&gt;name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个循环会执行一次查找回所有的书籍，接着每本书会运行一次查找作者的操作。所以，如果我们拥有 25 本书，那么循环将会进行 26 次查询：1 次查询所有的书籍，25 次查询相关书籍的作者。</p>
<p>非常幸运的，我们可以使用预加载来将查询有效的控制在 2 次。当查询时，使用 <code>with</code> 方法来指定关联的预加载：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$books = App\Book::with(<span class="string">'author'</span>)-&gt;get();</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($books <span class="keyword">as</span> $book) &#123;</div><div class="line">  <span class="keyword">echo</span> $book-&gt;author-&gt;name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于这个操作，只会执行两个查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">select * from books</div><div class="line"></div><div class="line">select * from authors where id in (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, ...)</div></pre></td></tr></table></figure>
<p><strong>预加载多个关联</strong></p>
<p>有时候你可能需要在一个操作中预加载多个关联，你只需要传递额外的参数到 <code>with</code> 方法中就可以：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$books = App\Book::with(<span class="string">'author'</span>, <span class="string">'publisher'</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p><strong>嵌套的预加载</strong></p>
<p>你可以使用 <code>.</code> 语法来加载嵌套的关联。比如，让我们在一个 Eloquent 语句中一次加载所有书籍的作者以及作者的私人通讯簿：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$books = App\Book::with(<span class="string">'author.contacts'</span>)-&gt;get();</div></pre></td></tr></table></figure>
<h3 id="预加载约束"><a href="#预加载约束" class="headerlink" title="预加载约束"></a>预加载约束</h3><p>有时候你可能希望预加载一些关联，但是也需要对预加载查询指定额外的约束，这里有个示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$users = App\User::with([<span class="string">'posts'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">  $query-&gt;where(<span class="string">'title'</span>, <span class="string">'like'</span>, <span class="string">'%first%'</span>);</div><div class="line">&#125;])-&gt;get();</div></pre></td></tr></table></figure>
<p>在这个例子中，Eloquent 会值预加载文章的 <code>title</code> 列包含 <code>first</code> 单词的记录。当然，你也可以调用其他查询生成器可用的方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$users = App\User::with([<span class="string">'posts'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">  $query-&gt;orderBy(<span class="string">'created_at'</span>, <span class="string">'desc'</span>);</div><div class="line">&#125;])-&gt;get();</div></pre></td></tr></table></figure>
<h3 id="延迟预加载"><a href="#延迟预加载" class="headerlink" title="延迟预加载"></a>延迟预加载</h3><p>有时候你可能需要在上层模型被获取后才预加载其关联。当你需要来动态决定是否加载关联模型时尤其有用:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$books = App\Book::all();</div><div class="line"></div><div class="line"><span class="keyword">if</span> ($someCondition) &#123;</div><div class="line">  $books-&gt;load(<span class="string">'author'</span>, <span class="string">'publisher'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你需要对预加载做一些查询约束，你可以传递 <code>Closure</code> 到 <code>load</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$books-&gt;load([<span class="string">'author'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">  $query-&gt;orderBy(<span class="string">'published_date'</span>, <span class="string">'asc'</span>);</div><div class="line">&#125;]);</div></pre></td></tr></table></figure>
<h2 id="插入关系模型"><a href="#插入关系模型" class="headerlink" title="插入关系模型"></a>插入关系模型</h2><p><strong>Save 方法</strong></p>
<p>Eloquent 提供了方便的方法来为模型添加一个关联。比如，也许你需要为 <code>Post</code> 模型新增一个 <code>Comment</code>。除了手动的设置 <code>Comment</code> 的 <code>post_id</code> 属性，你也可以直接在关联模型中调用 <code>save</code> 方法来插入 <code>Comment</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$comment = <span class="keyword">new</span> App\Comment([<span class="string">'message'</span> =&gt; <span class="string">'A new comment.'</span>]);</div><div class="line"></div><div class="line">$post = App\Post::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$post-&gt;comments()-&gt;save($comment);</div></pre></td></tr></table></figure>
<p>注意上面我们并没有使用关联模型的动态属性的方式来访问 <code>comments</code>，而是使用 <code>comments</code> 方法的形式来获取关联模型的实例。<code>save</code> 方法会自动的添加相应的 <code>post_id</code> 值到新的 <code>Comment</code> 模型上。</p>
<p>如果你需要一次添加多个关联模型，你需要使用 <code>saveMany</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$post = App\Post::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$post-&gt;comments()-&gt;saveMany([</div><div class="line">  <span class="keyword">new</span> App\Comment([<span class="string">'message'</span> =&gt; <span class="string">'A new comment.'</span>]),</div><div class="line">  <span class="keyword">new</span> App\Comment([<span class="string">'message'</span> =&gt; <span class="string">'Another comment.'</span>]),</div><div class="line">]);</div></pre></td></tr></table></figure>
<p><strong>Save &amp; 多对多关联</strong></p>
<p>当与多对多关联互动时，<code>save</code> 方法接收一个中间层表属性的额外参数数组作为第二个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">App\User::find(<span class="number">1</span>)-&gt;roles()-&gt;save($role, [<span class="string">'expires'</span> =&gt; $expires]);</div></pre></td></tr></table></figure>
<p><strong>Create 方法</strong></p>
<p>除了 <code>save</code> 和 <code>saveMany</code> 方法之外，你也可以使用 <code>create</code> 方法，它可以接收属性组成的数组，创建一个模型并且将其存储到数据库。这一次，<code>save</code> 和 <code>create</code> 方法的区别是 <code>save</code> 接收一个完整的 Eloquent 模型实例，而 <code>create</code> 接收的是一个原生的 PHP <code>array</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$post = App\Post::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$comment = $post-&gt;comments()-&gt;create([</div><div class="line">  <span class="string">'message'</span> =&gt; <span class="string">'A new comment.'</span>,</div><div class="line">]);</div></pre></td></tr></table></figure>
<p>在使用 <code>create</code> 方法之前，你应该确保已经阅读了属性的 <a href="https://laravel.com/docs/5.2/eloquent#mass-assignment" target="_blank" rel="external">批量赋值文档</a>。</p>
<p><strong>更新从属关联模型</strong></p>
<p>当更新一个 <code>belongsTo</code> 关联时，你应该使用 <code>associate</code> 方法。这个方法会在下层模型中设置外键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$account = App\Account::find(<span class="number">10</span>);</div><div class="line"></div><div class="line">$user-&gt;account()-&gt;associate($account);</div><div class="line"></div><div class="line">$user-&gt;save();</div></pre></td></tr></table></figure>
<p>当删除 <code>belongsTo</code> 关联时，你应该使用 <code>dissociate</code> 方法，该方法会重置下层模型所关联的外键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user-&gt;account()-&gt;dissociate();</div><div class="line"></div><div class="line">$user-&gt;save();</div></pre></td></tr></table></figure>
<h3 id="多对多关联"><a href="#多对多关联" class="headerlink" title="多对多关联"></a>多对多关联</h3><p><strong>附加 / 抽离</strong></p>
<p>当使用多对多关联时，Eloquent 提供了一些额外的帮助方法来更方便的管理关联模型。比如，让我们想象一下用户可以有很多角色并且角色可以有很多用户。你可以使用 <code>attach</code> 方法来附加一个角色到用户并且在中间表中加入这条记录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$user-&gt;roles()-&gt;attach($roleId);</div></pre></td></tr></table></figure>
<p>当附加关联到模型时，你也可以传递一个含有额外数据的数组来将其添加到中间表中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$user-&gt;roles()-&gt;attach($roleId, [<span class="string">'expires'</span> =&gt; $expires]);</div></pre></td></tr></table></figure>
<p>当然，有时候你可能需要从用户中删除一个角色。你可以使用 <code>detach</code> 方法来删除多对多关联的记录。<code>datech</code> 方法将从中间表中删除相应的记录。但是，除了中间表，其它两个模型的记录都还会被保留：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Detach a single role from the user...</span></div><div class="line">$user-&gt;roles()-&gt;detach($roleId);</div><div class="line"></div><div class="line"><span class="comment">// Detach all roles from the user...</span></div><div class="line">$user-&gt;roles()-&gt;detach();</div></pre></td></tr></table></figure>
<p>为了更加的便捷，<code>attach</code> 和 <code>detach</code> 也可以接收 IDs 所组成的数组作为输入：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$user-&gt;roles()-&gt;detach([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</div><div class="line"></div><div class="line">$user-&gt;roles()-&gt;attach([<span class="number">1</span> =&gt; [<span class="string">'expires'</span> =&gt; $expires], <span class="number">2</span>, <span class="number">3</span>]);</div></pre></td></tr></table></figure>
<p><strong>更新中间表的记录</strong><br>如果你需要更新中间表中存在的行，你可以使用 <code>updateExistingPivot</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$user-&gt;roles()-&gt;updateExistingPivot($roleId, $attributes);</div></pre></td></tr></table></figure>
<p><strong>便利的同步</strong></p>
<p>你也可以使用 <code>sync</code> 方法来构建多对多的关联。<code>sync</code> 方法接收放置中间表 IDs 所组成的数组。任意 IDs 如果没有在所给定的数组中，那么其将会从中间表中进行删除。所以，在操作完成之后，只有存在于给定数组里的 IDs 才会存在于中间表中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$user-&gt;roles()-&gt;sync([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</div></pre></td></tr></table></figure>
<p>你也可以同时传递额外的中间表的键值对：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$user-&gt;roles()-&gt;sync([<span class="number">1</span> =&gt; [<span class="string">'expires'</span> =&gt; <span class="keyword">true</span>], <span class="number">2</span>, <span class="number">3</span>]);</div></pre></td></tr></table></figure>
<p><strong>联动上层模型时间戳</strong></p>
<p>当一个模型 <code>belongsTo</code> 或者 <code>belongsToMany</code> 另外一个模型时，比如 <code>Comment</code> 从属于 <code>Post</code>，这对下层模型更新时同时要求更新上层模型的时间戳时很有帮助。比如，当 <code>Comment</code> 模型更新了，你想要自动的更新其所属的 <code>Post</code> 模型的 <code>updated_at</code> 时间戳。Eloquent 使之变的非常容易。你只需要在下层模型中添加一个 <code>touches</code> 属性来包含关联的名称就可以了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * All of the relationships to be touched.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">protected</span> $touches = [<span class="string">'post'</span>];</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get the post that the comment belongs to.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">post</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;belongsTo(<span class="string">'App\Post'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在，当你更新 <code>Comment</code> 时，其所属的 <code>Post</code> 将会同时更新 <code>updated_at</code> 列：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$comment = App\Comment::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$comment-&gt;text = <span class="string">'Edit to this comment!'</span>;</div><div class="line"></div><div class="line">$comment-&gt;save();</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/24/laravel-from-scratch-eloquent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/24/laravel-from-scratch-eloquent/" itemprop="url">laravel 基础教程 —— Eloquent</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-24T14:26:51+08:00">
                2016-06-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Eloquent-起步"><a href="#Eloquent-起步" class="headerlink" title="Eloquent: 起步"></a>Eloquent: 起步</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Laravel 的 Eloquent ORM 提供了一种漂亮简洁的关系映射的模型来与数据库进行交互。所有的数据库表都有相应的模型，这些模型被用来与表进行交互。模型允许你直接查询数据库表中的数据，及插入新的记录到数据表中。</p>
<p>在开始之前，你需要确保完成了 <code>config/database.php</code> 配置文件中的数据库配置。对于更多的配置数据库相关的信息，请参考 <a href="https://laravel.com/docs/5.2/database#configuration" target="_blank" rel="external">文档</a>。</p>
<h2 id="定义模型"><a href="#定义模型" class="headerlink" title="定义模型"></a>定义模型</h2><p>在开始之前，让我们先来创建一个 Eloquent 模型。模型通常存放在 <code>app</code> 目录下，但是你也可以自由的放置在任何地方，只要它能够根据你的 <code>composer.json</code> 文件的指导进行自动的加载。所有的 Eloquent 模型都继承自 <code>Illuminate\Database\Eloquent\Model</code> 类。</p>
<p>最简单的创建一个模型类的方式就是使用 <code>make:model</code> Artisan 命令：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan make:model User</div></pre></td></tr></table></figure>
<p>如果你希望在你生成模型的同时生成一份数据库迁移，你可以使用 <code>--migration</code> 或者 <code>-m</code> 选项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">php artisan make:model User --migration</div><div class="line"></div><div class="line">php artisan make:model User -m</div></pre></td></tr></table></figure>
<h3 id="Eloquent-模型约定"><a href="#Eloquent-模型约定" class="headerlink" title="Eloquent 模型约定"></a>Eloquent 模型约定</h3><p>现在，让我们来看一个 <code>Flight</code> 模型的示例，我们将通过它获取和存储数据库中 <code>flights</code> 表的数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>表名称</strong></p>
<p>你需要注意我们上面的代码中并没有指出 <code>Flight</code> 模型使用哪个数据库的表。如果你没有明确的指出模型所对应的表，那么 Eloquent 将使用类的蛇形命名的复数形式来使用相应的数据表。所以，在这个例子中，Eloquent 将会假定 <code>Flight</code> 模型存储的记录被放在 <code>flights</code> 表中。你可以使用 <code>table</code> 属性来指定表名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The table associated with the model.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> $table = <span class="string">'my_flights'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>主键</strong></p>
<p>Eloquent 也会假定所有表的主键列名为 <code>id</code>。你也可使用 <code>$primaryKey</code> 属性来手动的指定表的主键。</p>
<p>另外，Eloquent 也会假定主键是一个自增的整型值，这意味着，在默认情况下主键会被自动的转为 <code>int</code>。如果你希望使用非自增或者非数字的主键，那么你需要在模型中将公开的 <code>$incrementing</code> 属性设置为 <code>false</code>。</p>
<p><strong>时间戳</strong></p>
<p>默认的，Eloquent 期望模型表中存在 <code>created_at</code> 和 <code>updated_at</code> 列，如果你不希望 Eloquent 自主的管理这两列，你可以在模型中设置 <code>$timestamps</code> 属性为 <code>false</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Indicates if the model should be timestamped.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> bool</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> $timestamps = <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你需要自定义时间戳的格式，你可以设置 <code>$dateFormat</code> 属性。这个属性用来决定日期属性存储在数据库中的格式，以及模型在进行序列化为数组或者 JSON 时的显示样式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The storage format of the model's date columns.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> $dateFormat = <span class="string">'U'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>数据库连接</strong></p>
<p>默认的，所有的 Eloquent 模型都会使用应用配置的默认的数据库连接。如果你希望模型使用不同的数据库连接，你可以使用 <code>$connection</code> 属性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The connection name for the model.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> $connection = <span class="string">'connection-name'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="检索多个模型"><a href="#检索多个模型" class="headerlink" title="检索多个模型"></a>检索多个模型</h2><p>一旦你创建了模型和其相应的数据表，你就为从数据库中检索数据做好了准备。你可以把 Eloquent 模型作为一个强大的查询生成器来使用，它允许通过模型流畅的查询相应的表中的数据。比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Flight</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlightController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Show a list of all available flights.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $flights = Flight::all();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> view(<span class="string">'flight.index'</span>, [<span class="string">'flights'</span> =&gt; $flights]);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>访问列的值</strong></p>
<p>如果你获得了 Eloquent 模型的实例，那么你可以通过模型中相应的列名的属性来访问表中列的值。比如，让我们循环查询的结果，并通过获取的 <code>Flight</code> 实例来获得 <code>name</code> 列的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">foreach</span> ($flights <span class="keyword">as</span> $flight) &#123;</div><div class="line">  <span class="keyword">echo</span> $flight-&gt;name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>添加额外的条件</strong></p>
<p>Eloquent 的 <code>all</code> 方法会返回模型表中所有的记录。由于所有的 Eloquent 模型都可以作为查询生成器来进行服务，所以你可以在这些查询中增加额外的条件，然后使用 <code>get</code> 方法来检索结果：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$flights = App\Flight::where(<span class="string">'active'</span>, <span class="number">1</span>)</div><div class="line">             -&gt;orderBy(<span class="string">'name'</span>, <span class="string">'desc'</span>)</div><div class="line">             -&gt;take(<span class="number">10</span>)</div><div class="line">             -&gt;get();</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：由于 Eloquent 模型也是查询生成器，所以你可以回顾一下查询生成器中所有可用的方法，因为它们同样可以在 Eloquent 中进行使用。</p>
</blockquote>
<p><strong>集合</strong></p>
<p>对于像 <code>all</code> 和 <code>get</code> 这样的 Eloquent 方法会返回多个结果，这将返回一个 <code>Illuminate\Database\Eloquent\Collection</code> 实例。<code>Collection</code> 类提供了各种有用的方法与 Eloquent 结果进行交互。当然，你可以简单的对集合进行循环，因为他实现了 ArrayAccess 接口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">foreach</span> ($flights <span class="keyword">as</span> $flight) &#123;</div><div class="line">  <span class="keyword">echo</span> $flight-&gt;name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>对结果进行分块</strong></p>
<p>如果你需要处理数千条 Eloquent 记录，那么你可以使用 <code>chunk</code> 方法。<code>chunk</code> 方法会从 Eloquent 模型中检索出一小块记录，然后将其传递给 <code>Closure</code> 进行处理。使用 <code>chunk</code> 方法在处理大量结果集时可有有效的降低内存的消耗：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Flight::chunk(<span class="number">200</span>, <span class="function"><span class="keyword">function</span> <span class="params">($flights)</span> </span>&#123;</div><div class="line">  <span class="keyword">foreach</span> ($flights <span class="keyword">as</span> $flight) &#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">  &#125; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>传递到方法的第一个参数是你要设置进行分块的大小。而传递到第二个参数的闭包将会在从数据库检索出每块内容时进行调用。</p>
<h2 id="检索单个模型-统计"><a href="#检索单个模型-统计" class="headerlink" title="检索单个模型 / 统计"></a>检索单个模型 / 统计</h2><p>当然，除了可以从表中检索出所有的记录之外，你也可以使用 <code>find</code> 和 <code>first</code> 方法来从数据库中检索出单条的数据。这将会返回一个单独的模型实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Retrieve a model by its primary key...</span></div><div class="line">$flight = App\Flight::find(<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="comment">// Retrieve the first model matching the query constraints...</span></div><div class="line">$flight = App\Flight::where(<span class="string">'active'</span>, <span class="number">1</span>)-&gt;first();</div></pre></td></tr></table></figure>
<p>你也可以使用 <code>find</code> 方法时传递一个包含主键所组成的数组，这将返回所有匹配到记录的集合：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$flights = App\Flight::find([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</div></pre></td></tr></table></figure>
<p><strong>未发现时的异常</strong></p>
<p>有时候，你可能希望在没有找到匹配的模型时抛出一个异常。这对路由或者控制器来说尤其有用。<code>findOrFail</code> 和 <code>firstOrFail</code> 方法可以从查询中检索出首个匹配的结果，但是，如果结果中没有匹配的项，那么会抛出一个 <code>Illuminate\Database\Eloquent\ModelNotFoundException</code> 异常：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$model = App\Flight::findOrFail(<span class="number">1</span>);</div><div class="line"></div><div class="line">$model = App\Flight::where(<span class="string">'legs'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>)-&gt;firstOrFail();</div></pre></td></tr></table></figure>
<p>如果异常没有被捕获，那么会直接传递给用户一个 <code>404</code> HTTP 响应。所以当你在使用这些方法时是没有必要编写明确的检查并返回 <code>404</code> 响应的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'/api/flights/&#123;id&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($id)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> App\Flight::findOrFail($id); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="检索统计"><a href="#检索统计" class="headerlink" title="检索统计"></a>检索统计</h3><p>当然，你可以使用 <code>count</code>，<code>sum</code>，<code>max</code> 和其他 <a href="https://laravel.com/docs/5.2/queries" target="_blank" rel="external">查询生成器</a> 所提供的的 <a href="https://laravel.com/docs/5.2/queries#aggregates" target="_blank" rel="external">聚合函数</a>。这些方法会返回适当的数值，而不是完整的模型实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$count = App\Flight::where(<span class="string">'active'</span>, <span class="number">1</span>)-&gt;count();</div><div class="line"></div><div class="line">$max = App\Flight::where(<span class="string">'active'</span>, <span class="number">1</span>)-&gt;max(<span class="string">'price'</span>);</div></pre></td></tr></table></figure>
<h2 id="插入-amp-更新模型"><a href="#插入-amp-更新模型" class="headerlink" title="插入 &amp; 更新模型"></a>插入 &amp; 更新模型</h2><h3 id="基础插入"><a href="#基础插入" class="headerlink" title="基础插入"></a>基础插入</h3><p>想要在数据库中插入新的记录，只需要简单的创建模型实例，然后设置模型的属性，再调用 <code>save</code> 方法就可以了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Flight</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlightController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Create a new flight instance.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> Request $request</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(Request $request)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="comment">// Validate the request...</span></div><div class="line"></div><div class="line">     $flight = <span class="keyword">new</span> Flight;</div><div class="line"></div><div class="line">     $flight-&gt;name = $request-&gt;name;</div><div class="line"></div><div class="line">     $flight-&gt;save();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这个例子中，我们简单的从流入的 HTTP 请求中的 <code>name</code> 参数分配到 <code>App\Flight</code> 模型实例的 <code>name</code> 属性上。当我们调用 <code>save</code> 方法时，这条记录将会插入到数据库中，同时 <code>created_at</code> 和 <code>updated_at</code> 时间戳也会自动的被进行设置，所以这并不需要进行手动的设置它们。</p>
<h3 id="基础的更新"><a href="#基础的更新" class="headerlink" title="基础的更新"></a>基础的更新</h3><p><code>save</code> 方法也可用来更新数据库中已经存在的数据模型。为了更新模型，你应该首先检索到它们，然后设置任何你想要更新的属性，接着调用 <code>save</code> 方法。这一次，<code>updated_at</code> 时间戳会自动的进行更新，所以你并不需要手动的更新这个值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$flight = App\Flight::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$flight-&gt;name = <span class="string">'New Flight Name'</span>;</div><div class="line"></div><div class="line">$flight-&gt;save();</div></pre></td></tr></table></figure>
<p>你也可以针对查询匹配的多个模型进行更新操作。比如，所有 <code>active</code> 并且 <code>destination</code> 为 <code>San Diego</code> 的航班将会被标记为延迟：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">App\Flight::where(<span class="string">'active'</span>, <span class="number">1</span>)</div><div class="line">          -&gt;where(<span class="string">'destination'</span>, <span class="string">'San Diego'</span>)</div><div class="line">          -&gt;update([<span class="string">'delayed'</span> =&gt; <span class="number">1</span>]);</div></pre></td></tr></table></figure>
<p><code>update</code> 方法接收一个想要更新的列的键值对数组。</p>
<h3 id="批量赋值"><a href="#批量赋值" class="headerlink" title="批量赋值"></a>批量赋值</h3><p>你也可以使用 <code>create</code> 方法来在一行中存储一个新的模型。一个新增的模型实例将会从方法中返回。事实上，在开始做这些之前，你需要先指定模型的 <code>fillable</code> 或者 <code>guarded</code> 属性，它们是针对批量赋值时的保护措施。</p>
<p>当用户通过 HTTP 请求传递一些意外的参数时，这可能会造成批量赋值时一些问题的出现，或许参数中存在一些你并不想改变的列值的参数。比如，一个恶意的用户可能会在请求中嵌入一个 <code>is_admin</code> 参数，然后这些参数映射到你的 <code>create</code> 方法中，这就使用户将自己升级为了超级管理员。</p>
<p>所以，在开始之前，你需要先定义哪些模型属性是可以进行批量分配的。你可以使用模型 <code>$fillable</code> 属性，让我们在 <code>Flight</code> 模型中添加允许 <code>name</code> 属性的批量赋值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dlight</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The attributes that are mass assignable.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> $fillable = [<span class="string">'name'</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一旦我们使一个属性可以进行批量赋值。那么我们可以使用 <code>create</code> 方法直接的添加记录到数据中。<code>create</code> 方法会返回存储后的模型实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$flight = App\Flight::create([<span class="string">'name'</span> =&gt; <span class="string">'Flight 10'</span>]);</div></pre></td></tr></table></figure>
<p>而 <code>$fillable</code> 就像是为批量赋值提供了一种白名单的机制。你也可以选择使用 <code>$guarded</code>。<code>$guarded</code> 属性应该包含一个你不想要进行批量赋值的属性所组成的数组。所有不在这个数组中的属性都将可以进行批量赋值。所以，<code>$guarded</code> 就像一个黑名单的功能。当然，你应该只使用 <code>$fillable</code> 或者 <code>$guarded</code> 中的一个，而不是全部：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The attributes that aren't mass assignable.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> $guarded = [<span class="string">'price'</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在上面的例子中，除了 <code>price</code>，所有的属性都可以进行批量赋值。</p>
<p><strong>其他创建方法</strong></p>
<p>这里也有其他两种方法可以使用批量赋值进行模型的创建：<code>firstOrCreate</code> 和 <code>firstOrNew</code>。<code>firstOrCreate</code> 方法会尝试根据给定的列的键值对从数据库定位相关的模型。如果相关的模型没有找到，那么会根据给定的属性在数据库中新增一条记录。</p>
<p><code>firstOrNew</code> 方法和 <code>firstOrCreate</code> 方法一样，但是它在模型没找到时只会返回一个新的模型实例，并不会在数据库中新增一条记录。你需要手动的使用 <code>save</code> 方法来将其存储到数据库中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Retrieve the flight by the attributes, or create it if it doesn't exists...</span></div><div class="line">$flight = App\Flight::firstOrCreate([<span class="string">'name'</span> =&gt; <span class="string">'Flight 10'</span>]);</div><div class="line"></div><div class="line"><span class="comment">// Retrieve the flight by the attributes, or instantiate a new instance...</span></div><div class="line">$flight = App\Flight::firstOrNew([<span class="string">'name'</span> =&gt; <span class="string">'Flight 10'</span>]);</div></pre></td></tr></table></figure>
<h2 id="删除模型"><a href="#删除模型" class="headerlink" title="删除模型"></a>删除模型</h2><p>你可以在模型实例中使用 <code>delete</code> 方法来删除模型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$flight = App\Flight::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$flight-&gt;delete();</div></pre></td></tr></table></figure>
<p><strong>根据键删除存在的模型</strong></p>
<p>在上面的例子中，我们先从数据库中检索出相关的模型，然后才调用 <code>delete</code> 方法来进行删除。事实上，如果你知道了模型的主键，那么你完全可以不用去检索到它。你可以直接使用 <code>destroy</code> 方法来进行删除：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">App\Flight::destroy(<span class="number">1</span>);</div><div class="line"></div><div class="line">App\Flight::destroy([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</div><div class="line"></div><div class="line">App\Flight::destroy(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</div></pre></td></tr></table></figure>
<p><strong>通过查询删除模型</strong></p>
<p>当然，你也可以通过查询删除一个模型集。在这个例子中，我们将删除所有标记为未启用的航班：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$deletedRows = App\Flight::where(<span class="string">'active'</span>, <span class="number">0</span>)-&gt;delete();</div></pre></td></tr></table></figure>
<h3 id="软删除"><a href="#软删除" class="headerlink" title="软删除"></a>软删除</h3><p>除了从数据库中真实的删除数据之外，Eloquent 也可以进行软删除操作。当模型是一个软删除模型时，它们并不会真正的从数据库中清除记录。实际上，它们会将模型的 <code>deleted_at</code> 属性进行设置，并且将其更新到数据库中。如果模型中的 <code>deleted_at</code> 的值不是 <code>NULL</code>，那么它就被标记为软删除了。如果你需要启用软删除模型，你需要在模型中引入 <code>Illuminate\Database\Eloquent\SoftDeletes</code> trait，并且在模型的 <code>$dates</code> 属性中添加 <code>deleted_at</code> 列：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">SoftDeletes</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flight</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">use</span> <span class="title">SoftDeletes</span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The attributes that should be mutated to dates.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> $dates = [<span class="string">'deleted_at'</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，你应该在数据表中添加 <code>deleted_at</code> 列。Laravel 的 <a href="https://laravel.com/docs/5.2/migrations" target="_blank" rel="external">结构生成器</a> 中提供了生成该列的方法:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Schema::table(<span class="string">'flights'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;softDeletes(); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>现在，当我们调用 <code>delete</code> 方法时，<code>deleted_at</code> 列会被设置为当前时间。并且，当查询启用软删除的模型时，已经被软删除的模型将自动从结果中剔除。</p>
<p>你可以使用 <code>trashed</code> 方法来判断所给定的模型是否已经被软删除：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($flight-&gt;trashed()) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="查询软删除的模型"><a href="#查询软删除的模型" class="headerlink" title="查询软删除的模型"></a>查询软删除的模型</h3><p><strong>包含软删除的模型</strong></p>
<p>就如上面我们所提到的，被软删除的模型将自动的从结果中进行剔除。事实上，你可以使用 <code>withTrashed</code> 方法来强制结果中显示已经被软删除的模型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$flights = App\Flight::withTrashed()</div><div class="line">             -&gt;where(<span class="string">'account_id'</span>, <span class="number">1</span>)</div><div class="line">             -&gt;get();</div></pre></td></tr></table></figure>
<p><code>whitTrashed</code> 方法也可以在关联查询中进行使用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$flight-&gt;history()-&gt;withTrashed()-&gt;get();</div></pre></td></tr></table></figure>
<p><strong>只检索被软删除的模型</strong></p>
<p><code>onlyTrashed</code> 方法会从数据库中检索被软删除的模型记录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$flights = App\Flight::onlyTrashed()</div><div class="line">             -&gt;where(<span class="string">'airline_id'</span>, <span class="number">1</span>)</div><div class="line">             -&gt;get();</div></pre></td></tr></table></figure>
<p><strong>还原被软删除的模型</strong></p>
<p>有时候你可能会希望还原已经被软删除的模型，你可以使用 <code>restore</code> 方法来将模型从软删除中解除：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$flight-&gt;restore();</div></pre></td></tr></table></figure>
<p>你也可以在查询中使用 <code>restore</code> 方法来快速的重启多个模型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">App\Flight::withTrashed()</div><div class="line">  -&gt;where(<span class="string">'airline_id'</span>, <span class="number">1</span>)</div><div class="line">  -&gt;restore();</div></pre></td></tr></table></figure>
<p>就像 <code>withTrashed</code> 方法一样，<code>restore</code> 方法也可以在关联查询中使用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$flight-&gt;history()-&gt;restore();</div></pre></td></tr></table></figure>
<p><strong>永久的删除模型</strong></p>
<p>有时候你可能希望从数据库中直接删除这个模型。你可以使用 <code>forceDelete</code> 方法来将模型从数据库中永久的删除：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Force deleting a single model instance...</span></div><div class="line">$flight-&gt;forceDelete();</div><div class="line"></div><div class="line"><span class="comment">// Force deleting all related modls...</span></div><div class="line">$flight-&gt;history()-&gt;forceDelete();</div></pre></td></tr></table></figure>
<h2 id="查询区间"><a href="#查询区间" class="headerlink" title="查询区间"></a>查询区间</h2><h3 id="全局区间"><a href="#全局区间" class="headerlink" title="全局区间"></a>全局区间</h3><p>全局区间允许你在给定的模型上的所有查询进行约束的添加。Laravel 自己的软删除功能就是利用了全局区间来从数据库中拉取未删除的数据。编写自己的全局区间可以方便的对给定模型的所有查询进行约束。</p>
<p><strong>编写全局区间</strong></p>
<p>编写一个全局区间非常简单，你只需要定义一个实现了 <code>Illuminate\Database\Eloquent\Scope</code> 接口的类。这个接口只要求你实现一个方法：<code>apply</code>。<code>apply</code> 方法可以在需要的时添加 <code>where</code> 约束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?Php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Scopes</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Scope</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Builder</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AgeScope</span> <span class="keyword">implements</span> <span class="title">Scope</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Apply the scope to a given Eloquent query builder.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> \Illuminate\Database\Eloquent\Builder $builder</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> \Illuminate\Database\Eloquent\Model $model</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">apply</span><span class="params">(Builder $builder, Model $model)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">return</span> $builder-&gt;where(<span class="string">'age'</span>, <span class="string">'&gt;'</span>, <span class="number">200</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Laravel 没有为区间预置存放的目录，所以你可以自由的创建自己的 <code>Scopes</code> 目录来进行管理。</p>
<p><strong>应用全局区间</strong></p>
<p>你需要在给定的模型中复写 <code>boot</code> 方法并且使用 <code>addGlobalScope</code> 方法来分配全局区间：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Scopes</span>\<span class="title">AgeScope</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The "booting" method of the model</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     paraent::boot();</div><div class="line"></div><div class="line">     <span class="keyword">static</span>::addGlobalScope(<span class="keyword">new</span> AgeScope);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在添加完区间之后，调用 <code>User::all()</code> 的查询会产生下述的 SQL：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from `users` where `age` &gt; <span class="number">200</span></div></pre></td></tr></table></figure>
<p><strong>匿名全局区间</strong></p>
<p>Eloquent 也允许你通过一个闭包来定义全局区间，这通常对于不需要分离到单独一个类文件中的简单区间尤其有用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Builder</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The "booting" method of the model.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">parent</span>::boot();</div><div class="line"></div><div class="line">     <span class="keyword">static</span>::addGlobalScope(<span class="string">'age'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Builder $builder)</span> </span>&#123;</div><div class="line">       $builder-&gt;where(<span class="string">'age'</span>, <span class="string">'&gt;'</span>, <span class="number">200</span>);</div><div class="line">     &#125;);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>传递到 <code>addGlobalScope()</code> 方法的首个参数将作为区间的唯一标识，你可以通过标识将其排除：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">User::withoutGlobalScope(<span class="string">'age'</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p><strong>删除全局区间</strong></p>
<p>如果你希望从给定的查询中移除全局区间，你可以使用 <code>withoutGlobalScope</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">User::withoutGlobalScope(AgeScope::class)-&gt;get();</div></pre></td></tr></table></figure>
<p>如果你希望删除多个或者全部的全局区间，你可以使用这么使用 <code>withoutGlobalScopes</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">User::withoutGlobalScopes()-&gt;get();</div><div class="line"></div><div class="line">User::withoutGlobalScopes([FirstScope::class, SecondScope::class])-&gt;get();</div></pre></td></tr></table></figure>
<h3 id="当前区间"><a href="#当前区间" class="headerlink" title="当前区间"></a>当前区间</h3><p>当前区间允许你在模型中定义一些可以复用的常用的约束。比如，你可能经常需要检索一些受欢迎的用户。你可以简单的在模型方法中前置 <code>scope</code> 命名来定义一个区间.</p>
<p>区间应该总是返回一个查询生成器的实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Scope a query to only include popular users.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Builder</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scopePopular</span><span class="params">($query)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">return</span> $query-&gt;where(<span class="string">'votes'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Scope a query to only include active users.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Builder</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scopePopular</span><span class="params">($query)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="keyword">return</span> $query-&gt;where(<span class="string">'votes'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Scope a query to only include active users.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Builder</span></div><div class="line"><span class="comment">     */</span></div><div class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scopeActive</span><span class="params">($query)</span></span></div><div class="line"><span class="function">     </span>&#123;</div><div class="line">       <span class="keyword">return</span> $query-&gt;where(<span class="string">'active'</span>, <span class="number">1</span>);</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>利用区间查询</strong></p>
<p>一旦区间进行了定义，你可以在模型进行查询时调用区间方法，事实上，你在调用区间方法时并不需要包含 <code>scope</code> 前缀。你甚至可以链式的调用其它的区间：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$users = App\User::popular()-&gt;active()-&gt;orderBy(<span class="string">'created_at'</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p><strong>动态区间</strong></p>
<p>有时候你可能希望定义一个可以接收参数的区间。在开始之前，你仅仅只需要在你的区间中添加一些额外的参数。区间参数应该在 <code>$query</code> 参数之后进行定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Scope a query to only include users of a given type.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> \Illuminate\Database\Eloquent\Builder</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scopeOfType</span><span class="params">($query, $type)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">return</span> $query-&gt;where(<span class="string">'type'</span>, $type);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在，你可以在调用区间时传递一些参数了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$users = App\User::ofType(<span class="string">'admin'</span>)-&gt;get();</div></pre></td></tr></table></figure>
<h2 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h2><p>Eloquent 模型可以触发多种事件，这允许你在模型的生命周期的各个关键点进行 hook 操作。你可以使用下面的方法进行 Hook：<code>creating</code>，<code>created</code>，<code>updating</code>，<code>updated</code>，<code>saving</code>，<code>saved</code>，<code>deleting</code>，<code>deleted</code>，<code>restoring</code>，<code>restored</code>。事件允许你轻松的在模型进行存储或更新操作时进行执行额外的操作。</p>
<h3 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h3><p>当一个新的模型首次进行存储操作时，会触发 <code>creating</code> 和 <code>created</code> 事件。如果模型已经存在于数据库中，并且调用 <code>save</code> 方法，那么 <code>updating</code> / <code>updated</code> 事件将会被触发。事实上，在这两种情况下，<code>saving</code> 和 <code>saved</code> 事件都会被触发。</p>
<p>举个示例，让我们在服务提供者中定义一个 Eloquent 事件监听器。在我们的事件监听器中，我们将在给定的模型中调用 <code>isValid</code> 方法，当模型并没有通过验证时将返回 <code>false</code>。如果从 Eloquent 事件监听器中返回 <code>false</code>，那么将取消 <code>save</code> / <code>update</code> 操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Bootstrap any application services.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     User::creating(<span class="function"><span class="keyword">function</span> <span class="params">($user)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (! $user-&gt;isValid()) &#123;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">     &#125;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Register the service provider.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="comment">//</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Dearmadman</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">100</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dearmadman</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
