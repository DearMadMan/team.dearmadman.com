<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Team.dearmadman.com">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Team.dearmadman.com">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Team.dearmadman.com">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/5/"/>





  <title>Team.dearmadman.com</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Team.dearmadman.com</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do it.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/24/laravel-from-scratch-seeding/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/24/laravel-from-scratch-seeding/" itemprop="url">laravel 基础教程 —— Seeding</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-24T13:54:31+08:00">
                2016-06-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="数据库：数据填充（Seeding）"><a href="#数据库：数据填充（Seeding）" class="headerlink" title="数据库：数据填充（Seeding）"></a>数据库：数据填充（Seeding）</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Laravel 使用 seed 类提供一种简便的方法填充你用于测试的数据。所有的 seed 类文件都被存储在 <code>database/seeds</code> 目录下。Seed 类可以拥有任意的类名，但是你应该遵循某些命名规范，比如 <code>UsersTableSeeder</code>，等等。默认的 Laravel 为你提供了 <code>DatabaseSeeder</code> 类，在这个类中，你可以使用 <code>call</code> 方法来调用其他的 seed 类，这为你顺序的进行数据填充提供了便利。</p>
<h2 id="编写-Seeders"><a href="#编写-Seeders" class="headerlink" title="编写 Seeders"></a>编写 Seeders</h2><p>你可以使用 <code>make:seeder</code> Artisan 命令来生成一个 seeder。所有通过框架生成的 seeders 都会被放在 <code>database/seeds</code> 目录下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan make:seeder UsersTableSeeder</div></pre></td></tr></table></figure>
<p>seeder 类中默认的只包含了一个方法：<code>run</code>。该方法会在 <code>db:seed</code> Artisan 命令执行时被调用。在 <code>run</code> 方法中，你可以填充任意你想填充的数据到数据库中，你可以使用查询生成器手动的插入数据，或者你也可以使用 <a href="https://laravel.com/docs/5.2/testing#model-factories" target="_blank" rel="external">Eloquent 模型工厂</a>。</p>
<p>让我们来做个示例，我们修改 Laravel 默认提供的 <code>DatabaseSeeder</code> 类，让我们在 <code>run</code> 方法中进行一些数据插入：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Seeder</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatabaseSeeder</span> <span class="keyword">extends</span> <span class="title">Seeder</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Run the database seeds.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     DB::table(<span class="string">'users'</span>)-&gt;insert([</div><div class="line">       <span class="string">'name'</span> =&gt; str_random(<span class="number">10</span>),</div><div class="line">       <span class="string">'email'</span> =&gt; str_random(<span class="number">10</span>).<span class="string">'@gmail.com'</span>,</div><div class="line">       <span class="string">'password'</span> =&gt; bcrypt(<span class="string">'secret'</span>),</div><div class="line">     ]);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用模型工厂"><a href="#使用模型工厂" class="headerlink" title="使用模型工厂"></a>使用模型工厂</h3><p>当然，手动的为每个模型 seed 指定属性是一件非常麻烦的事情。你可以使用 <a href="https://laravel.com/docs/5.2/testing#model-factories" target="_blank" rel="external">model factories</a> 来方便的生成大量的数据记录。首先，你需要查询一下 <a href="https://laravel.com/docs/5.2/testing#model-factories" target="_blank" rel="external">model factory documentation</a> 来学习一下如何定义你的模型工厂。一旦你定义了模型工厂，你就可以使用 <code>factory</code> 帮助方法来插入数据到库中。</p>
<p>比如，让我们创建 50 个用户并且为每个用户附加一个关系：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Run the database seeds.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   factory(App\User::class, <span class="number">50</span>)-&gt;create()-&gt;each(<span class="function"><span class="keyword">function</span><span class="params">($u)</span> </span>&#123;</div><div class="line">     $u-&gt;posts()-&gt;save(factory(App\Post::class)-&gt;make());</div><div class="line">   &#125;);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="调用其他-Seeders"><a href="#调用其他-Seeders" class="headerlink" title="调用其他 Seeders"></a>调用其他 Seeders</h3><p>在 <code>DatabaseSeeder</code> 类中，你可以使用 <code>call</code> 方法来执行其他的 seed 类。使用 <code>call</code> 方法允许你将数据库填充分解到多个文件中，这样不会使一个单独的 seed 文件过于庞大。你只需要简单的传递 seeder 的类名到方法中就可以进行调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Run the database seeds.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">$this</span>-&gt;call(UsersTableSeeder::class);</div><div class="line">   <span class="keyword">$this</span>-&gt;call(PostsTableSeeder::class);</div><div class="line">   <span class="keyword">$this</span>-&gt;call(CommentsTableSeeder::class);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="执行-Seeders"><a href="#执行-Seeders" class="headerlink" title="执行 Seeders"></a>执行 Seeders</h2><p>一旦你编写完成 seeder 类，你就可以使用 <code>db:seed</code> Artisan 命令来将数据填充到数据库中。默认的，<code>db:seed</code> 命令会直接执行 <code>DatabaseSeeder</code> 类，你也可以在这个类中调用其他的 seed 类。事实上，你也可以使用 <code>--class</code> 选项来指定需要填充的类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">php artisan db:seed</div><div class="line"></div><div class="line">php artisan db:seed --<span class="class"><span class="keyword">class</span>=<span class="title">UsersTableSeeder</span></span></div></pre></td></tr></table></figure>
<p>你也可以在使用 <code>migrate:refresh</code> 命令时运行 seed，这将回滚所有的迁移，然后再执行迁移，之后进行填充数据。这条命令对于应用的数据库重置非常有用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan migrate:refresh --seed</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/23/laravel-from-scratch-migrations/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/23/laravel-from-scratch-migrations/" itemprop="url">laravel 基础教程 —— 迁移</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-23T22:18:46+08:00">
                2016-06-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="数据库：迁移"><a href="#数据库：迁移" class="headerlink" title="数据库：迁移"></a>数据库：迁移</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>迁移就像是为数据库提供的版本控制，这允许你的团队可以轻易的修改和共享应用数据库结构。迁移通常配合 laravel 的结构生成器来轻松的构建应用中的数据库结构。</p>
<p>Laravel 的 <code>Schema</code> 假面提供了创建和操作数据库的相关支持。它为所有 Laravel 支持的数据库系统提供了丰富流畅的相同的 API 接口。</p>
<h2 id="生成迁移"><a href="#生成迁移" class="headerlink" title="生成迁移"></a>生成迁移</h2><p>你可以使用 <code>make:migration</code> Artisan 命令来生成迁移：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan make:migration create_users_table</div></pre></td></tr></table></figure>
<p>新生成的迁移将会被存放在 <code>database/migrations</code> 目录下，每个迁移文件都包含了创建时的时间戳，这样就可以指导 Laravel 按序的进行迁移操作。</p>
<p>你也可以使用 <code>--table</code> 和 <code>--create</code> 选项来指导迁移所创建的表的名称。这些选项只是简单的填充生成的迁移文件为指定的表：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">php artisan make:migration add_votes_to_users_table --table=users</div><div class="line"></div><div class="line">php artisan make:migration create_users_table --create=users</div></pre></td></tr></table></figure>
<p>如果你想要自定义生成迁移的路径，你可以使用 <code>--path</code> 选项。所提供的路径应该是基于应用根目录的相对路径。</p>
<h2 id="迁移结构"><a href="#迁移结构" class="headerlink" title="迁移结构"></a>迁移结构</h2><p>迁移类中包含了两个方法：<code>up</code> 和 <code>down</code>。<code>up</code> 方法用来添加新的表，列或者数据库中的索引。而 <code>down</code> 方法应该简单的执行 <code>up</code> 方法的逆操作。</p>
<p>在这个两个方法里你可以使用 Laravel 的结构生成器来进行表的创建和修改。对于所有的 <code>Schema</code> 生成器中可用的方法，请参考 <a href="https://laravel.com/docs/5.2/migrations#creating-tables" target="_blank" rel="external">文档</a>。比如，让我们来看一个简单的创建一个 <code>flights</code> 表的迁移：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Schema</span>\<span class="title">Blueprint</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Migrations</span>\<span class="title">Migration</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateFlightsTable</span> <span class="keyword">extends</span> <span class="title">Migration</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Run the migrations.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     Schema::create(<span class="string">'flights'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint $table)</span> </span>&#123;</div><div class="line">       $table-&gt;increments(<span class="string">'id'</span>);</div><div class="line">       $table-&gt;string(<span class="string">'name'</span>);</div><div class="line">       $table-&gt;string(<span class="string">'airline'</span>);</div><div class="line">       $table-&gt;timestamps();</div><div class="line">     &#125;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Reverse the migrations.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">down</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      Schema::drop(<span class="string">'flights'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="执行迁移"><a href="#执行迁移" class="headerlink" title="执行迁移"></a>执行迁移</h2><p>你可以使用 <code>migrate</code> Artisan 命令来执行迁移操作。如果你使用 <a href="https://laravel.com/docs/5.2/homestead" target="_blank" rel="external">Homestead virtual machine</a>，你应该在你的虚拟机中运行如下命令：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan migrate</div></pre></td></tr></table></figure>
<p>如果你在执行迁移的过程中出现 “class not found” 错误，你可以尝试运行 <code>composer dump-autoload</code> 命令然后重新运行迁移命令。</p>
<p><strong>在生成环境中强制迁移操作</strong></p>
<p>有时候迁移的操作是有害的，这意味着你可能会丢失数据。为了保护你在生产环境中不随意的进行迁移操作，Laravel 会提示你确认执行这些操作。你可以使用 <code>--force</code> 标识来取消这些提示：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan migrate --force</div></pre></td></tr></table></figure>
<h3 id="回滚迁移"><a href="#回滚迁移" class="headerlink" title="回滚迁移"></a>回滚迁移</h3><p>你可以使用 <code>rollback</code> 命令来将迁移回滚到上一次的迁移操作。你需要注意的是，这个回滚是对最后一次迁移的批量操作的回滚，它可能会包含多个迁移文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan migrate:rollback</div></pre></td></tr></table></figure>
<p><code>migrate:reset</code> 命令将回滚所有的迁移操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan migrate:reset</div></pre></td></tr></table></figure>
<p><strong>在同一个命令里执行回滚 / 迁移操作</strong></p>
<p><code>migrate:refresh</code> 命令会一次回滚所有的迁移操作，然后接着执行 <code>migrate</code> 命令。该命令可以有效的重新创建你的整个数据库：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">php artisan migrate:refresh</div><div class="line"></div><div class="line">php artisan migrate:refresh --seed</div></pre></td></tr></table></figure>
<h2 id="编写迁移"><a href="#编写迁移" class="headerlink" title="编写迁移"></a>编写迁移</h2><h2 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h2><p>你可以使用 <code>Schema</code> 假面的 <code>create</code> 方法来创建一个新的数据库表。<code>create</code> 方法接收两个参数，第一个参数为表的名称，第二个参数是一个 <code>Closure</code>，该闭包接收一个 <code>Blueprint</code> 对象用来对表进行定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Schema::create(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint $table)</span> </span>&#123;</div><div class="line">  $table-&gt;increments(<span class="string">'id'</span>); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>当然，当创建表时，你也可以使用任意的结构生成器的 <a href="https://laravel.com/docs/5.2/migrations#creating-columns" target="_blank" rel="external">列方法</a> 来定义表的列。</p>
<p><strong>检查表 / 列是否已经存在</strong></p>
<p>你可以通过使用 <code>hasTable</code> 和 <code>hasColumn</code> 方法来简单的检查所给定的表或者列是否存在：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Schema::hasTable(<span class="string">'users'</span>)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (Schema::hasColumn(<span class="string">'users'</span>, <span class="string">'email'</span>)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>连接 &amp; 存储引擎</strong></p>
<p>如果你想在不是默认的数据库连接中执行 schema 的操作，你可以使用 <code>connection</code> 方法来选择数据库连接：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Schema::connection(<span class="string">'foo'</span>)-&gt;create(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;increments(<span class="string">'id'</span>); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>你也可以在结构生成器中设置 <code>engine</code> 属性来指定表的存储引擎：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Schema::create(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;engine = <span class="string">'InnoDB'</span>;</div><div class="line"></div><div class="line">  $table-&gt;increments(<span class="string">'id'</span>); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="重命名-删除表"><a href="#重命名-删除表" class="headerlink" title="重命名 / 删除表"></a>重命名 / 删除表</h2><p>你可以使用 <code>rename</code> 方法来重命名已经存在的表：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Schema::rename($from, $to);</div></pre></td></tr></table></figure>
<p>你可以使用 <code>drop</code> 或者 <code>dropifExists</code> 方法来删除存在的表：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Schema::drop(<span class="string">'users'</span>);</div><div class="line"></div><div class="line">Schema::dropIfExists(<span class="string">'users'</span>);</div></pre></td></tr></table></figure>
<p><strong>重命名含有外键的表</strong></p>
<p>在对表进行重命名之前，你应该先确认表中所有的外键约束在迁移文件中都有一个明确的名称，而不是让 Laravel 分配基于惯例的名称。另外，外键约束名称将引用旧表名。</p>
<h3 id="创建列"><a href="#创建列" class="headerlink" title="创建列"></a>创建列</h3><p>你可以使用 <code>Schema</code> 假面的 <code>table</code> 方法来进行已经存在表的更新操作。像 <code>create</code> 方法一样，<code>table</code> 方法接收两个参数：表的名称和一个接收 <code>Blueprint</code> 实例的闭包，我们可以使用 <code>Blueprint</code> 实例来在表中添加列：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;string(<span class="string">'email'</span>); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>可用的列类型</strong></p>
<p>当然，结构生成器包含了各种的列类型，你可以在构建表时使用它们：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$table-&gt;bigIncrements(&#39;id&#39;);</code></td>
<td>使用 “UNSIGNED BIG INTEGER” 类型来设置自增的 ID（主键）</td>
</tr>
<tr>
<td><code>$table-&gt;bigInteger(&#39;votes&#39;);</code></td>
<td>使用 BIGINT 类型</td>
</tr>
<tr>
<td><code>$table-&gt;binary(&#39;data&#39;);</code></td>
<td>使用 BLOB 类型</td>
</tr>
<tr>
<td><code>$table-&gt;boolean(&#39;confirmed&#39;);</code></td>
<td>使用 BOOLEAN 类型</td>
</tr>
<tr>
<td><code>$table-&gt;char(&#39;name&#39;, 4);</code></td>
<td>使用 CHAR 类型</td>
</tr>
<tr>
<td><code>$table-&gt;date(&#39;created_at&#39;);</code></td>
<td>使用 DATE 类型</td>
</tr>
<tr>
<td><code>$table-&gt;dateTime(&#39;created_at&#39;);</code></td>
<td>使用 DATETIME 类型</td>
</tr>
<tr>
<td><code>$table-&gt;dateTimeTz(&#39;created_at&#39;);</code></td>
<td>使用 DATETIME (和时区) 类型</td>
</tr>
<tr>
<td><code>$table-&gt;decimal(&#39;amount&#39;, 5, 2);</code></td>
<td>使用 DECIMAL 类型并伴随一个精度和尺度</td>
</tr>
<tr>
<td><code>$table-&gt;double(&#39;column&#39;, 15, 8);</code></td>
<td>使用 DOUBLE 类型并伴随一个精度，总共 15 个有效数组，并且其中 8 个是小数</td>
</tr>
<tr>
<td><code>$table-&gt;enum(&#39;choices&#39;, [&#39;foo&#39;, &#39;bar&#39;]);</code></td>
<td>使用 ENUM 类型</td>
</tr>
<tr>
<td><code>$table-&gt;float(&#39;amount&#39;);</code></td>
<td>使用 FLOAT 类型</td>
</tr>
<tr>
<td><code>$table-&gt;increments(&#39;id&#39;);</code></td>
<td>使用 UNSIGNED INTEGER 类型设置自增的 ID（主键）</td>
</tr>
<tr>
<td><code>$table-&gt;integer(&#39;votes&#39;);</code></td>
<td>使用 INTEGER 类型</td>
</tr>
<tr>
<td><code>$table-&gt;ipAddress(&#39;visitor&#39;);</code></td>
<td>使用 IP 地址类型</td>
</tr>
<tr>
<td><code>$table-&gt;json(&#39;options&#39;);</code></td>
<td>使用 JSON 类型</td>
</tr>
<tr>
<td><code>$table-&gt;jsonb(&#39;options&#39;);</code></td>
<td>使用 JSONB 类型</td>
</tr>
<tr>
<td><code>$table-&gt;longText(&#39;description&#39;);</code></td>
<td>使用 LONGTEXT 类型</td>
</tr>
<tr>
<td><code>$table-&gt;macAddress(&#39;device&#39;);</code></td>
<td>使用 MAC 地址类型</td>
</tr>
<tr>
<td><code>$table-&gt;mediumInteger(&#39;numbers&#39;);</code></td>
<td>使用 MEDIUMINT 类型</td>
</tr>
<tr>
<td><code>$table-&gt;mediumText(&#39;description&#39;);</code></td>
<td>使用 MEDIUMTEXT 类型</td>
</tr>
<tr>
<td><code>$table-&gt;morphs(&#39;taggable&#39;);</code></td>
<td>添加一个 INTEGER 类型的 <code>taggable_id</code> 和一个 STRING 类型的 <code>taggable_type</code></td>
</tr>
<tr>
<td><code>$table-&gt;nullableTimestamps();</code></td>
<td>和 <code>timestamps()</code> 一样，除了允许 NULLs</td>
</tr>
<tr>
<td><code>$table-&gt;rememberToken();</code></td>
<td>添加 VARCHAR(100) NULL <code>remember_token</code></td>
</tr>
<tr>
<td><code>$table-&gt;smallInteger(&#39;votes&#39;);</code></td>
<td>使用 SMALLINT 类型</td>
</tr>
<tr>
<td><code>$table-&gt;softDeletes();</code></td>
<td>为软删除添加 <code>delete_at</code> 列</td>
</tr>
<tr>
<td><code>$table-&gt;string(&#39;email&#39;);</code></td>
<td>使用 VARCHAR 类型</td>
</tr>
<tr>
<td><code>$table-&gt;string(&#39;name&#39;, 100);</code></td>
<td>使用 VARCHAR 类型并伴随一个长度。</td>
</tr>
<tr>
<td><code>$table-&gt;text(&#39;description&#39;);</code></td>
<td>使用 TEXT 类型</td>
</tr>
<tr>
<td><code>$table-&gt;time(&#39;sunrise&#39;);</code></td>
<td>使用 TIME 类型</td>
</tr>
<tr>
<td><code>$table-&gt;timeTz(&#39;sunrise&#39;);</code></td>
<td>使用 TIME （伴随时区）类型</td>
</tr>
<tr>
<td><code>$table-&gt;tinyInteger(&#39;numbers&#39;);</code></td>
<td>使用 TINYINT 类型</td>
</tr>
<tr>
<td><code>$table-&gt;timestamp(&#39;added_on&#39;);</code></td>
<td>使用 TIMESTAMP 类型</td>
</tr>
<tr>
<td><code>$table-&gt;timestampTz(&#39;added_on&#39;);</code></td>
<td>使用 TIMESTAMP 类型</td>
</tr>
<tr>
<td><code>$table-&gt;timestamps();</code></td>
<td>添加 <code>created_at</code> 和 <code>updated_at</code> 列</td>
</tr>
<tr>
<td><code>$table-&gt;uuid(&#39;id&#39;);</code></td>
<td>使用 UUID 类型</td>
</tr>
</tbody>
</table>
<p><strong>修改列</strong></p>
<p>除了上面所列出的列类型，这里也提供了一些其他在添加列的同时增加一些修正的功能。比如，你可以使用 <code>nullable</code> 方法来让列可以为 <code>NULL</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;string(<span class="string">'email'</span>)-&gt;nullable(); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>下面列出了一些可用的列的修正方法，这里并没有包含 <a href="https://laravel.com/docs/5.2/migrations#creating-indexes" target="_blank" rel="external">index modifiers</a>:</p>
<table>
<thead>
<tr>
<th>变化</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-&gt;first()</code></td>
<td>将列放在表的首列（仅支持 MySQL)</td>
</tr>
<tr>
<td><code>-&gt;after(&#39;column&#39;)</code></td>
<td>将列放置在其他列之后（仅支持 MySQL)</td>
</tr>
<tr>
<td><code>-&gt;nullable()</code></td>
<td>允许列中存在 NULL 值</td>
</tr>
<tr>
<td><code>-&gt;default($value)</code></td>
<td>为列指定默认值</td>
</tr>
<tr>
<td><code>-&gt;unsigned()</code></td>
<td>设置 <code>integer</code> 列为 <code>UNSIGNED</code></td>
</tr>
<tr>
<td><code>-&gt;comment(&#39;my comment&#39;)</code></td>
<td>为列添加注释</td>
</tr>
</tbody>
</table>
<h3 id="进行列的修改"><a href="#进行列的修改" class="headerlink" title="进行列的修改"></a>进行列的修改</h3><p><strong>先决条件</strong></p>
<p>在进行列的修改之前，你需要先在 <code>composer.json</code> 文件中添加 <code>doctrine/dbal</code> 用来。Doctrine DBAL 类库用来确定列的当前状态，并创建指定列所需调整的 SQL 查询。</p>
<p><strong>更新列的属性</strong></p>
<p><code>change</code> 方法允许你修改已存在的列的类型，或者修改列的属性。比如，你可能希望增加字符串类型的列的长度。你可以使用 <code>change</code> 方法来让 <code>name</code> 列的长度从 25 到 50：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;string(<span class="string">'name'</span>, <span class="number">50</span>)-&gt;change(); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们也想要将列修改为允许 NULL：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;string(<span class="string">'name'</span>, <span class="number">50</span>)-&gt;nullable()-&gt;chage(); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>注意: 修改表中含有 <code>enum</code> 类型的列的表中的任意列，目前都没有得到支持。</p>
</blockquote>
<p><strong>列的重命名</strong></p>
<p>你可以使用结构生成器的 <code>renameColumn</code> 方法来对列进行重命名,在进行重命名之前，你需要确保 <code>composer.json</code> 文件中引入了 <code>doctrine/dbal</code> 依赖：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;renameColumn(<span class="string">'from'</span>, <span class="string">'to'</span>); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>注意: 重命名表中含有 <code>enum</code> 类型的列的表，目前都没有得到支持。</p>
</blockquote>
<h3 id="删除列"><a href="#删除列" class="headerlink" title="删除列"></a>删除列</h3><p>你可以使用结构生成器中的 <code>dropColumn</code> 方法来删除一列：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;dropColumn(<span class="string">'votes'</span>); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>你也可以传递一个包含了列名称的数组到 <code>dropColumn</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;dropColumn([<span class="string">'votes'</span>, <span class="string">'avatar'</span>, <span class="string">'location'</span>]); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：如果你删除的是 SQLite 数据库里的列，你需要先在 <code>composer.json</code> 文件里引入 <code>doctrine/dbal</code> 依赖，并且执行 <code>composer update</code> 命令来安装这个类库。<br>注意： 在使用 SQLite 数据库时，使用单个迁移操作来删除或者修改多个列是行不通的。</p>
</blockquote>
<h3 id="建立索引"><a href="#建立索引" class="headerlink" title="建立索引"></a>建立索引</h3><p>结构生成器支持多种类型的索引。首先，让我们看一个简单的例子，这个例子指定列的值应该是唯一的。为了创建索引，我们可以简单的在列的定义中链式调用 <code>unique</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$table-&gt;string(<span class="string">'email'</span>)-&gt;unique();</div></pre></td></tr></table></figure>
<p>另外，你也可以在定义完列之后添加索引：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$table-&gt;unique(<span class="string">'email'</span>);</div></pre></td></tr></table></figure>
<p>你也可以通过传递一个列名的数组到 <code>index</code> 方法来创建一个复合的索引：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$table-&gt;index([<span class="string">'account_id'</span>, <span class="string">'created_at'</span>]);</div></pre></td></tr></table></figure>
<p>Laravel 会自动的生成一个合理的索引名称，但是你也可以传递第二个参数来指定索引名称：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$table-&gt;index(<span class="string">'email'</span>, <span class="string">'my_index_name'</span>);</div></pre></td></tr></table></figure>
<p><strong>可用的索引类型</strong></p>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$table-&gt;primary(&#39;id&#39;);</code></td>
<td>添加主键</td>
</tr>
<tr>
<td><code>$table-&gt;primary([&#39;first&#39;, &#39;last&#39;]);</code></td>
<td>添加复合键</td>
</tr>
<tr>
<td><code>$table-&gt;unique(&#39;email&#39;);</code></td>
<td>添加唯一的索引</td>
</tr>
<tr>
<td><code>$table-&gt;unique(&#39;state&#39;, &#39;my_index_name&#39;);</code></td>
<td>添加自定义的索引名称</td>
</tr>
<tr>
<td><code>$table-&gt;index(&#39;state&#39;);</code></td>
<td>添加基础的索引</td>
</tr>
</tbody>
</table>
<h3 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h3><p>你需要指定一个索引的名称才能删除索引，默认的 Laravel 会自动的分配一个合理的名称到索引。它只是简单的连接表名，索引的列名，索引的类型。这里有一些示例：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$table-&gt;dropPrimary(&#39;users_id_primary&#39;);</code></td>
<td>从用户表中删除主键</td>
</tr>
<tr>
<td><code>$table-&gt;dropUnique(&#39;users_email_unique&#39;);</code></td>
<td>从用户表中删除唯一的索引</td>
</tr>
<tr>
<td><code>$table-&gt;dropIndex(&#39;geo_stage_index&#39;);</code></td>
<td>从 geo 表中删除基础的索引</td>
</tr>
</tbody>
</table>
<p>如果你传递一个列名所组成的数组到删除索引的方法中，常规的索引的名称将根据表名，列名和键的类型来生成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Schema::table(<span class="string">'geo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;dropIndex([<span class="string">'state'</span>]); <span class="comment">// Drops index 'geo_state_index' </span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="外键约束"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束</h3><p>Laravel 也对创建外键约束提供了支持，外键约束用于强制参照表中数据的完整性。比如，让我们在 <code>posts</code> 表中定义一个 <code>user_id</code> 列，并且关联 <code>users</code> 表中的 <code>id</code> 列：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Schema::table(<span class="string">'posts'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;integer(<span class="string">'user_id'</span>)-&gt;unsigned();</div><div class="line"></div><div class="line">  $table-&gt;foreign(<span class="string">'user_id'</span>)-&gt;references(<span class="string">'id'</span>)-&gt;on(<span class="string">'users'</span>); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>你也可以指定约束的“关于删除”和“更新”属性所需要的操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$table-&gt;foreign(<span class="string">'user_id'</span>)</div><div class="line">      -&gt;references(<span class="string">'id'</span>)-&gt;on(<span class="string">'users'</span>)</div><div class="line">      -&gt;onDelete(<span class="string">'cascade'</span>);</div></pre></td></tr></table></figure>
<p>你可以使用 <code>dropForegin</code> 方法来移除外键。外键约束使用了和索引相同的命名方式。所以，我们会串联表名，列名，和 “_foreign” 后缀：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$table-&gt;dropForeign(<span class="string">'posts_user_id_foreign'</span>);</div></pre></td></tr></table></figure>
<p>或者你也可以通过传递一个包含列名的数组，它会自动的使用惯例命名来进行外键的移除：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$table-&gt;dropForeign([<span class="string">'user_id'</span>]);</div></pre></td></tr></table></figure>
<p>你也可以在你的迁移中使用下面的方法来开启或者关闭外键约束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Schema::enableForeignKeyConstraints();</div><div class="line"></div><div class="line">Schema::diableForeignKeyConstraints();</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/23/laravel-from-scratch-query-builder/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/23/laravel-from-scratch-query-builder/" itemprop="url">laravel 基础教程 —— 查询生成器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-23T14:53:08+08:00">
                2016-06-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="数据库：查询生成器"><a href="#数据库：查询生成器" class="headerlink" title="数据库：查询生成器"></a>数据库：查询生成器</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Laravel 的数据库查询生成器提供了一种方便流利的接口来构建和运行数据库查询。它可以用来在应用中提供执行大多数的数据库操作，并且它可以在所有支持的数据库系统中进行协作。</p>
<blockquote>
<p>注意：Laravel 的查询生成器使用了 PDO 参数绑定来针对可能的 SQL 注入攻击。所以这里不需要手动的去清洗作为绑定所传递的字符串。</p>
</blockquote>
<h2 id="检索结果"><a href="#检索结果" class="headerlink" title="检索结果"></a>检索结果</h2><p><strong>从表中检索所有的行</strong></p>
<p>在开始流畅的执行查询之前，你需要先使用 <code>DB</code> 假面的 <code>table</code> 方法，<code>table</code> 方法会返回一个给定表的查询生成器实例，这允许你链式添加多种查询约束，并最终获取结果。我们来看一个示例，我们只是调用 <code>get</code> 来获取所有的表中的记录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">DB</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Show a list of all of the application's users.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $users = DB::table(<span class="string">'users'</span>)-&gt;get();</div><div class="line"></div><div class="line">     <span class="keyword">return</span> view(<span class="string">'user.index'</span>, [<span class="string">'users'</span> =&gt; $users]);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就像原生的查询一样，<code>get</code> 方法会返回一个 <code>array</code> ，其每一项结果都是一个 <code>StdClass</code> PHP 类的对象。你可以通过其属性来访问每一列的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">foreach</span> ($users <span class="keyword">as</span> $user) &#123;</div><div class="line">  <span class="keyword">echo</span> $user-&gt;name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>从表中检索一个单独的行或者列</strong></p>
<p>如果你只需要从数据表中检索出单独的一行，你可以使用 <code>first</code> 方法，该方法会返回一个单独的 <code>StdClass</code> 对象：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'name'</span>, <span class="string">'John'</span>)-&gt;first();</div><div class="line"></div><div class="line"><span class="keyword">echo</span> $user-&gt;name;</div></pre></td></tr></table></figure>
<p>如果你甚至不需要一个完整的行，那么你可以通过使用 <code>value</code> 方法从记录中获取一个精确的列的值。该方法会直接返回列中的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$email = DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'name'</span>, <span class="string">'John'</span>)-&gt;value(<span class="string">'email'</span>);</div></pre></td></tr></table></figure>
<p><strong>对结果进行分块</strong></p>
<p>如果你与表中的数千条记录协作，你可以考虑使用 <code>chunk</code> 方法，该方法一次会从结果中检索出一小块。并且将这每一块放进闭包中提供给进程。该方法对于编写 Artisan 命令来协作数千条的记录非常有用。比如，让我们将整个用户表分块成每次 100 条来工作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;orderBy(<span class="string">'id'</span>)-&gt;chunk(<span class="number">100</span>, <span class="function"><span class="keyword">function</span> <span class="params">($users)</span> </span>&#123;</div><div class="line">  <span class="keyword">foreach</span> ($users <span class="keyword">as</span> $user) &#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">  &#125; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>你可以通过在 <code>Closure</code> 中返回 <code>false</code> 来停止进一步的处理块的操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;orderBy(<span class="string">'id'</span>)-&gt;chunk(<span class="number">100</span>, <span class="function"><span class="keyword">function</span> <span class="params">($users)</span> </span>&#123;</div><div class="line">  <span class="comment">// Process the records...</span></div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="keyword">false</span>; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>检索表列的值</strong></p>
<p>如果你希望获取一个数组来包含一个列中所有的值，你可以使用 <code>pluck</code> 方法，在这个例子中，我们将获取所有的角色名称：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$titles = DB::table(<span class="string">'roles'</span>)-&gt;pluck(<span class="string">'title'</span>);</div><div class="line"></div><div class="line"><span class="keyword">foreach</span>($titles <span class="keyword">as</span> $title) &#123;</div><div class="line">  <span class="keyword">echo</span> $title;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你也可以为所返回的数组指定自定义的键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$roles = DB::table(<span class="string">'roles'</span>)-&gt;pluck(<span class="string">'title'</span>, <span class="string">'name'</span>);</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($roles <span class="keyword">as</span> $name =&gt; $title) &#123;</div><div class="line">  <span class="keyword">echo</span> $title;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="合计"><a href="#合计" class="headerlink" title="合计"></a>合计</h3><p>查询生成器也提供了多种合计的方法。比如 <code>count</code>，<code>max</code>，<code>min</code>，<code>avg</code>，和 <code>sum</code>。你可以在查询构建后调用这些方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;count();</div><div class="line"></div><div class="line">$price = DB::table(<span class="string">'orders'</span>)-&gt;max(<span class="string">'price'</span>);</div></pre></td></tr></table></figure>
<p>当然，你可以结合其它约束来构建你的查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$price = DB::table(<span class="string">'orders'</span>)</div><div class="line">           -&gt;where(<span class="string">'finalized'</span>, <span class="number">1</span>)</div><div class="line">           -&gt;avg(<span class="string">'price'</span>);</div></pre></td></tr></table></figure>
<h3 id="选择"><a href="#选择" class="headerlink" title="选择"></a>选择</h3><p><strong>指定一个选择约束</strong></p>
<p>当然，你不会总是想要从数据库中获取所有的列。你可以使用 <code>select</code> 方法来指定一个自定义的 <code>select</code> 约束到查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'name'</span>, <span class="string">'email as user_email'</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p><code>distinct</code> 方法允许你强迫查询返回一个不重复的结果：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;distinct()-&gt;get();</div></pre></td></tr></table></figure>
<p>如果你已经获取了查询生成器的实例，并且你想要在已经添加过选择约束的实例中添加额外一列的检索，你可以使用 <code>addSelect</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$query = DB::table(<span class="string">'users'</span>)-&gt;select(<span class="string">'name'</span>);</div><div class="line"></div><div class="line">$users = $query-&gt;addSelect(<span class="string">'age'</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p><strong>原生的表达式</strong></p>
<p>有时候，你可能需要在查询时使用原生的表达式，这些表达式会以字符串的方式注入到查询中，所以你应该小心的不要构造出任何的 SQL 注入点。你可以使用 <code>DB::raw</code> 方法来构造一个原生的表达式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;select(DB::raw(<span class="string">'count(*) as user_count, status'</span>))</div><div class="line">           -&gt;where(<span class="string">'status'</span>, <span class="string">'&lt;&gt;'</span>, <span class="number">1</span>)</div><div class="line">           -&gt;groupBy(<span class="string">'status'</span>)</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<h2 id="Joins"><a href="#Joins" class="headerlink" title="Joins"></a>Joins</h2><p><strong>内连接声明</strong></p>
<p>查询生成器也可以用来编写 join 声明。为了执行一个基础的 SQL 内连接，你可以在查询生成器中使用 <code>join</code> 方法。<code>join</code> 方法所接收的第一个参数应该是你需要加入的表的名称，而其它的参数则是对加入提供约束。当然，就如你所看到的，你可以在一个查询中加入多个表：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;join(<span class="string">'contacts'</span>, <span class="string">'users.id'</span>, <span class="string">'='</span>, <span class="string">'contacts.user_id'</span>)</div><div class="line">           -&gt;join(<span class="string">'orders'</span>, <span class="string">'users.id'</span>, <span class="string">'='</span>, <span class="string">'orders.user_id'</span>)</div><div class="line">           -&gt;select(<span class="string">'users.*'</span>, <span class="string">'contacts.phone'</span>, <span class="string">'orders.price'</span>)</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p><strong>左连接声明</strong></p>
<p>如果你需要执行 <code>left join</code> 来代替 <code>inner join</code>，你可以使用 <code>leftJoin</code> 方法，<code>leftJoin</code> 方法具有和 <code>join</code> 方法相同的使用方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;leftJoin(<span class="string">'posts'</span>, <span class="string">'users.id'</span>, <span class="string">'='</span>, <span class="string">'posts.user_id'</span>)</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p><strong>交叉连接声明</strong></p>
<p>你可以使用 <code>crossJoin</code> 方法来执行一个交叉的连接操作，你需要为 <code>crossJoin</code> 提供一个你想要交叉连接的表名。交叉连接会生成第一个表和加入的表的笛卡尔积：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'sizes'</span>)</div><div class="line">           -&gt;crossJoin(<span class="string">'colours'</span>)</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p><strong>高级的 Join 声明</strong></p>
<p>你也可以指定更高级的 join 约束。你可以传递一个 <code>Closure</code> 作为 <code>join</code> 方法的第二个参数。<code>Closure</code> 会接收一个 <code>JoinClause</code> 对象并且该对象允许你指定 <code>join</code> 约束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">  -&gt;join(<span class="string">'contacts'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($join)</span> </span>&#123;</div><div class="line">    $join-&gt;on(<span class="string">'users.id'</span>, <span class="string">'='</span>, <span class="string">'contacts.user_id'</span>)-&gt;orOn(...); </div><div class="line">  &#125;)</div><div class="line">  -&gt;get();</div></pre></td></tr></table></figure>
<p>如果你喜欢在 joins 中使用 <code>where</code> 风格约束，那么你可以在 join 上使用 <code>where</code> 和 <code>orWhere</code> 方法。该方法会比较列的值而取代直接比较两列：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">  -&gt;join(<span class="string">'contacts'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($join)</span> </span>&#123;</div><div class="line">    $join-&gt;on(<span class="string">'users.id'</span>, <span class="string">'='</span>, <span class="string">'contacts.user_id'</span>)</div><div class="line">      -&gt;where(<span class="string">'contacts.user_id'</span>, <span class="string">'&gt;'</span>, <span class="number">5</span>);</div><div class="line">  &#125;)</div><div class="line">  -&gt;get();</div></pre></td></tr></table></figure>
<h2 id="Unions（联合）"><a href="#Unions（联合）" class="headerlink" title="Unions（联合）"></a>Unions（联合）</h2><p>查询生成器也提供了一种快捷的方式来将两个查询联合起来。比如，你可以构建一个初始化的查询，然后使用 <code>union</code> 方法来将其与之后的查询联合起来：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$first = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;whereNull(<span class="string">'first_name'</span>);</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;whereNull(<span class="string">'last_name'</span>)</div><div class="line">           -&gt;union($first)</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p><code>unionAll</code> 方法也是可用的，并且它与 <code>union</code> 方法具有相同的签证方式。</p>
<h2 id="Where-子句"><a href="#Where-子句" class="headerlink" title="Where 子句"></a>Where 子句</h2><p><strong>简单的 Where 子句</strong></p>
<p>你可以在查询生成器中使用 <code>where</code> 方法来在查询中添加 <code>where</code> 约束。大多数基础的 <code>where</code> 调用都需要提供三个参数，第一个参数是列的名称，第二个参数是比较操作的方式，第三个参数则是针对列所需要评估的值。</p>
<p>比如，这里的查询用来验证 “votes” 列的值等于 100:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'votes'</span>, <span class="string">'='</span>, <span class="number">100</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p>为了方便，你可以直接传递需要比较的值到第二个参数来表明列值与给定值相等的判断：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'votes'</span>, <span class="number">100</span>)-&gt;get();</div></pre></td></tr></table></figure>
<p>当然，你也可以在使用 <code>where</code> 子句时使用其它的操作符：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;where(<span class="string">'votes'</span>, <span class="string">'&gt;='</span>, <span class="number">100</span>)</div><div class="line">           -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;where(<span class="string">'votes'</span>, <span class="string">'&lt;&gt;'</span>, <span class="number">100</span>)</div><div class="line">           -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;where(<span class="string">'name'</span>, <span class="string">'like'</span>, <span class="string">'T%'</span>)</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p>你也可以传递一个数组所组成的条件到 <code>where</code> 方法中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;where([</div><div class="line">  [status<span class="string">', '</span><span class="number">1</span><span class="string">'],</span></div><div class="line"><span class="string">  ['</span>subscribed<span class="string">','</span>&lt;&gt;<span class="string">', '</span><span class="number">1</span><span class="string">'],</span></div><div class="line"><span class="string">])-&gt;get();</span></div></pre></td></tr></table></figure>
<p><strong>或声明</strong></p>
<p>你可以将 where 约束连在一起，以及添加 <code>or</code> 子句到查询中。<code>orWhere</code> 方法接收和 <code>where</code> 方法相同的参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;where(<span class="string">'votes'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>)</div><div class="line">           -&gt;orWhere(<span class="string">'name'</span>, <span class="string">'John'</span>)</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p><strong>其它 Where 子句</strong></p>
<p><strong>whereBetween</strong></p>
<p><code>whereBetween</code> 方法确定列的值是否在两个给定值之间：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;whereBetween(<span class="string">'votes'</span>, [<span class="number">1</span>, <span class="number">100</span>])-&gt;get();</div></pre></td></tr></table></figure>
<p><strong>whereNotBetween</strong></p>
<p><code>whereNotBetween</code> 方法确定列的值应该不在所给定值区间内：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;whereNotBetween(<span class="string">'votes'</span>, [<span class="number">1</span>, <span class="number">100</span>])</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p><strong>whereIn / whereNotIn</strong></p>
<p><code>whereIn</code> 方法验证给定的列的值应该是给定的数组值中之一：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;whereIn(<span class="string">'id'</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p><code>whereNotIn</code> 方法验证所给定的列的值应该不在给定的数组中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;whereNotIn(<span class="string">'id'</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p><strong>whereNull / whereNotNull</strong></p>
<p><code>whereNull</code> 方法验证所给定列的值应该是 <code>NULL</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;whereNull(<span class="string">'updated_at'</span>)</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p><code>whereNotNull</code> 方法验证所给定的列的值不应该为 <code>NULL</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$users = DB::(<span class="string">'users'</span>)</div><div class="line">           -&gt;whereNotNull(<span class="string">'updated_at'</span>)</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p><strong>whereColumn</strong></p>
<p><code>whereColumn</code> 方法可以用来判断两列的值是否相等：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;whereColumn(<span class="string">'first_name'</span>, <span class="string">'last_name'</span>);</div></pre></td></tr></table></figure>
<p>你也可以传递一个比较符到方法中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;whereColumn(<span class="string">'updated_at'</span>, <span class="string">'&gt;'</span>, <span class="string">'created_at'</span>);</div></pre></td></tr></table></figure>
<p><code>whereColumn</code> 方法可以接收一个包含了多个限制条件的数组。这些条件会被使用 <code>add</code> 判定操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;whereColumn([</div><div class="line">             [<span class="string">'first_name'</span>, <span class="string">'last_name'</span>],</div><div class="line">             [<span class="string">'updated_at'</span>, <span class="string">'&gt;'</span>, <span class="string">'created_at'</span>]</div><div class="line">           ]);</div></pre></td></tr></table></figure>
<h2 id="高级-Where-子句"><a href="#高级-Where-子句" class="headerlink" title="高级 Where 子句"></a>高级 Where 子句</h2><p><strong>参数分组</strong></p>
<p>有时候你需要构建一些更加高级的 where 子句，比如，“where exists”或者嵌套的参数分组。Laravel 的查询生成器也能很好的处理这些。让我们来看一个分组括号内约束的例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">  -&gt;where(<span class="string">'name'</span>, <span class="string">'='</span>, <span class="string">'John'</span>)</div><div class="line">  -&gt;orWhere(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">    $query-&gt;where(<span class="string">'votes'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>)</div><div class="line">          -&gt;where(<span class="string">'title'</span>, <span class="string">'&lt;&gt;'</span>, <span class="string">'Admin'</span>);</div><div class="line">  &#125;)</div><div class="line">  -&gt;get();</div></pre></td></tr></table></figure>
<p>就如你所看到的，传递一个 <code>Closure</code> 到 <code>orWhere</code> 方法来指导查询生成器开始一个组约束。<code>Closure</code> 会接收一个查询生成器的实例，这样你就可以在括号组内构建一些约束。上面的示例将会生成下面的 SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'John'</span> <span class="keyword">or</span> (votes &gt; <span class="number">100</span> <span class="keyword">and</span> title &lt;&gt; <span class="string">'Admin'</span>)</div></pre></td></tr></table></figure>
<p><strong>Exists 声明</strong></p>
<p><code>whereExists</code> 方法允许你编写 <code>where exists</code> SQL 子句。<code>whereExists</code> 方法接收一个 <code>Closure</code> 参数，这个闭包会接收一个查询生成器实例，这允许你在 “exists” 子句中去构建查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">  -&gt;whereExists(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">    $query-&gt;select(DB::raw(<span class="number">1</span>))</div><div class="line">      -&gt;from(<span class="string">'orders'</span>)</div><div class="line">      -&gt;whereRaw(<span class="string">'orders.user_id = users.id'</span>);</div><div class="line">  &#125;)</div><div class="line">  -&gt;get();</div></pre></td></tr></table></figure>
<p>上面的查询将生成下面的 SQL:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span></div><div class="line"><span class="keyword">where</span> <span class="keyword">exists</span> (</div><div class="line">  <span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> orders <span class="keyword">where</span> orders.user_id = users.id</div><div class="line">)</div></pre></td></tr></table></figure>
<h2 id="JSON-where-子句"><a href="#JSON-where-子句" class="headerlink" title="JSON where 子句"></a>JSON where 子句</h2><p>Laravel 支持对支持 JSON 列类型的数据库查询 JSON 类型的列。目前，这只包含在 MySQL 5.7 和 Postgres。你需要使用 <code>-&gt;</code> 操作符来查询 JSON 列：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;where(<span class="string">'options-&gt;language'</span>, <span class="string">'en'</span>)</div><div class="line">           -&gt;get();</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;where(<span class="string">'preferences-&gt;dining-&gt;meal'</span>, <span class="string">'salad'</span>)</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<h2 id="排序，分组，限制-amp-位移"><a href="#排序，分组，限制-amp-位移" class="headerlink" title="排序，分组，限制 &amp; 位移"></a>排序，分组，限制 &amp; 位移</h2><p><strong>orderBy</strong></p>
<p><code>orderBy</code> 方法允许你对给定列的查询结果进行排序。<code>orderBy</code> 所接受的第一个参数应该是你希望进行排序的列，而第二个参数应该是你决定进行排序的方向，它们应该是 <code>asc</code> 或者 <code>desc</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;orderBy(<span class="string">'name'</span>, <span class="string">'desc'</span>)</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p><strong>inRandomOrder</strong></p>
<p><code>inRandomOrder</code> 方法可以用来对查询的结果进行随机排序。比如，你可以使用这个方法来随机的获取用户：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$randomUser = DB::table(<span class="string">'users'</span>)</div><div class="line">                -&gt;inRandomOrder()</div><div class="line">                -&gt;first();</div></pre></td></tr></table></figure>
<p><strong>groupBy / having / havingRaw</strong></p>
<p><code>groupBy</code> 和 <code>having</code> 方法可以用来对查询结果进行分组。<code>having</code> 方法具有和 <code>where</code> 方法相同的签证：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;groupBy(<span class="string">'account_id'</span>)</div><div class="line">           -&gt;having(<span class="string">'account_id'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>)</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p><code>havingRaw</code> 方法可以用来在 <code>having</code> 子句中使用原生的字符串值，比如，我们可以找到所有销售额大于 $2,500 的部门：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'orders'</span>)</div><div class="line">           -&gt;select(<span class="string">'department'</span>, DB::raw(<span class="string">'SUM(price) as total_sales'</span>))</div><div class="line">           -&gt;groupBy(<span class="string">'department'</span>)</div><div class="line">           -&gt;havingRaw(<span class="string">'SUM(price) &gt; 2500'</span>)</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p><strong>skip / take</strong></p>
<p>你可以使用 <code>take</code> 和 <code>skip</code> 方法来限制查询所返回结果的数量和在查询中跳过一定的数目（<code>offset</code>）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$users = DB::table(<span class="string">'users'</span>)-&gt;skip(<span class="number">10</span>)-&gt;take(<span class="number">5</span>)-&gt;get();</div></pre></td></tr></table></figure>
<h2 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h2><p>有时候你可能希望只有当某些条件达成时才去添加一些查询到语句中。又或者你想要在只有进入的请求数据中含有指定的字段时才会判断在 <code>where</code> 子句中进行加入。你可以使用 <code>when</code> 方法来做到这些：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$role = $request-&gt;input(<span class="string">'role'</span>);</div><div class="line"></div><div class="line">$users = DB::table(<span class="string">'users'</span>)</div><div class="line">           -&gt;where($role, <span class="function"><span class="keyword">function</span> <span class="params">($query)</span> <span class="title">use</span> <span class="params">($role)</span> </span>&#123;</div><div class="line">             <span class="keyword">return</span> $query-&gt;where(<span class="string">'role_id'</span>, $role);</div><div class="line">           &#125;)</div><div class="line">           -&gt;get();</div></pre></td></tr></table></figure>
<p><code>when</code> 方法只有所给定的第一个参数为 <code>true</code> 时才会执行给定的闭包。如果第一个参数是 <code>false</code>，那么闭包将不会被执行。</p>
<h2 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h2><p>查询生成器也为插入记录到数据库中提供了 <code>insert</code> 方法。<code>insert</code> 方法可以接受列名所组成的键值对数组作为参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;insert(</div><div class="line">  [<span class="string">'email'</span> =&gt; <span class="string">'john@example.com'</span>, <span class="string">'votes'</span> =&gt; <span class="number">0</span>]</div><div class="line">);</div></pre></td></tr></table></figure>
<p>你也可以在一次调用 <code>insert</code> 方法时添加多条记录到数据库中，你需要传递一个嵌套的数组，数组中的每一个数组都代表了数据库中的一行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;insert([</div><div class="line">  [<span class="string">'email'</span> =&gt; <span class="string">'taylor@example.com'</span>, <span class="string">'votes'</span> =&gt; <span class="number">0</span>],</div><div class="line">  [<span class="string">'email'</span> =&gt; <span class="string">'dayle@example.com'</span>, <span class="string">'votes'</span> =&gt; <span class="number">0</span>]</div><div class="line">]);</div></pre></td></tr></table></figure>
<p><strong>自动递增的 IDs</strong></p>
<p>如果挑中存在自动递增的 id，你可以使用 <code>insertGetId</code> 方法来插入记录的同时获取 ID：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$id = DB::table(<span class="string">'users'</span>)-&gt;insertGetId(</div><div class="line">  [<span class="string">'email'</span> =&gt; <span class="string">'john@example.com'</span>, <span class="string">'votes'</span> =&gt; <span class="number">0</span>]</div><div class="line">);</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：当使用 PostgreSQL 时，insertGetId 方法期望自增的列名为 <code>id</code>。如果你想要检索的 ID 是一个其他列名，你需要传递列名到 <code>insertGetId</code> 方法的第二个参数。</p>
</blockquote>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><p>当然，除了新增记录之外，查询生成器也提供了为数据库中存在的记录更新的 <code>update</code> 方法。<code>update</code> 方法像 <code>insert</code> 方法一样，接收一个键值对所组成的数组来进行列值的更新。你可以在使用 <code>update</code> 查询时使用 <code>where</code> 子句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)</div><div class="line">  -&gt;where(<span class="string">'id'</span>, <span class="number">1</span>)</div><div class="line">  -&gt;update([<span class="string">'votes'</span> =&gt; <span class="number">1</span>]);</div></pre></td></tr></table></figure>
<p><strong>增量 / 递减</strong></p>
<p>查询生成器也提供一些方便的方法来对列的值进行增量和递减。这只是一种快捷的方式，用来提供比手动写入 <code>update</code> 语句更具表现力和简洁的接口。</p>
<p>这两种方法都接收最少一个参数：待修改的列名，第二个参数是一个可选的参数，它用来控制递增或者递减的数量：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;increment(<span class="string">'votes'</span>);</div><div class="line"></div><div class="line">DB::table(<span class="string">'users'</span>)-&gt;increment(<span class="string">'votes'</span>, <span class="number">5</span>);</div><div class="line"></div><div class="line">DB::table(<span class="string">'users'</span>)-&gt;decrement(<span class="string">'votes'</span>);</div><div class="line"></div><div class="line">DB::table(<span class="string">'users'</span>)-&gt;decrement(<span class="string">'votes'</span>, <span class="number">5</span>);</div></pre></td></tr></table></figure>
<p>你也可以指定同时更新额外的列：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;increment(<span class="string">'votes'</span>, <span class="number">1</span>, [<span class="string">'name'</span> =&gt; <span class="string">'John'</span>]);</div></pre></td></tr></table></figure>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><p>当然，查询生成器也提供了从数据库中删除记录的 <code>delete</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;delete();</div></pre></td></tr></table></figure>
<p>你可以在调用 <code>delete</code> 方法之前添加一些 <code>where</code> 子句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'votes'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>)-&gt;delete();</div></pre></td></tr></table></figure>
<p>如果你希望清除整个表的数据，你可以使用 <code>truncate</code> 方法，它将清除所有的行并且重置自增的 ID 到 0：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;truncate();</div></pre></td></tr></table></figure>
<h2 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h2><p>查询生成器也提供了一些方法来帮助你在 <code>select</code> 声明中实现“悲观锁”。你可以在查询中使用 <code>sharedLock</code> 方法来运行“共享锁”。共享锁可以保证所选定的行在事务提交前不会被修改：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'votes'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>)-&gt;sharedLock()-&gt;get();</div></pre></td></tr></table></figure>
<p>另外，你也可以使用 <code>lockForUpdate</code> 方法。更新锁可以防止行被修改或者被另一共享锁所选中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::table(<span class="string">'users'</span>)-&gt;where(<span class="string">'votes'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>)-&gt;lockForUpdate()-&gt;get();</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/23/laravel-from-scratch-database/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/23/laravel-from-scratch-database/" itemprop="url">laravel 基础教程 —— 数据库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-23T13:00:10+08:00">
                2016-06-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="数据库入门"><a href="#数据库入门" class="headerlink" title="数据库入门"></a>数据库入门</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Laravel 可以非常简单的使用原生的 SQL，流利的查询构建器，和 <a href="https://laravel.com/docs/5.2/eloquent" target="_blank" rel="external">Eloquent ORM</a> 来进行跨终端的后端数据库连接的建立与交互。<br>目前，Laravel 支持的 4 种数据库系统：</p>
<ul>
<li>MySQL</li>
<li>Postgres</li>
<li>SQLite</li>
<li>SQL Serve</li>
</ul>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>Laravel 使建立数据库连接与其进行交互变的非常简单。而数据库的配置文件就存放在 <code>config/database.php</code>。在这个文件中你可以定义所有的数据库连接，以及指定何种连接作为应用的默认数据库连接。对于所有支持的数据库系统，该文件中都给出了相应的配置示例。</p>
<p>默认的，Laravel 的环境配置示例已经在 Laravel Homestead 中被设置使用，当然，你可以自由的根据需求来修改这个配置。</p>
<p><strong>SQLite 配置</strong></p>
<p>在创建 SQLite 数据库之后，比如你可以通过 <code>touch database/database.sqlite</code> 命令直接创建一个文件，然后你就可以在环境配置中添加新创建的数据库的绝对路径了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">DB_CONNECTION=sqlite</div><div class="line">DB_DATABASE=/absolute/path/to/database.sqlite</div></pre></td></tr></table></figure>
<p><strong>SQL Server Configuration</strong></p>
<p>Laravel 支持 SQL Server 的开箱即用。但是，你需要为这个数据库添加连接配置: </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="string">'sqlsrv'</span> =&gt; [</div><div class="line">  <span class="string">'driver'</span> =&gt; <span class="string">'sqlsrv'</span>,</div><div class="line">  <span class="string">'host'</span> =&gt; env(<span class="string">'DB_HOST'</span>, <span class="string">'localhost'</span>),</div><div class="line">  <span class="string">'database'</span> =&gt; env(<span class="string">'DB_DATABASE'</span>, <span class="string">'forge'</span>),</div><div class="line">  <span class="string">'username'</span> =&gt; env(<span class="string">'DB_USERNAME'</span>, <span class="string">'forge'</span>),</div><div class="line">  <span class="string">'password'</span> =&gt; env(<span class="string">'DB_PASSWORD'</span>, <span class="string">''</span>),</div><div class="line">  <span class="string">'charset'</span> =&gt; <span class="string">'utf8'</span>,</div><div class="line">  <span class="string">'prefix'</span> =&gt; <span class="string">''</span>, </div><div class="line">],</div></pre></td></tr></table></figure>
<p><strong>读写分离的连接</strong></p>
<p>有时候，你可能希望使用一个数据库连接来处理 SELECT 声明，而使用另外一个连接来处理 INSERT，UPDATE，和 DELETE 声明。Laravel 可以轻而易举的做到这些，并且不论你是使用的原生查询还是通过查询构造器，又或者是 Eloquent ORM，laravel 都会为你提供恰当的连接。</p>
<p>下面给出的示例来演示如何配置读写分离的数据库：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="string">'mysql'</span> =&gt; [</div><div class="line">  <span class="string">'read'</span> =&gt; [</div><div class="line">    <span class="string">'host'</span> =&gt; <span class="string">'192.168.1.1'</span>,</div><div class="line">  ],</div><div class="line">  <span class="string">'write'</span> =&gt; [</div><div class="line">    <span class="string">'host'</span> =&gt; <span class="string">'192.168.1.2'</span></div><div class="line">  ],</div><div class="line">  <span class="string">'driver'</span> =&gt; <span class="string">'mysql'</span>,</div><div class="line">  <span class="string">'database'</span> =&gt; <span class="string">'database'</span>,</div><div class="line">  <span class="string">'username'</span> =&gt; <span class="string">'root'</span>,</div><div class="line">  <span class="string">'password'</span> =&gt; <span class="string">''</span>,</div><div class="line">  <span class="string">'charset'</span> =&gt; <span class="string">'utf8'</span>,</div><div class="line">  <span class="string">'collation'</span> =&gt; <span class="string">'utf8_unicode_ci'</span>,</div><div class="line">  <span class="string">'prefix'</span> =&gt; <span class="string">''</span>,</div><div class="line">],</div></pre></td></tr></table></figure>
<p>你应该注意到了数组中被添加了两个键：<code>read</code> 和 <code>write</code>。它们两个都是一个数组且只包含了一个键： <code>host</code>。而对 <code>read</code> 和 <code>write</code> 连接的其余选项都会从 <code>mysql</code> 数组中合并过来。</p>
<p>所以，如果我们想要覆盖主数组中的值，我们只需要在 <code>read</code> 和 <code>write</code> 数组中添加相应的项就可以了。在这个场景下，<code>192.168.1.1</code> 会被用来作为读连接，而 <code>192.168.1.2</code> 将会被用来作为写连接。数据库凭证，数据表前缀，字符集，所有主 <code>mysql</code> 数组中的其它选项都会被分享到这两个连接中。</p>
<h2 id="执行原生的-SQL-查询"><a href="#执行原生的-SQL-查询" class="headerlink" title="执行原生的 SQL 查询"></a>执行原生的 SQL 查询</h2><p>当你配置完你的数据库连接之后，你可以通过使用 <code>DB</code> 假面来执行查询。<code>DB</code> 假面对每种类型的查询都提供了方法：<code>select</code>，<code>update</code>，<code>insert</code>，<code>delete</code> 和 <code>statement</code>。</p>
<p><strong>执行 select 查询</strong></p>
<p>我们可以使用 <code>DB</code> 假面的 <code>select</code> 方法来进行基础的查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">DB</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Show a list of all of the application's users.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $users = DB::select(<span class="string">'select * from users where active = ?'</span>, [<span class="number">1</span>]);</div><div class="line"></div><div class="line">     <span class="keyword">return</span> view(<span class="string">'user.index'</span>, [<span class="string">'users'</span> =&gt; $users]);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>传递到 <code>select</code> 方法的第一个参数是一个原生的 SQL 查询，而第二个参数则是传递的所有绑定到查询中的参数值。通常，这些值都是关于条件约束的。参数绑定提供了针对 SQL 注入的保护。</p>
<p><code>select</code> 方法总是返回一个 <code>array</code> 作为结果。而数组中的每一项都应该是一个 <code>StdClass</code> PHP 对象，这允许你从结果中访问它的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">foreach</span>($users <span class="keyword">as</span> $user) &#123;</div><div class="line">  <span class="keyword">echo</span> $user-&gt;name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>使用命名的绑定</strong></p>
<p>你可以使用命名的绑定来取代使用 <code>?</code> 参数绑定：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$results = DB::select(<span class="string">'select * from users where id = :id'</span>, [<span class="string">'id'</span> =&gt; <span class="number">1</span>]);</div></pre></td></tr></table></figure>
<p><strong>运行一个 Insert 声明</strong></p>
<p>你可以使用 <code>DB</code> 假面的 <code>insert</code> 方法来执行一个 <code>insert</code> 声明。就像 <code>select</code> 一样，该方法接收一个原生的 SQL 查询作为第一个参数，一个绑定值作为第二个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::insert(<span class="string">'insert into users (id, name) values (?, ?)'</span>, [<span class="number">1</span>, <span class="string">'Dayle'</span>]);</div></pre></td></tr></table></figure>
<p><strong>运行一个 Update 声明</strong></p>
<p><code>update</code> 方法会更新数据库中检索到的记录。这个方法会返回受影响的行数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$affected = DB::update(<span class="string">'update users set votes = 100 where name = ?'</span>, [<span class="string">'John'</span>]);</div></pre></td></tr></table></figure>
<p><strong>运行一个 Delete 声明</strong></p>
<p><code>delete</code> 方法应该用来从数据库中删除记录。就像 <code>update</code> 一样，它返回删除的行数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$deleted = DB::delete(<span class="string">'delete from users'</span>);</div></pre></td></tr></table></figure>
<p><strong>运行普通的声明</strong></p>
<p>一些数据库声明不应该返回任意的值。对于这些特别的操作，你可以使用 <code>DB</code> 假面的 <code>statement</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::statement(<span class="string">'drop table users'</span>);</div></pre></td></tr></table></figure>
<h3 id="监听查询事件"><a href="#监听查询事件" class="headerlink" title="监听查询事件"></a>监听查询事件</h3><p>如果你希望在每次应用中执行查询时都受到通知，那么你可以使用 <code>listen</code> 方法，该方法通常用来作为查询日志的调试。你可以在服务提供者中进行注册一个查询监听器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">DB</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Bootstrap any application services.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     DB::listen(<span class="function"><span class="keyword">function</span> <span class="params">($query)</span> </span>&#123;</div><div class="line">       <span class="comment">// $query-&gt;sql</span></div><div class="line">       <span class="comment">// $query-&gt;bindings</span></div><div class="line">       <span class="comment">// $query-&gt;time</span></div><div class="line">     &#125;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Register the service provider.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="comment">//</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="数据库事务"><a href="#数据库事务" class="headerlink" title="数据库事务"></a>数据库事务</h2><p>你可以通过使用 <code>DB</code> 假面的 <code>transaction</code> 方法来在数据库事务中执行某些操作。如果在事务 <code>Closure</code> 中抛出了异常，那么事务会自动的执行回滚操作。如果 <code>Closure</code> 成功的执行，那么事务就会自动的进行提交操作。你并不需要在使用 <code>transaction</code> 方法时担心如何手动的执行回滚或者提交操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">DB::transaction(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  DB::table(<span class="string">'users'</span>)-&gt;update([<span class="string">'votes'</span> =&gt; <span class="number">1</span>]);</div><div class="line"></div><div class="line">  DB::table(<span class="string">'posts'</span>)-&gt;delete(); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>手动的使用事务</strong></p>
<p>如果你想要手动的执行事务，并且想要对回滚和提交具有完整的控制权，那么你可以使用 <code>DB</code> 假面的 <code>beginTransaction</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::beginTransaction();</div></pre></td></tr></table></figure>
<p>你可以通过 <code>rollBack</code> 方法来进行回滚操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::rollBack();</div></pre></td></tr></table></figure>
<p>最后，你可以使用 <code>commit</code> 方法来进行提交操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DB::commit();</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：使用 <code>DB</code> 假面的事务方法同样对查询构造器和 Eloquent ORM 有效。</p>
</blockquote>
<h2 id="使用多个数据库连接"><a href="#使用多个数据库连接" class="headerlink" title="使用多个数据库连接"></a>使用多个数据库连接</h2><p>当使用多个数据连接时，你可以通过 <code>DB</code> 假面的 <code>connection</code> 方法来访问这些连接。传递到 <code>connection</code> 方法中的 <code>name</code> 应该与你的 <code>config/database.php</code> 配置文件中的连接相匹配：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$users = DB::connection(<span class="string">'foo'</span>)-&gt;select(...);</div></pre></td></tr></table></figure>
<p>你也可以在连接实例上调用 <code>getPdo</code> 方法来获取底层的 PDO 实例。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/22/laravel-from-scratch-validation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/22/laravel-from-scratch-validation/" itemprop="url">laravel 基础教程 —— 验证</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-22T13:48:50+08:00">
                2016-06-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Laravel 对验证应用的输入数据提供了多中途径的实现。默认的，Laravel 的基础控制器类使用了 <code>ValidatesRequests</code> trait，该性状允许使用各种强大的验证约束来验证 HTTP 的输入请求。</p>
<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><p>要了解 Laravel 强大的验证功能，我们需要一个完整的示例来描述表单的验证，和将表单验证的错误信息显示给用户。</p>
<h3 id="定义路由"><a href="#定义路由" class="headerlink" title="定义路由"></a>定义路由</h3><p>首先，让我们假定我们在 <code>app/Http/routes.php</code> 文件中拥有下述的路由：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Display a form to create a blog post...</span></div><div class="line">Route::get(<span class="string">'post/create'</span>, <span class="string">'PostController@create'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Store a new blog post...</span></div><div class="line">Route::post(<span class="string">'post'</span>, <span class="string">'PostController@store'</span>);</div></pre></td></tr></table></figure>
<p>当然， <code>GET</code> 路由会为用户创建一个新的博客文章时提供一个表单，而 <code>POST</code> 路由会存储新的博客文章到数据库。</p>
<h3 id="创建控制器"><a href="#创建控制器" class="headerlink" title="创建控制器"></a>创建控制器</h3><p>接着，我们需要一个控制器来处理这些路由，目前，我们先不在 <code>store</code> 方法里放任何的逻辑：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Show the form to create a new blog post.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">return</span> view(<span class="string">'post.create'</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Store a new blog post.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> Request $request</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(Request $request)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="comment">// Validate and store the blog post...</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="编写验证逻辑"><a href="#编写验证逻辑" class="headerlink" title="编写验证逻辑"></a>编写验证逻辑</h3><p>现在我们准备好了在 <code>store</code> 方法中进行博客文章的验证逻辑。如果你检查应用的基础控制器（<code>App\Http\Controllers\Controller</code>) 类，你会发现该类使用了 <code>ValidatesRequests</code> trait。这个性状为所有的控制器提供了方便的 <code>validate</code> 方法。</p>
<p><code>validate</code> 方法接收 HTTP 输入请求，并设置验证约束。如果验证约束通过，那么后续的代码将会正常的执行。如果验证失败，那么将会抛出一个恰当的异常响应返回给用户。对于传统的 HTTP 请求，验证器会自动生成一个重定向响应，而 AJAX 请求，则会返回 JSON 响应。</p>
<p>为了能够更好的理解 <code>validate</code> 方法，让我们继续回到 <code>store</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Store a new blog post.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> Request $request</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(Request $request)</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">$this</span>-&gt;validate($request, [</div><div class="line">     <span class="string">'title'</span> =&gt; <span class="string">'required|unique:posts|max:255'</span>,</div><div class="line">     <span class="string">'body'</span> =&gt; <span class="string">'required'</span>,</div><div class="line">   ]);</div><div class="line"></div><div class="line">   <span class="comment">// The blog post is valid, store in database...</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>就如你所看到的，我们简单的传递了一个 HTTP 输入请求，并且在 <code>validate</code> 方法中设置了预期的验证约束。而这次，如果验证失败，那么相应的响应会被自动的生成并且被返回给请求用户。如果验证通过，那么我们的控制器会继续执行之后的业务。</p>
<p><strong>在初次验证失败时停止</strong></p>
<p>有时候你希望在获取首个验证约束失败时停止当前属性其余约束的验证。你可以在属性中加入 <code>bail</code> 约束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;validate($request, [</div><div class="line">  <span class="string">'title'</span> =&gt; <span class="string">'bail|required|unique:posts|max:255'</span>,</div><div class="line">  <span class="string">'body'</span> =&gt; <span class="string">'required'</span>,</div><div class="line">]);</div></pre></td></tr></table></figure>
<p>在这个例子中，如果 <code>title</code> 属性中的 <code>required</code> 约束验证失败，那么 <code>unique</code> 约束就不会再被验证。约束是按照其被分配的顺序来进行验证的。</p>
<p><strong>嵌套的属性</strong></p>
<p>如果你的 HTTP 请求包含了嵌套的参数，你可以使用 <code>.</code> 语法来为其指定约束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;validate($request, [</div><div class="line">  <span class="string">'title'</span> =&gt; <span class="string">'required|unique:posts|max:255'</span>,</div><div class="line">  <span class="string">'author.name'</span> =&gt; <span class="string">'required'</span>,</div><div class="line">  <span class="string">'author.description'</span> =&gt; <span class="string">'required'</span>,</div><div class="line">]);</div></pre></td></tr></table></figure>
<h3 id="显示验证错误"><a href="#显示验证错误" class="headerlink" title="显示验证错误"></a>显示验证错误</h3><p>那么，假如传入的请求参数并没有通过给定约束的验证怎么办？就如前面所提到的，Laravel 会自动的重定向用户到之前的位置。另外，所有的验证错误信息都会被自动的闪存到 session 中。</p>
<p>你需要注意到我们并没有明确的绑定错误信息到 <code>GET</code> 路由的响应视图里。这是因为 laravel 会检查闪存 seesion 里的错误数据，并且会自动的在其可用时注入到视图中。你可以在视图中使用 <code>$errors</code> 变量，它是一个 <code>Illuminate\Support\MessageBag</code> 实例。如果需要了解更多这个实例对象，请参考其 <a href="https://laravel.com/docs/5.2/validation#working-with-error-messages" target="_blank" rel="external">文档</a>。</p>
<blockquote>
<p>注意：<code>$errors</code> 变量是通过 <code>Illuminate\View\Middleware\ShareErrorsFromSession</code> 中间件来绑定到视图中的。这个中间件已经被提供到了 <code>web</code> 中间件组中。这个中间件被应用时会自主的在你的视图中注入 <code>$errors</code> 变量，这允许你方便的假定 <code>$errors</code> 变量总是已经被定义且可以安全的使用。</p>
</blockquote>
<p>所以，在我们的例子中，当验证失败是，用户将会被重定向到控制器的 <code>create</code> 方法中，这允许你在视图中展示错误信息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;!-- /resources/views/post/create.blade.php --&gt;</div><div class="line"></div><div class="line">&lt;h1&gt;Create Post&lt;/h1&gt;</div><div class="line"></div><div class="line">@<span class="keyword">if</span> (count($errors) &gt; <span class="number">0</span>)</div><div class="line">  &lt;div class="alert alert-danger"&gt;</div><div class="line">    &lt;ul&gt;</div><div class="line">      @<span class="keyword">foreach</span> ($errors-&gt;all() <span class="keyword">as</span> $error)</div><div class="line">        &lt;li&gt;&#123;&#123; $error &#125;&#125;&lt;/li&gt;</div><div class="line">      @<span class="keyword">endforeach</span></div><div class="line">    &lt;/ul&gt;</div><div class="line">  &lt;/div&gt;</div><div class="line">@<span class="keyword">endif</span></div><div class="line"></div><div class="line">&lt;!-- Create Post Form --&gt;</div></pre></td></tr></table></figure>
<p><strong>自定义闪存错误格式</strong></p>
<p>如果你希望在验证失败时可以自定义闪存进 session 中的错误消息的格式，你需要在你的基础控制器中复写 <code>formatValidationErrors</code> 方法。不要忘记在顶部引入 <code>Illuminate\Contracts\Validation\Validator</code> 类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Bus</span>\<span class="title">DispatchesJobs</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Validation</span>\<span class="title">Validator</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Routing</span>\<span class="title">Controller</span> <span class="title">as</span> <span class="title">BaseController</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Validation</span>\<span class="title">ValidatesRequests</span>;</div><div class="line"></div><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">use</span> <span class="title">DispatchesJobs</span>, <span class="title">ValidatesRequests</span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * &#123;<span class="doctag">@inheritdoc</span>&#125;</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">formatValidationErrors</span><span class="params">(Validator $validator)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">return</span> $validator-&gt;errors()-&gt;all();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="AJAX-请求-amp-验证"><a href="#AJAX-请求-amp-验证" class="headerlink" title="AJAX 请求 &amp; 验证"></a>AJAX 请求 &amp; 验证</h3><p>在上面的示例中，我们使用传统的表单来发送数据到应用，事实上，如今很多应用都使用 AJAX 请求，当通过 AJAX 请求来使用 <code>validate</code> 方法时，laravel 并不会自动生成重定向的响应，相反的，laravel 会生成一个包含了验证错误消息的 JSON 响应。并且该响应会伴随 422 HTTP 状态码。</p>
<h3 id="验证数组"><a href="#验证数组" class="headerlink" title="验证数组"></a>验证数组</h3><p>验证数组形式的输入并不是一件痛苦的事情。比如，去验证给定的输入数组中所有的邮件都应该是唯一的，你可以参照如下做法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$validator = Validator::make($request-&gt;all(), [</div><div class="line">  <span class="string">'person.*.email'</span> =&gt; <span class="string">'email|unique:users'</span>,</div><div class="line">  <span class="string">'person.*.first_name'</span> =&gt; <span class="string">'required_with:person.*.last_name'</span>,</div><div class="line">]);</div></pre></td></tr></table></figure>
<p>同样的，你也可以在使用语言文件来指定特定的验证消息时使用 <code>*</code> 通配符。这可以轻而易举的使用单条验证消息提供给基于数组的输入：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">'custom'</span> =&gt; [</div><div class="line">  <span class="string">'person.*.email'</span> =&gt; [</div><div class="line">    <span class="string">'unique'</span> =&gt; <span class="string">'Each person must have a unique e-mail address'</span>,</div><div class="line">  ]</div><div class="line">]</div></pre></td></tr></table></figure>
<h2 id="其它验证途径"><a href="#其它验证途径" class="headerlink" title="其它验证途径"></a>其它验证途径</h2><h3 id="手动的创建-Validators"><a href="#手动的创建-Validators" class="headerlink" title="手动的创建 Validators"></a>手动的创建 Validators</h3><p>如果你不喜欢使用 <code>ValidatesRequests</code> trait 的 <code>validator</code> 方法，你也可以通过使用 <code>Validator</code> 假面来创建一个 validator 实例。<code>Validator</code> 假面的 <code>make</code> 方法就可以生成一个新的 validator 实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Validator</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Store a new blog post.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> Request $request</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(Request $request)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $validator = Validator::make($request-&gt;all(), [</div><div class="line">       <span class="string">'title'</span> =&gt; <span class="string">'required|unique:posts|max:255'</span>,</div><div class="line">       <span class="string">'body'</span> =&gt; <span class="string">'required'</span>,</div><div class="line">     ]);</div><div class="line"></div><div class="line">     <span class="keyword">if</span> ($validator-&gt;fails()) &#123;</div><div class="line">       <span class="keyword">return</span> redirect(<span class="string">'post/create'</span>)</div><div class="line">                -&gt;withErrors($validator)</div><div class="line">                -&gt;withInput();</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// Store the blog post...</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>make</code> 方法所接受的第一个参数是需要被验证的数据，第二个参数则是应该施加到数据的验证约束。</p>
<p>如果请求的验证失败，那么你需要使用 <code>withErrors</code> 方法来讲错误消息存放到 session 中。当使用该方法时，<code>$errors</code> 变量会在重定向之后被自动的共享到你的视图中，这使你可以轻松的将错误信息展示给用户。<code>withErrors</code> 方法可以接收 validator 实例，或者 <code>MessageBag</code> 实例，又或者原生的 PHP <code>array</code>。</p>
<p><strong>被命名的错误袋</strong></p>
<p>如果你在一个独立页面中包含了多个表单。那么你可能会希望能对 <code>MessageBag</code> 进行命名以展示相应的表单错误。你可以直接在 <code>withErrors</code> 方法中传递第二个参数对其进行命名:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> redirect(<span class="string">'register'</span>)</div><div class="line">         -&gt;withErrors($validator, <span class="string">'login'</span>);</div></pre></td></tr></table></figure>
<p>你之后可以通过 <code>$errors</code> 变量来访问被命名的 <code>MessageBag</code> 实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; $errors-&gt;login-&gt;first(<span class="string">'email'</span>) &#125;&#125;</div></pre></td></tr></table></figure>
<p><strong>验证之后的 Hook</strong></p>
<p>验证器也允许你在验证完成之后执行特定的操作。这允许你轻松的进行进一步的验证，你也可以在消息集合里添加更多的错误消息。在验证器的实例上使用 <code>after</code> 方法来进行 hook:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$validator = Validator::make(...);</div><div class="line"></div><div class="line">$validator-&gt;after(<span class="function"><span class="keyword">function</span> <span class="params">($validator)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;somethingElseIsInvalid()) &#123;</div><div class="line">    $validator-&gt;errors()-&gt;ad(<span class="string">'field'</span>, <span class="string">'Something is wrong with this field!'</span>);</div><div class="line">  &#125; </div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">if</span> ($validator-&gt;fails()) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="表单请求验证"><a href="#表单请求验证" class="headerlink" title="表单请求验证"></a>表单请求验证</h3><p>对于更为复杂的验证场景，你或许希望构建一个“表单请求”。表单请求是一个自定义的请求类，并且它包含了所有的验证逻辑。你可以使用 <code>make:request</code> Artisan CLI 命令来创建一个表单请求类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan make:request StoreBlogPostRequest</div></pre></td></tr></table></figure>
<p>被生成的类会被存储在 <code>app/Http/Requests</code> 目录。让我们在 <code>rules</code> 方法中来添加一些验证约束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Get the validation rules that apply to the request.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rules</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">return</span> [</div><div class="line">     <span class="string">'title'</span> =&gt; <span class="string">'required|unique:posts|max:255'</span>,</div><div class="line">     <span class="string">'body'</span> =&gt; <span class="string">'required'</span>,</div><div class="line">   ];</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>那么，这些验证约束是如何被评定的？你所要做的所有的事情就是在你的控制器方法中添加该请求类的类型提示。传入进来的表单请求会在控制器方法调用之前被自动的进行约束验证，这意味着你完全不需要再你的控制器方法中添加任何的验证逻辑：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Store the incoming blog post.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> StoreBlogPostRequest $request</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(StoreBlogPostRequest $request)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="comment">// The incoming request is valid...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果验证失败，用户会被自动的重定向到他们之前的位置。那么验证错误消息也会自动的闪存进 session 数据中被用于显示。如果你使用的是 AJAX 请求，那么会自动的返回一个包含所有验证错误消息的 JSON 格式的响应，它的 HTTP 状态码会被设置为 422。</p>
<p><strong>授权表单请求</strong></p>
<p>表单请求类也包含了 <code>authorize</code> 方法。在这个方法中，你可以检查已认证的用户是否真的拥有修改所给定资源的权利。比如，如果用户尝试修改博客文章中的评论消息，我们需要考虑一下这个评论是属于他的吗：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Determine if the user is authorized to make this request.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authorize</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   $commentId = <span class="keyword">$this</span>-&gt;route(<span class="string">'comment'</span>);</div><div class="line"></div><div class="line">   <span class="keyword">return</span> Comment::where(<span class="string">'id'</span>, $commentId)</div><div class="line">            -&gt;where(<span class="string">'user_id'</span>, Auth::id())-&gt;exists();</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>你应该注意到了上述实例中的 <code>route</code> 方法的调用。这个方法用来在路由被访问时发放所定义的 URL 参数，比如下面路由的 <code>{comment}</code> 参数:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Route::post(<span class="string">'comment/&#123;comment&#125;'</span>);</div></pre></td></tr></table></figure>
<p>如果 <code>authorize</code> 方法返回 <code>false</code>，那么会响应一个 403 的状态码，并且控制器的方法不会被执行。</p>
<p>如果你计划在应用的其它部分来处理授权逻辑，你可以简单的在 <code>authorize</code> 方法中返回 <code>true</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Determine if the user is authorized to make this request.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authorize</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p><strong>自定义闪存的错误格式</strong></p>
<p>如果你希望在验证失败时自定义闪存到 session 数据中验证错误消息的格式，那么你需要复写（<code>App\Http\Requests\Request</code>）基础请求类中的 <code>formatErros</code> 方法。不要忘记引入 <code>Illuminate\Contracts\Validation\Validator</code> 类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * &#123;<span class="doctag">@inheritdoc</span>&#125;</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">formatErrors</span><span class="params">(Validator $validator)</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">return</span> $validator-&gt;errors()-&gt;all();</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p><strong>自定义错误消息</strong></p>
<p>你也可以通过在请求类中复写 <code>messages</code> 方法来自定义错误消息。该方法应该返回一个包含相应错误消息的键值对数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Get the error messages for the defined validation rules.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">message</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">return</span> [</div><div class="line">     <span class="string">'title.required'</span> =&gt; <span class="string">'A title is required'</span>,</div><div class="line">     <span class="string">'body.required'</span> =&gt; <span class="string">'A message is required'</span>,</div><div class="line">   ];</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="与错误消息协作"><a href="#与错误消息协作" class="headerlink" title="与错误消息协作"></a>与错误消息协作</h2><p>在调用 <code>Validator</code> 实例的 <code>errors</code> 方法之后，你可以检索到一个 <code>Illuminate\Support\MessageBag</code> 的实例，这实例拥有多种便捷的方法来与错误消息进行交互。</p>
<p><strong>检索给定字段中的首个错误消息</strong></p>
<p>你可以使用 <code>first</code> 方法来检索给定字段的首个错误消息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$message = $validator-&gt;errors();</div><div class="line"></div><div class="line"><span class="keyword">echo</span> $message-&gt;first(<span class="string">'email'</span>);</div></pre></td></tr></table></figure>
<p><strong>检索给定字段的所有错误消息</strong></p>
<p>如果你需要检索给定字段的所有消息所组成的数组，那么你应该使用 <code>get</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">foreach</span> ($messages-&gt;get(<span class="string">'email'</span>) <span class="keyword">as</span> $message) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>检索所有字段的所有错误消息</strong></p>
<p>你可以使用 <code>all</code> 方法来检索所有字段的所有错误消息所组成的数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">foreach</span> ($message-&gt;all() <span class="keyword">as</span> $message) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>判断所给定的字段中是否存在消息</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($messages-&gt;has(<span class="string">'email'</span>)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>使用给定的格式来检索获取错误消息</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> $message-&gt;first(<span class="string">'email'</span>, <span class="string">'&lt;p&gt;:message&lt;/p&gt;'</span>);</div></pre></td></tr></table></figure>
<p><strong>使用给定的格式来检索所有的错误消息</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">foreach</span> ($messages-&gt;all(<span class="string">'&lt;li&gt;:message&lt;/li&gt;'</span>) <span class="keyword">as</span> $message) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="自定义错误消息"><a href="#自定义错误消息" class="headerlink" title="自定义错误消息"></a>自定义错误消息</h3><p>如果你需要，你可以使用自定义的错误消息来取代默认的验证消息。这里有几种方式来指定自定义的消息。首先，你可以传递自定的消息作为 <code>Validator::make</code> 方法的第三个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$messages = [</div><div class="line">  <span class="string">'required'</span> =&gt; <span class="string">'The :attribute field is required.'</span>,</div><div class="line">];</div><div class="line"></div><div class="line">$validator = Validator::make($input, $rules, $messages);</div></pre></td></tr></table></figure>
<p>在这个例子中，<code>:attribute</code> 占位符会被验证数据中真实的名称所替换。你还可以利用其它的占位符到验证消息中，比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$message = [</div><div class="line">  <span class="string">'same'</span> =&gt; <span class="string">'The :attribute and :other must match.'</span>,</div><div class="line">  <span class="string">'size'</span> =&gt; <span class="string">'The :attribute must be exactly :size.'</span>,</div><div class="line">  <span class="string">'between'</span> =&gt; <span class="string">'The :attribute must be between :min - :max.'</span>,</div><div class="line">  <span class="string">'in'</span> =&gt; <span class="string">'The :attribute must be one of the following types: :values'</span>,</div><div class="line">];</div></pre></td></tr></table></figure>
<p><strong>为给定的属性指定错误消息</strong></p>
<p>有时候，你可能希望指定自定义的错误消息到特定的字段。你可以使用 <code>.</code> 符号来进行分割，属性名应该在前，约束应该在后：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$message = [</div><div class="line">  <span class="string">'email.required'</span> =&gt; <span class="string">'We need to know your e-mail address!'</span>,</div><div class="line">];</div></pre></td></tr></table></figure>
<p><strong>在语言文件中指定自定义消息</strong></p>
<p>在多数情况下，你可能希望使用一个语言文件中的自定义消息属性直接传递到 <code>Validator</code>。你可以在 <code>resources/lang/xx/validation.php</code> 语言文件中添加 <code>custom</code> 数组来存储你的消息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">'custom'</span> =&gt; [</div><div class="line">  <span class="string">'email'</span> =&gt; [</div><div class="line">    <span class="string">'required'</span> =&gt; <span class="string">'We need to know your e-mail address!'</span>,</div><div class="line">  ],</div><div class="line">],</div></pre></td></tr></table></figure>
<h2 id="可用的验证约束"><a href="#可用的验证约束" class="headerlink" title="可用的验证约束"></a>可用的验证约束</h2><p>下面是所有的可用的验证约束和它们的功能的列表：</p>
<p><strong>accepted</strong></p>
<p>验证的字段必须为 <em>yes</em>，<em>on</em>，1，或者 <em>true</em>。这通常用来验证服务条款的承诺。</p>
<p><strong>active_url</strong></p>
<p>验证的字段必须可以通过 <code>checkdnsrr</code> PHP 方法的验证。</p>
<p><strong>after:date</strong></p>
<p>验证的字段必须是给定日期之后的值。日期会被传递到 <code>strtotime</code> PHP 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">`start_date<span class="string">' =&gt; '</span>required|date|after:tomorrow<span class="string">'</span></div></pre></td></tr></table></figure>
<p>你也可以指定使用其它字段的日期来进行评估：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'finish_date'</span> =&gt; <span class="string">'required|date|after:start_date'</span></div></pre></td></tr></table></figure>
<p><strong>alpha</strong></p>
<p>验证的字段必须全部是由字母字符组成的字符串。</p>
<p><strong>alpha_dash</strong></p>
<p>验证的字段可以是字母，数字，-，_ 所组成的字符串。</p>
<p><strong>alpha_num</strong></p>
<p>验证的字段必须全部由字母或数字所组成。</p>
<p><strong>array</strong></p>
<p>验证的字段必须是一个 PHP <code>array</code>。</p>
<p><strong>before:date</strong></p>
<p>验证的字段的值必须比指定的日期要早。指定的日期会被传递到 PHP 的 <code>strtotime</code> 方法。</p>
<p><strong>between:min,max</strong></p>
<p>验证的字段的大小必须在给定的 <em>min</em> 和 <em>max</em> 之间。字符串，数字和文件都会使用和 <code>size</code> 约束的相同的评估方式。</p>
<p><strong>boolean</strong></p>
<p>验证的字段必须能够转换为布尔值。所接受的输入可以是 <code>true</code>，<code>false</code>，<code>1</code>，<code>0</code>，<code>&quot;1&quot;</code>，<code>&quot;0&quot;</code>。</p>
<p><strong>confirmed</strong></p>
<p>验证的字段必须能够和 <code>foo_confirmation</code> 字段相匹配。比如，如果验证的字段是 <code>password</code>，相应的 <code>password_confirmation</code> 字段必须在输入中被提供且与 <code>password</code> 相匹配。</p>
<p><strong>date</strong></p>
<p>验证的字段必须是一个有效的日期，它应该能被 <code>strtotime</code> PHP 方法通过。</p>
<p><strong>date_format:format</strong></p>
<p>验证的字段必须匹配给定的格式。该格式会被 PHP <code>date_parse_from_format</code> 方法评定，你应该只使用 <code>date</code> 或者 <code>date_format</code> 其中之一来进行验证字段，不要全部都使用。</p>
<p><strong>different:field</strong></p>
<p>验证的字段必须与给定的字段不同。</p>
<p><strong>digits:value</strong></p>
<p>验证的字段必须是数字类型并且具有指定的长度。</p>
<p><strong>digits_between:min,max</strong></p>
<p>验证的字段必须具有指定区间的长度。</p>
<p><strong>dimensions</strong></p>
<p>验证的字段必须是一个图片类型的，并且要求符合指定的参数约束:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'avatar'</span> =&gt; <span class="string">'dimensions:min_with=100,min_height=200'</span></div></pre></td></tr></table></figure>
<p>可用的参数有：<em>min_width</em>，<em>max_width</em>，<em>min_height</em>，<em>max_height</em>，<em>width</em>，<em>height</em>，<em>ratio</em>。</p>
<p><strong>distinct</strong></p>
<p>当与数组协作时，验证的字段中必须不能含有重复的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'foo.*.id'</span> =&gt; <span class="string">'distinct'</span></div></pre></td></tr></table></figure>
<p><strong>email</strong></p>
<p>验证的字段必须是一个邮件地址的格式。</p>
<p><strong>exists:table,column</strong></p>
<p>验证的字段必须能在指定数据库表中检索的到。</p>
<p><strong>Exists 基础约束用法</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'state'</span> =&gt; <span class="string">'exists:states'</span></div></pre></td></tr></table></figure>
<p><strong>指定自定义列名称</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'state'</span> =&gt; <span class="string">'exists:states,abbreviation'</span></div></pre></td></tr></table></figure>
<p>你也可以像使用 <code>where</code> 语句一样指定添加更多的查询条件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'email'</span> =&gt; <span class="string">'exists:staff,email,account_id,1'</span></div></pre></td></tr></table></figure>
<p>查询条件也可以使用 <code>!</code> 来表明否定值:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'eamil'</span> =&gt; <span class="string">'exists:staff,email,role,!admin'</span></div></pre></td></tr></table></figure>
<p>你也可以传递 <code>NULL</code> 或者 <code>NOT_NULL</code> 到查询语句中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">'eamil'</span> =&gt; <span class="string">'exists:staff,email,deleted_at,NULL'</span></div><div class="line"></div><div class="line"><span class="string">'eamil'</span> =&gt; <span class="string">'exists:staff,email,deleted_at,NOT_NULL'</span></div></pre></td></tr></table></figure>
<p>极个别的情况下，你可能需要在 <code>exists</code> 查询下指定特定的数据库连接。你可以使用 <code>.</code> 语法将数据库连接名前置来进行指定：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'email'</span> =&gt; <span class="string">'exists:connection.staff,email'</span></div></pre></td></tr></table></figure>
<p><strong>filled</strong></p>
<p>验证的字段如果出现，那么它一定不能为空值。</p>
<p><strong>image</strong></p>
<p>被验证的文件必须是一个图片类型（jpeg，png，bmp，gif，svg）</p>
<p><strong>in:foo,bar,…</strong></p>
<p>验证的字段必须是给定值列中的一个。</p>
<p><strong>in_array:anotherfield</strong></p>
<p>验证的字段必须是指定的字段中值列之一。</p>
<p><strong>integer</strong></p>
<p>验证的字段必须是一个整数。</p>
<p><strong>ip</strong></p>
<p>验证的字段必须是一个 IP 地址。</p>
<p><strong>json</strong></p>
<p>验证的字段必须是合法的 JSON 字符串</p>
<p><strong>max:value</strong></p>
<p>验证的字段必须小于等于指定值。字符串，数字，和文件类型会与 <code>size</code> 约束使用相同的评估方法。</p>
<p><strong>mimetypes:text/plain,…</strong></p>
<p>验证的字段必须匹配给定的 MIME 类型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'video'</span> =&gt; <span class="string">'mimetypes:video/avi,video/mpeg,video/quicktime'</span></div></pre></td></tr></table></figure>
<p>为了判断所上传文件的 MIME 类型，laravel 会读取文件的内容并且会尝试猜测文件的 MIME 类型，这可能会与客户端提供的文件 MIME 类型有所区别。</p>
<p><strong>mimes:foo,bar,…</strong></p>
<p>验证的文件的 MIME 类型相应的后缀必须是所列的值之一。</p>
<p><strong>基础用法</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'photo'</span> =&gt; <span class="string">'mimes:jpeg,bmp,png'</span></div></pre></td></tr></table></figure>
<p>你只需要指定文件的扩展，这个约束会针对文件的内容进行猜测文件的 MIME 类型，然后进行扩展验证。</p>
<p>完整的 MIME 类型和其相应的扩展后缀，你可以从 <a href="http://svn.apache.org/repos/asf/httpd/httpd/trunk/docs/conf/mime.types" target="_blank" rel="external">这里</a> 找到。</p>
<p><strong>min:value</strong></p>
<p>验证的字段必须比指定的值要小。字符串，数字和文件类型会使用 <code>size</code> 约束相同的评估方法。</p>
<p><strong>not_in:foo,bar,…</strong></p>
<p>验证的字段不应该包含在给定的值列中。</p>
<p><strong>numeric</strong></p>
<p>验证的字段必须是一个数值类型。</p>
<p><strong>present</strong></p>
<p>验证的字段必须要求被提供，但是可以为空。</p>
<p><strong>regex:pattern</strong></p>
<p>验证的字段必须与给定的正则表达式相匹配。</p>
<blockquote>
<p>注意：当使用 <code>regex</code> 模式时，你必须将约束放进数组里来取代管道符分隔，特别是在正则表达式中包含管道符时。</p>
</blockquote>
<p><strong>required</strong></p>
<p>验证的字段必须被提供并且不能为空值。判断空值的依据：</p>
<ul>
<li>值是 <code>null</code></li>
<li>值是空字符串</li>
<li>值是一个空数组或者空的 <code>Countable</code> 对象</li>
<li>值是一个没有传递路径的上传的文件</li>
</ul>
<p><strong>required_if:anotherfield,value,…</strong></p>
<p>验证的字段必须在以下情况下被提供：指定的字段等于任意列出的值。</p>
<p><strong>required_unless:anotherfield,value,…</strong></p>
<p>验证的字段必须在以下情况下被提供: 所指定的字段和所提供的值都不相等。</p>
<p><strong>required_with:foo,bar,…</strong></p>
<p>验证的字段只有在其它所指定字段之一被提供时才会被要求提供。</p>
<p><strong>required_with_all:foo,bar,…</strong></p>
<p>验证的字段只有在其它所指定字段全部被提供时才会被要求提供。</p>
<p><strong>required_without:foo,bar,…</strong></p>
<p>验证的字段只有在其它所指定字段之一没有被提供时被要求提供。</p>
<p><strong>required_without_all:foo,bar,…</strong></p>
<p>验证的字段只有在所指定字段全部没有被提供时才会被要求提供。</p>
<p><strong>same:field</strong></p>
<p>所验证的字段必须与指定的字段相匹配。</p>
<p><strong>size:value</strong></p>
<p>验证的字段必须具有给定值的大小。对于字符串数据，值应该是字符串的字符长度。对于数值数据，值应该是相应的整数值。对于数组，大小匹配数组的 <code>count</code> 大小。对于文件，应该匹配文件的字节大小。</p>
<p><strong>string</strong></p>
<p>验证的字段必须是一个字符串。</p>
<p><strong>timezone</strong></p>
<p>验证的字段必须是经过 PHP <code>timezone_identifiers_list</code> 方法验证的合法的 timezone 标识。</p>
<p><strong>unique:table,column,except,idColumn</strong></p>
<p>验证的字段必须在给定的数据表中唯一，如果 <code>column</code> 选型没有被指定，那么会直接使用字段的名字。</p>
<p><strong>指定自定义的列名</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'email'</span> =&gt; <span class="string">'unique:users,email_address'</span></div></pre></td></tr></table></figure>
<p><strong>自定义数据库连接</strong></p>
<p>极少数情况下，你可能需要指定自定义的数据库连接来进行验证。就如上面所看到的，设置 <code>unique:users</code> 会使用默认的数据库连接来进行约束验证。如果想指定其他数据库连接，你可以使用 <code>.</code> 语法并前置指定数据库连接：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'email'</span> =&gt; <span class="string">'unique:connection.users,email_address'</span></div></pre></td></tr></table></figure>
<p><strong>强迫 Unique 约束 忽略给定的 ID</strong></p>
<p>有时候，你可能会希望 unique 检查忽略给定的 ID。比如，考虑一下一个更新个人信息的场景，它应该提供用户的名称，邮箱地址，和位置。你可能会想要验证邮箱的唯一性。但是你只想验证与用户的当前邮箱不一致的邮箱的唯一性。也就是说你只想验证这个邮箱有没有被其他用户所使用。你需要传递 ID 作为第三个参数来通知 unique 约束来忽略当前用户的 ID：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'email'</span> =&gt; <span class="string">'unique:users,email_address,'</span>.$user-&gt;id</div></pre></td></tr></table></figure>
<p>如果表名使用的主键列名不是 <code>id</code> ，那么你还需要指定主键的列名到第四个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'email'</span> =&gt; <span class="string">'unique:users,email_address,'</span>.$user-&gt;id.<span class="string">',user_id'</span></div></pre></td></tr></table></figure>
<p><strong>添加额外的条件查询</strong></p>
<p>你也可以指定更多的条件查询：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'email'</span> =&gt; <span class="string">'unique:users,email_address,null,id,account_id,1'</span></div></pre></td></tr></table></figure>
<p>在上面的约束中，只有 <code>account_id</code> 为 <code>1</code> 的行会被约束进行检查。</p>
<p><strong>url</strong></p>
<p>验证的字段必须符合 PHP <code>filter_var</code> 方法验证的有效 URL。</p>
<h2 id="添加约束条件"><a href="#添加约束条件" class="headerlink" title="添加约束条件"></a>添加约束条件</h2><p>在一些场景中，你会希望只有字段出现在了输入数组中时才会对其进行验证。你可以在约束列中添加 <code>sometimes</code> 约束来快速的完成指定：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$v = Validator::make($data, [</div><div class="line">  <span class="string">'email'</span> =&gt; <span class="string">'sometimes|required|email'</span>,</div><div class="line">]);</div></pre></td></tr></table></figure>
<p>这上面的例子中，只有 <code>$data</code> 中提供了 <code>email</code> 字段，<code>email</code> 的约束才会对其进行验证。</p>
<p><strong>复杂的验证条件</strong></p>
<p>有时候，你可能会希望基于更复杂的条件逻辑去进行约束的验证。比如，你希望只有另外一个字段拥有比 100 更大的值时才会验证给定的字段是否被提供。又或者你想要在只有另外一个字段被提供时才会需要其他两个字段的值。添加这些条件判定并非是痛苦的一件事。首先，你还是需要创建一个 <code>Validator</code> 实例和一些静态的约束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$v = Validator::make($data, [</div><div class="line">  <span class="string">'email'</span> =&gt; <span class="string">'required|email'</span>,</div><div class="line">  <span class="string">'games'</span> =&gt; <span class="string">'required|numeric'</span></div><div class="line">]);</div></pre></td></tr></table></figure>
<p>让我们假定我们的应用是服务于一些游戏收藏家的。如果一个游戏收藏家注册了我们的应用，并且它们添加了超过 100 个游戏时。我们需要它们解释一下为什么他会拥有那么多的游戏。比如，或许他开了一个游戏贩卖超市，又或者他仅仅就是喜欢收藏。我们可以使用 <code>Validator</code> 实例上的 <code>sometimes</code> 方法来添加这个必要的条件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$v-&gt;sometimes(<span class="string">'reason'</span>, <span class="string">'required|max:500'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($input)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $input-&gt;games &gt;= <span class="number">100</span>;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>传递到 <code>sometimes</code> 方法的第一个参数是我们需要考虑验证的字段的名字。第二个参数是我们想要添加的约束。如果第三个参数传递的 <code>Closure</code> 返回的结果是 <code>true</code>，那么这个约束就会被添加进去。这就可以轻松的对复杂的验证场景进行条件的构建。你甚至可以一次性的添加多个字段的条件验证：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$v-&gt;sometimes([<span class="string">'reson'</span>, <span class="string">'cost'</span>], <span class="string">'required'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($input)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $input-&gt;games &gt;= <span class="number">100</span>; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：传递到 <code>Closure</code> 中的 <code>$input</code> 是一个 <code>Illuminate\Support\Flument</code> 实例，并且它可以被用来访问你的输入和文件。</p>
</blockquote>
<h2 id="自定义验证约束"><a href="#自定义验证约束" class="headerlink" title="自定义验证约束"></a>自定义验证约束</h2><p>Laravel 提供了各种有用的验证约束。但是，你可能希望添加你自己的特定的约束。你可以使用 <code>Validator</code> 假面的 <code>extend</code> 方法来注册自己的验证约束。让我们在服务提供者里注册一个自定义的验证约束：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Validator</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Bootstrap any application services.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     Validator::extend(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($attribute, $value, $parameters, $validator)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> $value == <span class="string">'foo'</span>;</div><div class="line">     &#125;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Register the service provider.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="comment">//</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>自定义的验证闭包中接收四个参数：需要被验证的属性名称，属性的值，一个需要被传递到约束的 <code>$paramters</code> 数组，和 <code>Validator</code> 实例。</p>
<p>你也可以传递一个类名和方法到 <code>extend</code> 方法中来代替闭包：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Validator::extend(<span class="string">'foo'</span>, <span class="string">'FooValidator@validate'</span>);</div></pre></td></tr></table></figure>
<p><strong>定义错误消息</strong></p>
<p>你也需要为你的自定义约束添加一个错误消息。你可以使用行内自定义错误消息或者将其添加到独立的验证语言文件中。这个消息应该被存放在数组的一维中，而不是包含在 <code>custom</code> 数组里:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">"foo"</span> =&gt; <span class="string">'Your input was invalid!'</span>,</div><div class="line"></div><div class="line"><span class="string">'accepted'</span> =&gt; <span class="string">'The :attribute must be accepted.'</span>,</div><div class="line"></div><div class="line"><span class="comment">// The rest of the validation error messages...</span></div></pre></td></tr></table></figure>
<p>当构建自定义的验证约束时，你或许有时候也想为错误消息定义一些占位符。你可以使用 <code>Validator</code> 假面的 <code>replacer</code> 方法来进行占位替换。你可以在服务提供者的 <code>boot</code> 方法中来做这些：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Bootstrap any application services.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   Validator::extend(...);</div><div class="line"></div><div class="line">   Validator::replacer(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($message, $attribute, $rule, $parameters)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> str_replace(...);</div><div class="line">   &#125;);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p><strong>隐式的扩展</strong></p>
<p>默认的，当属性被验证时，如果在输入数组中没有被提供，或者验证约束为 <code>required</code> 却是一个空值。那么普通的验证约束，包括自定义的约束扩展，都不会再执行。比如，<code>unique</code> 约束就不会在出现 <code>null</code> 值进行执行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$rules = [<span class="string">'name'</span> =&gt; <span class="string">'unique'</span>];</div><div class="line"></div><div class="line">$input = [<span class="string">'name'</span> =&gt; <span class="keyword">null</span>];</div><div class="line"></div><div class="line">Validator:make($input, $rules)-&gt;passes(); <span class="comment">// true</span></div></pre></td></tr></table></figure>
<p>如果需要约束即使是属性值为空时也继续执行，那么约束需要暗示属性是必须的。你可以使用 <code>Validator::extendImplicit()</code> 方法来构建一个 “隐式的” 扩展：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Validator::extendImplicit(<span class="string">'foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($attribute, $value, $parameters, $validator)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $value == <span class="string">'foo'</span>; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>注意: 隐式的扩展仅仅是暗示属性是必须的，不论它实际上是缺失的值或者是空的属性，这都取决于你。</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/19/laravel-from-scratch-testing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/19/laravel-from-scratch-testing/" itemprop="url">laravel 基础教程 —— 测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-19T10:29:55+08:00">
                2016-06-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>测试是 Laravel 构建的核心理念。事实上，Laravel 开箱即用的支持 PHPUnit 测试，你的应用的根目录包含了 <code>phpunit.xml</code> 文件。同时，Laravel 也附带了一些方便的帮助方法可以使你丰满应用的测试。</p>
<p>在 <code>tests</code> 目录中提供了一个 <code>ExampleTest.php</code> 文件。在安装完成 Laravel 应用之后，你只需要在根目录运行 <code>phpunit</code> 命令就可以执行测试。</p>
<h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><p>当运行测试时，Laravel 会自动的设置配置环境为 <code>testing</code>。同时，Laravel 会自动的配置 session 和 缓存为 <code>array</code> 驱动。这意味着会话或者缓存数据在测试期间不会被持久化。</p>
<p>如果你需要，你完全可以自己创建一个测试环境。<code>testing</code> 环境变量是在 <code>phpunit.xml</code> 文件中被配置的，但是你要确保在运行测试之前先运行 <code>config:clear</code> Artisan 命令来清除配置缓存。</p>
<h3 id="定义-amp-运行测试"><a href="#定义-amp-运行测试" class="headerlink" title="定义 &amp; 运行测试"></a>定义 &amp; 运行测试</h3><p>你可以使用 <code>make:test</code> Artisan 命令来创建一个测试用例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan make:test UserTest</div></pre></td></tr></table></figure>
<p>这个命令会在 <code>tests</code> 目录下创建一个新的 <code>UserTest</code> 类。你可以像使用 PHPUnit 一样接着在类中定义一些测试方法。然后你只需要在终端执行 <code>phpunit</code> 命令就可以运行测试：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">WithoutMiddleware</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrationgs</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseTransactions</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * A basic test example.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testExample</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">$this</span>-&gt;assetTrue(<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：如果你在测试用例中定义了自己的 <code>setUp</code> 方法，你需要确保优先调用 <code>parent::setUp</code> 方法。</p>
</blockquote>
<h2 id="应用测试"><a href="#应用测试" class="headerlink" title="应用测试"></a>应用测试</h2><p>Laravel 提供非常顺畅的 API 来构建 HTTP 请求检查输出甚至是填充表格。比如，让我们看下 <code>tests</code> 目录下的 <code>ExampleTest.php</code> 文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">WithoutMiddleware</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseTransactions</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * A basic functional test example</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testBasicExample</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">$this</span>-&gt;visit(<span class="string">'/'</span>)</div><div class="line">          -&gt;see(<span class="string">'Laravel 5'</span>)</div><div class="line">          -&gt;dontSee(<span class="string">'Rails'</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>visit</code> 方法可以在应用中构造一个 <code>GET</code> 请求。<code>see</code> 方法会断言我们应该从应用的响应中看到所给定的文本。<code>dontSee</code> 方法刚好与 <code>see</code> 相反，它断言我们不应该看到给定的文本。这就是 Laravel 提供的最基本的应用测试。</p>
<h3 id="与应用进行交互"><a href="#与应用进行交互" class="headerlink" title="与应用进行交互"></a>与应用进行交互</h3><p>当然，你可以比这种简单的断言响应给定的文本做的更多。让我们来看一些点击链接和填充表单的例子：</p>
<p><strong>点击超链</strong></p>
<p>在这个测试，我们会为应用构造一个请求，在响应中会返回一个可点击的超链，并且我们会断言它应该导向给定的 URL。比如，让我们假设应用中返回了一个文本为 “About Us” 的超链:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/about-us"</span>&gt;</span>About Us<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure>
<p>现在，让我们编写一个测试并断言点击链接会跳转到相应的页面：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testBasicExample</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">$this</span>-&gt;visit(<span class="string">'/'</span>)</div><div class="line">       -&gt;click(<span class="string">'About Us'</span>)</div><div class="line">       -&gt;seePageIs(<span class="string">'/about-us'</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>与表单交互</strong></p>
<p>Laravel 同样也提供了多种方法来进行表单测试。<code>type</code>，<code>select</code>，<code>check</code>，<code>attach</code>，和 <code>press</code> 方法允许你与所有的表单输入进行交互。比如，让我们来想象一下一个存在于注册页面中的表单：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/register"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></div><div class="line">  &#123;&#123; csrf_field() &#125;&#125;</div><div class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></div><div class="line">    Name: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"checkbox"</span> <span class="attr">value</span>=<span class="string">"yes"</span> <span class="attr">name</span>=<span class="string">"terms"</span>&gt;</span>Accept Terms<span class="tag">&lt;/<span class="name">input</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure>
<p>我们可以编写一个测试来完成表单并检查结果：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testNewUserRegistration</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">$this</span>-&gt;visit(<span class="string">'/register'</span>)</div><div class="line">       -&gt;type(<span class="string">'Taylor'</span>, <span class="string">'name'</span>)</div><div class="line">       -&gt;check(<span class="string">'terms'</span>)</div><div class="line">       -&gt;press(<span class="string">'Register'</span>)</div><div class="line">       -&gt;seePageIs(<span class="string">'/dashboard'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，如果你的表单中包含了一些单选按钮或者下拉框之类的其他输入，你同样可以轻松的进行填充这些类型的字段。下面列出了所有的表单操作方法：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$this-&gt;type($text, $elementName)</code></td>
<td>对给定的字段进行输入</td>
</tr>
<tr>
<td><code>$this-&gt;select($value, $elementName)</code></td>
<td>选中一个单选按钮或者下拉框</td>
</tr>
<tr>
<td><code>$this-&gt;check($elementName)</code></td>
<td>选中复选框</td>
</tr>
<tr>
<td><code>$this-&gt;uncheck($elementName)</code></td>
<td>取消选中复选框</td>
</tr>
<tr>
<td><code>$this-&gt;attach($pathToFile, $elementName)</code></td>
<td>附加一个文件到表单</td>
</tr>
<tr>
<td><code>$this-&gt;press($buttonTextOrElementName)</code></td>
<td>单击给定的文本或名称的按钮</td>
</tr>
</tbody>
</table>
<p><strong>与附件交互</strong></p>
<p>如果你的表单中包含了 <code>file</code> 输入类型，你可以使用 <code>attach</code> 方法来附加附件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testPhotoCanBeUploaded</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">$this</span>-&gt;visit(<span class="string">'/upload'</span>)</div><div class="line">       -&gt;type(<span class="string">'File Name'</span>, <span class="string">'name'</span>)</div><div class="line">       -&gt;attach($absolutePathToFile, <span class="string">'photo'</span>)</div><div class="line">       -&gt;press(<span class="string">'Upload'</span>)</div><div class="line">       -&gt;see(<span class="string">'Upload Successful!'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="测试-JSON-APIs"><a href="#测试-JSON-APIs" class="headerlink" title="测试 JSON APIs"></a>测试 JSON APIs</h2><p>Laravel 同样也对测试 JSON APIs 和它们的响应提供了多种帮助方法。比如，<code>get</code>，<code>post</code>，<code>put</code>，<code>patch</code>，和 <code>delete</code> 方法可以用来发布一个相应 HTTP 行为方式的请求。你可以轻松的传递数据和头信息到这些方法中。在开始之前，让我们来编写一个 <code>POST</code> 请求的测试来断言 <code>/user</code> 会返回给定数组的 JSON 格式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * A basic functional test example.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testBasicExample</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">$this</span>-&gt;json(<span class="string">'POST'</span>, <span class="string">'/user'</span>, [<span class="string">'name'</span> =&gt; <span class="string">'Sally'</span>])</div><div class="line">          -&gt;seeJson([</div><div class="line">            <span class="string">'created'</span> =&gt; <span class="keyword">true</span>,</div><div class="line">          ]) ;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>seeJson</code> 方法会转换给定的数组为 JSON，并且会验证应用响应的完整 JSON 中是否会出现相应的片段。所以，如果响应中还含有其他 JSON 属性，那么这个测试依然会被通过。</p>
<p><strong>验证完全匹配的 JSON</strong></p>
<p>如果你希望验证完整的 JSON 响应，你可以使用 <code>seeJsonEquals</code> 方法，除非 JSON 相应于所给定的数组完全匹配，否则该测试不会被通过：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * A basic functional test example.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testBasicExample</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">$this</span>-&gt;json(<span class="string">'POST'</span>, <span class="string">'/user'</span>, [<span class="string">'name'</span> =&gt; <span class="string">'Sally'</span>])</div><div class="line">          -&gt;seeJsonEquals([</div><div class="line">            <span class="string">'created'</span> =&gt; <span class="keyword">true</span>,</div><div class="line">          ]);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>验证匹配 JSON 结构</strong></p>
<p>验证 JSON 响应是否采取给定的结构也是可以的。你可以使用 <code>seeJsonStructure</code> 方法并传递嵌套的键列表：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * A basic functional test example.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testBasicExample</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">$this</span>-&gt;get(<span class="string">'/user/1'</span>)</div><div class="line">          -&gt;seeJsonStructure([</div><div class="line">            <span class="string">'name'</span>,</div><div class="line">            <span class="string">'pet'</span> =&gt; [</div><div class="line">              <span class="string">'name'</span>, <span class="string">'age'</span></div><div class="line">            ]</div><div class="line">          ]);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在上面的例子中表明了期望获取一个含有 <code>name</code> 和 <code>pet</code> 属性的 JSON，并且 <code>pet</code> 键是一个含有 <code>name</code> 和 <code>age</code> 属性的对象。如果含有额外的键，<code>seeJsonStructure</code> 方法并不会失败。比如，如果 <code>pet</code> 还含有 <code>weight</code> 属性，那么测试依然会被通过。</p>
<p>你可以使用 <code>*</code> 来断言所返回的 JSON 结构中的每一项都应该包含所列出的这些属性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * A basic functional test example.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testBasicExample</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="comment">// Assert that each user in the list has at least an id, name and email attribute.</span></div><div class="line">     <span class="keyword">$this</span>-&gt;get(<span class="string">'/users'</span>)</div><div class="line">          -&gt;seeJsonStructure([</div><div class="line">            <span class="string">'*'</span> =&gt; [</div><div class="line">              <span class="string">'id'</span>, <span class="string">'name'</span>, <span class="string">'email'</span></div><div class="line">            ]</div><div class="line">          ]);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你也可以嵌套使用 <code>*</code>，下面的例子中，我们断言 JSON 响应返回的每一个用户都应该包含所列出的属性，并且 <code>pet</code> 属性应该也包含所给定的属性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;get(<span class="string">'/users'</span>)</div><div class="line">     -&gt;seeJsonStructure([</div><div class="line">       <span class="string">'*'</span> =&gt; [</div><div class="line">         <span class="string">'id'</span>, <span class="string">'name'</span>, <span class="string">'email'</span>, <span class="string">'pets'</span> =&gt; [</div><div class="line">           <span class="string">'*'</span> =&gt; [</div><div class="line">             <span class="string">'name'</span>, <span class="string">'age'</span></div><div class="line">           ]</div><div class="line">         ]</div><div class="line">       ]</div><div class="line">     ]);</div></pre></td></tr></table></figure>
<h3 id="会话-认证"><a href="#会话-认证" class="headerlink" title="会话 / 认证"></a>会话 / 认证</h3><p>Laravel 为测试期间的会话提供了多种帮助方法。首先，你需要通过 <code>withSession</code> 方法来根据给定的数组设置 session 数据，这通常用来在测试应用的请求到在之前先设置一些 session 数据：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testApplication</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;withSession([<span class="string">'foo'</span> =&gt; <span class="string">'bar'</span>])</div><div class="line">         -&gt;visit(<span class="string">'/'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，会话常见的用途就是保留用户的状态，比如用户认证。<code>actingAs</code> 帮助方法提供了一种方式来使用给定的用户作为已认证的当前用户。比如，我们可以使用模型工厂来生成一个认证用户：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testApplication</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $user = factory(App\User::class)-&gt;create();</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;actingAs($user)</div><div class="line">         -&gt;withSession([<span class="string">'foo'</span> =&gt; <span class="string">'bar'</span>])</div><div class="line">         -&gt;visit(<span class="string">'/'</span>)</div><div class="line">         -&gt;see(<span class="string">'Hello'</span> . $user-&gt;name);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你也可以传递一个给定的守卫名称到 <code>actingAs</code> 方法的第二个参数来选择用户认证的守卫：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;actingAs($user, <span class="string">'backend'</span>)</div></pre></td></tr></table></figure>
<h3 id="禁用中间件"><a href="#禁用中间件" class="headerlink" title="禁用中间件"></a>禁用中间件</h3><p>当测试应用时，你可以方便的在测试中禁中间件。这使你可以隔离的测试路由和控制器而免除中间件的顾虑。你可以简单的引入 <code>WithoutMiddleware</code> trait 来在测试类中禁用所有的中间件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">WithoutMiddleware</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseTransactions</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">use</span> <span class="title">WithoutMiddleware</span>;</div><div class="line"></div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你希望只在个别的测试方法中禁用中间件，你可以在方法中使用 <code>withoutMiddleware</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * A basic functional test example.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> funcion testBasicExample()</div><div class="line">   &#123;</div><div class="line">     <span class="keyword">$this</span>-&gt;withoutMiddleware();</div><div class="line"></div><div class="line">     <span class="keyword">$this</span>-&gt;visit(<span class="string">'/'</span>)</div><div class="line">          -&gt;see(<span class="string">'Laravel 5'</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="定制化-HTTP-请求"><a href="#定制化-HTTP-请求" class="headerlink" title="定制化 HTTP 请求"></a>定制化 HTTP 请求</h3><p>如果你希望构造一个自定义的 HTTP 请求，并且返回完整的 <code>Illuminate\Http\Response</code> 对象，你可以使用 <code>call</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testApplication</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  $response = <span class="keyword">$this</span>-&gt;call(<span class="string">'GET'</span>, <span class="string">'/'</span>);</div><div class="line"></div><div class="line">  <span class="keyword">$this</span>-&gt;assertEquals(<span class="number">200</span>, $response-&gt;status());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你构造 <code>POST</code>，<code>PUT</code>，或者 <code>PATCH</code> 请求，你可以传递一个数组来作为请求的输入数据。当然，这些数据可以通过 Request 实例来在你的路由和控制器中可用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$response = <span class="keyword">$this</span>-&gt;call(<span class="string">'POST'</span>, <span class="string">'/user'</span>, [<span class="string">'name'</span> =&gt; <span class="string">'Taylor'</span>]);</div></pre></td></tr></table></figure>
<h3 id="PHPUnit-断言"><a href="#PHPUnit-断言" class="headerlink" title="PHPUnit 断言"></a>PHPUnit 断言</h3><p>Laravel 对 PHPUnit 测试提供了多种额外的断言方法：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-&gt;assertResponseOk();</code></td>
<td>断言客户端响应会返回 OK 状态码</td>
</tr>
<tr>
<td><code>-&gt;assertResponseStatus($code)</code></td>
<td>断言客户端响应给定的状态码</td>
</tr>
<tr>
<td><code>-&gt;assertViewHas($key, $value = null);</code></td>
<td>断言响应的视图中是否含有给定的数据片段。</td>
</tr>
<tr>
<td><code>-&gt;assertViewHasAll(array $bindings);</code></td>
<td>断言视图中是否含有所有的绑定数据</td>
</tr>
<tr>
<td><code>-&gt;assertViewMissing($key);</code></td>
<td>断言视图中是否缺失所给定的片段</td>
</tr>
<tr>
<td><code>-&gt;assertRedirectedTo($uri, $with = []);</code></td>
<td>断言客户端是否重定向到给定的 URI</td>
</tr>
<tr>
<td><code>-&gt;assertRedirectedToRoute($name, $parameters = [], $with = []);</code></td>
<td>断言客户端是否重定向到给定的动作</td>
</tr>
<tr>
<td><code>-&gt;assertSessionHas($key, $value = null);</code></td>
<td>断言会话中是否含有给定的键</td>
</tr>
<tr>
<td><code>-&gt;assertSessionHasAll(array $bindings);</code></td>
<td>断言会话中是否包含给定列表的数据</td>
</tr>
<tr>
<td><code>-&gt;assertSessionHasErrors($bindings = [], $format = null);</code></td>
<td>断言会话中是否包含错误数据</td>
</tr>
<tr>
<td><code>-&gt;assertHasOldInput();</code></td>
<td>断言会话中是否包含旧的输入</td>
</tr>
<tr>
<td><code>-&gt;assertSessionMissing($key);</code></td>
<td>断言会话中是否缺失给定的键</td>
</tr>
</tbody>
</table>
<h2 id="与数据库协作"><a href="#与数据库协作" class="headerlink" title="与数据库协作"></a>与数据库协作</h2><p>Laravel 也提供了各种有用的工具来使测试基于数据库驱动的应用更简单。首先，你可以使用 <code>seeInDatabase</code> 方法来断言给定的规范是否能在数据库中匹配到相应的数据。比如，如果你希望验证 <code>users</code> 表中是否含有 <code>email</code> 为 <code>sally@example.com</code> 的记录，那么你可以这么做：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testDatabase</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="comment">// Make call to application...</span></div><div class="line"></div><div class="line">  <span class="keyword">$this</span>-&gt;seeInDatabase(<span class="string">'users'</span>, [<span class="string">'email'</span> =&gt; <span class="string">'sally@example.com'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，类似 <code>seeInDatabase</code> 等方法仅仅是为了测试的方便。你可以自由的使用任意的 PHPUnit 自带的断言方法来补充你的测试。</p>
<h3 id="在每个测试后重置数据库"><a href="#在每个测试后重置数据库" class="headerlink" title="在每个测试后重置数据库"></a>在每个测试后重置数据库</h3><p>我们通常要在每次测试后还原数据库，以便之前的测试数据不会对随后的测试产生干扰。</p>
<p><strong>使用迁移</strong></p>
<p>一种选择是在下个测试之前进行数据库回滚和迁移操作。Laravel 提供了简洁的 <code>DatabaseMigrations</code> trait 来自动的处理这些，你只需要在测试类引入该性状：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">WithoutMiddleware</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseTransactions</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">use</span> <span class="title">DatabaseMigrations</span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * A basic functional test example.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testBasicExample</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">$this</span>-&gt;visit(<span class="string">'/'</span>)</div><div class="line">          -&gt;see(<span class="string">'Laravel 5'</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>使用事务</strong></p>
<p>另外一种选择就是在每个测试用例中都使用数据库的事务进行包装，这一次，Laravel 提供了方便的 <code>DatabaseTransactions</code> trait 来自动的处理这些：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">WithoutMiddleware</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseMigrations</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Testing</span>\<span class="title">DatabaseTransactions</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">use</span> <span class="title">DatabaseTransactions</span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * A basic functional test example.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testBasicExample</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">$this</span>-&gt;visit(<span class="string">'/'</span>)</div><div class="line">          -&gt;see(<span class="string">'Laravel 5'</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意： 这一性状只会包装默认数据库连接的事务。</p>
</blockquote>
<h3 id="模型工厂"><a href="#模型工厂" class="headerlink" title="模型工厂"></a>模型工厂</h3><p>当测试时，通常需要在执行测试之前在数据库中添加一些测试所需要的数据记录。Laravel 允许你使用 “factories” 来对你的 Eloquent 模型定义一些默认的属性设置来取代这些手动的添加数据的行为。在开始之前，我们来看一下应用的 <code>database/factories/ModelFactory.php</code> 文件。该文件中只包含了一个工厂的定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$factory-&gt;define(App\User::class, <span class="function"><span class="keyword">function</span> <span class="params">(Faker\Generator $faker)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> [</div><div class="line">    <span class="string">'name'</span> =&gt; $faker-&gt;name,</div><div class="line">    <span class="string">'email'</span> =&gt; $faker-&gt;email,</div><div class="line">    <span class="string">'password'</span> =&gt; bcrypt(str_random(<span class="number">10</span>)),</div><div class="line">    <span class="string">'remember_token'</span> =&gt; str_random(<span class="number">10</span>),</div><div class="line">  ] ;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在工厂定义中的闭包中，你可以返回一些模型中的用作测试的默认值。这个闭包会接收一个 <a href="https://github.com/fzaninotto/Faker" target="_blank" rel="external">Faker</a> PHP 类库的实例，它会帮你生成一些随机数据用于测试。</p>
<p>当然，你可以自由的在 <code>ModelFactory.php</code> 文件中添加额外的工厂。你也可以创建额外的工厂文件来有效的组织管理。比如，你可以在 <code>database/factories</code> 目录下创建一个 <code>UserFactory.php</code> 和 一个 <code>CommentFactory.php</code> 文件。</p>
<p><strong>多个工厂类型</strong></p>
<p>有时候，你可能希望在同一个 Eloquent 模型上有多个工厂类型。比如，可能你希望除了普通用户之外还有一个管理员的工厂。你可以使用 <code>defineAs</code> 方法来定义这些工厂：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$factory-&gt;defineAs(App\User::class, <span class="string">'admin'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($faker)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> [</div><div class="line">    <span class="string">'name'</span> =&gt; $faker-&gt;name,</div><div class="line">    <span class="string">'email'</span> =&gt; $faker-&gt;email,</div><div class="line">    <span class="string">'password'</span> =&gt; str_random(<span class="number">10</span>),</div><div class="line">    <span class="string">'remember_token'</span> =&gt; str_random(<span class="number">10</span>),</div><div class="line">    <span class="string">'admin'</span> =&gt; <span class="keyword">true</span>,</div><div class="line">  ];</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>你可以使用 <code>raw</code> 方法来检索基础工厂的属性，这样可用于属性的复用，然后合并添加你所需要的额外属性：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$factory-&gt;defineAs(App\User::class, <span class="string">'admin'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($faker)</span> <span class="title">use</span> <span class="params">($factory)</span> </span>&#123;</div><div class="line">  $user = $factory-&gt;raw(App\User::class);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> array_merge($user, [<span class="string">'admin'</span> =&gt; <span class="keyword">true</span>]); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>在测试中使用工厂</strong></p>
<p>一旦你定义了工厂，你就可以在你的测试文件或者数据库 seed 文件中使用全局帮助函数 <code>factory</code> 工厂方法来生成模型的实例。那么，让我们来看一些创建模型的示例。首先，我们将使用 <code>make</code> 方法，它将会创建一些模型但是却不会将其保存到数据库：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testDatabase</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  $user = factory(App\User::class)-&gt;make();</div><div class="line"></div><div class="line">  <span class="comment">// Use model in tests...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可以通过传递一个数组到 <code>make</code> 方法中来覆盖模型中的默认值。只有指定的部分会被替换掉，而其它部分都会被保留为工厂定义的默认值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = factory(App\User::class)-&gt;make([</div><div class="line">  <span class="string">'name'</span> =&gt; <span class="string">'Abigail'</span>,</div><div class="line">]);</div></pre></td></tr></table></figure>
<p>你也可以根据给定的类型创建多个模型的集合：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Create three App\User instances...</span></div><div class="line">$user = factory(App\User::class, <span class="number">3</span>)-&gt;make();</div><div class="line"></div><div class="line"><span class="comment">// Create an App\User "admin" instance...</span></div><div class="line">$user = factory(App\User::class, <span class="string">'admin'</span>)-&gt;make();</div><div class="line"></div><div class="line"><span class="comment">// Create three App\User "admin" instance...</span></div><div class="line">$user = factory(App\User::class, <span class="string">'admin'</span>, <span class="number">3</span>)-&gt;make();</div></pre></td></tr></table></figure>
<p><strong>工厂模型持久化</strong></p>
<p><code>create</code> 方法不仅仅会创建一个模型实例，它还会使用 Eloquent 的 <code>save</code> 方法将其存储到数据库中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testDatabase</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  $user = factory(App\User::class)-&gt;create();</div><div class="line"></div><div class="line">  <span class="comment">// Use model in tests...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这一次，你也可以传递一个数组到 <code>create</code> 方法中来覆盖默认的属性值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = factory(App\User::class)-&gt;create([</div><div class="line">  <span class="string">'name'</span> =&gt; <span class="string">'Abigail'</span>,</div><div class="line">]);</div></pre></td></tr></table></figure>
<p><strong>为模型添加关系</strong></p>
<p>你甚至可以持久化多个模型到数据库中。在这个例子中，我们甚至会为创建的模型附加一个关联模型。当使用 <code>create</code> 方法来创建多个模型时，会返回一个集合实例，这允许你使用集合实例的方法，比如 <code>each</code> :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$users = factory(App\User::class, <span class="number">3</span>)</div><div class="line">           -&gt;create()</div><div class="line">           -&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">($u)</span> </span>&#123;</div><div class="line">             $u-&gt;posts()-&gt;save(factory(App\Post::class)-&gt;make());</div><div class="line">           &#125;);</div></pre></td></tr></table></figure>
<p><strong>关联 &amp; 属性闭包</strong></p>
<p>你也可以在工厂定义内使用一个闭包来附加关系模型，比如，如果你希望创建一个 <code>Post</code> 时也创建一个关联的 <code>User</code> 实例，你可以这么做：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$factory-&gt;fefine(App\Post::class, <span class="function"><span class="keyword">function</span><span class="params">($faker)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> [</div><div class="line">    <span class="string">'title'</span> =&gt; $faker-&gt;title,</div><div class="line">    <span class="string">'content'</span> =&gt; $faker-&gt;paragraph,</div><div class="line">    <span class="string">'user_id'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> factory(App\User::class)-&gt;create()-&gt;id;</div><div class="line">    &#125;</div><div class="line">  ];</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这些闭包还会接收工厂所包含的评估属性数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$factory-&gt;define(App\Post::class, <span class="function"><span class="keyword">function</span> <span class="params">($faker)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> [</div><div class="line">    <span class="string">'title'</span> =&gt; $faker-&gt;title,</div><div class="line">    <span class="string">'content'</span> =&gt; $faker-&gt;paragraph,</div><div class="line">    <span class="string">'user_id'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> factory(App\User::class)-&gt;create()-&gt;id;</div><div class="line">    &#125;,</div><div class="line">    <span class="string">'user_type'</span> =&gt; <span class="function"><span class="keyword">function</span> <span class="params">(array $post)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> App\User::find($post[<span class="string">'user_id'</span>])-&gt;type;</div><div class="line">    &#125;</div><div class="line">  ]; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="模拟"><a href="#模拟" class="headerlink" title="模拟"></a>模拟</h2><h3 id="模拟事件"><a href="#模拟事件" class="headerlink" title="模拟事件"></a>模拟事件</h3><p>如果你在 Laravel 中大量使用了事件系统，那么你可能会想在进行测试时不触发事件或者模拟运行一些事件。比如，如果你测试用户注册，你可能并不想触发所有 <code>UserRegistered</code> 事件，因为这些可能会发送电子邮件等。</p>
<p>Laravel 提供了方便的 <code>expectsEvents</code> 方法来验证预期的事件是否触发，但是会避免这些事件的真正的执行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testUserRegistration</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;expectsEvents(App\Events\UserRegistered::class);</div><div class="line"></div><div class="line">    <span class="comment">// Test user registration...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你也可以使用 <code>doesntExpectEvents</code> 方法来验证给定的事件没有被触发：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testPodcastPurchase</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;expectsEvents(App\Events\PodcastWasPurchased::class);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;doesntExpectEvents(App\Events\PaymentWasDeclined::class);</div><div class="line"></div><div class="line">    <span class="comment">// Test purchasing podcast...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你需要避免所有的事件触发，你可以使用 <code>withoutEvents</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testUerRegistration</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;withoutEvents();</div><div class="line"></div><div class="line">    <span class="comment">// Test user registration code...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="模拟任务"><a href="#模拟任务" class="headerlink" title="模拟任务"></a>模拟任务</h3><p>有时候，你想在构建请求到应用时，简单的测试一下控制器中是否进行了指定任务的分发。这可以使你隔离测试你的路由 / 控制器和你的任务逻辑，当然，你可以再写一个测试用例来单独的测试任务的执行。</p>
<p>Laravel 提供了方便的 <code>expectsJobs</code> 方法来验证期望的任务是否被分发，但是任务并不会被真正的分发执行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testPurchasePodcast</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;expectsJobs(App\Jobs\PurchasePodcast::class);</div><div class="line"></div><div class="line">    <span class="comment">// Test purchase podcast code...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：这个方法仅用来测试通过 <code>DispatchesJobs</code> trait 的分发或者 <code>dispatch</code> 帮助方法的分发。它并不检测直接使用 <code>Queue::push</code> 发布的任务。</p>
</blockquote>
<h3 id="模拟假面"><a href="#模拟假面" class="headerlink" title="模拟假面"></a>模拟假面</h3><p>当测试时，你或许经常需要模拟一个 Laravel 假面的调用。比如，考虑一下下面的控制器操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Cache</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Show a list of all users of the application</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $value = Cache::get(<span class="string">'key'</span>);</div><div class="line"></div><div class="line">     <span class="comment">//</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以使用 <code>shouldReceive</code> 方法来模拟调用 <code>Cache</code> 假面，它会返回一个 <a href="https://github.com/padraic/mockery" target="_blank" rel="external">Mockery</a> 的模拟实例。由于假面实际上是通过 Laravel 的服务容器来解析和管理的，所以它们比一般的静态类更具可测性。比如，让我们来模拟 <code>Cache</code> 假面的调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FooTest</span> <span class="keyword">extends</span> <span class="title">TestCase</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testGetIndex</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    Cache::shouldReceive(<span class="string">'get'</span>)</div><div class="line">             -&gt;once()</div><div class="line">             -&gt;with(<span class="string">'key'</span>)</div><div class="line">             -&gt;andReturn(<span class="string">'value'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;visit(<span class="string">'/users'</span>)-&gt;see(<span class="string">'value'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：你不应该模拟 <code>Request</code> 假面。你应该在运行测试时使用 HTTP 帮助方法如 <code>call</code> 和 <code>post</code> 来传递你所希望的输入。</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/18/laravel-from-scratch-task-scheduling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/18/laravel-from-scratch-task-scheduling/" itemprop="url">laravel 基础教程 —— 任务计划</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-18T09:10:06+08:00">
                2016-06-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="任务计划（Task-Scheduling）"><a href="#任务计划（Task-Scheduling）" class="headerlink" title="任务计划（Task Scheduling）"></a>任务计划（Task Scheduling）</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在过去，开发者需要手动的在计划表中添加一行来录入定时执行的任务。这是非常让人头疼的，因为你不得不手动的登录远端服务器去做这些事情，它并不能在代码中有效的控制。Laravel 的命令调度者允许你在 Laravel 中流利通畅的定义你的任务计划，并且，你只需要为此在服务器中增加一个单独的定时任务条目就可以了，之后就可以在代码中进行控制任务计划的数量。</p>
<p>你的任务计划被定义在 <code>app/Console/Kernel.php</code> 文件的 <code>schedule</code> 方法中。在开始之前，我们先看一个简单的例子。你可以在 <code>Schedule</code> 对象中添加任意你希望执行的任务计划。</p>
<h3 id="开始运行计划"><a href="#开始运行计划" class="headerlink" title="开始运行计划"></a>开始运行计划</h3><p>你只需要在你的服务器的 Cron 项中添加如下条目：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">* * * * * php /path/to/artisan schedule:run &gt;&gt; /dev/<span class="keyword">null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></div></pre></td></tr></table></figure>
<p>该 Cron 会每分钟调用 Laravel 的命令调度来执行计划任务。Laravel 会自动的评估你的任务计划并执行到期的任务。</p>
<h2 id="定义任务"><a href="#定义任务" class="headerlink" title="定义任务"></a>定义任务</h2><p>你可以在 <code>App\Console\Kernel</code> 类的 <code>schedule</code> 方法中定义所有的任务计划。在开始之前，先让我们看一个任务计划的简单例子。在这个例子中，我们会在每天的午夜执行 <code>Closure</code>。在 <code>Closure</code> 中我们会执行清除数据库表的查询语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Console</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">DB</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Scheduling</span>\<span class="title">Schedule</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Console</span>\<span class="title">Kernel</span> <span class="title">as</span> <span class="title">ConsoleKernel</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Kernel</span> <span class="keyword">extends</span> <span class="title">ConsoleKernel</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The Artisan commands provided by your application.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> $commands = [</div><div class="line">     \App\Console\Commands\Inspire::class,</div><div class="line">   ];</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Define the application's command schedule.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> \Illuminate\Console\Scheduling\Schedule $schedule</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">schedule</span><span class="params">(Schedule $schedule)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      $schedule-&gt;call(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        DB::table(<span class="string">'recent_users'</span>)-&gt;delete();</div><div class="line">      &#125;)-&gt;daily();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除了可以调度 <code>Closure</code> 调用，你也可以调度 Artisan 命令和操作系统的命令。比如，你可以使用 <code>command</code> 方法来调度一个 Artisan 命令：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$schedule-&gt;command(<span class="string">'emails:send --force'</span>)-&gt;daily();</div></pre></td></tr></table></figure>
<p>你可以使用 <code>exec</code> 方法来发布一个命令到操作系统中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$schedule-&gt;exec(<span class="string">'node /home/forge/script.js'</span>)-&gt;daily();</div></pre></td></tr></table></figure>
<h3 id="调度频率选项"><a href="#调度频率选项" class="headerlink" title="调度频率选项"></a>调度频率选项</h3><p>当然，这里还有各种可以分配到任务的调度方法：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-&gt;cron(&#39;* * * * * *&#39;);</code></td>
<td>执行自定义的 Cron 任务计划</td>
</tr>
<tr>
<td><code>-&gt;everyMinute();</code></td>
<td>每分钟执行一次任务</td>
</tr>
<tr>
<td><code>-&gt;everyFiveMinutes();</code></td>
<td>每五分钟执行一次任务</td>
</tr>
<tr>
<td><code>-&gt;everyTenMinutes();</code></td>
<td>每十分钟执行一次任务</td>
</tr>
<tr>
<td><code>-&gt;hourly();</code></td>
<td>每一小时执行一次任务</td>
</tr>
<tr>
<td><code>-&gt;daily();</code></td>
<td>每天的午夜执行一次任务</td>
</tr>
<tr>
<td><code>-&gt;dailyAt(&#39;13:00&#39;);</code></td>
<td>每天的 13:00 执行一次任务</td>
</tr>
<tr>
<td><code>-&gt;twiceDaily(1, 13);</code></td>
<td>每天的 1:00 &amp; 13:00 执行一次任务</td>
</tr>
<tr>
<td><code>-&gt;weekly();</code></td>
<td>每周执行一次任务</td>
</tr>
<tr>
<td><code>-&gt;montyly();</code></td>
<td>每月执行一次任务</td>
</tr>
<tr>
<td><code>-&gt;monthlyOn(4, &#39;15:00&#39;);</code></td>
<td>每月的 4 号 15:00 执行一次任务</td>
</tr>
<tr>
<td><code>-&gt;quarterly();</code></td>
<td>每季度执行一次任务</td>
</tr>
<tr>
<td><code>-&gt;yearly();</code></td>
<td>每年执行一次任务</td>
</tr>
<tr>
<td><code>-&gt;timezone(&#39;America/New_York&#39;);</code></td>
<td>设置时区</td>
</tr>
</tbody>
</table>
<p>这些方法可以与额外的限制相结合以创建更加细微调整的计划，比如仅在一周的某几天运行。让我们调度一个计划命令来在每周的周一执行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Run once per week on Monday at 1 PM...</span></div><div class="line">$schedule-&gt;call(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;)-&gt;weekly()-&gt;mondays()-&gt;at(<span class="string">'13:00'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Run hourly from 8 AM to 5 PM on weekdays...</span></div><div class="line">$schedule-&gt;command(<span class="string">'foo'</span>)</div><div class="line">         -&gt;weekdays()</div><div class="line">         -&gt;hourly()</div><div class="line">         -&gt;timezone(<span class="string">'America/Chicago'</span>)</div><div class="line">         -&gt;when(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">return</span> date(<span class="string">'H'</span>) &gt;= <span class="number">8</span> &amp;&amp; date(<span class="string">'H'</span>) &lt;= <span class="number">17</span>;</div><div class="line">         &#125;);</div></pre></td></tr></table></figure>
<p>下面列出了额外的计划约束条件：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-&gt;weekdays();</code></td>
<td>限制在平常日内（周六、日除外）</td>
</tr>
<tr>
<td><code>-&gt;sundays();</code></td>
<td>限制在周日</td>
</tr>
<tr>
<td><code>-&gt;mondays();</code></td>
<td>限制在周一</td>
</tr>
<tr>
<td><code>-&gt;tuesdays();</code></td>
<td>限制在周二</td>
</tr>
<tr>
<td><code>-&gt;wednesdays();</code></td>
<td>限制在周三</td>
</tr>
<tr>
<td><code>-&gt;thursdays();</code></td>
<td>限制在周四</td>
</tr>
<tr>
<td><code>-&gt;fridays();</code></td>
<td>限制在周五</td>
</tr>
<tr>
<td><code>-&gt;staturdays();</code></td>
<td>限制在周六</td>
</tr>
<tr>
<td><code>-&gt;when(Closure);</code></td>
<td>限制基于真值测试</td>
</tr>
</tbody>
</table>
<p><strong>真值约束</strong></p>
<p><code>when</code> 方法可以基于给定的真值测试的结果来约束一个任务的执行。换种说法就是，如果给定的 <code>Closure</code> 返回 <code>true</code>，那么只要其他约束并不阻止任务的执行时，该任务就会被执行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$schedule-&gt;command(<span class="string">'emails:send'</span>)-&gt;daily()-&gt;when(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>skip</code> 方法刚好与 <code>when</code> 相反。如果 <code>skip</code> 方法返回 <code>true</code>，那么调度任务将不会执行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$schedule-&gt;command(<span class="string">'emails:send'</span>)-&gt;daily()-&gt;skip(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">true</span>; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>当链式调用 <code>when</code> 方法时，只有在所有的 <code>when</code> 约束返回 <code>true</code> 时才会执行调度任务命令。</p>
<h3 id="避免任务重叠"><a href="#避免任务重叠" class="headerlink" title="避免任务重叠"></a>避免任务重叠</h3><p>默认的，如果前一个任务还在进程中，计划任务还是会再次运行的。你可以使用 <code>withoutOverlapping</code> 方法来避免这个：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$schedule-&gt;command(<span class="string">'emails:send'</span>)-&gt;withoutOverlapping();</div></pre></td></tr></table></figure>
<p>在这个例子中，<code>emails:send</code> Artisan 命令每分钟都会被调度，但是只有在进程中没有运行该命令时才会再次执行。<code>withoutOverlapping</code> 方法对于无法确定执行时间的任务特别有效，这样就可以避免同时执行越来越多的耗时任务增大服务器的压力。</p>
<h2 id="任务输出"><a href="#任务输出" class="headerlink" title="任务输出"></a>任务输出</h2><p>Laravel 的任务计划提供了多种方便的方法来生成计划任务的输出。首先，你需要使用 <code>sendOutputTo</code> 方法，你可以传递一个文件路径到方法以便之后的检查：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$schedule-&gt;command(<span class="string">'emails:send'</span>)</div><div class="line">         -&gt;daily()</div><div class="line">         -&gt;sendOutputTo($filePath);</div></pre></td></tr></table></figure>
<p>如果希望追加内容到给定的文件，你应该使用 <code>appendOutputTo</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$schedule-&gt;command(<span class="string">'emails:send'</span>)</div><div class="line">         -&gt;daily()</div><div class="line">         -&gt;appendOutputTo($filePath);</div></pre></td></tr></table></figure>
<p>你可以使用 <code>emailOutputTo</code> 方法来将输出发送到你选定的邮箱地址中。但是你需要注意的是，你必须先使用 <code>sendOutputTo</code> 方法将输出发送到文件中。并且，在通过邮件发送任务的输出之前，你需要先配置好 laravel 的邮件服务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$schedule-&gt;command(<span class="string">'foo'</span>)</div><div class="line">         -&gt;daily()</div><div class="line">         -&gt;sendOutputTo($filePath)</div><div class="line">         -&gt;emailOutputTo(<span class="string">'foo@example.com'</span>)</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：<code>emailOutputTo</code> 和 <code>sendOutputTo</code> 方法只能在 <code>command</code> 方法中执行，并不支持 <code>call</code> 方法的调用。</p>
</blockquote>
<h2 id="任务钩子"><a href="#任务钩子" class="headerlink" title="任务钩子"></a>任务钩子</h2><p>你可以使用 <code>before</code> 和 <code>after</code> 方法来在任务计划执行或者完成时执行特定的操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$schedule-&gt;command(<span class="string">'emails:send'</span>)</div><div class="line">         -&gt;daily()</div><div class="line">         -&gt;before(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">           <span class="comment">// Task is about to start...</span></div><div class="line">         &#125;)</div><div class="line">         -&gt;after(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">           <span class="comment">// Task is complete...</span></div><div class="line">         &#125;);</div></pre></td></tr></table></figure>
<p><strong>Pingings URLs</strong></p>
<p>使用 <code>pingBefore</code> 和 <code>thenPing</code> 方法，任务调度可以自动的在任务完成之前或者之后 ping 给定的 URL。这些方法通常用来通知外部的服务。比如 <a href="https://envoyer.io/" target="_blank" rel="external">Laravel Envoyer</a>，告知其计划任务将要执行或者已经完成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$schedule-&gt;command(<span class="string">'emails:send'</span>)</div><div class="line">         -&gt;daily()</div><div class="line">         -&gt;pingBefore($url)</div><div class="line">         -&gt;thenPing($url);</div></pre></td></tr></table></figure>
<p>使用 <code>pingBefore($url)</code> 或者 <code>thenPing($url)</code> 方法都需要引入 Guzzle HTTP 类库。你可以通过 Composer 来进行安装：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"guzzlehttp/guzzle"</span>: <span class="string">"~5.3|~6.0"</span></div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/17/laravel-from-scratch-ssh-task/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/17/laravel-from-scratch-ssh-task/" itemprop="url">laravel 基础教程 —— SSH 任务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-17T16:02:39+08:00">
                2016-06-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Envoy-任务运行器"><a href="#Envoy-任务运行器" class="headerlink" title="Envoy 任务运行器"></a>Envoy 任务运行器</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Laravel <a href="https://github.com/laravel/envoy" target="_blank" rel="external">Envoy</a> 为远端服务器常用任务的定义与执行提供了迷你简洁的语法。你可以通过使用 Blade 语法样式轻松的为部署，Artisan 命令等设置任务。目前，Envoy 只支持 Mac 和 Linux 操作系统。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>首先，你需要通过 Composer 的 <code>global</code> 命令来安装 Envoy：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">composer <span class="keyword">global</span> <span class="keyword">require</span> <span class="string">"laravel/envoy=~1.0"</span></div></pre></td></tr></table></figure>
<p>你需要确保 <code>~/.composer/vendor/bin</code> 目录被加入到你的 PATH 中，这样才能使你在使用终端时可以直接使用 <code>envoy</code> 命令。</p>
<p><strong>更新 Envoy</strong></p>
<p>你可以使用 Composer 来维持 Envoy 的更新：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">composer <span class="keyword">global</span> update</div></pre></td></tr></table></figure>
<h2 id="编写任务"><a href="#编写任务" class="headerlink" title="编写任务"></a>编写任务</h2><p>所有的 Envoy 任务应该被定义在你项目的根目录下的 <code>Envoy.blade.php</code> 文件中。这里有一个简单的示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@servers([<span class="string">'web'</span> =&gt; <span class="string">'user@192.168.1.1'</span>])</div><div class="line"></div><div class="line">@task(<span class="string">'foo'</span>, [<span class="string">'on'</span> =&gt; <span class="string">'web'</span>])</div><div class="line">  ls -al</div><div class="line">@endtask</div></pre></td></tr></table></figure>
<p>就如你所看到的，<code>@servers</code> 指令被定义在文件的头部，并且包含一个数组，数组中包含服务器的列表。<code>@task</code> 指令用来定义任务，它包含一个任务名称，和一个数组参数，数组中包含一个 <code>on</code> 键，它的值就是任务所要执行的服务器，它应该是 <code>@servers</code> 指令列表中的一个或多个。你应该在 <code>@task</code> 指令的内部放置 Bash 代码，这些代码会在任务执行时传递给所要执行的远端服务器。</p>
<p><strong>本地任务</strong></p>
<p>你可以指定服务器为本地来执行本地的任务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@servers([<span class="string">'localhost'</span> =&gt; <span class="string">'127.0.0.1'</span>])</div></pre></td></tr></table></figure>
<p><strong>引导</strong></p>
<p>有时候，你可能希望在执行 Envoy 任务之前先执行某些 PHP 操作。你可以使用 <code>@setup</code> 指令来声明变量，并且你可以在其内部使用 PHP 来工作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@setup</div><div class="line">  $now = <span class="keyword">new</span> DateTime();</div><div class="line"></div><div class="line">  $environment = <span class="keyword">isset</span>($env) ? $env : <span class="string">"testing"</span>;</div><div class="line">@endsetup</div></pre></td></tr></table></figure>
<p>你也可以使用 <code>@include</code> 指令来引入任意的外部 PHP 文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">include</span>(<span class="string">'vendor/autoload.php'</span>)</div></pre></td></tr></table></figure>
<p><strong>确认任务</strong></p>
<p>如果你希望在远端服务器执行所给定任务之前先进行提示，你可以在你的任务定义时添加 <code>confirm</code> 指令：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@task(<span class="string">'deploy'</span>, [<span class="string">'on'</span> =&gt; <span class="string">'web'</span>, <span class="string">'confirm'</span> =&gt; <span class="keyword">true</span>])</div><div class="line">  cd site</div><div class="line">  git pull origin &#123;&#123; $branch &#125;&#125;</div><div class="line">  php artisan migrate</div><div class="line">@endtask</div></pre></td></tr></table></figure>
<h3 id="任务变量"><a href="#任务变量" class="headerlink" title="任务变量"></a>任务变量</h3><p>如果你需要的话，你可以使用命令行开关来传递变量到 Envoy 任务中，这允许你定制化你的任务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">envoy run deploy --branch=master</div></pre></td></tr></table></figure>
<p>你可以在你的任务中通过 Blade 的 echo 语法使用该选项:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">@servers([<span class="string">'web'</span> =&gt; <span class="string">'192.168.1.1'</span>])</div><div class="line"></div><div class="line">@task(<span class="string">'deploy'</span>, [<span class="string">'on'</span> =&gt; <span class="string">'web'</span>])</div><div class="line">  cd site</div><div class="line">  git pull origin &#123;&#123; $branch &#125;&#125;</div><div class="line">  php artisan migrate</div><div class="line">@endtask</div></pre></td></tr></table></figure>
<h3 id="多个服务器"><a href="#多个服务器" class="headerlink" title="多个服务器"></a>多个服务器</h3><p>你可以轻松的跨多个服务器执行任务。首先，你需要在 <code>@servers</code> 指令中添加额外的服务器。每个服务器应该被分配一个唯一的名字。当你添加完额外的服务器之后，你需要在待执行的任务指令中使用数组 <code>on</code> 键来列出待执行的服务器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@servers([<span class="string">'web-1'</span> =&gt; <span class="string">'192.168.1.1'</span>, <span class="string">'web-2'</span> =&gt; <span class="string">'192.168.1.2'</span>])</div><div class="line"></div><div class="line">@task(<span class="string">'deploy'</span>, [<span class="string">'on'</span> =&gt; [<span class="string">'web-1'</span>, <span class="string">'web-2'</span>]])</div><div class="line">  cd site</div><div class="line">  git pull origin &#123;&#123; $branch &#125;&#125;</div><div class="line">  php artisan migrate</div></pre></td></tr></table></figure>
<p>默认的，任务会在服务器间串行执行，这意味着只有在当前服务器执行任务完成之后才会执行下一个服务器的任务。</p>
<p><strong>平行执行</strong></p>
<p>如果你希望跨服务器平行执行任务。你可以在任务指令中添加 <code>parallel</code> 选项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">@servers([<span class="string">'web-1'</span> =&gt; <span class="string">'192.168.1.1'</span>, <span class="string">'web-2'</span> =&gt; <span class="string">'192.168.1.2'</span>])</div><div class="line"></div><div class="line">@task(<span class="string">'deploy'</span>, [<span class="string">'on'</span> =&gt; [<span class="string">'web-1'</span>, <span class="string">'web-2'</span>], <span class="string">'parallel'</span> =&gt; <span class="keyword">true</span>])</div><div class="line">  cd site</div><div class="line">  git pull origin &#123;&#123; $branch &#125;&#125;</div><div class="line">  php artisan migrate</div><div class="line">@endtask</div></pre></td></tr></table></figure>
<h3 id="任务宏"><a href="#任务宏" class="headerlink" title="任务宏"></a>任务宏</h3><p>任务宏允许你定义一个命令来顺序的执行一组任务。举个实例，我们定义一个 <code>deploy</code> 宏来执行 <code>git</code> 和 <code>composer</code> 任务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">@servers([<span class="string">'web'</span> =&gt; <span class="string">'192.168.1.1'</span>])</div><div class="line"></div><div class="line">@macro(<span class="string">'deploy'</span>)</div><div class="line">  git</div><div class="line">  composer</div><div class="line">@endmacro</div><div class="line"></div><div class="line">@task(<span class="string">'git'</span>)</div><div class="line">  git pull origin master</div><div class="line">@endtask</div><div class="line"></div><div class="line">@task(<span class="string">'composer'</span>)</div><div class="line">  composer install</div><div class="line">@endtask</div></pre></td></tr></table></figure>
<p>一旦你定义完成了宏，你就可以通过一条命令来运行多个任务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">envoy run deploy</div></pre></td></tr></table></figure>
<h3 id="运行任务"><a href="#运行任务" class="headerlink" title="运行任务"></a>运行任务</h3><p>你需要使用 Envoy 的 <code>run</code> 命令来执行 <code>Envoy.blade.php</code> 文件中所定义的任务。你可以传递一个任务的名称或者宏名称到命令中。Envoy 会执行任务并同步显示服务器执行的输出：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">envoy run task</div></pre></td></tr></table></figure>
<h2 id="通知"><a href="#通知" class="headerlink" title="通知"></a>通知</h2><h3 id="HipChat"><a href="#HipChat" class="headerlink" title="HipChat"></a>HipChat</h3><p>你可以使用 <code>@hipchat</code> 指令来在任务执行完成之后，发送一个消息通知到团队的 HipChat 房间中。这个指令接收一个 API token，房间的名称和消息中所显示的发送者的用户名:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@servers([<span class="string">'web'</span> =&gt; <span class="string">'192.168.1.1'</span>])</div><div class="line"></div><div class="line">@task(<span class="string">'foo'</span>, [<span class="string">'on'</span> =&gt; <span class="string">'web'</span>])</div><div class="line">  ls -al</div><div class="line">@endtask</div><div class="line"></div><div class="line">@after</div><div class="line">  @hipchat(<span class="string">'token'</span>, <span class="string">'room'</span>, <span class="string">'Envoy'</span>)</div><div class="line">@endafter</div></pre></td></tr></table></figure>
<p>如果你需要，你也可以发送自定义的消息到 HipChat 房间。构建消息时，任务可用的变量在消息中也是可用的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@after</div><div class="line">  @hipchat(<span class="string">'token'</span>, <span class="string">'room'</span>, <span class="string">'Envoy'</span>, <span class="string">"$task ran in the $env environment."</span>)</div><div class="line">@endafter</div></pre></td></tr></table></figure>
<h3 id="Slack"><a href="#Slack" class="headerlink" title="Slack"></a>Slack</h3><p>除了 HipChat 之外，Envoy 也支持向 <a href="https://github.com/laravel/envoy" target="_blank" rel="external">Slack</a> 中发送通知。<code>@slack</code> 指令接收一个 Slack hook URL，一个频道名称，和你需要发送的消息内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@after</div><div class="line">  @slack(<span class="string">'hook'</span>, <span class="string">'channel'</span>, <span class="string">'message'</span>)</div><div class="line">@endafter</div></pre></td></tr></table></figure>
<p>你可以通过在 Slack 的网站上创建一个 <code>Incoming WebHooks</code> 来获取 webhook URL。<code>hook</code> 参数应该是一个完整的 webhook URL，比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https:<span class="comment">//hooks.slack.com/services/ZZZZZZZZZ/YYYYYYYYY/XXXXXXXXXXXXXXX</span></div></pre></td></tr></table></figure>
<p>你可以提供以下作为频道的参数之一：</p>
<ul>
<li><code>#channel</code> 发送通知到频道</li>
<li><code>@user</code> 发送通知到用户</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/15/vue-paginator-component/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/15/vue-paginator-component/" itemprop="url">vue paginator component</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-15T14:32:38+08:00">
                2016-06-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/14/laravel-from-scratch-session/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/14/laravel-from-scratch-session/" itemprop="url">laravel 基础教程 —— Session</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-14T16:29:28+08:00">
                2016-06-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>由于 HTTP 驱动是一种无状态的协议，这通常意味着服务端并不能清楚的知道当前请求用户与之前请求用户间的关系，而 Session 提供了这种跨请求用户的解决方案。Laravel 附带了简洁统一的 API 来支持各种后端 session 驱动。对于 <a href="http://memcached.org/" target="_blank" rel="external">Memcached</a>，<a href="http://redis.io/" target="_blank" rel="external">Redis</a> 和数据库这种流行的后端驱动，Laravel 提供了开箱即用的支持。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>session 的配置文件被存储在 <code>config/session.php</code>。你应该确保在使用前阅读该文件中的配置项注释。Laravel 对配置中的每一项都进行了详细的注释。默认的，laravel 配置使用的是 <code>file</code> session 驱动，这对于大多数应用来说已经够用了。但是在生产环境中还是建议使用 <code>memcached</code> 或者 <code>redis</code> 这种内存级驱动，这对于应用的 session 性能来说会是一个很大的提升。</p>
<p>对于每个请求的 session 数据，都会存储在你所定义的 session <code>driver</code> 所在的位置中。下列驱动在 laravel 中可以开箱即用：</p>
<ul>
<li><code>file</code> - sessions 会存储在 <code>storage/framework/sessions</code> 中。</li>
<li><code>cookie</code> - sessions 会被存储在经过安全加密的 cookies 中。</li>
<li><code>database</code> - sessions 会被存储在你应用中所使用的数据库中。</li>
<li><code>memcached</code> / <code>redis</code> - sessions 会被存储在更快的内存级存储驱动中。</li>
<li><code>array</code> - sessions 会使简单存储在 PHP 的数组中，并且它不能被跨请求访问。</li>
</ul>
<blockquote>
<p>注意：<code>array</code> 驱动通常是用来进行测试时使用的以避免持久的 session 数据。</p>
</blockquote>
<h3 id="驱动先决条件"><a href="#驱动先决条件" class="headerlink" title="驱动先决条件"></a>驱动先决条件</h3><p><strong>数据库</strong></p>
<p>当使用 <code>database</code> session 驱动时，你需要先创建一个表来存储 session 项。下面的例子是数据库 session 驱动表的架构声明：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Schema::create(<span class="string">'sessions'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;string(<span class="string">'id'</span>)-&gt;unique();</div><div class="line">  $table-&gt;integer(<span class="string">'user_id'</span>)-&gt;nullable();</div><div class="line">  $table-&gt;string(<span class="string">'ip_address'</span>, <span class="number">45</span>)-&gt;nullable();</div><div class="line">  $table-&gt;text(<span class="string">'user_agent'</span>)-&gt;nullable();</div><div class="line">  $table-&gt;text(<span class="string">'payload'</span>);</div><div class="line">  $table-&gt;integer(<span class="string">'last_activity'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>你也可以使用 <code>session:table</code> Artisan 命令来生成一个数据库会话驱动的迁移表：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">php artisan session:table</div><div class="line"></div><div class="line">composer dump-autoload</div><div class="line"></div><div class="line">php artisan migrate</div></pre></td></tr></table></figure>
<p><strong>Redis</strong></p>
<p>在使用 Redis session 驱动之前，你需要通过 Composer 安装 <code>predis/predis</code>（~1.0）。</p>
<p><strong>其他 Session 注意事项</strong></p>
<p>Laravel 框架内部使用了 <code>flash</code> 作为 session 其中的一个键，所以你应该避免使用该名称的键到 session 中。</p>
<p>如果你需要存储安全加密后的 session 数据，你可以在配置文件中将 <code>encrypt</code> 选项设置为 <code>true</code>。</p>
<h2 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h2><p><strong>访问 Session</strong></p>
<p>首先，让我们来访问 session。我们可以通过 HTTP 请求来访问 session 的实例。HTTP 请求可以通过在控制器方法中使用类型提示来进行依赖注入。你应该记得，控制器方法的依赖会通过 laravel 的服务容器进行注入：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Show the profile for the given user.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> Request $request</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showProfile</span><span class="params">(Request $request, $id)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $value = $request-&gt;session()-&gt;get(<span class="string">'key'</span>);</div><div class="line"></div><div class="line">     <span class="comment">//</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当你从 session 中检索值时，你也可以指定一个默认的值到 <code>get</code> 方法的第二个参数，默认值会在 session 未检索到相应键的值时返回。你也可以传递 <code>Closure</code> 作为默认值，如果找不到相应的键，<code>Closure</code> 执行的结果所返回的值将作为默认值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$value = $request-&gt;session()-&gt;get(<span class="string">'key'</span>, <span class="string">'default'</span>);</div><div class="line"></div><div class="line">$value = $request-&gt;session()-&gt;get(<span class="string">'key'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="string">'default'</span>; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>如果你希望从 session 中检索出所有的值，你可以使用 <code>all</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$data = $request-&gt;session()-&gt;all();</div></pre></td></tr></table></figure>
<p>你可以可以使用全局帮助方法 <code>session</code> 来进行值的检索和存储：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'home'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">// Retrieve a piece of data from the session...</span></div><div class="line">  $value = session(<span class="string">'key'</span>);</div><div class="line"></div><div class="line">  <span class="comment">// Store a piece of data in the session...</span></div><div class="line">  session([<span class="string">'key'</span> =&gt; <span class="string">'value'</span>]);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>判断 session 是否存在某项</strong></p>
<p>你可以使用 <code>has</code> 方法来判断 session 中是否含有某项，如果存在则返回 <code>true</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($request-&gt;session()-&gt;has(<span class="string">'user'</span>)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>在 session 中存储数据</strong></p>
<p>一旦你获取了 session 的实例，你就拥有了和底层数据进行交互的能力，你可以通过各种实例的方法来进行交互。比如，你可以使用 <code>put</code> 方法来在 session 中存储一个新的数据项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$request-&gt;session()-&gt;put(<span class="string">'key'</span>, <span class="string">'value'</span>);</div></pre></td></tr></table></figure>
<p><strong>推送内容到 session 中值为数组的项</strong></p>
<p>你可以使用 <code>push</code> 方法来将一个新的值推送到 session 中值为数组的项中。比如，如果 <code>user.teams</code> 键表明了数组在 session 中的路径，你可以像这样推送新的值到该数组中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$request-&gt;session()-&gt;push(<span class="string">'user.teams'</span>, <span class="string">'developers'</span>);</div></pre></td></tr></table></figure>
<p><strong>检索并删除某项</strong></p>
<p><code>pull</code> 方法会在检索的同时在 session 中删除该项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$value = $request-&gt;session()-&gt;pull(<span class="string">'key'</span>, <span class="string">'default'</span>);</div></pre></td></tr></table></figure>
<p><strong>删除 session 中的某项</strong></p>
<p>你可以使用 <code>forget</code> 方法来删除 session 中的某一项数据，如果你想要移除 session 中的所有数据，你可以使用 <code>flush</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$request-&gt;session()-&gt;forget(<span class="string">'key'</span>);</div><div class="line"></div><div class="line">$request-&gt;session()-&gt;flush();</div></pre></td></tr></table></figure>
<p><strong>重新生成 session ID</strong></p>
<p>如果你需要重新生成 session ID，你可以使用 <code>regenerate</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$request-&gt;session()-&gt;regenerate();</div></pre></td></tr></table></figure>
<h3 id="闪存数据"><a href="#闪存数据" class="headerlink" title="闪存数据"></a>闪存数据</h3><p>有时候你希望在 session 中存储某些数据，但是只允许下一次请求时使用，使用后即消除。那么就可以使用 <code>flash</code> 方法。这方法在 session 中存储的数据只能在随后的请求中进行访问，并且在之后删除。闪存的数据通常用来做一些临时的状态消息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$request-&gt;session()-&gt;flash(<span class="string">'status'</span>, <span class="string">'Task was successful!'</span>);</div></pre></td></tr></table></figure>
<p>如果你需要维持闪存的数据到更多的请求，你可以使用 <code>reflash</code> 方法，它会维持所有的闪存数据到额外的请求中。如果你只需要维持指定的闪存数据，你可以使用 <code>keep</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$request-&gt;session()-&gt;reflash();</div><div class="line"></div><div class="line">$request-&gt;session()-&gt;keep([<span class="string">'username'</span>, <span class="string">'email'</span>]);</div></pre></td></tr></table></figure>
<h2 id="添加自定义的-Session-驱动"><a href="#添加自定义的-Session-驱动" class="headerlink" title="添加自定义的 Session 驱动"></a>添加自定义的 Session 驱动</h2><p>你需要使用 <code>Session</code> 假面的 <code>extend</code> 方法才能添加额外的 session 驱动到 Laravel 中。你可以在服务提供者的 <code>boot</code> 方法中来调用 <code>extend</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Session</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Extensions</span>\<span class="title">MongoSessionStore</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SessionServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Perform post-registration booting of services.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     Session::extend(<span class="string">'mongo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">       <span class="comment">// Return implementation of SessionHandlerInterface...</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> MongoSessionStore;</div><div class="line">     &#125;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Register bindings in the container.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="comment">//</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你应该注意你的自定义 session 驱动应该实现 <code>SessionHandlerInterface</code> 接口。该接口仅包含了几个简单的需要实现的方法。一个实现了的 MongoDB 驱动的结构应该像下面一样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Extensions</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MongoHandler</span> <span class="keyword">implements</span> <span class="title">SessionHandlerInterface</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span><span class="params">($savePath, $sessionName)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">($sessionId)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">($sessionId, $data)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">destroy</span><span class="params">($sessionId)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">gc</span><span class="params">($lifetime)</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于这些方法并不像缓存的 <code>StoreInterface</code> 那样难于理解。所以，我们就来快速的过一下吧：</p>
<ul>
<li><code>open</code> 方法一般用于基于文件的 session 存储系统。由于 laravel 已经附带了 <code>file</code> session 驱动，所以你几乎不需要在这个方法中添加任何的代码。你可以直接放置其为空方法。事实上，这是一种可怜的接口设计（我们将会在后面讨论它），PHP 必须要我们实现这个方法。</li>
<li><code>close</code> 方法，类似于 <code>open</code> 方法，你也可以对其进行忽视，对于大多数驱动来说根本不需要。</li>
<li><code>read</code> 方法应该根据给定的 <code>$sessionId</code> 返回 session 中关联数据的字符串版本。你不需要在存储或检索时做任何的序列化或其它的编码操作，因为 laravel 会为你执行序列化服务。</li>
<li><code>destroy</code> 方法应该从 session 存储中删除所关联的数据。</li>
<li><code>gc</code> 方法应该根据给定的 <code>$lifetime</code> UNIX 时间戳删除 session 所关联的过期数据。对于拥有自动过期能力的系统，比如 Memcached 和 Redis，你可以直接让这个方法为空。</li>
</ul>
<p>一旦你的 session 驱动被注册。你就可以在 <code>config/session.php</code> 配置文件中使用 <code>mongo</code> 驱动了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Dearmadman</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">100</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dearmadman</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
