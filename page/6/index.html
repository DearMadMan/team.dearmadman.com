<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Team.dearmadman.com">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="Team.dearmadman.com">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Team.dearmadman.com">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/6/"/>





  <title>Team.dearmadman.com</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Team.dearmadman.com</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do it.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/10/laravel-from-scratch-redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/10/laravel-from-scratch-redis/" itemprop="url">laravel 基础教程 —— Redis</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-10T19:53:11+08:00">
                2016-06-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><a href="http://redis.io/" target="_blank" rel="external">Redis</a> 是一个开源高效的键值对存储系统。它通常用作为一个数据结构服务器来存储键值对，它可以支持字符串，散列，列表，集合，和有序集合。在 laravel 中使用 Redis 之前，你需要通过 Composer 来安装 <code>predis/predis</code> 包（~1.0）。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Redis 在应用中的配置文件存储在 <code>config/database.php</code>。在这个文件中，你可以看到一个包含了 Redis 服务信息的 <code>redis</code> 数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="string">'redis'</span> =&gt; [</div><div class="line">  <span class="string">'cluster'</span> =&gt; <span class="keyword">false</span>,</div><div class="line"></div><div class="line">  <span class="string">'default'</span> =&gt; [</div><div class="line">    <span class="string">'host'</span> =&gt; <span class="string">'127.0.0.1'</span>,</div><div class="line">    <span class="string">'port'</span> =&gt; <span class="number">6379</span>,</div><div class="line">    <span class="string">'database'</span> =&gt; <span class="number">0</span>,</div><div class="line">  ],</div><div class="line">],</div></pre></td></tr></table></figure>
<p>对于开发来说，默认的配置已经完全可以满足大部分的应用了。但是，你可以自由的在你环境中修改这个配置。你可以简单的添加 Redis 服务的名称，并且指定相应的服务器地址和端口。</p>
<p><code>cluster</code> 选项会告诉 Laravel Redis 客户端在你的 Redis 集群中进行客户端的分片，这样就可以构成节点池并且创建大量有效的 RAM。但是，你需要注意的是客户端分片并不能处理故障转移。因此，它主要用来从一个主要数据存储地址获取可用的缓存数据。</p>
<p>另外，你可以在你的 Redis 连接定义里添加一个 <code>options</code> 数组，这样你可以指定 Predis 的 <a href="https://github.com/nrk/predis/wiki/Client-Options" target="_blank" rel="external">客户端选项</a>。</p>
<p>如果你的 Redis 服务器引入了认证机制，那么你需要在你的 Redis 服务配置数组中添加一个 <code>password</code> 配置项来提供密码。</p>
<blockquote>
<p>注意：如果你通过 PECL 来安装的 Redis PHP 扩展，那么你需要在 <code>config/app.php</code> 文件中对 Redis 的别名进行重命名。</p>
</blockquote>
<h2 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h2><p>你可以通过使用 <code>Redis</code> 假面的各种方法来与 Redis 进行交互。<code>Redis</code> 假面支持动态方法，这意味着你可以在 <code>Redis</code> 假面上调用任何的 Redis <a href="http://redis.io/commands" target="_blank" rel="external">命令</a>，假面会直接将命令传递给 Redis。比如，我们通过 <code>Redis</code> 假面的 <code>get</code> 方法来调用 <code>GET</code> 命令：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Redis</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controler</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Show the profile for the given user.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showProfile</span><span class="params">($id)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $user = Redis::get(<span class="string">'user:profile:'</span>. $id);</div><div class="line"></div><div class="line">     <span class="keyword">return</span> view(<span class="string">'user.profile'</span>, [<span class="string">'user'</span> =&gt; $user]);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，就如我们前面所提到的，你可以通过 <code>Redis</code> 假面调用任何的 Redis 命令。Laravel 使用魔术方法来将其传递到 Redis 服务器，所以，可以直接简单的传递命令所需的参数即可：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Redis::set(<span class="string">'name'</span>, <span class="string">'Taylor'</span>);</div><div class="line"></div><div class="line">$value = Redis::lrange(<span class="string">'names'</span>, <span class="number">5</span>, <span class="number">10</span>);</div></pre></td></tr></table></figure>
<p>另外，你也可以通过 <code>command</code> 方法来将命令传递到服务器，它接收第一个参数作为命令名称，第二个参数数组作为传递命令的参数值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$values = Redis::command(<span class="string">'lrange'</span>, [<span class="string">'name'</span>, <span class="number">5</span>, <span class="number">10</span>]);</div></pre></td></tr></table></figure>
<p><strong>使用多 Redis 连接</strong></p>
<p>你可以通过使用 <code>Redis::connection</code> 方法来获取 Redis 的实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$redis = Redis::connection();</div></pre></td></tr></table></figure>
<p>这会返回默认的 Redis 服务器的实例。如果你没有使用集群服务，你可以传递配置文件中所定义的服务名称到 <code>connection</code> 方法中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$redis = Redis::connection(<span class="string">'other'</span>);</div></pre></td></tr></table></figure>
<h3 id="流水线命令"><a href="#流水线命令" class="headerlink" title="流水线命令"></a>流水线命令</h3><p>管道流水线可以允许你在一个操作中对 Redis 服务器执行多个命令。<code>pipeline</code> 方法接收一个参数: <code>Closure</code> ，它会接收 Redis 的实例。你可以在闭包中发布所有的命令，它们将会在一个操作中进行处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Redis::pipeline(<span class="function"><span class="keyword">function</span> <span class="params">($pipe)</span> </span>&#123;</div><div class="line">  <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">1000</span>; $i++) &#123;</div><div class="line">    $pipe-&gt;set(<span class="string">"key:$i"</span>, $i);</div><div class="line">  &#125; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="发布、订阅"><a href="#发布、订阅" class="headerlink" title="发布、订阅"></a>发布、订阅</h2><p>Laravel 也对 Redis 的 <code>publish</code> 和 <code>subscribe</code> 命令提供了一种方便的接口。这些 Redis 命令允许你通过给定的频道来监听信息。你可以从其他应用中向频道中发布信息，更甚者你可以使用其它的语言来进行发布，你可以轻而易举的在应用 / 进程间进行通讯:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Console</span>\<span class="title">Commands</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Redis</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Command</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisSubscribe</span> <span class="keyword">extends</span> <span class="title">Command</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The name and signature of the console command.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> $signature = <span class="string">'redis:subscribe'</span>;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * The console command description.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">protected</span> $description = <span class="string">'Subscribe to a Redis channel'</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Execute the console command.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></div><div class="line"><span class="comment">     */</span></div><div class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">()</span></span></div><div class="line"><span class="function">     </span>&#123;</div><div class="line">       Redis::subscribe([<span class="string">'text-channel'</span>], <span class="function"><span class="keyword">function</span> <span class="params">($message)</span> </span>&#123;</div><div class="line">         <span class="keyword">echo</span> $message;</div><div class="line">       &#125;);</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在，你可以使用 <code>publish</code> 方法来向频道中发布信息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'publish'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">// Route logic...</span></div><div class="line"></div><div class="line">  Redis::publish(<span class="string">'test-channel'</span>, json_encode([<span class="string">'foo'</span> =&gt; <span class="string">'bar'</span>]));</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><strong>订阅通配符</strong></p>
<p>你可以使用 <code>psubscribe</code> 方法来订阅统配符匹配的频道，这通常用来捕获频道中的所有消息。<code>$channel</code> 变量会自动的传递到 <code>Closure</code> 的第二个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Redis::psubscribe([<span class="string">'*'</span>], <span class="function"><span class="keyword">function</span> <span class="params">($message, $channel)</span> </span>&#123;</div><div class="line">  <span class="keyword">echo</span> $message; </div><div class="line">&#125;);</div><div class="line"></div><div class="line">Redis::psubscribe([<span class="string">'users.*'</span>], <span class="function"><span class="keyword">function</span> <span class="params">($message, $channel)</span> </span>&#123;</div><div class="line">  <span class="keyword">echo</span> $message; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/10/laravel-from-scratch-queues/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/10/laravel-from-scratch-queues/" itemprop="url">laravel 基础教程 —— 队列</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-10T12:15:50+08:00">
                2016-06-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>laravel 的队列服务对各种不同的后台队列服务提供了统一的 API。队列允许你延迟执行消耗时间的任务，比如发送一封邮件。这样可以有效的降低请求响应的时间。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>队列的配置文件被存储在 <code>config/queue.php</code> 中。在这个文件中你会发现框架所支持的队列驱动的配置连接示例。这些驱动包括：数据库，<a href="http://kr.github.com/beanstalkd" target="_blank" rel="external">Beanstalkd</a>，<a href="http://aws.amazon.com/sqs" target="_blank" rel="external">Amazon SQS</a>，<a href="http://redis.io/" target="_blank" rel="external">Redis</a>，和一个同步（本地使用）的驱动。</p>
<p>还有一个名为 <code>null</code> 的驱动表明不使用队列任务。</p>
<h3 id="队列先决条件"><a href="#队列先决条件" class="headerlink" title="队列先决条件"></a>队列先决条件</h3><p><strong>数据库</strong></p>
<p>如果使用 <code>database</code> 队列驱动，你需要添加一个数据表来处理队列任务。你可以使用 <code>queue:table</code> Artisan 命令来生成一个迁移表。一旦该迁移表生成完成，你就可以使用 <code>migrate</code> 命令来迁移到数据库中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">php artisan queue:table</div><div class="line"></div><div class="line">php artisan migrate</div></pre></td></tr></table></figure>
<p><strong>其他队列依赖</strong></p>
<p>下面列出了其它队列驱动及其相应的依赖：</p>
<ul>
<li>Amazon SQS: <code>aws/aws-sdk-php ~3.0</code></li>
<li>Beanstalkd: <code>pda/pheanstalk ~3.0</code></li>
<li>Redis: <code>predis/predis ~1.0</code></li>
</ul>
<h2 id="编写任务类"><a href="#编写任务类" class="headerlink" title="编写任务类"></a>编写任务类</h2><h3 id="生成任务类"><a href="#生成任务类" class="headerlink" title="生成任务类"></a>生成任务类</h3><p>默认的，所有的可队列执行的任务都被存储在 <code>app/Jobs</code> 目录下，你可以通过 Artisan 命令来生成一个新的队列任务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan make:job SendReminderEmail</div></pre></td></tr></table></figure>
<p>该命令会在 <code>app/Jobs</code> 目录下生成一个新的类。该类会实现 <code>Illuminate\Contracts\Queue\ShouldQueue</code> 接口，该接口表明 laravel 应该将该任务添加到后台的任务队列中，而不是同步执行。</p>
<h3 id="任务类结构"><a href="#任务类结构" class="headerlink" title="任务类结构"></a>任务类结构</h3><p>任务类是十分简单的，通常它只包含一个 <code>handle</code> 方法来在队列任务执行时被调用。我们来看一个简单的任务示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Jobs</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Jobs</span>\<span class="title">Job</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Mail</span>\<span class="title">Mailer</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">SerializesModels</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">InteractsWithQueue</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Queus</span>\<span class="title">ShouldQueue</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendReminderEmail</span> <span class="keyword">extends</span> <span class="title">Job</span> <span class="keyword">implements</span> <span class="title">ShouldQueue</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">use</span> <span class="title">InteractsWithQueue</span>, <span class="title">SerializesModels</span>;</div><div class="line"></div><div class="line">  <span class="keyword">protected</span> $user;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Create a new job instance.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> User $user</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(User $user)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">$this</span>-&gt;user = $user;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Execute the job.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> Mailer $mailer</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(Mailer $mailer)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      $mailer-&gt;send(<span class="string">'emails.reminder'</span>, [<span class="string">'user'</span> =&gt; <span class="keyword">$this</span>-&gt;user], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//</span></div><div class="line">      &#125;);</div><div class="line"></div><div class="line">      <span class="keyword">$this</span>-&gt;user-&gt;reminders()-&gt;create(...);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这个例子中，你需要注意的是，我们可以直接的在队列任务的构造函数中传送一个 Eloquent 模型。因为我们引入了 <code>SerializesModels</code> trait，所以当队列任务执行时，Eloquent 模型会被优雅的序列化和反序列化。如果队列任务在构造器中接收了 Eloquent 模型，那么队列任务只会序列化模型的 ID。而在任务需要进行处理时，队列系统会从数据库中自动的根据 ID 检索出模型实例。这在应用中完全是透明的，这样就可以避免了序列化完整的模型可能在队列中出现的问题。</p>
<p><code>handle</code> 方法会在队列任务执行时进行调用。你需要知道的是，我们可以在任务的 <code>handle</code> 方法中可以使用类型提示来进行依赖的注入。laravel 的服务容器会自动的将这些依赖注入进去。</p>
<p><strong>有异常发生</strong></p>
<p>如果任务进行的过程中有异常被抛出。它会自动的将任务释放，同时追加到队列的尾端以使任务可以进行再次尝试。该任务会被持续释放进行尝试除非尝试的次数超出了所设置的最大次数。你可以在队列监听器 <code>queue:listen</code> 或者 <code>queue:work</code> Artisan 任务命令中添加 <code>--tries</code> 选项来设置最大可尝试次数。我们将在后续篇幅中详细的介绍队列监听器。</p>
<p><strong>手动的释放任务到队列尾端</strong></p>
<p>你可以使用 <code>release</code> 方法来进行手动的释放任务。laravel 命令生成的任务类中已经引入了 <code>InteractsWithQueue</code> trait，这个性状提供了访问任务队列的 <code>release</code> 方法。该方法接收一个参数：你希望任务再次可用的间隔（秒）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(Mailer $mailer)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">if</span> (condition) &#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;release(<span class="number">10</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>检查任务已尝试的次数</strong></p>
<p>就如上面我们所谈到的，如果在任务进行的过程中，异常出现，那么队列会自动的释放任务并将任务推送到队列的尾端使其可以进行再次尝试。你可以通过 <code>attempts</code> 方法来检查任务的释放次数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(Mailer $mailer)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;attempts() &gt; <span class="number">3</span>) &#123;</div><div class="line">    <span class="comment">//</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="推送任务到队列"><a href="#推送任务到队列" class="headerlink" title="推送任务到队列"></a>推送任务到队列</h2><p>位于 <code>app/Http/Controllers/Controller.php</code> 的 laravel 基础控制器使用了 <code>DispatchesJobs</code> trait。这个性状提供了一些方法允许你方便的推送任务到队列。比如 <code>dispatch</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Jobs</span>\<span class="title">SendReminderEmail</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Send a reminder e-mail to a given user.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> Request $request</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendReminderEmail</span><span class="params">(Request $request, $id)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $user = User::findOrFail($id);</div><div class="line"></div><div class="line">     <span class="keyword">$this</span>-&gt;dispatch(<span class="keyword">new</span> SendReminderEmail($user));</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>DispatchesJobs</code> 性状</strong></p>
<p>当然，有时候你可能希望在应用中的任何地方进行任务的分发，而不仅仅只在路由或者控制器中。出于这个原因，你可以使用 <code>DispatchesJobs</code> trait 到任何你需要在应用中调用分发任务的类中，这样你就可以在这个类中使用 <code>dispatch</code> 方法，下面给出一个简单的使用 trait 的示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Bus</span>\<span class="title">DispatchesJobs</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExampleClass</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">use</span> <span class="title">DispatchesJobs</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong><code>dispatch</code> 方法</strong></p>
<p>或者，你可以使用 <code>dispatch</code> 全局帮助方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'/job'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  dispatch(<span class="keyword">new</span> App\Jobs\PerformTask); </div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="string">'Done!'</span>;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>对任务指定队列</strong></p>
<p>你也可以指定任务需要被分配到的队列。</p>
<p>你可以对你的队列任务进行分类，来将任务推送到不同的队列中，你甚至是可以分配各种队列工作的优先权。这并不是推送任务到队列配置文件中所定义的不同的队列连接上，而是仅在单个连接中指定的队列进行的操作。你可以使用任务实例的 <code>onQueue</code> 方法来指定队列。<code>onQueue</code> 来自 <code>Illuminate\Bus\Queueable</code> trait，该性状已经被 <code>App\Jobs\Job</code> 基类所引入：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Jobs</span>\<span class="title">SendReminderEmail</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Send a reminder e-mail to a given user.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> Request $request</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendReminderEmail</span><span class="params">(Request $request, $id)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $user = User::findOrFail($id);</div><div class="line"></div><div class="line">    $job = (<span class="keyword">new</span> SendReminderEmail($user))-&gt;onQueue(<span class="string">'emails'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;dispatch($job);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="延迟任务"><a href="#延迟任务" class="headerlink" title="延迟任务"></a>延迟任务</h3><p>有时候，你可能会想要延迟执行队列任务。比如，你可能希望有一个队列任务可以在用户注册后的 5 分钟发送一封提醒邮件。你可以在任务类中使用 <code>delay</code> 方法来完成，该方法是通过 <code>Illuminate\Bus\Queueable</code> 性状提供的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Jobs</span>\<span class="title">SendReminderEmail</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Send a reminder e-mail to a given user.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> Request $request</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendReminderEmail</span><span class="params">(Request $request, $id)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $user = User::findOrFail($id);</div><div class="line"></div><div class="line">     $job = (<span class="keyword">new</span> SendReminderEamil($user))-&gt;delay(<span class="number">60</span> * <span class="number">5</span>);</div><div class="line"></div><div class="line">     <span class="keyword">$this</span>-&gt;dispatch($job);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这个例子中，我们指定了任务应该在队列中延迟 5 分钟执行。</p>
<blockquote>
<p>注意： Amazon SQS 服务有最大延迟执行限制，其最多可延迟 15 分钟。</p>
</blockquote>
<h2 id="任务事件"><a href="#任务事件" class="headerlink" title="任务事件"></a>任务事件</h2><p><strong>任务生命周期事件</strong></p>
<p>你可以使用 <code>Queue::before</code> 和 <code>Queue::after</code> 方法来注册一个回调在队列任务开始之前或者队列执行成功之后调用。回调为添加额外的日志，持续执行子任务或者增加统计信息等提供了非常好的机会。比如，我们可以在 laravel 的 <code>AppServiceProvider</code> 中定义一个任务成功执行后的事件监听，并附加一个回调到事件中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Queue</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">Events</span>\<span class="title">JobProcessed</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Bootstrap any application services.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     Queue::after(<span class="function"><span class="keyword">function</span> <span class="params">(JobProcessed $event)</span> </span>&#123;</div><div class="line">       <span class="comment">// $event-&gt;connectionName</span></div><div class="line">       <span class="comment">// $event-&gt;job</span></div><div class="line">       <span class="comment">// $event-&gt;data</span></div><div class="line">     &#125;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Register the service provider.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="comment">//</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="运行队列监听器"><a href="#运行队列监听器" class="headerlink" title="运行队列监听器"></a>运行队列监听器</h2><p><strong>开始进行队列监听</strong></p>
<p>laravel 包含了一个 Artisan 命令来运行推送到队列中的任务的执行。你可以使用 <code>queue:listen</code> 命令来运行监听器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan queue:listen</div></pre></td></tr></table></figure>
<p>你也可以指定监听哪一个连接的队列：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan queue:listen connection-name</div></pre></td></tr></table></figure>
<p>你需要注意的是，这个命令执行，它会持续的运行，除非你手动的进行停止。你可以通过使用 <a href="http://supervisord.org/" target="_blank" rel="external">Supervisor</a> 进程监控来确保队列监听器的运行。</p>
<p><strong>队列优先级</strong></p>
<p>你可以通过使用 <code>,</code> 来分割连接的队列，以确定队列的运行优先级：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan queue:listen --queue=high,low</div></pre></td></tr></table></figure>
<p>在这个例子中，任务会优先执行 <code>high</code> 的队列，然后才会运行 <code>low</code> 队列中的任务。</p>
<p><strong>指定任务的超时时间</strong></p>
<p>你可以设置任务的超时时间：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan queue:listen --timeout=<span class="number">60</span></div></pre></td></tr></table></figure>
<p><strong>指定队列的睡眠时间</strong></p>
<p>另外，你可以指定队列轮询新的任务需要等待的时间（秒）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan queue:listen --sleep=<span class="number">5</span></div></pre></td></tr></table></figure>
<p>你需要注意的是，队列只会在队列中没有需要执行的任务时才会进行睡眠。如果队列中有多个可执行的任务，那么队列会持续的进行任务的执行，而不会进行睡眠操作。</p>
<p><strong>执行队列的首个任务</strong></p>
<p>你可以使用 <code>queue:work</code> 命令来只执行队列的首个任务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan queue:work</div></pre></td></tr></table></figure>
<h3 id="Supervisor-配置"><a href="#Supervisor-配置" class="headerlink" title="Supervisor 配置"></a>Supervisor 配置</h3><p>Supervisor 是 Linux 操作系统的一个进程监控器，并且它可以自动的在 <code>queue:listen</code> 或者 <code>queue:work</code> 命令失败时进行重启。你可以使用下面的命令在 Ubuntu 中安装 Supervisor:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install supervisor</div></pre></td></tr></table></figure>
<p>Supervisor 配置文件通常都存储在 <code>/etc/supervisor/conf.d</code> 目录中。在这个目录中，你可以创建任意数量的配置文件来指导 supervisor 来管理监控进程。比如，让我们创建一个 <code>laravel-worker.conf</code> 文件来开始和监控 <code>queue:work</code> 进程：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[program:laravel-worker]</div><div class="line">process_name=%(program_name)s_%(process_num)<span class="number">02</span>d</div><div class="line">command= php /home/forge/app.com/artisan queue:work sqs --sleep=<span class="number">3</span> --tries=<span class="number">3</span> --daemon</div><div class="line">autostart=<span class="keyword">true</span></div><div class="line">autorestart=<span class="keyword">true</span></div><div class="line">user=forge</div><div class="line">numprocs=<span class="number">8</span></div><div class="line">redirect_stderr=<span class="keyword">true</span></div><div class="line">stdout_logfile=/home/forge/app.com/worker.log</div></pre></td></tr></table></figure>
<p>上面的例子中，<code>numprocs</code> 会指导 Supervisor 运行 8 个 <code>queue:work</code> 进程并且对其进行监控，它会自动的在其失败时进行重启。当然，你可以修改命令的 <code>queue:work sqs</code> 部分来使用你所期望的队列驱动。</p>
<p>一旦配置文件创建完成，你可以使用下面的命令来更新 Supervisor 的配置文件和启动进程：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo supervisorctl reread</div><div class="line"></div><div class="line">sudo supervisorctl update</div><div class="line"></div><div class="line">sudo supervisorctl start laravel-worker:*</div></pre></td></tr></table></figure>
<p>关于更多的 Supervisor 的配置信息，请参考 <a href="http://supervisord.org/index.html" target="_blank" rel="external">Supervisor documentation</a>。另外，你也可以使用 <a href="https://forge.laravel.com/" target="_blank" rel="external">Laravel Forge</a> 来从一个方便的 Web 界面自动的配置和管理你的 Supervisor 配置。</p>
<h3 id="队列监控器守护进程"><a href="#队列监控器守护进程" class="headerlink" title="队列监控器守护进程"></a>队列监控器守护进程</h3><p><code>queue:work</code> Artisan 命令包含了一个 <code>--daemon</code> 选项来强迫队列工作持续的执行任务而不重新引导框架。这相比较 <code>queue:lsten</code> 命令来说会显著的减少 CPU 的消耗：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">php artisan queue:work connection-name --daemon</div><div class="line"></div><div class="line">php artisan queue:work connection-name --daemon --sleep=<span class="number">3</span></div><div class="line"></div><div class="line">php artisan queue:work connection-name --daemon --sleep=<span class="number">3</span> --tries=<span class="number">3</span></div></pre></td></tr></table></figure>
<p>就如你所看到的，<code>queue:work</code> 任务支持和 <code>queue:listen</code> 差不多的选项。你可以通过使用 <code>php artisan help queue:work</code> 命令来显示可用选项。</p>
<p><strong>对于守护进程的编码注意事项</strong></p>
<p>队列任务的守护进程不会在每个任务执行之前重新引导框架，所以，你应该注意在你的任务完成时清除一些比较重的资源消耗。比如，如果你使用 GD 类库来处理图片，你应该在任务执行完成后使用 <code>imagedestroy</code> 来将其从内存中进行释放。</p>
<h3 id="部署具有守护进程的队列监听器"><a href="#部署具有守护进程的队列监听器" class="headerlink" title="部署具有守护进程的队列监听器"></a>部署具有守护进程的队列监听器</h3><p>因为队列工作的守护进程是一个常驻进程。它不会再你的代码改变时进行重启。所以，你应该使用部署脚本来在代码变更时重新部署使用守护进程的队列工作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan queue:restart</div></pre></td></tr></table></figure>
<p>该命令会优雅的指导队列完成当前的任务后死亡，所以不会存在任务的遗漏。你应该注意的是，当你执行 <code>queue:restart</code> 命令时，队列工作就会死亡，所以你应该使用一种进程管理器，比如 Supervisor，你可以配置它来自动的重启队列工作。</p>
<blockquote>
<p>注意：该命令依赖于缓存系统来制定重启时间表。默认的 APCu 不支持在 CLI 中运行任务。如果你使用 APCu，你应该添加 <code>apc.enable_cli=1</code> 到你的 APCu 配置中。</p>
</blockquote>
<h2 id="与失败的任务进行交互"><a href="#与失败的任务进行交互" class="headerlink" title="与失败的任务进行交互"></a>与失败的任务进行交互</h2><p>由于很多事情并不能如计划中的那样进行，有时候队列任务的执行可能会失败，不要担心，它发生对我们来说是最好的！laravel 包含了一种便捷的方式来指定任务应该重复尝试的次数。如果任务被重复执行到指定的次数，它就会被记录到 <code>failed_jobs</code> 表中。这个表的名字你可以通过 <code>config/queue.php</code> 配置文件进行定制。</p>
<p>你可以使用 <code>queue:failed-table</code> 命令来生成一个 <code>failed_jobs</code> 迁移表：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan queue:failed-table</div></pre></td></tr></table></figure>
<p>当你运行队列监听器时，你可以使用 <code>--tries</code> 选项来指定任务的最大尝试次数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan queue:listen connection-name --tries=<span class="number">3</span></div></pre></td></tr></table></figure>
<h3 id="失败任务事件"><a href="#失败任务事件" class="headerlink" title="失败任务事件"></a>失败任务事件</h3><p>如果你希望在队列任务失败时执行某些操作，你可以使用 <code>Queue::failing</code> 方法来注册一个监听事件。这个事件对通过 email 或者 <a href="https://www.hipchat.com/" target="_blank" rel="external">HipChat</a> 通知你的团队提供了一个很好的机会。比如，你可以在 <code>AppServiceProvider</code> 在事件中附加一个回调：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Queue</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">Events</span>\<span class="title">JobFailed</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Bootstrap any application service.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     Queue::failing(<span class="function"><span class="keyword">function</span> <span class="params">(JobFailed $event)</span> </span>&#123;</div><div class="line">       <span class="comment">// $event-connectionName</span></div><div class="line">       <span class="comment">// $event-&gt;job</span></div><div class="line">       <span class="comment">// $event-data</span></div><div class="line">     &#125;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Register the service provider.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="comment">//</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>任务类中的失败方法</strong></p>
<p>你可以在任务类中定义一个 <code>failed</code> 方法来进行更为精细的控制，这允许你在任务出现失败时来执行一些指定的动作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Jobs</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Jobs</span>\<span class="title">Job</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Mail</span>\<span class="title">Mailer</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">SerializesModels</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">InteractsWithQueue</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Queue</span>\<span class="title">ShouldQueue</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendReminderEmail</span> <span class="keyword">extends</span> <span class="title">Job</span> <span class="keyword">implements</span> <span class="title">ShouldQueue</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">use</span> <span class="title">InteractsWithQueue</span>, <span class="title">SerializesModels</span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Execute the job.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> Mailer $mailer</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(Mailer $mailer)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="comment">//</span></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Handle a job failure.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">failed</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="comment">// Called when the job is failing...</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="重新执行失败的任务"><a href="#重新执行失败的任务" class="headerlink" title="重新执行失败的任务"></a>重新执行失败的任务</h3><p>你可以使用 <code>queue:failed</code> Artisan 命令来显示数据库 <code>failed_jobs</code> 表中失败的任务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan queue:failed</div></pre></td></tr></table></figure>
<p><code>queue:failed</code> 命令会列出任务的 ID，连接，队列，和失败时间。任务 ID 可以用来进行失败任务的尝试。比如，你可以尝试重新执行 ID 为 5 的任务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan queue:retry <span class="number">5</span></div></pre></td></tr></table></figure>
<p>你可以使用 <code>queue:retry all</code> 命令来重启所有的任务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan queue:retry all</div></pre></td></tr></table></figure>
<p>如果你希望删除失败的任务，你可以使用 <code>queue:forget</code> 命令：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan queue:forget <span class="number">5</span></div></pre></td></tr></table></figure>
<p>你可以使用 <code>queue:flush</code> 命令来清除所有失败的任务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan queue:flush</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/10/laravel-from-scratch-pagination/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/10/laravel-from-scratch-pagination/" itemprop="url">laravel 基础教程 —— 分页</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-10T09:25:56+08:00">
                2016-06-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在其他框架中，分页通常是比较痛苦的。laravel 使其变的非常简单。laravel 可以根据当前页面快速的生成智能的范围链接，并且其生成的 HTML 是兼容 <a href="http://getbootstrap.com/" target="_blank" rel="external">Bootstrap CSS framework</a> 的。</p>
<h2 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h2><h3 id="对查询构建器结果进行分页"><a href="#对查询构建器结果进行分页" class="headerlink" title="对查询构建器结果进行分页"></a>对查询构建器结果进行分页</h3><p>这里有几种方式来对元素进行分页。而最简单的方式就是通过使用查询构造器或者 Eloquent 查询的 <code>paginate</code> 方法。<code>paginate</code> 方法会根据当前用户所访问的当前页面来自动的设置正确的位移和显示的范围。默认的，当前页面是通过 HTTP 请求的查询字符串 <code>?page</code> 来自动获取的。当然，laravel 会自动的检测到这个值，并且会自动的在生成的分页器的链接中插入合适的值。</p>
<p>首先，让我们来看一下在查询中调用 <code>paginate</code> 方法。在这个例子中，你仅需要在 <code>paginate</code> 方法中传递每页所需要展示的数量。让我们来设置每页展示的数量为 <code>15</code> :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">DB</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Show all of the users for the application.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $users = DB::table(<span class="string">'users'</span>)-&gt;paginate(<span class="number">15</span>);</div><div class="line"></div><div class="line">     <span class="keyword">return</span> view(<span class="string">'user.index'</span>, [<span class="string">'users'</span> =&gt; $users]);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：目前，laravel 中使用 <code>groupBy</code> 语法不能正确的进行分页操作。如果你需要使用 <code>groupBy</code> 来对结果进行分页，推荐你手动的执行查询和进行分页。</p>
</blockquote>
<p><strong>简单的分页</strong></p>
<p>如果你只需要简单的显示“上一页”和“下一页”链接，你可以选择使用 <code>simplePaginate</code> 方法来执行一个有效的查询。这对于一些大型的数据库在视图中不需要显示每一页的链接时非常有效：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$user = DB::table(<span class="string">'users'</span>)-&gt;simplePaginate(<span class="number">15</span>);</div></pre></td></tr></table></figure>
<p><strong>对 Eloquent 结果进行分页</strong></p>
<p>你也可以对 Eloquent 查询的结果进行分页。我们来对 <code>User</code> 模型以每页显示 15 项的方式来进行分页。其语法和使用查询构造器进行分页非常像：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$users = App\User::paginate(<span class="number">15</span>);</div></pre></td></tr></table></figure>
<p>当然，你也可以优先进行其他查询之后再进行分页操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$users = User::where(<span class="string">'votes'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>)-&gt;paginate(<span class="number">15</span>);</div></pre></td></tr></table></figure>
<p>你同样也可以在 Eloquent 模型分页时使用 <code>simplePaginate</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$user = User::where(<span class="string">'votes'</span>, <span class="string">'&gt;'</span>, <span class="number">100</span>)-&gt;simplePaginate(<span class="number">15</span>);</div></pre></td></tr></table></figure>
<h3 id="手动的创建分页器"><a href="#手动的创建分页器" class="headerlink" title="手动的创建分页器"></a>手动的创建分页器</h3><p>有时候你可能需要手动的创建一个分页实例，它传递项目的数组。你可以创建 <code>Illuminate\Pagination\Paginator</code> 或者 <code>Illuminate\Pagination\LengthAwarePaginator</code> 实例，这取决于你的需求。</p>
<p><code>Paginator</code> 类不需要知道结果中项目的总数量。事实上，正是因为这样，这个类并没有提供获取最后一页的方法。<code>LengthAwarePaginator</code> 类似于 <code>Paginator</code> 接收几乎同样的参数。但是，它需要在结果中包含项目的总数目。</p>
<p>另一方面，<code>Paginator</code> 对应查询构造器和 Eloquent 中的 <code>simplePaginate</code> 方法。而 <code>LengthAwarePaginator</code> 对应 <code>paginate</code> 方法。</p>
<p>当手动的创建分页器实例时，你应该手动的对传递到分页器中的结果进行切片操作，如果你并不明白如何去进行分片，请查看 PHP 的 <a href="http://php.net/manual/en/function.array-slice.php" target="_blank" rel="external">array_slice</a> 方法。</p>
<h2 id="在视图中显示结果"><a href="#在视图中显示结果" class="headerlink" title="在视图中显示结果"></a>在视图中显示结果</h2><p>当你对查询构造器或者 Eloquent 查询使用 <code>paginate</code> 或者 <code>simplePaginate</code> 方法时，你可以获取到分页器的实例。当调用 <code>paginate</code> 方法时，你会获取到一个 <code>Illuminate\Pagination\LengthAwarePaginator</code> 实例，当调用 <code>simplePaginate</code> 方法时，你会获得一个 <code>Illuminate\Pagination\Paginator</code> 的实例。这些对象会提供多种方法来描述结果集。除了这些帮助方法，分页器本身也是一个迭代器，它可以像数组一样被循环操作。</p>
<p>所以，一旦你获取到了分页结果，你可以像这样在 Blade 视图中来显示和生成分页链接：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;div class="container"&gt;</div><div class="line">  @<span class="keyword">foreach</span> ($users <span class="keyword">as</span> $user)</div><div class="line">    &#123;&#123; $user-&gt;name &#125;&#125;</div><div class="line">  @<span class="keyword">endforeach</span></div><div class="line">&lt;/div&gt;</div><div class="line"></div><div class="line">&#123;&#123; $users-&gt;links() &#125;&#125;</div></pre></td></tr></table></figure>
<p><code>links</code> 方法会根据结果集来生成分页结果。对每一个链接都会自动包含 <code>?page</code> 查询变量。使用 <code>links</code> 方法生成的 HTML 是兼容 Bootstrap CSS 框架的。</p>
<p><strong>自定义分页器 URL</strong></p>
<p><code>setPath</code> 方法允许你对分页器生成的链接的 URI 进行定制化。比如，你希望分页器生成类似于 <code>http://example.com/custom/url?page=N</code>，你可以传递 <code>custom/url</code> 到 <code>setPath</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  $users = App\User::paginate(<span class="number">15</span>);</div><div class="line"></div><div class="line">  $users-&gt;setPath(<span class="string">'custom/url'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>追加查询字符串到分页器链接</strong></p>
<p>你可以通过使用 <code>appends</code> 方法来添加查询字符串到分页器链接中。比如，在分页器链接中追加 <code>&amp;sort=votes</code> 查询字符串。你可以像下面一样调用 <code>appends</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; $users-&gt;appends([<span class="string">'sort'</span> =&gt; <span class="string">'votes'</span>])-&gt;links() &#125;&#125;</div></pre></td></tr></table></figure>
<p>如果你需要在分页器的 URLs 中添加一个 hash 分段，你可以使用 <code>fragment</code> 方法。比如，在分页链接中添加 <code>#foo</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; $users-&gt;fragment(<span class="string">'foo'</span>)-&gt;links() &#125;&#125;</div></pre></td></tr></table></figure>
<p><strong>其他帮助方法</strong></p>
<p>你可以调用分页器实例的下面的方法来访问额外的分页器信息：</p>
<ul>
<li><code>$results-&gt;count()</code></li>
<li><code>$results-&gt;currentPage()</code></li>
<li><code>$results-&gt;firstItem()</code></li>
<li><code>$results-&gt;hasMorePages()</code></li>
<li><code>$results-&gt;lastItem() (Not avaliable when using simplePaginate)</code></li>
<li><code>$results-&gt;nextPageUrl()</code></li>
<li><code>$results-&gt;perPage()</code></li>
<li><code>$results-&gt;previousPageUrl()</code></li>
<li><code>$results-&gt;total() (Not available when using simplePaginate)</code></li>
<li><code>$results-&gt;url($page)</code></li>
</ul>
<h2 id="转换结果为-JSON"><a href="#转换结果为-JSON" class="headerlink" title="转换结果为 JSON"></a>转换结果为 JSON</h2><p>laravel 的分页器类实现了 <code>Illuminate\Contracts\Support\JsonableInterface</code> 契约并且暴露了 <code>toJson</code> 方法，所以它可以非常简单的将分页结果转换为 JSON 格式。</p>
<p>你也可以在路由或者控制器动作中简单的返回分页器实例来进行 JSON 格式的响应：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> App\User::paginate(); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>分页器的 JSON 信息会包含许多的元数据，比如 <code>total</code>，<code>current_page</code>，<code>last_page</code> 等等。而实际的结果对象集会保存在 JSON 数组的 <code>data</code> 键中。下面是一个从路由中返回分页器实例的响应示例：</p>
<p><strong>分页器 JSON 示例</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">   <span class="string">"total"</span>: <span class="number">50</span>,</div><div class="line">   <span class="string">"per_page"</span>: <span class="number">15</span>,</div><div class="line">   <span class="string">"current_page"</span>: <span class="number">1</span>,</div><div class="line">   <span class="string">"last_page"</span>: <span class="number">4</span>,</div><div class="line">   <span class="string">"next_page_url"</span>: <span class="string">"http://laravel.app?page=2"</span>,</div><div class="line">   <span class="string">"prev_page_url"</span>: <span class="keyword">null</span>,</div><div class="line">   <span class="string">"from"</span>: <span class="number">1</span>,</div><div class="line">   <span class="string">"to"</span>: <span class="number">15</span>,</div><div class="line">   <span class="string">"data"</span>:[</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// Result Object</span></div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// Result Object</span></div><div class="line">        &#125;</div><div class="line">   ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/08/laravel-from-scratch-packages/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/08/laravel-from-scratch-packages/" itemprop="url">laravel 基础教程 —— 包开发</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-08T21:46:33+08:00">
                2016-06-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="包开发"><a href="#包开发" class="headerlink" title="包开发"></a>包开发</h1><p>包是在 laravel 中添加功能的主要方式。包可以是任何形式，比如处理日期的 <a href="https://github.com/briannesbitt/Carbon" target="_blank" rel="external">Carbon</a> 或者是整个 BDD 测试框架 <a href="https://github.com/Behat/Behat" target="_blank" rel="external">Behat</a>。</p>
<p>当然，包是有不同类型的。有些包是独立的包。意味着它可以在任何框架中使用，而不仅仅是在 laravel 中。Carbon 和 Behat 就是独立的包。这些包你可以简单的通过在 <code>composer.json</code> 文件中进行引入安装使用。</p>
<p>而在另一方面，有些包是专门用于 laravel 使用的。这些包可能拥有路由，控制器，视图和配置文件，他们配合起来旨在提高 laravel 的功能。这篇指南就是来告诉你如何开发增强 laravel 功能的包。</p>
<h2 id="服务提供者"><a href="#服务提供者" class="headerlink" title="服务提供者"></a>服务提供者</h2><p>服务提供者是 laravel 和包的连接点。服务提供者主要负责包内容在服务容器中的绑定以及应用应该如何加载资源文件如视图，配置文件和语言文件。</p>
<p>一个服务提供者应该继承 <code>Illuminate\Support\ServiceProvider</code> 类并且包含两个方法： <code>register</code> 和 <code>boot</code>。基类 <code>ServiceProvider</code> 类位于 Composer 包的 <code>illuminate/support</code> 中。你应该在你的包中添加这个依赖。</p>
<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p>你可以在你的服务提供者的 <code>boot</code> 方法中简单的 <code>require</code> 路由文件来定义包的路由。在你的路由文件中，你可以使用 <code>Route</code> 假面来注册路由，其方式就如普通的 laravel 应用一样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Perform post-registration booting of services.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;app-&gt;routesAreCached()&#123;</div><div class="line">     requir <span class="keyword">__DIR__</span>.<span class="string">'/../../routes.php'</span>;</div><div class="line">   &#125;)</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><p>你需要告诉 laravel 视图的位置才能使 laravel 加载包中的视图。你可以通过服务提供者的 <code>loadViewsFrom</code> 方法。<code>loadViewsFrom</code> 方法接受两个参数：视图的路径和包的名称。比如，如果你的包名称是“courier”，你应该像下面一样在 <code>boot</code> 中添加：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Perform post-registration booting of services.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">$this</span>-&gt;loadViewsFrom(<span class="keyword">__DIR__</span>.<span class="string">'/path/to/views'</span>, <span class="string">'courier'</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>包视图的使用方式是通过 <code>package::view</code> 类似的语法引用的。所以，你可以像这样从 <code>courier</code> 包中引入 <code>admin</code> 视图：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'admin'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> view(<span class="string">'courier::admin'</span>); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>覆盖包视图</strong></p>
<p>当你使用 <code>loadViewsFrom</code> 方法来加载视图时，laravel 实际上是注册了两个视图位置：一个是应用的 <code>resources/views/vendor</code> 目录，另一个是你指定的目录。所以，我们还使用上面的例子：当请求引入包视图时，laravel 会首先检查 <code>resources/views/vendor/courier</code> 目录中是否有相应的视图，然后，如果没有才会通过 <code>loadViewFrom</code> 方法来加载指定的目录下的视图。这就引入了一种自定义包视图的简便方式。</p>
<p><strong>发布视图</strong></p>
<p>如果你希望有一种简单的方式将包的视图发布到 <code>resources/views/vendor</code> 目录。你可以在服务提供者中使用 <code>publishes</code> 方法。<code>publishes</code> 方法接收一个包视图路径和其发布地址路径所组成的数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Perform post-registration booting of services.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">$this</span>-&gt;loadViewsFrom(<span class="keyword">__DIR__</span>.<span class="string">'/path/to/views'</span>, <span class="string">'courier'</span>);</div><div class="line"></div><div class="line">   <span class="keyword">$this</span>-&gt;publishes([</div><div class="line">     <span class="keyword">__DIR__</span>./path/to/views<span class="string">' =&gt; resource_path('</span>views/vendor/courier<span class="string">'),</span></div><div class="line"><span class="string">   ]);</span></div><div class="line"><span class="string"> &#125;</span></div></pre></td></tr></table></figure>
<p>现在，当你通过命令行工具使用 <code>vendor:publish</code> Artisan 命令时，你的包视图会被复制到其所指定的位置。</p>
<h3 id="译文"><a href="#译文" class="headerlink" title="译文"></a>译文</h3><p>如果你的包中包含了翻译文件。你可以使用 <code>loadTranslationsFrom</code> 方法来指导 laravel 如何载入它们。比如，如果你的包名称为 ‘courier’，你应该使用如下的方式在你的服务提供者的 <code>boot</code> 方法中添加：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">* Perform post-registration booting of services</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">$this</span>-&gt;loadTranslationsFrom(<span class="keyword">__DIR__</span>./path/to/translations<span class="string">', '</span>courier<span class="string">');</span></div><div class="line"><span class="string">&#125;</span></div></pre></td></tr></table></figure>
<p>包译文的引入使用 <code>package::filer.line</code> 类似的语法。所以，你可以像这样来加载 <code>courier</code> 包中的 <code>messages</code> 文件的 <code>welcome</code> 键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> trans(<span class="string">'courier::messages.welcome'</span>);</div></pre></td></tr></table></figure>
<p><strong>发布译文</strong></p>
<p>如果你希望发布包的译文到应用的 <code>resources/lang/vendor</code> 目录，你可以使用服务提供者的 <code>publishes</code> 方法。<code>publishes</code> 方法接收一个包含包路径和其相应的发布路径所组成的数组。比如，发布 <code>courier</code> 包中的译文：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Perform post-registration booting of services.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">$this</span>-&gt;loadTranslationsFrom(<span class="keyword">__DIR__</span>.<span class="string">'/path/to/translations'</span>, <span class="string">'courier'</span>);</div><div class="line"></div><div class="line">   <span class="keyword">$this</span>-&gt;publishes([</div><div class="line">     <span class="keyword">__DIR__</span>.<span class="string">'/path/to/translations'</span> =&gt; resource_path(<span class="string">'lang/vendor/courier'</span>)</div><div class="line">   ]);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>现在，当你通过命令行工具使用 <code>vendor:publish</code> Artisan 命令时，包中的译文会自动的发布到指定的位置。</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>通常，你希望发布你的包配置文件到应用的 <code>config</code> 目录。这样就允许用户通过简单的配置来覆盖默认的配置选项。你可以使用 <code>publishes</code> 方法来发布配置文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Perform post-registration booting of services.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">$this</span>-&gt;publishes([</div><div class="line">     <span class="keyword">__DIR__</span>.<span class="string">'/path/to/config/courier.php'</span> =&gt; config_path(<span class="string">'courier.php'</span>),</div><div class="line">   ]);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>现在当使用你包的用户使用 laravel 的 <code>vendor:push</code> 命令时，你的配置文件将会复制到指定的位置。当然，一旦你的配置文件被发布到 <code>config</code> 目录，它就可以像访问其他配置文件一样被访问：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$value = config(<span class="string">'courier.option'</span>);</div></pre></td></tr></table></figure>
<p><strong>默认的包配置</strong></p>
<p>你也可以选择合并包的默认配置和应用复制的配置。这样就允许用户只引入其真实需要变更的配置选项。你可以使用 <code>mergeConfigFrom</code> 方法来在你的服务提供者的 <code>register</code> 方法中进行合并：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Register bindingsin the container.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">$this</span>-&gt;mergeConfigFrom(</div><div class="line">     <span class="keyword">__DIR__</span>.<span class="string">'/path/to/config/courier.php'</span>, <span class="string">'courier'</span></div><div class="line">   );</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="公共资源文件"><a href="#公共资源文件" class="headerlink" title="公共资源文件"></a>公共资源文件</h2><p>你的包文件中可能含有一些资源文件比如 JavaScript，CSS，图片。你同样可以在你的服务提供者中使用 <code>publishes</code> 方法来发布这些资源到应用的 <code>public</code> 目录。我们同样可以添加一个 <code>public</code> 组标签，这样可以选择在发布时只发布 <code>public</code> 标签组的文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Perform post-registration booting of services.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">$this</span>-&gt;published([</div><div class="line">     <span class="keyword">__DIR__</span>.<span class="string">'/path/to/assets'</span> =&gt; public_path(<span class="string">'vendor/courier'</span>),</div><div class="line">   ], <span class="string">'public'</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>现在，使用你的包的用户在执行 <code>vendor:publish</code> 命令时，你的资源文件会被发布到指定的位置。如果你需要每次发布资源时覆盖之前发布的内容，你可以使用 <code>--force</code> 标识：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan vendor:publish --tag=<span class="keyword">public</span> --force</div></pre></td></tr></table></figure>
<p>如果你希望你的公共资源总是在发布时是最新的版本，你应该在你的 <code>composer.json</code> 文件中的 <code>post-update-cmd</code> 列中添加上述命令。</p>
<h2 id="发布组文件"><a href="#发布组文件" class="headerlink" title="发布组文件"></a>发布组文件</h2><p>你可能希望将前端资源和后端资源进行分组分开发布。比如，你可能希望用户在发布配置文件的同时并不重新发布更新公共资源文件。你可以通过在使用 <code>publishes</code> 方法时对发布项打标签的方式来对发布进行分组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * perform post-registration booting of services.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">$this</span>-&gt;publishes([</div><div class="line">     <span class="keyword">__DIR__</span>.<span class="string">'/../config/package.php'</span> =&gt; config_path(<span class="string">'package.php'</span>)</div><div class="line">   ], <span class="string">'config'</span>);</div><div class="line"></div><div class="line">   <span class="keyword">$this</span>-&gt;publishes([</div><div class="line">     <span class="keyword">__DIR__</span>.<span class="string">'/../database/migrations/'</span> =&gt; database_path(<span class="string">'migrations'</span>)</div><div class="line">   ], <span class="string">'migrations'</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>现在，你的包用户可以在发布文件时通过组标签来分开发布了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan vendor:publish --provider=<span class="string">"Vendor\Providers\PackageServiceProvider"</span></div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/08/laravel-from-scratch-mail/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/08/laravel-from-scratch-mail/" itemprop="url">laravel 基础教程 —— 邮件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-08T18:24:27+08:00">
                2016-06-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="邮件"><a href="#邮件" class="headerlink" title="邮件"></a>邮件</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>laravel 基于流行的 <a href="http://swiftmailer.org/" target="_blank" rel="external">SwiftMailer</a> 类库构建了一种干净简洁的邮件 API。laravel 提供了驱动以支持 SMTP，Mandrill，SparkPost，Amazon SES，PHP 的 <code>mail</code> 方法和 <code>sendmail</code> 方法，这允许你快速的开始构建通过本地或云服务发送邮件的功能。</p>
<h3 id="驱动先决条件"><a href="#驱动先决条件" class="headerlink" title="驱动先决条件"></a>驱动先决条件</h3><p>基于 API 的驱动程序如 Mailgun 和 Mandrill 通常要比 SMTP 服务简单快速。所有的 API 驱动都必须引入 Guzzle HTTP 类库，你可以通过在 <code>composer.json</code> 文件中添加下面的内容来进行安装：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"guzzlehttp/guzzle"</span>: <span class="string">"~5.3|~6.0"</span></div></pre></td></tr></table></figure>
<p><strong>Mailgun 驱动</strong></p>
<p>如果使用 Mailgun 驱动，你首先需要安装 Guzzle，然后设置 <code>config/mail.php</code> 配置文件的 <code>driver</code> 选项为 <code>mailgun</code>。然后，你需要确认你的 <code>config/services.php</code> 配置文件中包含以下选项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="string">'mailgun'</span> =&gt; [</div><div class="line">  <span class="string">'domain'</span> =&gt; <span class="string">'your-mailgun-domain'</span>,</div><div class="line">  <span class="string">'secret'</span> =&gt; <span class="string">'your-mailgun-key'</span>,</div><div class="line">],</div></pre></td></tr></table></figure>
<p><strong>Mandrill 驱动</strong></p>
<p>如果使用 Mandrill 驱动，你首先需要安装 Guzzle，然后设置 <code>config/mail.php</code> 配置文件的 <code>driver</code> 选项为 <code>mandrill</code>。接着，你需要确认你的 <code>config/services.php</code> 配置文件中包含以下选项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">'mandrill'</span> =&gt; [</div><div class="line">  <span class="string">'secret'</span> =&gt; <span class="string">'your-mandrill-key'</span>,</div><div class="line">],</div></pre></td></tr></table></figure>
<p><strong>SparkPost 驱动</strong></p>
<p>如果使用 SparkPost 驱动，你首先需要安装 Guzzle，然后设置你的 <code>config/mail.php</code> 配置文件中的 <code>driver</code> 选项为 <code>sparkpost</code>。接着，你需要确认你的 <code>config/services.php</code> 配置文件中包含以下选项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">'sparkpost'</span> =&gt; [</div><div class="line">  <span class="string">'secret'</span> =&gt; <span class="string">'your-sparkpost-key'</span>,</div><div class="line">],</div></pre></td></tr></table></figure>
<p><strong>SES 驱动</strong></p>
<p>如果使用 Amazon SES 驱动，你需要在 PHP 中引入 Amazon AWS SDK。你可以通过在 <code>composer.json</code> 文件中进行引入安装：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"aws/aws-sdk-php"</span>: <span class="string">"~3.0"</span></div></pre></td></tr></table></figure>
<p>然后设置你的 <code>config/mail.php</code> 配置文件的 <code>driver</code> 选项为 <code>ses</code>。接着，你需要确认你的 <code>config/services.php</code> 配置文件中包含以下选项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">'ses'</span> =&gt; [</div><div class="line">  <span class="string">'key'</span> =&gt; <span class="string">'your-ses-key'</span>,</div><div class="line">  <span class="string">'secret'</span> =&gt; <span class="string">'your-ses-secret'</span>,</div><div class="line">  <span class="string">'region'</span> =&gt; <span class="string">'ses-region'</span>, <span class="comment">//e.g. us-east-1</span></div><div class="line">],</div></pre></td></tr></table></figure>
<h2 id="发送邮件"><a href="#发送邮件" class="headerlink" title="发送邮件"></a>发送邮件</h2><p>laravel 允许你使用视图来存储你的邮件信息。比如，你可以在 <code>resources/views</code> 目录下创建一个 <code>emails</code> 目录来管理你的邮件视图：</p>
<p>你需要使用 <code>Mail</code> 假面的 <code>send</code> 方法来发送一个邮件。<code>send</code> 方法接收三个参数，第一个参数应该是视图的名称。第二个参数应该是传递到视图中的数据所组成的数组。最后，是一个 <code>Closure</code> 回调函数，这个回调函数会接收一个 message 实例，这允许你自由的配置收件人，主题，和其他方面的邮件信息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Mail</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Send an e-mail reminder to the user.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> Request $request</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendEmailReminder</span><span class="params">(Request $request, $id)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $user = User::findOrFail($id);</div><div class="line"></div><div class="line">     Mail::send(<span class="string">'emails.reminder'</span>, [<span class="string">'user'</span> =&gt; $user], <span class="function"><span class="keyword">function</span> <span class="params">($m)</span> <span class="title">use</span> <span class="params">($user)</span> </span>&#123;</div><div class="line">       $m-&gt;from(<span class="string">'hello@app.com'</span>, <span class="string">'Your Application'</span>);</div><div class="line"></div><div class="line">       $m-&gt;to($user-&gt;email, $user-&gt;name)-&gt;subject(<span class="string">'Your Reminder!'</span>);</div><div class="line">     &#125;);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为上面的示例中我们传递了 <code>user</code> 键到数组中，所以我们可以在我们的邮件视图中使用用户的名称：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $user-&gt;name; <span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>注意： 一个 <code>$message</code> 变量会自动的传递到邮件视图，并且允许内联附件。所以，你应该避免手动的传递到视图 <code>message</code> 变量。</p>
</blockquote>
<p><strong>构建一个 Message</strong></p>
<p>就如我们上面谈到的，传递到 <code>send</code> 方法的第三个参数是一个 <code>Closure</code>，这个闭包允许你设置邮件信息的各种选项。使用闭包，你可以指定信息的其它属性，比如复写，密抄等：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Mail::send(<span class="string">'emails.welcome'</span>, $data, <span class="function"><span class="keyword">function</span> <span class="params">($message)</span> </span>&#123;</div><div class="line">  $message-&gt;from(<span class="string">'us@example.com'</span>, <span class="string">'Laravel'</span>);</div><div class="line"></div><div class="line">  $message-&gt;to(<span class="string">'foo@example.com'</span>)-&gt;cc(<span class="string">'bar@example.com'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这里列出了 <code>$message</code> 构建实例所有可用的方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$message-&gt;from($address, $name = <span class="keyword">null</span>);</div><div class="line">$message-&gt;sender($address, $name = <span class="keyword">null</span>);</div><div class="line">$message-&gt;to($address, $name = <span class="keyword">null</span>);</div><div class="line">$message-&gt;cc($address, $name = <span class="keyword">null</span>);</div><div class="line">$message-&gt;bcc($address, $name = <span class="keyword">null</span>);</div><div class="line">$message-&gt;replyTo($address, $name = <span class="keyword">null</span>);</div><div class="line">$message-&gt;subject($subject);</div><div class="line">$message-&gt;priority($level);</div><div class="line">$message-&gt;attach($pathToFile, <span class="keyword">array</span> $options = []);</div><div class="line"></div><div class="line"><span class="comment">// Attach a file from a raw $data string...</span></div><div class="line">$message-&gt;attachData($data, $name, <span class="keyword">array</span> $options = []);</div><div class="line"></div><div class="line"><span class="comment">// Get the underlying SwiftMailer message instance...</span></div><div class="line">$message-&gt;getSwiftMessage();</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：message 实例继承自 SwiftMailer 信息类并会被传递到 <code>Mail::send</code> 闭包中。这允许你在访问所有 SwiftMailer 信息类的方法。</p>
</blockquote>
<p><strong>纯文本邮件</strong></p>
<p>默认的，<code>send</code> 方法会假设传递到其中的视图包含了 HTML。但是，你可以传递一个数组到 <code>send</code> 方法的第一个参数，你指定一个纯文本视图来合并 HTML 视图：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Mail::send([<span class="string">'html.view'</span>, <span class="string">'text.view'</span>], $data, $callback);</div></pre></td></tr></table></figure>
<p>或者你可以只传递一个纯文本的邮件，你需要指定数组的键为 <code>text</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Mail::send([<span class="string">'text'</span> =&gt; <span class="string">'view'</span>], $data, $callback);</div></pre></td></tr></table></figure>
<p><strong>原始字符串邮件</strong></p>
<p>你可以使用 <code>raw</code> 方法来直接发送原始字符串邮件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Mail::raw(<span class="string">'Text to e-mail'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($message)</span></span>&#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h3><p>你可以使用传递到闭包中的 <code>$message</code> 对象的 <code>attach</code> 方法来在邮件中添加附件。<code>attach</code> 方法接收一个完整的文件路径作为第一个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Mail::send(<span class="string">'emails.welcome'</span>, $data, <span class="function"><span class="keyword">function</span> <span class="params">($message)</span> </span>&#123;</div><div class="line">  <span class="comment">//</span></div><div class="line"></div><div class="line">  $message-&gt;attach($pathToFile); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>当你添加一个邮件附件时，你可能也需要指定附件显示的名称或者 MIME type。你可以向 <code>attach</code> 方法传递一个数组作为第二个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$message-&gt;attach($pathToFile, [<span class="string">'as'</span> =&gt; $display, <span class="string">'mime'</span> =&gt; $mime]);</div></pre></td></tr></table></figure>
<p><code>attachData</code> 方法可以用来添加一个原始字节字符串作为一个附件。比如，你可能需要使用这个方法来将内存中生成的 PDF 直接添加到附件中，而不需要先存储到磁盘：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$message-&gt;attachData($pdf, <span class="string">'invoice.pdf'</span>);</div><div class="line"></div><div class="line">$message-&gt;attachData($pdf, <span class="string">'invoice.pdf'</span>, [<span class="string">'mime'</span> =&gt; $mime]);</div></pre></td></tr></table></figure>
<h3 id="内联附件"><a href="#内联附件" class="headerlink" title="内联附件"></a>内联附件</h3><p><strong>在邮件视图中嵌入一个图片</strong></p>
<p>在邮件中内联一个图片通常是比较笨重的。但是，laravel 提供了一种便捷的方式在你的邮件中附加一个图片并且取回适当的 CID。你需要在邮件视图中使用 <code>$message</code> 变量的 <code>embed</code> 方法。你应该记得，Laravel 会自动的创建一个 <code>$message</code> 变量并将其传递到你的邮件视图中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">  Here is an image:</div><div class="line"></div><div class="line">  &lt;img src=<span class="string">"&lt;?php echo $message-&gt;embed($pathToFile); ?&gt;"</span></div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>
<p><strong>嵌入原始数据到视图</strong></p>
<p>如果你希望嵌入一个原始数据到邮件信息中，你可以使用 <code>$message</code> 变量的 <code>embedData</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">  Here is an image from raw data:</div><div class="line"></div><div class="line">  &lt;img src=<span class="string">"&lt;?php echo $message-&gt;embedData($data, $name); ?&gt;"</span></div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>
<h3 id="邮件队列"><a href="#邮件队列" class="headerlink" title="邮件队列"></a>邮件队列</h3><p><strong>队列化邮件信息</strong></p>
<p>由于发送邮件是非常消耗资源的一件事，这样会影响到应用的响应时间。所以很多开发者都选择使用队列来完成异步的邮件发送。Laravel 使用统一的队列接口来使这些非常简单。你需要使用 <code>Mail</code> 假面的 <code>queue</code> 方法来使邮件队列化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Mail::queue(<span class="string">'emails.welcome'</span>, $data, <span class="function"><span class="keyword">function</span> <span class="params">($message)</span> </span>&#123;</div><div class="line">  <span class="comment">// </span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>该方法会自动的在队列添加发送邮件的任务，该任务会在后台自动的执行。当然，你需要先配置好队列。</p>
<p><strong>延迟消息队列</strong></p>
<p>如果你希望延迟执行邮件的发送队列。你需要使用 <code>later</code> 方法。你需要在方法的第一个参数传送一个你希望延迟执行的秒数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Mail::later(<span class="number">5</span>, <span class="string">'emails.welcome'</span>, $data, <span class="function"><span class="keyword">function</span> <span class="params">($message)</span> </span>&#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>添加到指定的队列</strong></p>
<p>如果你希望添加邮件任务到指定的队列，你需要使用 <code>queueOn</code> 和 <code>laterOn</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Mail::queueOn(<span class="string">'queue-name'</span>, <span class="string">'emails.welcome'</span>, $data, <span class="function"><span class="keyword">function</span> <span class="params">($message)</span> </span>&#123;</div><div class="line">  <span class="comment">// </span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">Mail::laterOn(<span class="string">'queue-name'</span>, <span class="number">5</span>, <span class="string">'emails.welcome'</span>, $data, <span class="function"><span class="keyword">function</span> <span class="params">($message)</span> </span>&#123;</div><div class="line">  <span class="comment">// </span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="邮件-amp-本地开发"><a href="#邮件-amp-本地开发" class="headerlink" title="邮件 &amp; 本地开发"></a>邮件 &amp; 本地开发</h2><p>当开发一个发送邮件的服务时，你可能并不希望真实的去发送一个邮件。只需要模拟测试成功就可以了。laravel 提供了多种方式来禁用真实的邮件发送。</p>
<p><strong>log 驱动</strong></p>
<p>其中一个解决方案就是在本地开发时使用 <code>log</code> 邮件驱动。这个驱动会将所有的邮件信息写入到日志文件中。</p>
<p><strong>通用的邮件</strong></p>
<p>另外一个解决方案就是设置一个通用的邮件来接收所有的应用发出的邮件。这种方式，会使应用生成的所有邮件都发送到这个地址。你可以通过配置 <code>config/mail.php</code> 文件的 <code>to</code> 选项来进行设置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="string">'to'</span> =&gt; [</div><div class="line">  <span class="string">'address'</span> =&gt; <span class="string">'dev@domain.com'</span>,</div><div class="line">  <span class="string">'name'</span> =&gt; <span class="string">'Dev Example'</span></div><div class="line">],</div></pre></td></tr></table></figure>
<p><strong>mailtrap</strong></p>
<p>最后，你也可以使用一些像 <a href="https://mailtrap.io/" target="_blank" rel="external">Mailtrap</a> 和 <code>smtp</code> 驱动的服务来发送你的邮件到一个虚拟邮箱，而且你也可以通过真实的邮件客户端进行查看。这可以使你看到真实的邮件在 Mailtrap 中的显示效果。</p>
<h2 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h2><p>laravel 会在发送邮件之前触发事件。你应该注意的是，它是在邮件发送之前触发事件，而不是添加到队列时。你可以在 <code>EventServiceProvider</code> 中注册一个事件监听者：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * The event listener mappings for the application.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">protected</span> $listen = [</div><div class="line">  <span class="string">'Illuminate\Mail\Events\MessageSending'</span> =&gt; [</div><div class="line">    <span class="string">'App\Listeners\LogSentMessage'</span>,</div><div class="line">  ],</div><div class="line"> ];</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/08/laravel-from-scratch-localization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/08/laravel-from-scratch-localization/" itemprop="url">laravel 基础教程 —— 本土化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-08T10:23:17+08:00">
                2016-06-08
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="本土化"><a href="#本土化" class="headerlink" title="本土化"></a>本土化</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>laravel 的本土化特性提供了一种便捷的方式来获取各种语言的字符串。它允许你在应用中可以简单的支持多语言。</p>
<p>语言字符串被存储在 <code>resources/lang</code> 目录下的文件里。在这个目录下，应该划分出多个支持的语言子目录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/resources</div><div class="line">    /lang</div><div class="line">        /en</div><div class="line">            messages.php</div><div class="line">        /es</div><div class="line">            messages.php</div></pre></td></tr></table></figure>
<p>所有的语言文件简单的返回一个使用字符串键化的数组，比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">return</span> [</div><div class="line">  <span class="string">'welcome'</span> =&gt; <span class="string">'Welcome to our application'</span></div><div class="line">];</div></pre></td></tr></table></figure>
<p><strong>配置语言环境</strong></p>
<p>应用使用的默认语言被存储在 <code>config/app.php</code> 配置文件中。当然，你可以根据需求自由的修改当前设置。你也可以使用 <code>App</code> 假面的 <code>setLocale</code> 方法在运行时切换语言：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'welcome/&#123;locale&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($locale)</span> </span>&#123;</div><div class="line">  App::setLocale($locale);</div><div class="line"></div><div class="line">  <span class="comment">// </span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>你也可以设置一个备用语言，它会在激活的语言环境中未找到所给定的语言键时使用。备用语言也是在 <code>config/app.php</code> 配置文件中进行设置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'fallback_local'</span> =&gt; <span class="string">'en'</span>,</div></pre></td></tr></table></figure>
<p>你可以使用 <code>App</code> 假面的 <code>isLocale</code> 方法来判断当前语言环境是否给定的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (App::isLocale(<span class="string">'en'</span>)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可以使用 <code>App</code> 假面的 <code>getLocale</code> 方法来获取当前的语言环境：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> App::getLocale();</div></pre></td></tr></table></figure>
<h2 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h2><p>你可以使用 <code>trans</code> 帮助方法来从语言文件中提取内容。<code>trans</code> 方法接收文件名和键值作为其第一个参数。比如，让我们检索 <code>resources/lang/messages.php</code> 语言文件中的 <code>welcome</code> 键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> trans(<span class="string">'messages.welcome'</span>);</div></pre></td></tr></table></figure>
<p>如果你使用 Blade 模板引擎，那么你可以在视图文件中使用双括号语法或者使用 <code>@lang</code> 指令来提取内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; trans(<span class="string">'message.welcome'</span>) &#125;&#125;</div><div class="line"></div><div class="line">@lang(<span class="string">'messages.welcome'</span>)</div></pre></td></tr></table></figure>
<p>如果指定的语言文件中的键不存在，<code>trans</code> 方法就会简单的返回这个键名。所以，如果上述示例中的键不存在，那么会返回 <code>messages.welcome</code>。</p>
<p><strong>语言内容中的参数替换</strong></p>
<p>如果你需要，你可以定义一个占位到你的语言内容中。所有的语言占位都是使用的 <code>:</code> 来标识。比如，你希望定义一个欢迎某某的一个占位：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'welcome'</span> =&gt; <span class="string">'Welcome, :name'</span>,</div></pre></td></tr></table></figure>
<p>你可以在 <code>trans</code> 方法中传递一个数组作为第二个参数，它会将数组的值替换到语言内容的占位符中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> trans(<span class="string">'message.welcome'</span>, [<span class="string">'name'</span> =&gt; <span class="string">'dayle'</span>]);</div></pre></td></tr></table></figure>
<p>如果你的占位符中包含了首字母大写或者全体大写，那么替换后的字符串也是相应的方式进行处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="string">'welcome'</span> =&gt; <span class="string">'Welcome, :NAME'</span>, <span class="comment">// Welcome, DAYLE</span></div><div class="line"><span class="string">'goodbye'</span> =&gt; <span class="string">'Goodbye, :Name'</span>, <span class="comment">// Goodbye, Dayle</span></div></pre></td></tr></table></figure>
<h3 id="多元化"><a href="#多元化" class="headerlink" title="多元化"></a>多元化</h3><p>语言的多元化是个复杂的问题。不同的语言拥有各种复杂的规则来定义多元化。你可以通过使用 <code>|</code> 字符串来从一个完整的字符串中区分单数或者复数的形式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'apples'</span> =&gt; <span class="string">'There is one apple|There are many apples'</span>,</div></pre></td></tr></table></figure>
<p>然后你可以使用 <code>trans_choice</code> 方法来根据给定的数目获取语言内容。在这个例子中，因为数目大于 1，所以语言会提取复数形式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> trans_choice(<span class="string">'messages.apples'</span>, <span class="number">10</span>);</div></pre></td></tr></table></figure>
<p>因为 laravel 的翻译者是基于 Symfony 翻译组件的，所以你可以创建更为复杂的复杂复数规则：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'apples'</span> =&gt; <span class="string">'&#123;0&#125; There are none|[1,19] There are some|[20,Inf] There are many'</span>,</div></pre></td></tr></table></figure>
<h2 id="覆盖供应商语言文件"><a href="#覆盖供应商语言文件" class="headerlink" title="覆盖供应商语言文件"></a>覆盖供应商语言文件</h2><p>很多包都会附带自己的语言文件。如果你需要替换其中某些语言内容，你可以通过存放自己的语言文件到 <code>resources/lang/vendor/{package}/{locale}</code> 目录。</p>
<p>所以，比如，如果你需要覆盖一个包名为 <code>skyrim/hearthfire</code> 的 <code>messages.php</code> 文件，你需要存放你自己的语言文件到 <code>resources/lang/vendor/hearthfire/en/message.php</code> 。在这个文件中你应该只添加想要覆盖的语言内容，任何未覆盖的内容还将使用包自带的原始语言文件。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/07/laravel-from-scratch-helpers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/07/laravel-from-scratch-helpers/" itemprop="url">laravel 基础教程 —— 帮助方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-07T23:45:45+08:00">
                2016-06-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="帮助方法"><a href="#帮助方法" class="headerlink" title="帮助方法"></a>帮助方法</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Laravel 包含了多中“帮手” PHP 函数，很多方法都在框架中进行了使用，如果你发现他们很方便，你也可以在自己的应用中使用。</p>
<h2 id="方法名单"><a href="#方法名单" class="headerlink" title="方法名单"></a>方法名单</h2><h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><h3 id="array-add"><a href="#array-add" class="headerlink" title="array_add()"></a>array_add()</h3><p><code>array_add</code> 方法用来在数组中添加键值对，它仅会在数组中不存在所给定的键时才会添加：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$array = array_add([<span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>], <span class="string">'price'</span>, <span class="number">100</span>);</div><div class="line"></div><div class="line"><span class="comment">// ['name' =&gt; 'Desk', 'price' =&gt; 100]</span></div></pre></td></tr></table></figure>
<h3 id="array-collapse"><a href="#array-collapse" class="headerlink" title="array_collapse()"></a>array_collapse()</h3><p><code>array_collapse</code> 方法会将坍塌数组到一个单一的数组中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$array = array_collapse([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]])</div><div class="line"></div><div class="line"><span class="comment">// [1, 2, 3, 4, 5, 6, 7, 8, 9]</span></div></pre></td></tr></table></figure>
<h3 id="array-divide"><a href="#array-divide" class="headerlink" title="array_divide()"></a>array_divide()</h3><p><code>array_divide</code> 方法将会分列数组，它会返回两个数组，一个数组包含了原数组的所有的键，另一个数组包含原数组所有的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">list</span>($keys, $values) = array_divide([<span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>]);</div><div class="line"></div><div class="line"><span class="comment">// $keys: ['name']</span></div><div class="line"></div><div class="line"><span class="comment">// $values: ['Desk']</span></div></pre></td></tr></table></figure>
<h3 id="array-dot"><a href="#array-dot" class="headerlink" title="array_dot()"></a>array_dot()</h3><p><code>array_dot</code> 方法将数组从多维降低为一维数组，它使用 <code>.</code> 符号来表明其深度：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$array = array_dot([<span class="string">'foo'</span> =&gt; [<span class="string">'bar'</span> =&gt; <span class="string">'baz'</span>]]);</div><div class="line"></div><div class="line"><span class="comment">// ['foo.bar' =&gt; 'baz'];</span></div></pre></td></tr></table></figure>
<h3 id="array-except"><a href="#array-except" class="headerlink" title="array_except()"></a>array_except()</h3><p><code>array_except</code> 方法从数组中移除指定的键值对：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$array = [<span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'price'</span> =&gt; <span class="number">100</span>];</div><div class="line"></div><div class="line">$array = array_except($array, [<span class="string">'price'</span>]);</div><div class="line"></div><div class="line"><span class="comment">// ['name' =&gt; 'Desk']</span></div></pre></td></tr></table></figure>
<h3 id="array-first"><a href="#array-first" class="headerlink" title="array_first()"></a>array_first()</h3><p><code>array_first</code> 方法返回数组回调迭代中第一个返回真值的元素:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$array = [<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>];</div><div class="line"></div><div class="line">$value = array_first($array, <span class="function"><span class="keyword">function</span> <span class="params">($key, $value)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $value &gt;= <span class="number">150</span>; </div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 200</span></div></pre></td></tr></table></figure>
<p>你也可以在第三个参数中传递一个默认值，如果迭代结束仍未返回真值，将返回默认值:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$value = array_first($array, $callback, $default);</div></pre></td></tr></table></figure>
<h3 id="array-flatten"><a href="#array-flatten" class="headerlink" title="array_flatten()"></a>array_flatten()</h3><p><code>array_flatten</code> 方法会将多维数组降为一维数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$array = [<span class="string">'name'</span> =&gt; <span class="string">'Joe'</span>, <span class="string">'languages'</span> =&gt; [<span class="string">'PHP'</span>, <span class="string">'Ruby'</span>]];</div><div class="line"></div><div class="line">$array = array_flatten($array);</div><div class="line"></div><div class="line"><span class="comment">// ['Joe', 'PHP', 'Ruby'];</span></div></pre></td></tr></table></figure>
<h3 id="array-forget"><a href="#array-forget" class="headerlink" title="array_forget()"></a>array_forget()</h3><p><code>array_forget</code> 方法可以使用 <code>.</code> 语法来删除数组中嵌套的键值对:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$array = [<span class="string">'products'</span> =&gt; [<span class="string">'desk'</span> =&gt; [<span class="string">'price'</span> =&gt; <span class="number">100</span>]]];</div><div class="line"></div><div class="line">array_forget($array, <span class="string">'products.desk'</span>);</div><div class="line"></div><div class="line"><span class="comment">// ['products' =&gt; []]</span></div></pre></td></tr></table></figure>
<h3 id="array-get"><a href="#array-get" class="headerlink" title="array_get()"></a>array_get()</h3><p><code>array_get</code> 方法可以使用 <code>.</code> 语法来从数组中检索嵌套的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$array = [<span class="string">'products'</span> =&gt; [<span class="string">'desk'</span> =&gt; [<span class="string">'price'</span> =&gt; <span class="number">100</span>]]];</div><div class="line"></div><div class="line">$value = array_get($array, <span class="string">'products.desk'</span>);</div><div class="line"></div><div class="line"><span class="comment">// ['price' =&gt; 100]</span></div></pre></td></tr></table></figure>
<p><code>array_get</code> 方法也可以接收第三个参数，用来作为默认值，如果数组中并没有检索到相应的值，将会返回默认值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$value = array_get($array, <span class="string">'names.john'</span>, <span class="string">'default'</span>);</div></pre></td></tr></table></figure>
<h3 id="array-has"><a href="#array-has" class="headerlink" title="array_has()"></a>array_has()</h3><p><code>array_has</code> 方法允许使用 <code>.</code> 语法来检查数组中是否含有给定的项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$array = [<span class="string">'products'</span> =&gt; [<span class="string">'desk'</span> =&gt; [<span class="string">'price'</span> =&gt; <span class="number">100</span>]]];</div><div class="line"></div><div class="line">$hasDesk = array_has($array, <span class="string">'products.desk'</span>);</div><div class="line"></div><div class="line"><span class="comment">// true</span></div></pre></td></tr></table></figure>
<h3 id="array-only"><a href="#array-only" class="headerlink" title="array_only()"></a>array_only()</h3><p><code>array_only</code> 方法会给定的数组中返回指定的键值对：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$array = [<span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'price'</span> =&gt; <span class="number">100</span>, <span class="string">'orders'</span> =&gt; <span class="number">10</span>];</div><div class="line"></div><div class="line">$array = array_only($array, [<span class="string">'name'</span>, <span class="string">'price'</span>]);</div><div class="line"></div><div class="line"><span class="comment">// ['name' =&gt; 'Desk', 'price' =&gt; 100]</span></div></pre></td></tr></table></figure>
<h3 id="array-pluck"><a href="#array-pluck" class="headerlink" title="array_pluck()"></a>array_pluck()</h3><p><code>array_pluck</code> 方法摘取数组中所给定的键值对：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$array = [</div><div class="line">  [<span class="string">'developer'</span> =&gt; [<span class="string">'id'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'Taylor'</span>]],</div><div class="line">  [<span class="string">'developer'</span> =&gt; [<span class="string">'id'</span> =&gt; <span class="number">2</span>, <span class="string">'name'</span> =&gt; <span class="string">'Abigail'</span>]],</div><div class="line">];</div><div class="line"></div><div class="line">$array = array_pluck($array, <span class="string">'developer.name'</span>);</div><div class="line"></div><div class="line"><span class="comment">// ['Taylor', 'Abigail'];</span></div></pre></td></tr></table></figure>
<p>你可以可以指定希望返回的结果如何键化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$array = array_pluck($array, <span class="string">'developer.name'</span>, <span class="string">'developer.id'</span>);</div><div class="line"></div><div class="line"><span class="comment">// [1 =&gt; 'Taylor', 2 =&gt; 'Abigail'];</span></div></pre></td></tr></table></figure>
<h3 id="array-prepend"><a href="#array-prepend" class="headerlink" title="array_prepend()"></a>array_prepend()</h3><p><code>array_prepend</code> 方法会在数组的起始端加入项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$array = [<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>, <span class="string">'four'</span>];</div><div class="line"></div><div class="line">$array = array_prepend($array, <span class="string">'zero'</span>);</div><div class="line"></div><div class="line"><span class="comment">// $array: ['zero', 'one', 'two', 'three', 'four']</span></div></pre></td></tr></table></figure>
<h3 id="array-pull"><a href="#array-pull" class="headerlink" title="array_pull()"></a>array_pull()</h3><p><code>array_pull</code> 方法从数组中返回键值对并将其在数组中进行剔除：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$array = [<span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'price'</span> =&gt; <span class="number">100</span>];</div><div class="line"></div><div class="line">$name = array_pull($array, <span class="string">'name'</span>)</div><div class="line"></div><div class="line"><span class="comment">// $name: Desk</span></div><div class="line"><span class="comment">// $array: ['price' =&gt; 100]</span></div></pre></td></tr></table></figure>
<h3 id="array-set"><a href="#array-set" class="headerlink" title="array_set()"></a>array_set()</h3><p><code>array_set</code> 方法使用 <code>.</code> 语法对数组中的项进行设置值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$array = [<span class="string">'products'</span> =&gt; [<span class="string">'desk'</span> =&gt; [<span class="string">'price'</span> =&gt; <span class="number">100</span>]]];</div><div class="line"></div><div class="line">array_set($array, <span class="string">'products.desk.price'</span>, <span class="number">200</span>);</div><div class="line"></div><div class="line"><span class="comment">// ['products' =&gt; ['desk' =&gt; ['price' =&gt; 200]]]</span></div></pre></td></tr></table></figure>
<h3 id="array-sort"><a href="#array-sort" class="headerlink" title="array_sort()"></a>array_sort()</h3><p><code>array_sort</code> 方法会根据给定闭包所返回的结果对数组进行排序：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$array = [</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>],</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Chair'</span>],</div><div class="line">];</div><div class="line"></div><div class="line">$array = array_values(array_sort($array, <span class="function"><span class="keyword">function</span> <span class="params">($value)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $value[<span class="string">'name'</span>];</div><div class="line">&#125;));</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">   [</span></div><div class="line"><span class="comment">    ['name' =&gt; 'Chair'],</span></div><div class="line"><span class="comment">    ['name' =&gt; 'Desk'],</span></div><div class="line"><span class="comment">   ]</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<h3 id="array-sort-recursive"><a href="#array-sort-recursive" class="headerlink" title="array_sort_recursive()"></a>array_sort_recursive()</h3><p><code>array_sort_recursive</code> 方法会对数组进行递归的使用 <code>sort</code> 方法排序：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">$array = [</div><div class="line">  [</div><div class="line">    <span class="string">'Roman'</span>,</div><div class="line">    <span class="string">'Taylor'</span>,</div><div class="line">    <span class="string">'Li'</span>,</div><div class="line">  ],</div><div class="line">  [</div><div class="line">    <span class="string">'PHP'</span>,</div><div class="line">    <span class="string">'Ruby'</span>,</div><div class="line">    <span class="string">'JavaScript'</span>,</div><div class="line">  ],</div><div class="line">];</div><div class="line"></div><div class="line">$array = array_sort_recursive($array);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">  [</span></div><div class="line"><span class="comment">    [</span></div><div class="line"><span class="comment">      'Li',</span></div><div class="line"><span class="comment">      'Roman',</span></div><div class="line"><span class="comment">      'Taylor',</span></div><div class="line"><span class="comment">    ],</span></div><div class="line"><span class="comment">    [</span></div><div class="line"><span class="comment">      'JavaScript',</span></div><div class="line"><span class="comment">      'PHP',</span></div><div class="line"><span class="comment">      'Ruby',</span></div><div class="line"><span class="comment">    ],</span></div><div class="line"><span class="comment">  ];</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<h3 id="array-where"><a href="#array-where" class="headerlink" title="array_where()"></a>array_where()</h3><p><code>array_where</code> 方法会根据给定的闭包对数组进行过滤：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$array = [<span class="number">100</span>, <span class="string">'200'</span>, <span class="number">300</span>, <span class="string">'400'</span>, <span class="number">500</span>];</div><div class="line"></div><div class="line">$array = array_where($array, <span class="function"><span class="keyword">function</span> <span class="params">($key, $value)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> is_string($value);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// [1 =&gt; 200, 3 =&gt; 400]</span></div></pre></td></tr></table></figure>
<h3 id="head"><a href="#head" class="headerlink" title="head()"></a>head()</h3><p><code>head</code> 方法简单的从数组中返回其首个元素：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$array = [<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>];</div><div class="line"></div><div class="line">$first = head($array);</div><div class="line"></div><div class="line"><span class="comment">// 100</span></div></pre></td></tr></table></figure>
<h3 id="last"><a href="#last" class="headerlink" title="last()"></a>last()</h3><p><code>last</code> 方法返回所给定数组中的最后一个元素：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$array = [<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>];</div><div class="line"></div><div class="line">$last = last($array);</div><div class="line"></div><div class="line"><span class="comment">// 300</span></div></pre></td></tr></table></figure>
<h2 id="Paths"><a href="#Paths" class="headerlink" title="Paths"></a>Paths</h2><h3 id="app-path"><a href="#app-path" class="headerlink" title="app_path()"></a>app_path()</h3><p><code>app_path</code> 方法返回 <code>app</code> 目录的完整路径：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$path = app_path();</div></pre></td></tr></table></figure>
<p>你也可以使用 <code>app_path</code> 方法来生成相对于应用目录的完整路径：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$path = app_path(<span class="string">'Http/Controllers/Controller.php'</span>);</div></pre></td></tr></table></figure>
<h3 id="base-path"><a href="#base-path" class="headerlink" title="base_path()"></a>base_path()</h3><p><code>base_path</code> 方法返回项目根目录的完整路径：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$path = base_path();</div></pre></td></tr></table></figure>
<p>你也可以使用 <code>base_path</code> 方法来返回相对于根目录的完整路径：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$path = base_path(<span class="string">'vendor/bin'</span>);</div></pre></td></tr></table></figure>
<h3 id="config-path"><a href="#config-path" class="headerlink" title="config_path()"></a>config_path()</h3><p><code>config_path</code> 方法用来返回应用的配置文件目录的完整路径：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$path = config_path();</div></pre></td></tr></table></figure>
<h3 id="database-path"><a href="#database-path" class="headerlink" title="database_path()"></a>database_path()</h3><p><code>database_path</code> 方法返回应用的数据库目录的完整路径：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$path = database_path();</div></pre></td></tr></table></figure>
<h3 id="elixir"><a href="#elixir" class="headerlink" title="elixir()"></a>elixir()</h3><p><code>elixir</code> 方法返回版本化的文件路径：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">elixir($file);</div></pre></td></tr></table></figure>
<h3 id="public-path"><a href="#public-path" class="headerlink" title="public_path()"></a>public_path()</h3><p><code>public_path</code> 方法返回 <code>public</code> 目录的完整路径：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$path = public_path();</div></pre></td></tr></table></figure>
<h3 id="storage-path"><a href="#storage-path" class="headerlink" title="storage_path()"></a>storage_path()</h3><p><code>storage_path</code> 方法返回 <code>storage</code> 目录的完整路径：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$path = storage_path();</div></pre></td></tr></table></figure>
<p>你也可以使用 <code>storage_path</code> 方法来生成相对目录的完整路径：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$path = storage_path(<span class="string">'app/file.txt'</span>);</div></pre></td></tr></table></figure>
<h2 id="Strings"><a href="#Strings" class="headerlink" title="Strings"></a>Strings</h2><h3 id="camel-case"><a href="#camel-case" class="headerlink" title="camel_case()"></a>camel_case()</h3><p><code>camel_case</code> 方法将给定字符串转换成 <code>camelCase</code> 格式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$camel = camel_case(<span class="string">'foo_bar'</span>);</div><div class="line"></div><div class="line"><span class="comment">// fooBar</span></div></pre></td></tr></table></figure>
<h3 id="class-basename"><a href="#class-basename" class="headerlink" title="class_basename()"></a>class_basename()</h3><p><code>class_basename</code> 反回所给定类移除命名空间之后的类名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$class = class_basename(<span class="string">'Foo\Bar\Baz'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Baz</span></div></pre></td></tr></table></figure>
<h3 id="e"><a href="#e" class="headerlink" title="e()"></a>e()</h3><p><code>e</code> 方法使用 <code>htmlentities</code> 方法来过滤给定字符串：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> e(<span class="string">'&lt;html&gt;foo&lt;/html&gt;'</span>);</div><div class="line"></div><div class="line"><span class="comment">// &amp;lt;html&amp;gt;foo&amp;lt;/html&amp;gt;</span></div></pre></td></tr></table></figure>
<h3 id="ends-with"><a href="#ends-with" class="headerlink" title="ends_with()"></a>ends_with()</h3><p><code>ends_with</code> 方法用来判断给定的字符串是否以给定的值结尾：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$value = ends_with(<span class="string">'This is my name'</span>, <span class="string">'name'</span>);</div><div class="line"></div><div class="line"><span class="comment">// true</span></div></pre></td></tr></table></figure>
<h3 id="snake-case"><a href="#snake-case" class="headerlink" title="snake_case()"></a>snake_case()</h3><p><code>snake_case</code> 方法将字符串转换成 <code>snake_case</code> 格式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$snake = snake_case(<span class="string">'fooBar'</span>);</div><div class="line"></div><div class="line"><span class="comment">// foo_bar</span></div></pre></td></tr></table></figure>
<h3 id="str-limit"><a href="#str-limit" class="headerlink" title="str_limit()"></a>str_limit()</h3><p><code>str_limit</code> 方法用来限制字符串的长度。该方法的第一个参数应该是一个字符串，而第二个参数应该是允许返回结果的最大长度：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$value = str_limit(<span class="string">'The PHP framework for web artisans.'</span>, <span class="number">7</span>);</div><div class="line"></div><div class="line"><span class="comment">// The PHP...</span></div></pre></td></tr></table></figure>
<h3 id="starts-with"><a href="#starts-with" class="headerlink" title="starts_with()"></a>starts_with()</h3><p><code>starts_with</code> 方法用来判断给定的字符串是否已给定的值起始：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$value = starts_with(<span class="string">'This is my name'</span>, <span class="string">'This'</span>);</div><div class="line"></div><div class="line"><span class="comment">// true</span></div></pre></td></tr></table></figure>
<h3 id="str-finish"><a href="#str-finish" class="headerlink" title="str_finish()"></a>str_finish()</h3><p><code>str_finish</code> 方法可以在字符串的结尾添加独特的值（如果字符串不是以该值结尾）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$string = str_finish(<span class="string">'this/string'</span>, <span class="string">'/'</span>);</div><div class="line"></div><div class="line"><span class="comment">// this/string/</span></div></pre></td></tr></table></figure>
<h3 id="str-is"><a href="#str-is" class="headerlink" title="str_is()"></a>str_is()</h3><p><code>str_is</code> 方法用来判断给定的字符串是否匹配给定的模式。可以使用星号作为通配符：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$value = str_is(<span class="string">'foo*'</span>, <span class="string">'foobar'</span>);</div><div class="line"></div><div class="line"><span class="comment">// true</span></div><div class="line"></div><div class="line">$value = str_is(<span class="string">'baz*'</span>, <span class="string">'foobar'</span>);</div><div class="line"></div><div class="line"><span class="comment">// false</span></div></pre></td></tr></table></figure>
<h3 id="str-plural"><a href="#str-plural" class="headerlink" title="str_plural()"></a>str_plural()</h3><p><code>str_plural</code> 方法将字符串转换为其相应的复数形式，该方法目前只支持英语：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$plural = str_plural(<span class="string">'car'</span>);</div><div class="line"></div><div class="line"><span class="comment">// cars</span></div><div class="line"></div><div class="line">$plural = str_plural(<span class="string">'child'</span>);</div><div class="line"></div><div class="line"><span class="comment">// children</span></div></pre></td></tr></table></figure>
<p>你可以传递一个整型值到第二个参数来表明返回单数或复数形式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$plural = str_plural(<span class="string">'child'</span>, <span class="number">2</span>);</div><div class="line"></div><div class="line"><span class="comment">// children</span></div><div class="line"></div><div class="line">$plural = str_plural(<span class="string">'child'</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="comment">// child</span></div></pre></td></tr></table></figure>
<h3 id="str-random"><a href="#str-random" class="headerlink" title="str_random()"></a>str_random()</h3><p><code>str_random</code> 方法根据指定的长度生成随机字符串：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$string = str_random(<span class="number">40</span>);</div></pre></td></tr></table></figure>
<h3 id="str-singular"><a href="#str-singular" class="headerlink" title="str_singular()"></a>str_singular()</h3><p><code>str_singular</code> 方法将字符串转换为单数形式，目前只支持英语：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$singular = str_singular(<span class="string">'cars'</span>);</div><div class="line"></div><div class="line"><span class="comment">// car</span></div></pre></td></tr></table></figure>
<h3 id="str-slug"><a href="#str-slug" class="headerlink" title="str_slug()"></a>str_slug()</h3><p><code>str_slug</code> 方法使用给定的胶连字符对给定的字符串生成 URL:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$title = str_slug(<span class="string">'Laravel 5 Framework'</span>, <span class="string">'-'</span>);</div><div class="line"></div><div class="line"><span class="comment">// laravel-5-framework</span></div></pre></td></tr></table></figure>
<h3 id="studly-case"><a href="#studly-case" class="headerlink" title="studly_case()"></a>studly_case()</h3><p><code>studly_case</code> 方法转换给定的字符串到 <code>StudlyCase</code> 格式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$value = studly_case(<span class="string">'foo_bar'</span>);</div><div class="line"></div><div class="line"><span class="comment">// FooBar</span></div></pre></td></tr></table></figure>
<h3 id="trans"><a href="#trans" class="headerlink" title="trans()"></a>trans()</h3><p><code>trans</code> 方法根据本地文件中的语言来进行翻译：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> trans(<span class="string">'validation.required'</span>);</div></pre></td></tr></table></figure>
<h3 id="trans-choice"><a href="#trans-choice" class="headerlink" title="trans_choice()"></a>trans_choice()</h3><p><code>trans_choice</code> 方法来转义到给定的语言，并使用相应的单复数形式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$value = trans_choice(<span class="string">'foo.bar'</span>, $count);</div></pre></td></tr></table></figure>
<h2 id="URLs"><a href="#URLs" class="headerlink" title="URLs"></a>URLs</h2><h3 id="action"><a href="#action" class="headerlink" title="action()"></a>action()</h3><p><code>action</code> 方法根据给定的控制器动作生成相应的 URL。你不需要传递完整的命名空间。默认的所传递的控制器类名是相对于 <code>App\Http\Controllers</code> 的命名空间：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$url = action (<span class="string">'HomeController@getIndex'</span>);</div></pre></td></tr></table></figure>
<p>如果方法接受路由参数，你可以传递第二个参数到该方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$url = action(<span class="string">'UserController@profile'</span>, [<span class="string">'id'</span> =&gt; <span class="number">1</span>]);</div></pre></td></tr></table></figure>
<h3 id="asset"><a href="#asset" class="headerlink" title="asset()"></a>asset()</h3><p>根据当前的请求方式来返回指定资源的地址：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$url = asset(<span class="string">'img/photo.jpg'</span>);</div></pre></td></tr></table></figure>
<h3 id="secure-asset"><a href="#secure-asset" class="headerlink" title="secure_asset()"></a>secure_asset()</h3><p>使用 HTTPS 生成给定资源的 URL：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> secure_asset(<span class="string">'foo/bar.zip'</span>, $title, $attributes = []);</div></pre></td></tr></table></figure>
<h3 id="route"><a href="#route" class="headerlink" title="route()"></a>route()</h3><p><code>route</code> 方法根据给定的路由名称来生成 URL：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$url = route(<span class="string">'routeName'</span>);</div></pre></td></tr></table></figure>
<p>如果路由接受参数，你可以传递第二个参数到方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$url = route(<span class="string">'routeName'</span>, [<span class="string">'id'</span> =&gt; <span class="number">1</span>]);</div></pre></td></tr></table></figure>
<h3 id="url"><a href="#url" class="headerlink" title="url()"></a>url()</h3><p><code>url</code> 方法根据指定的路径生成完整的路径：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> url(<span class="string">'user/profile'</span>);</div><div class="line"></div><div class="line"><span class="keyword">echo</span> url(<span class="string">'user/profile'</span>, [<span class="number">1</span>]);</div></pre></td></tr></table></figure>
<p>如果没有路径指定，将返回 <code>Illuminate\Routing\UrlGenerator</code> 的实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> url()-&gt;current();</div><div class="line"><span class="keyword">echo</span> url()-&gt;full();</div><div class="line"><span class="keyword">echo</span> url()-&gt;previous();</div></pre></td></tr></table></figure>
<h2 id="Miscellaneous"><a href="#Miscellaneous" class="headerlink" title="Miscellaneous"></a>Miscellaneous</h2><h3 id="auth"><a href="#auth" class="headerlink" title="auth()"></a>auth()</h3><p><code>auth</code> 方法返回一个认证实例。你可以方便的替换 <code>Auth</code> 假面：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$user = auth()-&gt;user();</div></pre></td></tr></table></figure>
<h3 id="back"><a href="#back" class="headerlink" title="back()"></a>back()</h3><p><code>back</code> 方法生成重定向响应到用户之前的地址：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> back();</div></pre></td></tr></table></figure>
<h3 id="bcrypt"><a href="#bcrypt" class="headerlink" title="bcrypt()"></a>bcrypt()</h3><p><code>bcrypt</code> 方法使用 Bcrypt 加密来哈希化给定的值。你也可以通过 <code>Hash</code> 假面来调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$password = bcrypt(<span class="string">'my-secret-password'</span>);</div></pre></td></tr></table></figure>
<h3 id="collect"><a href="#collect" class="headerlink" title="collect()"></a>collect()</h3><p><code>collect</code> 方法根据给定的项目组来生成 <code>collection</code> 实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'taylor'</span>, <span class="string">'abigail'</span>]);</div></pre></td></tr></table></figure>
<h3 id="config"><a href="#config" class="headerlink" title="config()"></a>config()</h3><p><code>config</code> 根据给定的值来获取配置项的值。你可以使用 <code>.</code> 语法来获取配置项的值。也可以传递第二个参数作为配置项未找到时的默认值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$value = config(<span class="string">'app.timezone'</span>);</div><div class="line"></div><div class="line">$value = config(<span class="string">'app.timezone'</span>, $default);</div></pre></td></tr></table></figure>
<p>你也可以在运行时使用键值对的方式对配置进行设置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">config([<span class="string">'app.debug'</span> =&gt; <span class="keyword">true</span>]);</div></pre></td></tr></table></figure>
<h3 id="csrf-field"><a href="#csrf-field" class="headerlink" title="csrf_field()"></a>csrf_field()</h3><p><code>csrf_field</code> 方法用来生成一个 <code>hidden</code> 文本框字段来包含 CSRF token。你可以在 Blade 模板中使用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&#123; csrf_field() &#125;&#125;</div></pre></td></tr></table></figure>
<h3 id="csrf-token"><a href="#csrf-token" class="headerlink" title="csrf_token()"></a>csrf_token()</h3><p><code>csrf_token</code> 方法返回当前的 CSRF token 值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$token = csrf_token();</div></pre></td></tr></table></figure>
<h3 id="dd"><a href="#dd" class="headerlink" title="dd()"></a>dd()</h3><p><code>dd</code> 方法打印输出给定的变量并终止执行之后的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dd($value);</div></pre></td></tr></table></figure>
<p>如果你不想停止执行之后的代码，你应该使用 <code>dump</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dump($value);</div></pre></td></tr></table></figure>
<h3 id="dispatch"><a href="#dispatch" class="headerlink" title="dispatch()"></a>dispatch()</h3><p><code>dispatch</code> 方法在 laravel 的任务对了中添加一个新的任务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dispatch(<span class="keyword">new</span> App\Jobs\SendEmails);</div></pre></td></tr></table></figure>
<h3 id="env"><a href="#env" class="headerlink" title="env()"></a>env()</h3><p><code>env</code> 方法用来获取环境变量，也可以在未设置环境变量时返回默认值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$env = env(<span class="string">'APP_ENV'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Return a default value if the variable doesn't exist...</span></div><div class="line">$env = env(<span class="string">'APP_ENV'</span>, <span class="string">'production'</span>);</div></pre></td></tr></table></figure>
<h3 id="event"><a href="#event" class="headerlink" title="event()"></a>event()</h3><p><code>event</code> 方法分发给定的事件到它的监听器中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">event(<span class="keyword">new</span> UserRegistered($user));</div></pre></td></tr></table></figure>
<h3 id="factory"><a href="#factory" class="headerlink" title="factory()"></a>factory()</h3><p><code>factory</code> 方法创建一个模型工厂构造器来生成给定的类名的实例。你可以在写单元测试或者 seeding 时使用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$user = factory(App\User::class)-&gt;make();</div></pre></td></tr></table></figure>
<h3 id="method-field"><a href="#method-field" class="headerlink" title="method_field()"></a>method_field()</h3><p><code>method_field</code> 方法生成一个 <code>hidden</code> 文本框来包含一个欺骗性的 HTTP 请求动词。你可以在 Blade 模板中使用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;form method=<span class="string">"POST"</span>&gt;</div><div class="line">  &#123;&#123; method_field(<span class="string">'DELETE'</span>) &#125;&#125;</div><div class="line">&lt;/form&gt;</div></pre></td></tr></table></figure>
<h3 id="old"><a href="#old" class="headerlink" title="old()"></a>old()</h3><p><code>old</code> 方法返回 session 中闪存的旧的文本值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$value = old(<span class="string">'value'</span>);</div><div class="line"></div><div class="line">$value = old(<span class="string">'value'</span>, <span class="string">'default'</span>);</div></pre></td></tr></table></figure>
<h3 id="redirect"><a href="#redirect" class="headerlink" title="redirect()"></a>redirect()</h3><p><code>redirect</code> 方法返回一个重定向的实例来做重定向响应：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> redirect(<span class="string">'/home'</span>);</div></pre></td></tr></table></figure>
<h3 id="request"><a href="#request" class="headerlink" title="request()"></a>request()</h3><p><code>request</code> 方法返回当前的请求实例或者检索请求中的输入项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$request = request();</div><div class="line"></div><div class="line">$value = request(<span class="string">'key'</span>, $default = <span class="keyword">null</span>)</div></pre></td></tr></table></figure>
<h3 id="response"><a href="#response" class="headerlink" title="response()"></a>response()</h3><p><code>response</code> 方法生成一个响应实例或者从响应工厂中获得一个实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> response(<span class="string">'Hello World'</span>, <span class="number">200</span>, $headers);</div><div class="line"></div><div class="line"><span class="keyword">return</span> response()-&gt;json([<span class="string">'foo'</span> =&gt; <span class="string">'bar'</span>], <span class="number">200</span>, $headers);</div></pre></td></tr></table></figure>
<h3 id="session"><a href="#session" class="headerlink" title="session()"></a>session()</h3><p><code>session</code> 方法可以用来获取或者设置 session 值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$value = session(<span class="string">'key'</span>);</div></pre></td></tr></table></figure>
<p>你可以通过传递键值对来进行 session 值的设置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">session([<span class="string">'chairs'</span> =&gt; <span class="number">7</span>, <span class="string">'instruments'</span> =&gt; <span class="number">3</span>]);</div></pre></td></tr></table></figure>
<p>如果调用的是无参数的 <code>session</code> 方法，将返回 session 存储器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$value = session()-&gt;get(<span class="string">'key'</span>);</div><div class="line"></div><div class="line">session()-&gt;put(<span class="string">'key'</span>, $value);</div></pre></td></tr></table></figure>
<h3 id="value"><a href="#value" class="headerlink" title="value()"></a>value()</h3><p><code>value</code> 方法会简单的返回所给定的值。但是，如果你传递的是一个 <code>Closure</code> ，<code>Closure</code> 将会被执行，其结果将被返回：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$value = value(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="string">'bar'</span>;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="view"><a href="#view" class="headerlink" title="view()"></a>view()</h3><p><code>view</code> 方法用来检索 <code>view</code> 实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> view(<span class="string">'auth.login'</span>);</div></pre></td></tr></table></figure>
<h3 id="with"><a href="#with" class="headerlink" title="with()"></a>with()</h3><p><code>with</code> 方法返回给定的值。它主要用于方法的链式调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$value = with(<span class="keyword">new</span> Foo)-&gt;work();</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/07/laravel-from-scratch-hashing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/07/laravel-from-scratch-hashing/" itemprop="url">laravel 基础教程 —— 哈希</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-07T23:13:18+08:00">
                2016-06-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="哈希"><a href="#哈希" class="headerlink" title="哈希"></a>哈希</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Laravel 的 <code>Hash</code> 假面对存储用户的密码提供了安全的 Bcrypt 加密工具哈希化。如果你使用了 laravel 自带的 <code>AuthController</code> 控制器，那么你就已经使用过了它。它会在注册和认证时自动的使用 Bcrypt 加密工具。</p>
<p>Bcrypt 对于密码哈希化是一种很好的选择，因为它的‘工作因子’是可以调整的，这就意味着随着硬件功率的提升，生成哈希密码的时间也会提升。</p>
<h2 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h2><p>你可以使用 <code>Hash</code> 假面的 <code>make</code> 方法来进行密码的哈希化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Hash</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Update the password for the user.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> Request $request</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">updatePassword</span><span class="params">(Request $request, $id)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $user = User::findOrFail($id);</div><div class="line"></div><div class="line">    <span class="comment">// validate the new password length...</span></div><div class="line"></div><div class="line">    $user-&gt;fill([</div><div class="line">        <span class="string">'password'</span> =&gt; Hash::make($request-&gt;newPassword)</div><div class="line">      ])-&gt;save();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另外，你可以使用全局帮助方法 <code>bcrypt</code> 来做同样的事情：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bcrypt(<span class="string">'plain-text'</span>);</div></pre></td></tr></table></figure>
<p><strong>针对 Hash 密码的验证</strong></p>
<p><code>check</code> 方法允许你验证所给定的哈希化的密码是否与所给定的原始字符串相匹配。如果你使用了 laravel 所提供的 <code>AuthController</code> 控制器，那么你并不需要直接的去使用这个方法，因为在认证控制器中系统会自动的调用这个方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Hash::check(<span class="string">'plain-text'</span>, $hashedPassword)) &#123;</div><div class="line">  <span class="comment">// The passwords match...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>检查密码是否需要刷新</strong></p>
<p><code>needsRehash</code> 方法可以用来判断密码是否需要重新生成，当工作因子变更时而密码没有使用新的工作因子生成时，其将返回 <code>true</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Hash::needsRehash($hashed)) &#123;</div><div class="line">  $hashed = Hash::make(<span class="string">'plain-text'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/07/laravel-from-scratch-filesystem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/07/laravel-from-scratch-filesystem/" itemprop="url">laravel 基础教程 —— 文件系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-07T21:22:06+08:00">
                2016-06-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="文件系统-云存储"><a href="#文件系统-云存储" class="headerlink" title="文件系统/云存储"></a>文件系统/云存储</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>laravel 提供了一个强大的文件系统的抽象，这得益于 Frank de Jonge 所开发的 <a href="https://github.com/thephpleague/flysystem" target="_blank" rel="external">Flyststem</a> PHP 包。laravel 的文件系统提供了对一些存储驱动的支持，它们包括本地文件系统，Amazon S3，Rackspace 云存储。更为奇妙的是，它可以通过存储配置选项来切换这些存储系统，因为 laravel 对它们提供了统一的 API 接口。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>文件系统的配置选项存储在 <code>config/filesystems.php</code> 文件中。在这个文件中你可以对所有的磁盘进行配置。每个磁盘选项包含着其所使用的存储驱动及其存储位置。对于 laravel 默认支持的存储驱动，在这个文件中都有相应的配置示例。所以，你可以简单的在这个文件中修改配置选项就可以使用其强大的功能。</p>
<p>当然，你可以配置多个磁盘，甚至可以使多个磁盘使用相同的驱动。</p>
<p><strong>公共磁盘</strong></p>
<p><code>public</code> 磁盘意味着其可以被公开的访问。默认的 <code>public</code> 磁盘使用的是 <code>local</code> 驱动并且其存储的文件位置是在 <code>storage/app/public</code> 目录。如果你想要这个目录下的文件可以在 web 中进行访问，你需要创建一个 <code>public/storage</code> 到 <code>storage/app/public</code> 的符号链接。这个约定可以使公开访问的文件保持存放在同一个目录中并且可以在使用像 <a href="https://envoyer.io/" target="_blank" rel="external">Envoyer</a> 这种无痛持续部署系统时可以方便的共享整个部署过程。</p>
<p>当然，一旦文件被存储并且建立了符号链接。你就可以通过 <code>asset</code> 帮助方法来生成文件的 URL：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">echo</span> asset(<span class="string">'storage/file.txt'</span>)</div></pre></td></tr></table></figure>
<p><strong>本地驱动</strong></p>
<p>当使用 <code>local</code> 驱动时，你需要知道的是所有的文件操作都是相对于配置文件中的 <code>root</code> 选项所定义的目录。默认的这个值设置的是 <code>storage/app</code> 目录。因此，下面的方法将文件存储到 <code>storage/app/file.txt</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Storage::disk(<span class="string">'local'</span>)-&gt;put(<span class="string">'file.txt'</span>, <span class="string">'Contents'</span>);</div></pre></td></tr></table></figure>
<p><strong>其他驱动先决条件</strong></p>
<p>在使用 S3 或者 Rackspace 驱动之前，你需要先通过 Composer 来安装适当的包文件：</p>
<ul>
<li>Amazon S3: <code>league/flysystem-aws-s3-v3 ~1.0</code></li>
<li>Rackspace: <code>league/flysystem-rackspace ~1.0</code></li>
</ul>
<p><strong>FTP 驱动配置</strong></p>
<p>laravel 的文件系统可以很好的支持 FTP 的集成，但是在默认的配置文件中并没有给出示例。如果你需要配置 FTP 的文件系统，你可以使用下面的配置示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="string">'ftp'</span> =&gt; [</div><div class="line">  <span class="string">'dirver'</span> =&gt; <span class="string">'ftp'</span>,</div><div class="line">  <span class="string">'host'</span> =&gt; <span class="string">'ftp.example.com'</span>,</div><div class="line">  <span class="string">'username'</span> =&gt; <span class="string">'your-username'</span>,</div><div class="line">  <span class="string">'password'</span> =&gt; <span class="string">'your-password'</span>,</div><div class="line"></div><div class="line">  <span class="comment">// Optional FTP Settings...</span></div><div class="line">  <span class="comment">// 'port' =&gt; 21,</span></div><div class="line">  <span class="comment">// 'root' =&gt; '',</span></div><div class="line">  <span class="comment">// 'passive' =&gt; true,</span></div><div class="line">  <span class="comment">// 'ssl' =&gt; true,</span></div><div class="line">  <span class="comment">// 'timeout' =&gt; 30,</span></div><div class="line">],</div></pre></td></tr></table></figure>
<p><strong>Rackspace 驱动配置</strong></p>
<p>laravel 的文件系统可以很好的支持 Rackspace 的集成，但是在默认的配置文件中并没有给出示例。如果你需要配置 Rackspace 文件系统，你可以使用下面的示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="string">'rackspace'</span> =&gt; [</div><div class="line">  <span class="string">'driver'</span> =&gt; <span class="string">'rackspace'</span>,</div><div class="line">  <span class="string">'username'</span> =&gt; <span class="string">'your-username'</span>,</div><div class="line">  <span class="string">'key'</span> =&gt; <span class="string">'your-key'</span>,</div><div class="line">  <span class="string">'container'</span> =&gt; <span class="string">'your-container'</span>,</div><div class="line">  <span class="string">'endpoint'</span> =&gt; <span class="string">'https://identity.api.rackspacecloud.com/v2.0/'</span>,</div><div class="line">  <span class="string">'region'</span> =&gt; <span class="string">'IAD'</span>,</div><div class="line">  <span class="string">'url_type'</span> =&gt; <span class="string">'publicURL'</span>,</div><div class="line">],</div></pre></td></tr></table></figure>
<h2 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h2><h3 id="获取磁盘实例"><a href="#获取磁盘实例" class="headerlink" title="获取磁盘实例"></a>获取磁盘实例</h3><p><code>Storage</code> 假面可以用来和你所配置的磁盘进行交互。比如，你可以使用它的 <code>put</code> 方法来将用户的头像图片存储到默认的磁盘。如果你在调用该方法的时候没有在其之前使用 <code>disk</code> 方法的话，那么该方法会自动的将头像传递到默认的磁盘：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Storage</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Update teh avatar for the given user.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> Request $request</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">updateAvatar</span><span class="params">(Request $request, $id)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $user = User::findOrFail($id);</div><div class="line"></div><div class="line">     Storage::put(</div><div class="line">        <span class="string">'avatars/'</span>.$user-&gt;id,</div><div class="line">        file_get_contents($request-&gt;file(<span class="string">'avatar'</span>)-&gt;getRealPath())</div><div class="line">      );</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当你使用多个磁盘时，你可以使用 <code>Storage</code> 假面的 <code>disk</code> 方法来指定访问的磁盘。当然，你可以使用链式的方法来进行持续的操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$disk = Storage::disk(<span class="string">'s3'</span>);</div><div class="line"></div><div class="line">$contents = Storage::disk(<span class="string">'local'</span>)-&gt;get(<span class="string">'file.jpg'</span>);</div></pre></td></tr></table></figure>
<h3 id="检索文件"><a href="#检索文件" class="headerlink" title="检索文件"></a>检索文件</h3><p><code>get</code> 方法可以用来从所给定的文件中检索出其内容。该方法会返回文件的原始字符串内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$contents = Storage::get(<span class="string">'file.jpg'</span>);</div></pre></td></tr></table></figure>
<p><code>exists</code> 方法可以用来判断所给定的文件是否存在于磁盘中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$exists = Storage::disk(<span class="string">'s3'</span>)-&gt;exists(<span class="string">'file.jpg'</span>);</div></pre></td></tr></table></figure>
<h3 id="文件-URLs"><a href="#文件-URLs" class="headerlink" title="文件 URLs"></a>文件 URLs</h3><p>当使用 <code>local</code> 或者 <code>s3</code> 驱动时，你可以使用 <code>url</code> 方法来获得给定文件的 URL。如果你使用的是 <code>local</code> 驱动，那它只会简单的在给定的路径前增加 <code>/storage</code> 前缀以返回相对的文件路径。如果你使用的是 <code>s3</code> 驱动，将会返回完整的远端 RUL：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$url = Storage::url(<span class="string">'file1.jpg'</span>);</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：当使用的是 <code>local</code> 驱动时，一定要确保创建了 <code>public/storage</code> 到 <code>storage/app/public</code> 的符号链接。</p>
</blockquote>
<p><strong>文件元信息</strong></p>
<p><code>size</code> 方法可以用来获取给定文件的字节大小：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$size = Storage::size(<span class="string">'file1.jpg'</span>);</div></pre></td></tr></table></figure>
<p><code>lastModified</code> 方法会返回给定文件的最后修改时间，它使用的 是 UNIX 时间戳：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$time = Storage::lastModified(<span class="string">'file1.jpg'</span>);</div></pre></td></tr></table></figure>
<h3 id="存储文件"><a href="#存储文件" class="headerlink" title="存储文件"></a>存储文件</h3><p><code>put</code> 方法可以用来将文件存储到磁盘。你可以传递一个 PHP 的 <code>resource</code> 到 <code>put</code> 方法，那么它会使用文件系统的底层流支持。在与大型文件交互时，推荐使用文件流：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Storage::put(<span class="string">'file.jpg'</span>, $contents);</div><div class="line"></div><div class="line">Storage::put(<span class="string">'file.jpg'</span>, $resource);</div></pre></td></tr></table></figure>
<p><code>copy</code> 方法可以用来复制磁盘中已存在的文件到新的位置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Storage::copy(<span class="string">'old/file1.jpg'</span>, <span class="string">'new/file1.jpg'</span>);</div></pre></td></tr></table></figure>
<p><code>move</code> 方法可以被用对磁盘中已存在的文件进行名称的修改或移动到新的位置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Storage:move(<span class="string">'old,file1.jpg'</span>, <span class="string">'new/file1.jpg'</span>);</div></pre></td></tr></table></figure>
<p><strong>前置或追加内容到文件</strong></p>
<p><code>prepend</code> 和 <code>append</code> 方法允许你轻松的往文件的起始或结束位置加入内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Storage::prepend(<span class="string">'file.log'</span>, <span class="string">'Prepended Text'</span>);</div><div class="line"></div><div class="line">Storage::append(<span class="string">'file.log'</span>, <span class="string">'Appended Text'</span>);</div></pre></td></tr></table></figure>
<h3 id="文件可见性"><a href="#文件可见性" class="headerlink" title="文件可见性"></a>文件可见性</h3><p>你可以通过使用 <code>getVisibility</code> 和 <code>setVisibility</code> 方法来进行文件可见性的检索和设置。可见性是跨平台的文件权限的抽象：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Storage::getVisibility(<span class="string">'file.jpg'</span>);</div><div class="line"></div><div class="line">Storage::setVisibility(<span class="string">'file.jpg'</span>, <span class="string">'public'</span>);</div></pre></td></tr></table></figure>
<p>另外，你可以在使用 <code>put</code> 方法的同时设置文件的可见性。有效的可见性值是 <code>public</code> 和 <code>private</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Storage::put(<span class="string">'file.jpg'</span>, $contents, <span class="string">'public'</span>);</div></pre></td></tr></table></figure>
<h3 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h3><p><code>delete</code> 方法可以接受一个文件名或者文件名所组成的数组，它将从磁盘中删除相应的文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Storage::delete(<span class="string">'file.jpg'</span>);</div><div class="line"></div><div class="line">Storage::delete([<span class="string">'file1.jpg'</span>, <span class="string">'file2.jpg'</span>]);</div></pre></td></tr></table></figure>
<h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><p><strong>从目录中获取所有文件</strong></p>
<p><code>files</code> 方法会返回所给定目录中所有的文件所组成的数组。如果你想要在检索到的文件中包含所给定目录的子目录。那么你需要使用 <code>allFiles</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$file = Storage::files($directory);</div><div class="line"></div><div class="line">$files = Storage::allFiles($directory);</div></pre></td></tr></table></figure>
<p><strong>从给定的目录中获取所有的目录</strong></p>
<p><code>directories</code> 方法可以返回所给定目录下的所有子目录所组成的数组。另外你可以使用 <code>allDirectories</code> 方法递归检索子目录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$directories = Storage::directories($directory);</div><div class="line"></div><div class="line"><span class="comment">// Recursive...</span></div><div class="line"></div><div class="line">$directories = Storage::allDirectories($directory);</div></pre></td></tr></table></figure>
<p><strong>创建目录</strong></p>
<p><code>makeDirectory</code> 方法将创建给定的目录，包括其所需要的子目录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Storage::makeDirectory($directory);</div></pre></td></tr></table></figure>
<p><strong>删除一个目录</strong></p>
<p>最后，<code>deleteDirectory</code> 方法可以用来删除一个目录，并且其删除磁盘中该目录下所有的文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Storage::deleteDirectory($directory);</div></pre></td></tr></table></figure>
<h2 id="自定义文件系统"><a href="#自定义文件系统" class="headerlink" title="自定义文件系统"></a>自定义文件系统</h2><p>laravel 的文件系统对几种常见的存储系统提供了开箱即用的支持。事实上，文件系统并没有限制你只使用所提供的这些。你可以自己创建一个适配器来构建一个自定义的驱动去支持你所期望使用的文件存储系统。</p>
<p>你需要创建一个服务提供者来进行自定义文件存储系统的构建。比如 <code>DropboxServiceProvider</code>。在提供者的 <code>boot</code> 方法中，你需要使用 <code>Storage</code> 假面的 <code>extend</code> 方法来定义你自己的驱动：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Storage</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">League</span>\<span class="title">Flysystem</span>\<span class="title">Filesystem</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Dropbox</span>\<span class="title">Client</span> <span class="title">as</span> <span class="title">DropboxClient</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">League</span>\<span class="title">Flysystem</span>\<span class="title">Dropbox</span>\<span class="title">DropboxAdapter</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DropboxServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Perform post-registration booting of services.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     Storage::extend(<span class="string">'dropbox'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app, $config)</span> </span>&#123;</div><div class="line">       $client = <span class="keyword">new</span> DropboxClient(</div><div class="line">        $config[<span class="string">'accessToken'</span>], $config[<span class="string">'clientIdentifier'</span>]</div><div class="line">       );      </div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Filesystem(<span class="keyword">new</span> DropboxAdapter($client));</div><div class="line">     &#125;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Register bindings in the container.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="comment">//</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>extend</code> 方法中的第一个参数应该是驱动的名称，第二个参数是一个闭包，闭包接受 <code>$app</code> 和 <code>$config</code> 变量。被解析的闭包必须返回一个 <code>League\Flysystem\Filesystem</code> 的实例。<code>$config</code> 变量包含了 <code>config/filesystems.php</code> 文件中指定磁盘的值。</p>
<p>一旦你创建了服务提供者并且注册了这个扩展，你就可以在 <code>config/filesystem.php</code> 配置文件中使用 <code>dropbox</code> 驱动了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/06/laravel-from-scratch-events/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/06/laravel-from-scratch-events/" itemprop="url">laravel 基础教程 —— 事件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-06T10:58:41+08:00">
                2016-06-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>laravel 的事件提供了一种简单的观察者实现。它允许你在应用中进行订阅和监听事件。事件类通常都是存储在 <code>app/Events</code> 目录中，而他们的监听者都是存储在 <code>app/Listeners</code> 目录中。</p>
<h2 id="注册事件-监听者"><a href="#注册事件-监听者" class="headerlink" title="注册事件/监听者"></a>注册事件/监听者</h2><p><code>EventServiceProvider</code> 提供了一个注册所有事件监听者的方便的场所。它的 <code>listen</code> 属性包含了一个所有事件（keys）以及他们的监听者（values）所组成的数组。当然，你可以在这个数组中添加任何你需要的事件。比如，让我们添加 <code>PodcastWasPurchased</code> 事件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * The event listener mappiings for the application.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">protected</span> $listen = [</div><div class="line">   <span class="string">'App\Events\PodcastWasPurchased'</span> =&gt; [</div><div class="line">     <span class="string">'App\Listeners\EmailPurchaseConfirmation'</span>,</div><div class="line">   ],</div><div class="line"> ],</div></pre></td></tr></table></figure>
<h3 id="生成事件-监听者类"><a href="#生成事件-监听者类" class="headerlink" title="生成事件/监听者类"></a>生成事件/监听者类</h3><p>当然，每次都手动的去创建一个事件文件和一个监听者文件是很麻烦的事情，所以，你可以在 <code>EventServiceProvider</code> 中添加事件和监听者然后使用 <code>event:generate</code> 命令来自动生成。这个命令会生成 <code>EventServiceProvider</code> 中的所有列出的事件和监听者，当然，已经存在的事件和监听者不会重新生成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan event:generate</div></pre></td></tr></table></figure>
<h2 id="手动的注册事件"><a href="#手动的注册事件" class="headerlink" title="手动的注册事件"></a>手动的注册事件</h2><p>通常，事件应该被注册在 <code>EventServiceProvider</code> 的 <code>$listen</code> 数组中，事实上，你可以使用 <code>Event</code> 假面的事件分发器或者一个 <code>Illuminate\Contracts\Events\Dispatcher</code> 的实现来手动注册事件:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Register any other events for your application</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> \Illuminate\Contracts\Events\Dispatcher $events</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">(DispatcherContract $events)</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">parent</span>::boot($events);</div><div class="line"></div><div class="line">   $events-&gt;listen(<span class="string">'event.name'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($foo, $bar)</span> </span>&#123;</div><div class="line">     <span class="comment">//</span></div><div class="line">   &#125;);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p><strong>事件监听通配符</strong></p>
<p>你可以在注册监听器的时候使用 <code>*</code> 来作为通配符。这允许你来在同一个监听器中监听多种事件。通配符监听器接收整个事件数据数组作为第一个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$events-&gt;listen(<span class="string">'event.*'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(array $data)</span> </span>&#123;</div><div class="line">  <span class="comment">// </span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="定义事件"><a href="#定义事件" class="headerlink" title="定义事件"></a>定义事件</h2><p>一个事件类只是简单的数据存储器，它应该持有事件相关的信息.比如，让我们假设我们生成的 <code>PodcastWasPurchased</code> 事件应该接收一个 Eloquent ORM 对象：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Events</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">podcast</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Events</span>\<span class="title">Event</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">SerializesModels</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PodcastWasPurchased</span> <span class="keyword">extends</span> <span class="title">Event</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">use</span> <span class="title">SerializesModels</span>;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> $podcast;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Create a new event instance.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> Podcast $podcast</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Podcast $podcast)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">$this</span>-&gt;podcast = $podcast;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就如你所看到的，这个事件类并没有包含什么业务逻辑。它只是简单的包含了一个被购买的 <code>Podcast</code> 对象。<code>SerializesModels</code> trait 被用来序列化 Eloquent 模型，如果事件对象是使用 PHP 的 <code>serialize</code> 方法被进行序列化，那么 <code>SerializesModels</code> 就会优雅的将其内部的 Eloquent 对象序列化。</p>
<h2 id="定义监听者"><a href="#定义监听者" class="headerlink" title="定义监听者"></a>定义监听者</h2><p>接着，让我们来看一下针对我们上面举例的事件的监听者。事件监听者会在其 <code>handle</code> 方法中接收事件的实例。<code>event:generate</code> 命令会自动的在 <code>handle</code> 方法中引入其对应的事件的类型提示。你可以在 <code>handle</code> 方法中来提供对事件的响应逻辑：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Listeners</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Events</span>\<span class="title">PodcastWasPurchased</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmailPurchaseConfirmation</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Create the event listener.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="comment">//</span></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Handle the event.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> PodcastWasPurchased $event</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(PodcastWasPurchased $event)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="comment">// Access the podcast using $event-&gt;podcast...</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你的事件监听者也可以在构造函数中进行类型提示来注入依赖。所有的事件监听器都是通过 laravel 的服务容器解析的。所以，它们的依赖可以被自动的注入：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Mail</span>\<span class="title">Mailer</span>;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Mailer $mailer)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">$this</span>-&gt;mailer = $mailer;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>停止传递事件</strong></p>
<p>有时候，你可能希望停止传递事件到后续的监听者中。你可以在监听者的 <code>handle</code> 方法中返回 <code>false</code>，这样后续的监听者将不再进行事件的响应。</p>
<h3 id="监听者队列化"><a href="#监听者队列化" class="headerlink" title="监听者队列化"></a>监听者队列化</h3><p>需要对事件监听者进行队列化？没有比这更简单的了。直接添加 <code>ShouldeQueue</code> 接口到监听者类中就可以了。通过 <code>event:generate</code> Artisan 命令生成的监听者已经在当前的命名空间中添加了对这个接口的支持，所以你立即就可以使用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Listeners</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Events</span>\<span class="title">PodcastWasPurchased</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Queue</span>\<span class="title">ShouldQueue</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmailPurchaseConfirmation</span> <span class="keyword">implements</span> <span class="title">ShouldQueue</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就这么简单！当事件触发时，事件分发器会使用 laravel 的队列系统对监听器进行自动的队列化调用。如果监听器队列化执行的过程中没有异常出现，队列任务会自动的在监听器进程完成后进行删除。</p>
<p><strong>手动的访问队列</strong></p>
<p>如果你需要手动的访问底层队列任务的 <code>delete</code> 和 <code>release</code> 方法。那么你就可以直接去使用它们。<code>Illuminate\Queue\InteractsWithQueue</code> trait 对默认生成的监听器提供了访问这些方法的权限：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Listeners</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Events</span>\<span class="title">PodcastWasPurchased</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">InteractsWithQueue</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Queue</span>\<span class="title">ShouldQueue</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmailPurchaseConfirmation</span> <span class="keyword">implements</span> <span class="title">ShouldQueue</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">use</span> <span class="title">InteractsWithQueue</span>;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(PodcastWasPurchased $event)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">true</span>) &#123;</div><div class="line">      <span class="keyword">$this</span>-&gt;release(<span class="number">30</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="触发事件"><a href="#触发事件" class="headerlink" title="触发事件"></a>触发事件</h2><p>你可以使用 <code>Event</code> 假面来进行事件的触发，你需要传递一个事件实例到 <code>fire</code> 方法中。<code>fire</code> 方法会分发事件到所有的监听器中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Event</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Podcast</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Events</span>\<span class="title">PodcastWasPurchased</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Show the profile for the given user.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $userId</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $podcastId</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">purchasePodcast</span><span class="params">($userId, $podcastId)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    $podcast = Podcast::findOrFail($podcastId);</div><div class="line"></div><div class="line">    <span class="comment">// Purchase podcast logic...</span></div><div class="line"></div><div class="line">    Event::fire(<span class="keyword">new</span> PodcastWasPurchased($podcast));</div><div class="line">  &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此外，你还可以通过使用全局 <code>event</code> 帮助函数来触发事件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">event( <span class="keyword">new</span> PodcastWasPurchased($podcast));</div></pre></td></tr></table></figure>
<h2 id="广播事件"><a href="#广播事件" class="headerlink" title="广播事件"></a>广播事件</h2><p>很多现代化的应用中，会使用 web sockets 来实现实时交互的用户接口。当一些数据在服务端变更时，一条消息会通过 websocket 连接来传递到客户端进行处理。</p>
<p>为了帮助你构建这种类型的应用。laravel 使通过 websocket 连接进行广播事件变的非常简单。laravel 允许你广播事件来共享事件的名称到你的服务端和客户端的 JavaScript 框架。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>所有的事件广播配置选项都被存储在 <code>config/broadcasting.php</code> 配置文件中。laravel 支持多种开箱即用的广播驱动：<a href="https://pusher.com/" target="_blank" rel="external">Pusher</a>，<a href="https://laravel.com/docs/5.2/redis" target="_blank" rel="external">Redis</a> 和 <code>log</code> 驱动来提供本地开发和调试。在这个配置文件中包含了每种驱动的配置示例。</p>
<p><strong>广播先决条件</strong></p>
<p>事件广播需要以下依赖：</p>
<ul>
<li>Pusher: <code>pusher/pusher-php-server ~2.0</code></li>
<li>Redis: <code>predis/predis ~1.0</code></li>
</ul>
<p><strong>队列化先决条件</strong></p>
<p>在进行事件广播之前，你需要先配置好队列监听器。所有的广播都是通过队列任务来异步执行的，这样应用响应就不会受到影响。</p>
<h3 id="对事件进行广播"><a href="#对事件进行广播" class="headerlink" title="对事件进行广播"></a>对事件进行广播</h3><p>你需要实现 <code>Illuminate\Contracts\Broadcasting\ShouldBroadcast</code> 接口在事件类中，以通知 laravel 所给定的事件需要被广播。<code>ShouldBroadcast</code> 接口只要求你实现一个单一的方法：<code>broadcastOn</code>.该方法应该返回一个事件应该被广播的通道名称：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Events</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Events</span>\<span class="title">Event</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">SerializesModles</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Broadcasting</span>\<span class="title">ShouldBroadcast</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServerCreated</span> <span class="keyword">extends</span> <span class="title">Event</span> <span class="keyword">implements</span> <span class="title">ShouldBroadcast</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">use</span> <span class="title">SerializesModels</span>;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> $user;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Create a new event instance.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(User $user)</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;user = $user;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get the channels the event should be broadcast on.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> array</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastOn</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">return</span> [<span class="string">'user.'</span> . <span class="keyword">$this</span>-&gt;user-&gt;id];</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后，你只需要像平常那样去触发事件就可以了。一旦事件被触发，队列任务会自动的广播事件到你指定的广播驱动中。</p>
<h3 id="广播数据"><a href="#广播数据" class="headerlink" title="广播数据"></a>广播数据</h3><p>当一个事件被广播时，事件类的所有 <code>public</code> 属性都会被序列化并作为广播的载荷，允许你的前端 JavaScript 应用来访问所有的开放属性。比如，如果事件类中只有一个开放的 <code>$user</code> 属性，该属性包含了一个 Eloquent 模型，那么广播的载荷将会像这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"user"</span>: &#123;</div><div class="line">    <span class="string">"id"</span>: <span class="number">1</span>,</div><div class="line">    <span class="string">"name"</span>: <span class="string">"Jonathan Banks"</span></div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>事实上，你可以通过在事件中添加 <code>broadcastWith</code> 方法来对广播载荷拥有更多的控制。该方法应该返回一个数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Get the data to broadcast.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> array</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastWith</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">return</span> [<span class="string">'user'</span> =&gt; <span class="keyword">$this</span>-&gt;user-&gt;id];</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="定制化事件广播"><a href="#定制化事件广播" class="headerlink" title="定制化事件广播"></a>定制化事件广播</h3><p><strong>定制事件名称</strong></p>
<p>默认的，广播事件的名称会使用事件类的全名。比如，如果事件的类名是 <code>App\Events\ServerCreated</code>，那么广播事件的名称就是 <code>App\Events\ServerCreated</code>。你可以通过定义 <code>broadcastAs</code> 方法来自定义广播事件的名称：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Get the broadcast event name</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastAs</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">'app.server-created'</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p><strong>定制化队列</strong></p>
<p>默认的，所有的事件广播都是通过 <code>queue.php</code> 配置文件中所指定的默认队列配置来进行的。你可以通过在事件广播类中添加一个 <code>onQueue</code> 方法来指定所使用的队列。该方法应该返回一个你所期望使用的队列的名称：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Set the name of the queue the event should be placed on.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onQueue</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">return</span> <span class="string">'your-queue-name'</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="对接广播事件"><a href="#对接广播事件" class="headerlink" title="对接广播事件"></a>对接广播事件</h3><p><strong>Pusher</strong></p>
<p>你可以使用 <a href="https://pusher.com/" target="_blank" rel="external">Pusher</a> 驱动的 JavaScript SDK来轻松的对接广播事件。比如，让我们消费前面例子中的 <code>App\Events\ServerCreated</code> 事件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.pusher = <span class="keyword">new</span> Pusher(<span class="string">'pusher-key'</span>);</div><div class="line"></div><div class="line"><span class="keyword">this</span>.pusherChannel = <span class="keyword">this</span>.pusher.subscribe(<span class="string">'user.'</span> + USER_ID);</div><div class="line"></div><div class="line"><span class="keyword">this</span>.pusherChannel.bind(<span class="string">'App\\Events\\ServerCreated'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">message</span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(message.user); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>Redis</strong></p>
<p>如果你使用的是 Redis 广播。那么你可能需要编写自己的 Redis 发布/订阅消费者来接收消息，你可以自由的选择使用 websocket 技术来进行事件的广播。比如，你可以选择使用基于 Node 受欢迎的 <a href="http://socket.io/" target="_blank" rel="external">Socket.io</a> 类库。</p>
<p>你可以使用 <code>socket.io</code> 和 <code>ioredis</code> Node 类库来快速的编写事件广播员来发布所有的应用事件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'http'</span>).createServer(handler);</div><div class="line"><span class="keyword">var</span> io = <span class="built_in">require</span>(<span class="string">'socket.io'</span>)(app);</div><div class="line"></div><div class="line"><span class="keyword">var</span> Redis = <span class="built_in">require</span>(<span class="string">'ioredis'</span>);</div><div class="line"><span class="keyword">var</span> redis = <span class="keyword">new</span> Redis();</div><div class="line"></div><div class="line">app.listen(<span class="number">6001</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Server is running!'</span>) ;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handler</span>(<span class="params">req, res</span>) </span>&#123;</div><div class="line">  res.writeHead(<span class="number">200</span>);</div><div class="line">  res.end(<span class="string">''</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">io.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">socket</span>) </span>&#123;</div><div class="line">  <span class="comment">// </span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">redis.psubscribe(<span class="string">'*'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, count</span>) </span>&#123;</div><div class="line">  <span class="comment">// </span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">redis.on(<span class="string">'pmessage'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">subscrbed, channel, message</span>) </span>&#123;</div><div class="line">  message = <span class="built_in">JSON</span>.parse(message);</div><div class="line">  io.emit(channel + <span class="string">':'</span> + message.event, message.data);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="事件订阅"><a href="#事件订阅" class="headerlink" title="事件订阅"></a>事件订阅</h2><p>事件订阅允许一个类在其内部订阅多个事件。这允许你在同一个文件中对多个事件进行处理。订阅者应该定义 <code>subscribe</code> 方法。该方法会被传递一个事件分发器实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Listeners</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserEventListener</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Handle user login events.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onUserLogin</span><span class="params">($event)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Handle user logout events.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onUserLogout</span><span class="params">($event)</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * Register the listeners for the subscriber.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> Illuminate\Events\Dispatcher $events</span></div><div class="line"><span class="comment">     */</span></div><div class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span><span class="params">($events)</span></span></div><div class="line"><span class="function">     </span>&#123;</div><div class="line">       $events-&gt;listen(</div><div class="line">         <span class="string">'App\Events\UserLoggedIn'</span>,</div><div class="line">         <span class="string">'App\Listeners\UserEventListener@onUserLogin'</span></div><div class="line">        );</div><div class="line">       $events-&gt;listen(</div><div class="line">         <span class="string">'App\Events\UserLoggedOut'</span>,</div><div class="line">         <span class="string">'App\Listeners\UserEventListener@onUserLogout'</span></div><div class="line">        );</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>注册一个事件订阅者</strong></p>
<p>当你的订阅者被定义完成之后，它应该在事件分发器中进行注册。你可以使用 <code>EventServieProvider</code> 的 <code>$subscribe</code> 属性来注册订阅者。比如，让我们来添加一个 <code>UserEventListener</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Events</span>\<span class="title">Dispatcher</span> <span class="title">as</span> <span class="title">DispatcherContract</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Support</span>\<span class="title">Providers</span>\<span class="title">EventServiceProvider</span> <span class="title">as</span> <span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The event listener mapping for the application.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> $listen = [</div><div class="line">     <span class="comment">//</span></div><div class="line">   ];</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * The subscriber classes to register.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">protected</span> $subscribe = [</div><div class="line">      <span class="string">'App\Listeners\UserEventListener'</span>,</div><div class="line">    ];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Dearmadman</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">100</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dearmadman</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
