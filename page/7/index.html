<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Team.dearmadman.com">
<meta property="og:url" content="http://yoursite.com/page/7/index.html">
<meta property="og:site_name" content="Team.dearmadman.com">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Team.dearmadman.com">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/7/"/>





  <title>Team.dearmadman.com</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Team.dearmadman.com</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Just do it.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/05/laravel-from-scratch-errors/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/05/laravel-from-scratch-errors/" itemprop="url">laravel 基础教程 —— 错误和日志</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-05T21:28:09+08:00">
                2016-06-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="错误和日志"><a href="#错误和日志" class="headerlink" title="错误和日志"></a>错误和日志</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>当你开始一个新的 laravel 项目时，你一定会需要到对错误和异常的处理，而这些 laravel 都已经为你配置好了。另外，laravel 还集成了 <a href="https://github.com/Seldaek/monolog" target="_blank" rel="external">Monolog</a> 日志组件库，它提供了各种强大的日志处理器。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p><strong>错误详情</strong></p>
<p>你的应用中通过浏览器来展示的错误详情程度是通过你的 <code>config/app.php</code> 配置文件中的 <code>debug</code> 选项来进行配置的。默认的该配置项遵从 <code>.env</code> 文件中的 <code>APP_DEBUG</code> 环境变量。</p>
<p><strong>日志模式</strong></p>
<p>larvel 提供了几种开箱即用的日志模式：<code>single</code>，<code>daily</code>，<code>syslog</code> 和 <code>errorlog</code>。比如，如果你希望使用每日日期文件记录日志来替换默认的单文件记录方式。你可以简单的在 <code>config/app.php</code> 配置文件中该设置 <code>log</code> 选项的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'log'</span> =&gt; <span class="string">'daily'</span></div></pre></td></tr></table></figure>
<p>当使用 <code>daily</code> 日志模式时，laravel 默认只会保留 5 天内的日志文件。如果你需要保留更多的日志文件，你需要在 <code>config/app.php</code> 文件中添加 <code>log_max_files</code> 选项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'log_max_files'</span> =&gt; <span class="number">30</span></div></pre></td></tr></table></figure>
<p><strong>自定义 Monolog 配置</strong></p>
<p>如果你想要在应用中对 Monolog 的配置拥有完全的控制，你可以使用应用的 <code>configureMonologUsing</code> 方法。你应该在 <code>bootstrap/app.php</code> 文件中进行方法的调用，并且你应该把它放置在返回 <code>$app</code> 之前：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$app-&gt;configureMonologUsing(<span class="function"><span class="keyword">function</span> <span class="params">($monolog)</span> </span>&#123;</div><div class="line">  $monolog-&gt;pushHandler(...); </div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">return</span> $app;</div></pre></td></tr></table></figure>
<p>默认的，laravel 会记录所有等级的日志。在生产环境中，你可能会想要只记录某些等级的日志，你可以通过在 <code>app.php</code> 配置文件中添加 <code>log_level</code> 选项来做到。laravel 会记录这个等级的日志和比这个等级日志更高级的日志。比如，设置 <code>log_level</code> 为 <code>error</code>，那么它会记录 <code>error</code>，<code>critical</code>，<code>alert</code> 和 <code>emergency</code> 等级的消息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">'log_level'</span> =&gt; app_env(<span class="string">'APP_LOG_LEVEL'</span>, <span class="string">'debug'</span>),</div></pre></td></tr></table></figure>
<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>所有的异常都会在 <code>App\Exceptions\Handler</code> 类中进行处理。该类包含了两个方法：<code>report</code> 和 <code>render</code>。我们将会对这个两个方法进行详细的剖析。</p>
<h3 id="Report-方法"><a href="#Report-方法" class="headerlink" title="Report 方法"></a>Report 方法</h3><p><code>report</code> 方法被用来记录异常或者发送异常到其他的服务中去，比如 <a href="https://bugsnag.com/" target="_blank" rel="external">BugSnag</a> 或者 <a href="https://github.com/getsentry/sentry-laravel" target="_blank" rel="external">Sentry</a>。默认的，<code>report</code> 方法只是简单的传递异常到异常记录的基类中。事实上，你可以自由的按照自己的希望去记录异常。</p>
<p>比如，如果你希望用不同的方式来记录不同类型的异常，你可以使用 PHP 的 <code>instanceof</code> 方法来进行筛选操作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Report or log an exception.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This is a great spot to send exceptions to Sentry, Bugsnag, etc.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> \Exception $e</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">report</span><span class="params">(Exception $e)</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">if</span> ($e <span class="keyword">instanceof</span> CustomException) &#123;</div><div class="line">     <span class="comment">//</span></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="keyword">parent</span>::report($e);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p><strong>根据类型来忽略异常</strong></p>
<p>异常处理类的 <code>$dontReport</code> 属性包含了一个需要忽略的异常类数组。这个数组中类型的异常将不会被记录。默认的 404 类型的错误就不会记录在日志文件中，你可以按需在这个数组中进行追加忽略的异常类名。</p>
<h3 id="Render-方法"><a href="#Render-方法" class="headerlink" title="Render 方法"></a>Render 方法</h3><p><code>render</code> 方法用来将异常转换为传递回浏览器的响应信息。默认异常会被传递到基类并返回一个响应。事实上，你可以自由的按需进行定制化响应：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Render an exception into an HTTP response.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> \Illuminate\Http\Request $request</span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> \Exception $e</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> \Illuminate\Http\Response</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span><span class="params">($request, Exception $e)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">if</span> ($e <span class="keyword">instanceof</span> CustomException) &#123;</div><div class="line">    <span class="keyword">return</span> response()-&gt;view(<span class="string">'errors.custom'</span>, [], <span class="number">500</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="keyword">parent</span>::render($request, $e);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="HTTP-异常"><a href="#HTTP-异常" class="headerlink" title="HTTP 异常"></a>HTTP 异常</h2><p>有些异常是直接从服务器来描述 HTTP 的错误代码。比如，这可能是一个“页面没有找到”的错误（404），一个“未授权”的错误（401）或者是一个“开发错误”（500）。为了在你的应用中快速的生成这种类型的响应，你可以使用下面的方式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">abort(<span class="number">404</span>);</div></pre></td></tr></table></figure>
<p><code>abort</code> 方法会立即的提出一个异常，该异常会在异常处理中被渲染。你也可以在该方法中提供一个可选的响应文本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">abort(<span class="number">403</span>, <span class="string">'Unauthorized action.'</span>);</div></pre></td></tr></table></figure>
<p>该方法可以在请求的生命周期中的任意时间点使用。</p>
<h3 id="自定义-HTTP-错误页面"><a href="#自定义-HTTP-错误页面" class="headerlink" title="自定义 HTTP 错误页面"></a>自定义 HTTP 错误页面</h3><p>laravel 使根据 HTTP 响应状态码来创建自定义的错误页面非常简单。比如，你可能希望自定义一个错误页面来提供给 404 HTTP 状态码。你可以创建一个 <code>resoucres/views/errors/404.blade.php</code> 文件。该文件会在应用抛出 404 错误时自动的提供服务。</p>
<p>在该目录下的视图的命名应该与 HTTP 状态码相对应。</p>
<h2 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h2><p>laravel 的日志系统是基于强大的 <a href="http://github.com/seldaek/monolog" target="_blank" rel="external">Monolog</a> 类库的。默认的，laravel 设置了 <code>storage/logs</code> 目录来存放日志文件。你可以使用 <code>Log</code> 假面来记录日志信息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Log</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Show the profile for the given user.</span></div><div class="line"><span class="comment">   * </span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showProfile</span><span class="params">($id)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     Log::info(<span class="string">'Showing user profile for user: '</span> . $id);</div><div class="line"></div><div class="line">     <span class="keyword">return</span> view(<span class="string">'user.profile'</span>, [<span class="string">'user'</span> =&gt; User:findOrFail($id)]);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>日志记录器根据 <a href="http://tools.ietf.org/html/rfc5424" target="_blank" rel="external">RFC 5424</a> 规范定义了 8 中日志等级：<strong>emergency</strong>,<strong>alert</strong>,<strong>critical</strong>,<strong>error</strong>,<strong>warning</strong>,<strong>notice</strong>,<strong>info</strong> 和 <strong>debug</strong>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Log::emergency($error);</div><div class="line">Log::alert($error);</div><div class="line">Log::critical($error);</div><div class="line">Log::error($error);</div><div class="line">Log::warning($error);</div><div class="line">Log::notice($error);</div><div class="line">Log::info($error);</div><div class="line">Log::debug($error);</div></pre></td></tr></table></figure>
<p><strong>上下文信息</strong></p>
<p>你可以在入日志方法中传递一个上下文数据的数组，这个上下文数据将会被格式化并在日志信息中显示：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Log::info(<span class="string">'User failed to login.'</span>, [<span class="string">'id'</span> =&gt; $user-&gt;id]);</div></pre></td></tr></table></figure>
<p><strong>访问底层的 Monolog 实例</strong></p>
<p>Monolog 拥有多种额外日志处理方法。如果你需要，你可以在 laravel 中使用下面的方式访问底层的 Monolog 实例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$monolog = Log::getMonolog();</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/05/laravel-from-scratch-encryption/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/05/laravel-from-scratch-encryption/" itemprop="url">laravel 基础教程 —— 加密</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-05T21:06:58+08:00">
                2016-06-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h1><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>在你使用 laravel 的加密之前，你应该先在你的 <code>config/app.php</code> 文件中设置 <code>key</code> 选项，该选项的值应该是一个 32 位的随机字符串。如果这个值没有设置正确，那么 laravel 中所有的加密都是不安全的。</p>
<h2 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h2><p><strong>对值进行加密</strong></p>
<p>你可以使用 <code>Crypt</code> 假面来加密一个值。所有的加密都是使用的 OpenSSL 和 <code>AES-256-CBC</code> 算法。除此之外，所有加密后的值都会伴随一个消息认证码（MAC）用来检测任何的消息变动。<br>比如，我们可以使用 <code>encrypt</code> 方法来加密一个秘钥然后将其存储到 Eloquent 模型中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Crypt</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Store a secret message for the user.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> Request $request</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">storeSecret</span><span class="params">(Request $request, $id)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $user = User::findOrFail($id);</div><div class="line"></div><div class="line">     $user-&gt;fill([</div><div class="line">        <span class="string">'secret'</span> =&gt; Crypt::encrypt($request-&gt;secret)</div><div class="line">      ])-&gt;save();</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：加密后的值在加密期间是通过 <code>serialize</code> 来传递的。这意味着你可以对对象和数组进行加密。从而，非 PHP 客户端在接收加密后的值之后还需要对数据进行反序列化操作。</p>
</blockquote>
<p><strong>对值进行解密</strong></p>
<p>当然，你可以使用 <code>Crypt</code> 假面的 <code>decrypt</code> 方法来对值进行解密。如果值不能被解密，比如 MAC 验证失败，那么会抛出一个 <code>Illuminate\Contracts\Encryption\DecryptException</code> 错误：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Encryption</span>\<span class="title">DecryptException</span>;</div><div class="line"></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  $decrypted = Crypt::decrypt($encryptedValue);</div><div class="line">&#125; <span class="keyword">catch</span> (DecryptException $e) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/03/laravel-from-scratch-elixir/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/03/laravel-from-scratch-elixir/" itemprop="url">laravel 基础教程 —— 炼金药</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-03T14:49:12+08:00">
                2016-06-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Laravel-Elixir（炼金药）"><a href="#Laravel-Elixir（炼金药）" class="headerlink" title="Laravel Elixir（炼金药）"></a>Laravel Elixir（炼金药）</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Laravel Elixir 为你的应用定义基础的 <a href="http://gulpjs.com/" target="_blank" rel="external">Gulp</a> 任务提供了简单流利的 API。Elixir 提供了几种常用的 CSS 和 JavaScript 预处理器和测试工具。Elixir 允许你通过链式调用来对你的资源管道进行流利的操作。比如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> (<span class="params">mix</span>) </span>&#123;</div><div class="line">  mix.sass(<span class="string">'app.scss'</span>)</div><div class="line">     .coffee(<span class="string">'app.coffee'</span>);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>如果你曾对如何使用 Gulp 和资源预编译有所疑惑，那么你肯定会爱上 Laravel Elixir。事实上，你也可以在开发应用的时候不使用它。你可以自由的使用任何的资源管道工具，或者一点也不用。</p>
<h2 id="安装-amp-起步"><a href="#安装-amp-起步" class="headerlink" title="安装 &amp; 起步"></a>安装 &amp; 起步</h2><h3 id="安装-Node"><a href="#安装-Node" class="headerlink" title="安装 Node"></a>安装 Node</h3><p>在触碰到 Elixir 之前，你首先需要确定你的机器中已经安装了 Node:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">node -v</div></pre></td></tr></table></figure>
<p>默认的，Laravel Homestead 包含了所有你所需要的；事实上，如果你使用 Vagrant，你也是可以非常简单的通过 <a href="http://nodejs.org/download/" target="_blank" rel="external">这里</a> 来进行安装 Node。</p>
<h3 id="Gulp"><a href="#Gulp" class="headerlink" title="Gulp"></a>Gulp</h3><p>接着，你需要通过 NPM 中安装 <a href="http://gulpjs.com/" target="_blank" rel="external">Gulp</a> 到全局:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install --<span class="keyword">global</span> gulp</div></pre></td></tr></table></figure>
<p>如果你使用了版本控制器，你可能希望去运行 <code>npm shrinkwrap</code> 来锁住你的 NPM 依赖：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm shrinkwrap</div></pre></td></tr></table></figure>
<p>一旦你运行了这条命令。你可以自由的提交 <code>npm-shrinkwrap.json</code> 文件到源码控制器中去。</p>
<h3 id="Laravel-Elixir"><a href="#Laravel-Elixir" class="headerlink" title="Laravel Elixir"></a>Laravel Elixir</h3><p>最后剩下的就是安装 Elixir 了！在一个新的 laravel 应用中，你会在根目录中发现 <code>package.json</code> 文件。你可以把它想象成 <code>composer.json</code> 文件。它的不同之处就是它定义的是 Node 依赖，而不是 PHP。你可以通过下面的命令来安装这些依赖：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install</div></pre></td></tr></table></figure>
<p>如果你是在 Windows 系统中进行开发，或者运行在虚拟机中的 Windows 系统，你需要运行 <code>npm install</code> 命令的同时添加 <code>--no-bin-links</code> 选项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install --no-bin-links</div></pre></td></tr></table></figure>
<h2 id="运行-Elixir"><a href="#运行-Elixir" class="headerlink" title="运行 Elixir"></a>运行 Elixir</h2><p>Elixir 是建立于 Gulp 之上的，所以运行 Elixir 任务你只需要在终端运行 <code>gulp</code> 命令就行了。添加 <code>--production</code> 标识到命令会指导 Elixir 去压缩你的 CSS 和 JavaScript 文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Run all tasks...</span></div><div class="line">gulp</div><div class="line"></div><div class="line"><span class="comment">// Run all tasks and minify all CSS and JavaScript...</span></div></pre></td></tr></table></figure>
<p><strong>监控资源文件的变动</strong></p>
<p>为了不让你每次文件变动之后还要重新运行 <code>gulp</code> 命令，你应该使用 <code>gulp watch</code> 命令来监控资源文件的变动。这个命令会持续的在你的终端中运行。当检测到资源文件的变动，新的文件将自动编译完成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gulp watch</div></pre></td></tr></table></figure>
<h2 id="与样式文件合作"><a href="#与样式文件合作" class="headerlink" title="与样式文件合作"></a>与样式文件合作</h2><p> 在你项目的根目录中有一个 <code>gulpfile.js</code> 文件，该文件包含了所有的 Elixir 任务。Elixir 任务可以被链式的调用，会通过有序的传递来对你的资源文件进行编译。</p>
<h3 id="Less"><a href="#Less" class="headerlink" title="Less"></a>Less</h3><p>你可以使用 <code>less</code> 方法来将 less 文件编译为 CSS。<code>less</code> 方法假设你的 less 文件存放在 <code>resources/assets/less</code> 目录中。默认的，在下面的示例中，任务运行的结果将编译的 CSS 文件存放在 <code>public/css/app.css</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line"> mix.less(<span class="string">'app.less'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>你也可以合并多个 less 文件到一个单独的 CSS 文件中。默认的，他们将被编译为 <code>public/css/app.css</code> 文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">mix.less([</div><div class="line">  <span class="string">'app.less'</span>,</div><div class="line">  <span class="string">'controllers.less'</span></div><div class="line">]); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>如果你希望将编译的文件存放到自定义的位置，那么你可以传递第二个参数到 less 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">mix.less(<span class="string">'app.less'</span>, <span class="string">'public/stylesheets'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// Specifying a specific output filename...</span></div><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">mix.less(<span class="string">'app.less'</span>, <span class="string">'public/stylesheets/style.css'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="sass"><a href="#sass" class="headerlink" title="sass"></a>sass</h3><p><code>sass</code> 方法允许你讲 sass 文件编译为 CSS。它假定你的 Sass 文件存放在 <code>resources/assets/sass</code>，你可以像下面的方式来使用该方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.sass(<span class="string">'app.scss'</span>); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>就像 <code>less</code> 方法一样，你可以编译多个 Sass 文件到一个 CSS 文件中，还可以将编译的结果存放到指定的位置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.sass([</div><div class="line">    <span class="string">'app.scss'</span>,</div><div class="line">    <span class="string">'controllers.scss'</span></div><div class="line">  ], <span class="string">'public/assets/css'</span>); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="原生-CSS"><a href="#原生-CSS" class="headerlink" title="原生 CSS"></a>原生 CSS</h3><p>如果你希望合并多个 CSS 文件到一个文件中，你可以使用 <code>styles</code> 方法。你需要传递文件的路径是相对于 <code>resources/assets/css</code> 目录的，并且默认的合并的结果将会被存放到 <code>public/css/all.css</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.styles([</div><div class="line">    <span class="string">'normalize.css'</span>,</div><div class="line">    <span class="string">'main.css'</span></div><div class="line">  ]);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>当然，你也是可以自定义输出结果的路径：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.styles([</div><div class="line">    <span class="string">'normalize.css'</span>,</div><div class="line">    <span class="string">'main.css'</span></div><div class="line">  ], <span class="string">'public/assets/css'</span>); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="编译地图"><a href="#编译地图" class="headerlink" title="编译地图"></a>编译地图</h3><p>编译地图是开箱即用的。所以，对于所有的被编译后的文件你都可以在相同的目录下发现 <code>*.css.map</code> 文件。这个地图文件可以使你在浏览器中追踪到编译前代码的位置，这样方便于调试。</p>
<p>如果你不希望生成地图，你可以在配置中进行关闭：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">elixir.config.sourcemaps = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.sass(<span class="string">'app.scss'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="与脚本合作"><a href="#与脚本合作" class="headerlink" title="与脚本合作"></a>与脚本合作</h2><p>Elixr 也提供了多种方法来帮助你协同 JavaScript 的工作，例如 ECMAPScript 6，CoffeeScript 的编译，Browserify 模块的加载，脚本的压缩，或者是简单的原生 JavaScript 文件的合并，这都不是问题！</p>
<h3 id="CoffeeScript"><a href="#CoffeeScript" class="headerlink" title="CoffeeScript"></a>CoffeeScript</h3><p><code>coffee</code> 方法可以用来编译 CoffeeScript 到原生 JavaScript。<code>coffee</code> 方法可以接收一个字符串或者一个 CoffeeScript 文件的数组来进行文件的编译，它假设你的 CoffeeScript 文件存放在 <code>resources/assets/coffee</code> 目录，并且合并生成的 JavaScript 文件到 <code>public/js/app.js</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.coffee([<span class="string">'app.coffee'</span>, <span class="string">'controllers.coffee'</span>]);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="Browserify"><a href="#Browserify" class="headerlink" title="Browserify"></a>Browserify</h3><p>Elixir 也附带了 <code>browserify</code> 方法，该方法可以在浏览器中给你提供你所需要模块的加载，并且允许你使用 ECMAScript 6 和 JSX。</p>
<p>这个任务假设你的脚本存放在 <code>resources/assets/js</code> 并且会将结果文件输出到 <code>public/js/main.js</code>。你也可以传递第二个参数来指定输出的位置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.browserify(<span class="string">'main.js'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// Specifying a specific output filename...</span></div><div class="line">elixir(<span class="function"><span class="keyword">function</span><span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.browserify(<span class="string">'main.js'</span>, <span class="string">'public/javascripts/main.js'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>而 Browserify 附带了 Partialify 和 Babelify 转换器，你可以自由的安装你所希望的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install aliasify --save-dev</div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">elixir.config.js.browserify.transformers.push(&#123;</div><div class="line">  name: <span class="string">'aliasify'</span>,</div><div class="line">  options: &#123;&#125; </div><div class="line">&#125;);</div><div class="line"></div><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.browserify(<span class="string">'main.js'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="Babel"><a href="#Babel" class="headerlink" title="Babel"></a>Babel</h3><p><code>babel</code> 方法可以使你编译 <code>ECMAScript 6 和 7</code> 和 <code>JSX</code> 到原生的 JavaScript。该方法接收一个文件列表相对于 <code>resources/assets/js</code> 目录的数组，并且在 <code>public/js</code> 目录中生成 <code>all.js</code> 文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.babel([</div><div class="line">    <span class="string">'order.js'</span>,</div><div class="line">    <span class="string">'product.js'</span>,</div><div class="line">    <span class="string">'react-component.jsx'</span></div><div class="line">  ]); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>你可以传递第二个参数来指定不同的输出路径。除了进行 Babel 编译，其方法的功能和 <code>mix.scripts</code> 一样。</p>
<h3 id="Scripts"><a href="#Scripts" class="headerlink" title="Scripts"></a>Scripts</h3><p>如果你想要将多个 JavaScript 文件合并到一个文件中，你可以使用 <code>scripts</code> 方法。</p>
<p><code>scripts</code> 方法假设你所有的文件都相对于 <code>resouces/assets/js</code> 目录，并且会默认的将结果编译到 <code>public/js/all.js</code> 文件中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.scripts([</div><div class="line">    <span class="string">'jquery.js'</span>,</div><div class="line">    <span class="string">'app.js'</span></div><div class="line">  ]);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>如果你需要合并多个文件到多个不同的路径，你可以通过多次链式调用并传递第二个参数作为指定输出的路径：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.scripts([<span class="string">'app.js'</span>, <span class="string">'controllers.js'</span>], <span class="string">'public/js/app.js'</span>)</div><div class="line">     .scripts([<span class="string">'forum.js'</span>, <span class="string">'threads.js'</span>], <span class="string">'public/js/forum.js'</span>);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>如果你需要合并指定目录下的所有脚本文件，你可以使用 <code>scriptIn</code> 方法。合并的结果将存放到 <code>public/js/all.js</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.scriptsIn(<span class="string">'public/js/some/directory'</span>)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="复制文件-amp-目录"><a href="#复制文件-amp-目录" class="headerlink" title="复制文件 &amp; 目录"></a>复制文件 &amp; 目录</h2><p><code>copy</code> 方法可以用来复制文件和目录到一个新的位置。所有的操作都是相对于项目的根目录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.copy(<span class="string">'vendor/foo/bar.css'</span>, <span class="string">'public/css/bar.css'</span>)</div><div class="line">&#125;)</div><div class="line"></div><div class="line">elixir(<span class="function"><span class="keyword">function</span><span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.copy(<span class="string">'vendor/package/views'</span>, <span class="string">'resources/views'</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h2 id="版本-缓存移除"><a href="#版本-缓存移除" class="headerlink" title="版本 / 缓存移除"></a>版本 / 缓存移除</h2><p>对于许多开发者比较痛苦的事就是手动的对资源文件增加时间戳或者唯一的 token 标识来强迫浏览器重新加载新的资源文件。Elixir 可以通过 <code>version</code> 方法来帮你自动的完成这些。</p>
<p><code>version</code> 方法接收文件名称相对于 <code>public</code> 目录，并且它会自动的为文件名增加一个独特的 hash，这样就可以自动的进行缓存清除了。比如，新生成的文件名看上去像这样：<code>all-16d570a7.css</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.version(<span class="string">'css/all.css'</span>) </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在生成版本化的文件之后，你可以使用 laravel 的全局帮助函数 <code>elixir</code> 在你的视图文件中进行加载适当的 hashed 资源。<code>elixir</code> 方法会自动的判断文件的名称：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"&#123;&#123; elixir('css/all.css') &#125;&#125;"</span>&gt;</div></pre></td></tr></table></figure>
<p><strong>对多个文件进行版本化</strong></p>
<p>你可以传递一个数组到 <code>version</code> 方法来进行多个文件的版本化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.version([<span class="string">'css/all.css'</span>, <span class="string">'js/app.js'</span>]);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>一旦文件本版本化，你就可以使用 laravel 的 <code>elixir</code> 方法去生成版本化的 link。记住，你只需要向 <code>elixir</code> 帮助方法中传递文件名的前缀就可以了，并不需要填写 hash 后的文件名。帮助方法会自动的识别 hash 后的文件名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"&#123;&#123; elixir('css/all.css') &#125;&#125;"</span>&gt;</div><div class="line"></div><div class="line">&lt;script src=<span class="string">"&#123;&#123; elixir('js/app.js') &#125;&#125;"</span>&gt;&lt;/script&gt;</div></pre></td></tr></table></figure>
<h2 id="BrowserSync"><a href="#BrowserSync" class="headerlink" title="BrowserSync"></a>BrowserSync</h2><p>BrowserSync 可以在你的前端资源文件变更之后自动的刷新的你浏览器。你可以使用 <code>browserSync</code> 方法来指导 Elixir 当你运行 <code>gulp watch</code> 命令时启动 BrowserSync 服务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.browserSync(); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>一旦你运行 <code>gulp watch</code>，你可以通过访问你的应用使用 3000 端口来启用 browsersyncing: <code>http://homestead.app:3000</code>。如果你使用了 <code>homestead.app</code> 之外的域名作为本地开发的支持，你可以传递一个 <a href="http://www.browsersync.io/docs/options/" target="_blank" rel="external">options</a> 数组到第一个参数到 <code>browserSync</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.browserSync(&#123;</div><div class="line">    proxy: <span class="string">'project.app'</span></div><div class="line">  &#125;) </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="调用已存在的-Gulp-任务"><a href="#调用已存在的-Gulp-任务" class="headerlink" title="调用已存在的 Gulp 任务"></a>调用已存在的 Gulp 任务</h2><p>如果你需要从 Elixir 中调用已经存在的 Gulp 任务。你可以使用 <code>task</code> 方法。你可以想象一下你有一个 Gulp 任务是用来简单的发送一个文本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">gulp.task(<span class="string">'speak'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> message = <span class="string">'Tea...Earl Grey...Hot'</span>;</div><div class="line"></div><div class="line">  gulp.src(<span class="string">''</span>).pipe(shell(<span class="string">'say '</span> + message))</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>如果你想通过 Elixir 来调用这个任务，你可以使用 <code>mix.task</code> 方法并且传递任务的名称到该方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.task(<span class="string">'speak'</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><strong>自定义监控</strong></p>
<p>如果你需要注册一个监控者在你的自定义任务中监控每次文件的变更。你可以传递一个正则表达式作为第二个参数到 <code>task</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.task(<span class="string">'speak'</span>, <span class="string">'app/**/*.php'</span>) </div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h2 id="编写-Elixir-扩展"><a href="#编写-Elixir-扩展" class="headerlink" title="编写 Elixir 扩展"></a>编写 Elixir 扩展</h2><p>如果你需要比 Elixir <code>task</code> 方法所提供的更高的灵活性，你可以创建自己的 Elixir 扩展。Elixir 扩展允许你传递参数到你的自定义任务中。比如，你可以编写一个下面类似的扩展：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// File: elixir-extensions.js</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> gulp = <span class="keyword">require</span>(<span class="string">'gulp'</span>)</div><div class="line"><span class="keyword">var</span> shell = <span class="keyword">require</span>(<span class="string">'gulp-shell'</span>)</div><div class="line"><span class="keyword">var</span> Elixir = <span class="keyword">require</span>(<span class="string">'laravel-elixir'</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> Task = Elixir.Task</div><div class="line"></div><div class="line">Elixi.extends(<span class="string">'speak'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(message)</span> </span>&#123;</div><div class="line">  <span class="keyword">new</span> Task(<span class="string">'speak'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> gulp.src(<span class="string">''</span>).pipe(shell(<span class="string">'say '</span> + message))</div><div class="line">  &#125;)  </div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// mix.speak('Hello World')</span></div></pre></td></tr></table></figure>
<p>就是这么简单。你应该注意，任务的专有逻辑应该编写在方法中传递给 <code>Tast</code> 构造函数作为第二个参数。你也可以将其存放在 Gulpfile 的顶部或者提取到独立的扩展文件中。比如，你可以存放你的扩展到 <code>elixir-extendsions.js</code>，然后在你的 <code>Gulpfile</code> 文件中进行载入：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// File: Gulpfile.js</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> elixir = <span class="keyword">require</span>(<span class="string">'laravel-elixir'</span>)</div><div class="line"></div><div class="line"><span class="keyword">require</span>(<span class="string">'./elixir-extendsions'</span>)</div><div class="line"></div><div class="line">elixir(<span class="function"><span class="keyword">function</span> <span class="params">(mix)</span> </span>&#123;</div><div class="line">  mix.speak(<span class="string">'Tea, Earl Grey, Hot'</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><strong>自定义监控者</strong><br>如果你希望在运行 <code>gulp watch</code> 时，你的自定义任务可以在文件变更时自动的触发，你可以注册一个监控者：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Task(<span class="string">'speak'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> gulp.src(<span class="string">''</span>).pipe(shell(<span class="string">'say '</span> + mesage))</div><div class="line">&#125;)</div><div class="line">.watch(<span class="string">'./app/**'</span>)</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/03/laravel-from-scratch-collections/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/03/laravel-from-scratch-collections/" itemprop="url">laravel 基础教程 —— 集合</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-03T07:01:48+08:00">
                2016-06-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><code>Illuminate\Support\Collection</code> 类提供了对数组数据流利操作的封装。比如，看下面的延时代码。我们会使用 <code>collect</code> 帮助方法从一个数组中创建一个新的集合实例，然后运行 <code>strtoupper</code> 方法转为大写再剔除集合中的空元素：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'taylor'</span>, <span class="string">'abigail'</span>, <span class="keyword">null</span>])-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> strtoupper($name); </div><div class="line">&#125;)</div><div class="line">-&gt;reject(<span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">empty</span>($name);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>就如你所看到的，<code>Collection</code> 类允许你链式的调用它的方法，就是这样提供了一种流利的映射的执行能力的同时缩小了底层的数组。通常情况下，所有的 <code>Collection</code> 方法都会返回一个全新的 <code>Collection</code> 实例。</p>
<h2 id="创建集合"><a href="#创建集合" class="headerlink" title="创建集合"></a>创建集合</h2><p>就如上面的代码，<code>collect</code> 帮助方法会根据给定的数组返回一个新的 <code>Illuminate\Support\Collection</code> 实例。所以，创建一个集合是非常的简单：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</div></pre></td></tr></table></figure>
<p>默认的，Eloquent 模型集合总是返回 <code>Collection</code> 的实例。事实上，你可以在你的应用中任意位置使用 <code>Collection</code> 类。</p>
<h2 id="可用的方法"><a href="#可用的方法" class="headerlink" title="可用的方法"></a>可用的方法</h2><p>在文档的余下部分，我们将探讨 <code>Collection</code> 类中所有可用的方法。你应该记住，所有的这些方法都可以链式调用来流利的操作底层的数组。另外，几乎每一个方法都会返回一个新的 <code>Collection</code> 实例，这允许你可以在必要时保存原始的集合。</p>
<h2 id="方法名单"><a href="#方法名单" class="headerlink" title="方法名单"></a>方法名单</h2><p><code>all()</code></p>
<p><code>all</code> 方法会简单的返回集合中所包含的底层数组:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [1, 2, 3]</span></div></pre></td></tr></table></figure>
<p><code>avg()</code></p>
<p><code>avg</code> 方法会返回集合中所有项的平均值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])-&gt;avg();</div><div class="line"></div><div class="line"><span class="comment">// 3</span></div></pre></td></tr></table></figure>
<p>如果集合中包含的是嵌套的数组或者对象，你应该传递 key 来表明所需要计算的值的平均值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'JavaScript: The Good Parts'</span>, <span class="string">'pages'</span> =&gt; <span class="number">176</span>],</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'JavaScript: The Definitive Guide'</span>, <span class="string">'pages'</span> =&gt; <span class="number">1096</span>],</div><div class="line">]);</div><div class="line"></div><div class="line">$collection-&gt;avg(<span class="string">'pages'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 636</span></div></pre></td></tr></table></figure>
<p><code>chunk()</code></p>
<p><code>chunk</code> 方法会根据给定的大小来将集合分割成多个小的集合：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>]);</div><div class="line"></div><div class="line">$chunks = $collection-&gt;chunk(<span class="number">4</span>);</div><div class="line"></div><div class="line">$chunks-&gt;toArray();</div><div class="line"></div><div class="line"><span class="comment">// [[1, 2, 3, 4], [5, 6, 7]]</span></div></pre></td></tr></table></figure>
<p>该方法在视图中使用类似于 Bootstrap 的网格系统时特别有用。想象一下你有一个关于 Eloquent 模型的集合想要在网格中显示：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">foreach</span> ($products-&gt;chunk(<span class="number">3</span>) <span class="keyword">as</span> $chunk)</div><div class="line">  &lt;div class="row"&gt;</div><div class="line">    @<span class="keyword">foreach</span> ($chunk <span class="keyword">as</span> $product)</div><div class="line">      &lt;div class="col-xs-4"&gt;&#123;&#123; $product-&gt;name &#125;&#125;&lt;/div&gt;</div><div class="line">    @<span class="keyword">endforeach</span></div><div class="line">  &lt;/div&gt;</div><div class="line">@<span class="keyword">endforeach</span></div></pre></td></tr></table></figure>
<p><code>collapse()</code></p>
<p><code>collapse</code> 方法会将集合中的数组从多维坍塌到一维：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>], [<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]]);</div><div class="line"></div><div class="line">$collapsed = $collection-&gt;collapse();</div><div class="line"></div><div class="line">$collapsed-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [1, 2, 3, 4, 5, 6, 7, 8, 9]</span></div></pre></td></tr></table></figure>
<p><code>combine()</code></p>
<p><code>combine</code> 方法会将一个集合中的 keys 和另外一个集合或数组中的 values 相结合：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'name'</span>, <span class="string">'age'</span>]);</div><div class="line"></div><div class="line">$combined = $collection-&gt;combine([<span class="string">'George'</span>, <span class="number">29</span>]);</div><div class="line"></div><div class="line">$combined-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['name' =&gt; 'George', 'age' =&gt; 29]</span></div></pre></td></tr></table></figure>
<p><code>contains()</code></p>
<p><code>contains</code> 方法来判断集合中是否含有给定的项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'price'</span> =&gt; <span class="number">100</span>]);</div><div class="line"></div><div class="line">$collection-&gt;contains(<span class="string">'Desk'</span>);</div><div class="line"></div><div class="line"><span class="comment">// true</span></div><div class="line"></div><div class="line">$collection-&gt;contains(<span class="string">'New York'</span>);</div><div class="line"></div><div class="line"><span class="comment">// false</span></div></pre></td></tr></table></figure>
<p>你也可以传递键值对到 <code>contains</code> 方法，这将会用来判断集合中是否含有给定的键值对项:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  [<span class="string">'product'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'price'</span> =&gt; <span class="number">200</span>],</div><div class="line">  [<span class="string">'product'</span> =&gt; <span class="string">'Chair'</span>, <span class="string">'price'</span> =&gt; <span class="number">100</span>],</div><div class="line">]);</div><div class="line"></div><div class="line">$collection-&gt;contains(<span class="string">'product'</span>, <span class="string">'Bookcase'</span>);</div><div class="line"></div><div class="line"><span class="comment">// false</span></div></pre></td></tr></table></figure>
<p>最后，你也可以传递一个匿名函数到 <code>contains</code> 方法来提供自己的真值判断逻辑：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$collection-&gt;contains(<span class="function"><span class="keyword">function</span> <span class="params">($key, $value)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $value &gt; <span class="number">5</span>; </div><div class="line">&#125;); </div><div class="line"></div><div class="line"><span class="comment">// false</span></div></pre></td></tr></table></figure>
<p><code>count()</code></p>
<p><code>count</code> 方法会返回集合中项目的总数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]);</div><div class="line"></div><div class="line">$collection-&gt;count();</div><div class="line"></div><div class="line"><span class="comment">// 4</span></div></pre></td></tr></table></figure>
<p><code>diff()</code></p>
<p><code>diff</code> 方法用来比较集合中存在而其他集合或者原生 PHP 的数组不存在的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$diff = $collection-&gt;diff([<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>]);</div><div class="line"></div><div class="line">$diff-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [1, 3, 5]</span></div></pre></td></tr></table></figure>
<p><code>diffKeys()</code></p>
<p><code>diffKeys</code> 方法用来比较集合中存在而其他集合或原生 PHP 数组不存在的键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  <span class="string">'one'</span> =&gt; <span class="number">10</span>,</div><div class="line">  <span class="string">'two'</span> =&gt; <span class="number">20</span>,</div><div class="line">  <span class="string">'three'</span> =&gt; <span class="number">30</span>,</div><div class="line">  <span class="string">'four'</span> =&gt; <span class="number">40</span>,</div><div class="line">  <span class="string">'five'</span> =&gt; <span class="number">50</span>,</div><div class="line">]);</div><div class="line"></div><div class="line">$diff = $collection-&gt;diffKeys([</div><div class="line">  <span class="string">'two'</span> =&gt; <span class="number">2</span>,</div><div class="line">  <span class="string">'four'</span> =&gt; <span class="number">4</span>,</div><div class="line">  <span class="string">'six'</span> =&gt; <span class="number">6</span>,</div><div class="line">  <span class="string">'eight'</span> =&gt; <span class="number">8</span>,</div><div class="line">]);</div><div class="line"></div><div class="line">$diff-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['one' =&gt; 10, 'three' =&gt; 30, 'five' =&gt; 50]</span></div></pre></td></tr></table></figure>
<p><code>each()</code></p>
<p><code>each</code> 方法会迭代集合中的每一项，并将该项传递给所给定的回调：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$collection = $collection-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">($item, $key)</span> </span>&#123;</div><div class="line">  <span class="comment">// </span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">在回调中返回 `<span class="keyword">false</span>` 将会中断迭代：</div><div class="line"></div><div class="line">```php</div><div class="line">$collection = $collection-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">($item, $key)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="comment">/* some condition */</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125; </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>every()</code></p>
<p><code>every</code> 方法会创建一个由每第 N 个元素（包含起始位）所组成的集合：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>]);</div><div class="line"></div><div class="line">$collection-&gt;every(<span class="number">4</span>);</div><div class="line"></div><div class="line"><span class="comment">// ['a', 'e']</span></div></pre></td></tr></table></figure>
<p>你可以传递第二个参数来设置位移：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$collection-&gt;every(<span class="number">4</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="comment">// ['b', 'f']</span></div></pre></td></tr></table></figure>
<p><code>except()</code></p>
<p><code>except</code> 方法返回集合中的项，并在项目中剔除选定的键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'product_id'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'price'</span> =&gt; <span class="number">100</span>, <span class="string">'discount'</span> =&gt; <span class="keyword">false</span>]);</div><div class="line"></div><div class="line">$filtered = $collection-&gt;except([<span class="string">'price'</span>, <span class="string">'discount'</span>]);</div><div class="line"></div><div class="line">$filtered-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['product_id' =&gt; 1, 'name' =&gt; 'Desk']</span></div></pre></td></tr></table></figure>
<p><code>filter()</code></p>
<p><code>filter</code> 方法会根据给定的回调的迭代结果进行过滤，如果回调返回的是真值，该项将会被保留：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]);</div><div class="line"></div><div class="line">$filtered = $collection-&gt;filter(<span class="function"><span class="keyword">function</span> <span class="params">($value, $key)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $value &gt; <span class="number">2</span>; </div><div class="line">&#125;);</div><div class="line"></div><div class="line">$filtered-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [3, 4]</span></div></pre></td></tr></table></figure>
<p><code>rejct</code> 方法与 <code>filter</code> 方法相反。</p>
<p><code>first()</code></p>
<p><code>first</code> 方法会返回集合中第一个回调返回真值的项:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])-&gt;first(<span class="function"><span class="keyword">function</span> <span class="params">($key, $value)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $value &gt; <span class="number">2</span>; </div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 3</span></div></pre></td></tr></table></figure>
<p>你也可以调用无参数的 <code>first</code> 方法，该方法会返回集合中的第一个元素。如果集合是空的，则会返回 <code>null</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])-&gt;first();</div><div class="line"></div><div class="line"><span class="comment">// 1</span></div></pre></td></tr></table></figure>
<p><code>flatMap()</code></p>
<p><code>flatMap</code> 方法会迭代处理所有元素，并将处理后的集合进行扁平化处理（从多维降为一维）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$collection = collect(</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Sally'</span>],</div><div class="line">  [<span class="string">'school'</span> =&gt; <span class="string">'Arkansas'</span>],</div><div class="line">  [<span class="string">'age'</span> =&gt; <span class="number">28</span>]</div><div class="line">);</div><div class="line"></div><div class="line">$flattened = $collection-&gt;flatMap(<span class="function"><span class="keyword">function</span> <span class="params">($values)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> strtoupper($values);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">$flattened-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['name' =&gt; 'SALLY', 'school' =&gt; 'ARKANSAS', 'age' =&gt; 28];</span></div></pre></td></tr></table></figure>
<p><code>flatten()</code></p>
<p><code>flatten</code> 方法将多规格的集合转换为单一格式的集合：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'name'</span> =&gt; <span class="string">'taylor'</span>, <span class="string">'languages'</span> =&gt; [<span class="string">'php'</span>, <span class="string">'javascript'</span>]]);</div><div class="line"></div><div class="line">$flattened = $collection-&gt;flatten();</div><div class="line"></div><div class="line">$flattened-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['taylor', 'php', 'javascript'];</span></div></pre></td></tr></table></figure>
<p>你也可以传递一个“深度”参数到方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  <span class="string">'Apple'</span> =&gt; [</div><div class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'iPhone 6S'</span>, <span class="string">'brand'</span> =&gt; <span class="string">'Apple'</span>],</div><div class="line">  ],</div><div class="line">  <span class="string">'Samsung'</span> =&gt; [</div><div class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'Galaxy S7'</span>, <span class="string">'brand'</span> =&gt; <span class="string">'Samsung'</span>]</div><div class="line">  ],</div><div class="line">]);</div><div class="line"></div><div class="line">$products = $collection-&gt;flatten(<span class="number">1</span>);</div><div class="line"></div><div class="line">$products-&gt;values()-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">  [</span></div><div class="line"><span class="comment">    ['name' =&gt; 'iPhone 6S', 'brand' =&gt; 'Apple'],</span></div><div class="line"><span class="comment">    ['name' =&gt; 'Galaxy S7', 'brand' =&gt; 'Samsung'],</span></div><div class="line"><span class="comment">  ]</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<p>这里，调用不提供深度的 <code>flatten</code> 方法也会扁平化数组，这将导致返回 <code>[&#39;iPhone 6S&#39;, &#39;Apple&#39;, &#39;GalaxyS7&#39;, &#39;Samsung&#39;]</code>。提供深度可以使你限制拉平嵌套数组的层级。</p>
<p><code>flip()</code></p>
<p><code>flip</code> 方法将会反转键值对：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'name'</span> =&gt; <span class="string">'taylor'</span>, <span class="string">'framework'</span> =&gt; <span class="string">'laravel'</span>]);</div><div class="line"></div><div class="line">$flipped = $collection-&gt;flip();</div><div class="line"></div><div class="line">$flipped-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['taylor' =&gt; 'name', 'laravel' =&gt; 'framework']</span></div></pre></td></tr></table></figure>
<p><code>forget()</code></p>
<p><code>forget</code> 方法根据所提供的键剔除集合中相应的项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'name'</span> =&gt; <span class="string">'taylor'</span>, <span class="string">'framework'</span> =&gt; <span class="string">'laravel'</span>]);</div><div class="line"></div><div class="line">$collection-&gt;forget(<span class="string">'name'</span>);</div><div class="line"></div><div class="line">$collection-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['framework' =&gt; 'laravel']</span></div></pre></td></tr></table></figure>
<blockquote>
<p>注意： 不像其他的集合方法，<code>forget</code> 方法不会返回一个新的修改后的集合，它会直接修改当前的集合。</p>
</blockquote>
<p><code>forPage()</code></p>
<p><code>forPage</code> 方法将返回给定当前页所包含的项的集合：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]);</div><div class="line"></div><div class="line">$chunk = $collection-&gt;forPage(<span class="number">2</span>, <span class="number">3</span>);</div><div class="line"></div><div class="line">$chunk-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [4, 5, 6]</span></div></pre></td></tr></table></figure>
<p>该方法需要传递当前页的数值及每页所包含的数目。</p>
<p><code>get()</code></p>
<p><code>get</code> 方法将根据给定的键从集合中返回项，如果给定键不存在，则返回 <code>null</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'name'</span> =&gt; <span class="string">'taylor'</span>, <span class="string">'framework'</span> =&gt; <span class="string">'laravel'</span>]);</div><div class="line"></div><div class="line">$value = $collection-&gt;get(<span class="string">'name'</span>);</div><div class="line"></div><div class="line"><span class="comment">// taylor</span></div></pre></td></tr></table></figure>
<p>你可以传递第二个参数来作为默认值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'name'</span> =&gt; <span class="string">'taylor'</span>, <span class="string">'framework'</span> =&gt; <span class="string">'laravel'</span>]);</div><div class="line"></div><div class="line">$value = $collection-&gt;get(<span class="string">'foo'</span>, <span class="string">'default-value'</span>);</div><div class="line"></div><div class="line"><span class="comment">// default-value</span></div></pre></td></tr></table></figure>
<p>你也可以传递一个回调作为默认值。回调的结果将会被作为未找到键时的默认值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$collection-&gt;get(<span class="string">'email'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="string">'default-value'</span>; </div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// default-value</span></div></pre></td></tr></table></figure>
<p><code>groupBy()</code></p>
<p><code>groupBy</code> 方法将会根据给定的键将集合进行分组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  [<span class="string">'account_id'</span> =&gt; <span class="string">'account-x10'</span>, <span class="string">'product'</span> =&gt; <span class="string">'Chair'</span>],</div><div class="line">  [<span class="string">'account_id'</span> =&gt; <span class="string">'account-x10'</span>, <span class="string">'product'</span> =&gt; <span class="string">'Bookcase'</span>],</div><div class="line">  [<span class="string">'account_id'</span> =&gt; <span class="string">'account-x11'</span>, <span class="string">'product'</span> =&gt; <span class="string">'Desk'</span>],</div><div class="line">]);</div><div class="line"></div><div class="line">$grouped = $collection-&gt;groupBy(<span class="string">'account_id'</span>);</div><div class="line"></div><div class="line">$grouped-&gt;toArray();</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">  [</span></div><div class="line"><span class="comment">    'account-x10' =&gt; [</span></div><div class="line"><span class="comment">      ['account_id' =&gt; 'account-x10', 'product' =&gt; 'Chair'],</span></div><div class="line"><span class="comment">      ['account_id' =&gt; 'account-x10', 'product' =&gt; 'Bookcase'],</span></div><div class="line"><span class="comment">    ],</span></div><div class="line"><span class="comment">    'account-x11' =&gt; [</span></div><div class="line"><span class="comment">      ['account_id' =&gt; 'account-x11', 'prodcut' =&gt; 'Desk'],</span></div><div class="line"><span class="comment">    ],</span></div><div class="line"><span class="comment">  ]</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<p>除了传递一个字符串 <code>key</code> 之外，你也可以传递一个回调函数。回调函数应该返回你所期望进行分组的键的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$grouped = $collection-&gt;groupBy(<span class="function"><span class="keyword">function</span> <span class="params">($item, $key)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> substr($item[<span class="string">'account_id'</span>], <span class="number">-3</span>); </div><div class="line">&#125;);</div><div class="line"></div><div class="line">$grouped-&gt;toArray();</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">  [</span></div><div class="line"><span class="comment">    'x10' =&gt; [</span></div><div class="line"><span class="comment">      ['account_id' =&gt; 'account-x10', 'product' =&gt; 'Chair'],</span></div><div class="line"><span class="comment">      ['account_id' =&gt; 'account-x10', 'product' =&gt; 'Bookcase'],</span></div><div class="line"><span class="comment">    ],</span></div><div class="line"><span class="comment">    'x11' =&gt; [</span></div><div class="line"><span class="comment">      ['account_id' =&gt; 'account-x11', 'product' =&gt; 'Desk'],</span></div><div class="line"><span class="comment">    ],</span></div><div class="line"><span class="comment">  ]</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<p><code>has()</code></p>
<p><code>has</code> 方法用来判断集合中是否存在给定的键:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'account_id'</span> =&gt; <span class="number">1</span>, <span class="string">'product'</span> =&gt; <span class="string">'Desk'</span>]);</div><div class="line"></div><div class="line">$collection-&gt;has(<span class="string">'email'</span>);</div><div class="line"></div><div class="line"><span class="comment">// false</span></div></pre></td></tr></table></figure>
<p><code>implode()</code></p>
<p><code>implode</code> 方法会将集合中的项连接成字符串。其参数取决于集合中的项目类型。</p>
<p>如果集合中包含的是键值对数组或对象，你就应该传递一个键到方法来表明你想要连接的值，然后紧跟着一个胶连字符串参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  [<span class="string">'account_id'</span> =&gt; <span class="number">1</span>, <span class="string">'product'</span> =&gt; <span class="string">'Desk'</span>],</div><div class="line">  [<span class="string">'account_id'</span> =&gt; <span class="number">2</span>, <span class="string">'product'</span> =&gt; <span class="string">'Chair'</span>],</div><div class="line">]);</div><div class="line"></div><div class="line">$collection-&gt;implode(<span class="string">'product'</span>, <span class="string">', '</span>);</div><div class="line"></div><div class="line"><span class="comment">// Desk, Chair</span></div></pre></td></tr></table></figure>
<p>如果集合只是包含了简单的字符串或者数组类型的值，你可以直接传递胶连字符串参数到方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])-&gt;implode(<span class="string">'-'</span>);</div><div class="line"></div><div class="line"><span class="comment">// '1-2-3-4-5'</span></div></pre></td></tr></table></figure>
<p><code>intersect()</code></p>
<p><code>intersect</code> 方法返回给定数组与集合的交集：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'Desk'</span>, <span class="string">'Sofa'</span>, <span class="string">'Chair'</span>]);</div><div class="line"></div><div class="line">$intersect = $collection-&gt;intersect([<span class="string">'Desk'</span>, <span class="string">'Chair'</span>, <span class="string">'Bookcase'</span>]);</div><div class="line"></div><div class="line">$intersect-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [0 =&gt; 'Desk', 2 =&gt; 'Chair']</span></div></pre></td></tr></table></figure>
<p>就如你所看到的，结果集合将保留原始集合的键。</p>
<p><code>isEmpty()</code></p>
<p><code>isEmpty</code> 方法用来判断集合是否为空，如果集合为空，则返回 <code>true</code>，否则返回 <code>false</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">collect([])-&gt;isEmpty();</div><div class="line"></div><div class="line"><span class="comment">// true</span></div></pre></td></tr></table></figure>
<p><code>keyBy()</code></p>
<p>键值化给定键的集合：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  [<span class="string">'product_id'</span> =&gt; <span class="string">'prod-100'</span>, <span class="string">'name'</span> =&gt; <span class="string">'desk'</span>],</div><div class="line">  [<span class="string">'product_id'</span> =&gt; <span class="string">'prod-200'</span>, <span class="string">'name'</span> =&gt; <span class="string">'chair'</span>],</div><div class="line">]);</div><div class="line"></div><div class="line">$keyed = $collection-&gt;keyBy(<span class="string">'product_id'</span>);</div><div class="line"></div><div class="line">$keyed-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">  [</span></div><div class="line"><span class="comment">    'prod-100' =&gt; ['product_id' =&gt; 'prod-100', 'name' =&gt; 'Desk'],</span></div><div class="line"><span class="comment">    'prod-200' =&gt; ['product_id' =&gt; 'prod-200', 'name' =&gt; 'Chair'],</span></div><div class="line"><span class="comment">  ]</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<p>如果多个项目含有相同的键，那么只有最后一个项目会出现在新的集合中。</p>
<p>你也可以传递你自己的回调来返回集合键的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$keyed = $collection-&gt;keyBy(<span class="function"><span class="keyword">function</span> <span class="params">($item)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> strtoupper($imte[<span class="string">'product_id'</span>]) ;</div><div class="line">&#125;); </div><div class="line"></div><div class="line">$keyed-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">  [</span></div><div class="line"><span class="comment">    'PROD-100' =&gt; ['product_id' =&gt; 'prod-100', 'name' =&gt; 'Desk'],</span></div><div class="line"><span class="comment">    'PROD-200' =&gt; ['product_id' =&gt; 'prod-200', 'name' =&gt; 'Chair'],</span></div><div class="line"><span class="comment">  ]</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<p><code>keys()</code></p>
<p><code>keys</code> 方法返回集合中所有的键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  <span class="string">'prod-100'</span> =&gt; [<span class="string">'product_id'</span> =&gt; <span class="string">'prod-100'</span>, <span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>],</div><div class="line">  <span class="string">'prod-200'</span> =&gt; [<span class="string">'product_id'</span> =&gt; <span class="string">'prod-200'</span>, <span class="string">'name'</span> =&gt; <span class="string">'Chair'</span>],</div><div class="line">]);</div><div class="line"></div><div class="line">$keys = $collection-&gt;keys();</div><div class="line"></div><div class="line">$keys-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['prod-100', 'prod-200']</span></div></pre></td></tr></table></figure>
<p><code>last()</code></p>
<p><code>last</code> 方法返回回调中最后一个返回真值的项:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])-&gt;last(<span class="function"><span class="keyword">function</span> <span class="params">($key, $value)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $value &lt; <span class="number">3</span>; </div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 2</span></div></pre></td></tr></table></figure>
<p>你也可以调用无参数的 <code>last</code> 方法，它将返回集合中最后一个元素，如果集合为空，则返回 <code>null</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])-&gt;last();</div><div class="line"></div><div class="line"><span class="comment">// 4</span></div></pre></td></tr></table></figure>
<p><code>map()</code></p>
<p><code>map</code> 方法会使用给定的回调来进行迭代集合中的所有项，在回调函数中可以自由的修改该项并进行返回，这样新的集合将包含修改后的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$multiplied = $collection-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($item, $key)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $item * <span class="number">2</span>; </div><div class="line">&#125;);</div><div class="line"></div><div class="line">$multiplied-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [2, 4, 6, 8, 10]</span></div></pre></td></tr></table></figure>
<blockquote>
<p>注意：就像其他的集合方法一样，<code>map</code> 返回一个新的集合实例。它并不会突变原集合。如果你想要在原有集合中进行改变，你应该使用 <code>transform</code> 方法。</p>
</blockquote>
<p><code>max()</code></p>
<p><code>max</code> 方法返回给定键中最大的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$max = collect([[<span class="string">'foo'</span> =&gt; <span class="number">10</span>], [<span class="string">'foo'</span> =&gt; <span class="number">20</span>]])-&gt;max(<span class="string">'foo'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 20</span></div><div class="line"></div><div class="line">$max = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])-&gt;max();</div><div class="line"></div><div class="line"><span class="comment">// 5</span></div></pre></td></tr></table></figure>
<p><code>merge()</code></p>
<p><code>merge</code> 方法会合并给定的数组到集合。数组中的值将会覆盖集合中相同键的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$colletion = collect([<span class="string">'product_id'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>]);</div><div class="line"></div><div class="line">$merged = $collection-&gt;merge([<span class="string">'price'</span> =&gt; <span class="number">100</span>, <span class="string">'discount'</span> =&gt; <span class="keyword">false</span>]);</div><div class="line"></div><div class="line">$merged-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['product_id' =&gt; 1, 'name' =&gt; 'Desk', 'price' =&gt; 100, 'discount' =&gt; false]</span></div></pre></td></tr></table></figure>
<p>如果给定的数组的键是数值，则它的值将会被追加在集合的末尾：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'Desk'</span>, <span class="string">'Chair'</span>]);</div><div class="line"></div><div class="line">$merged = $collection-&gt;merge([<span class="string">'Bookcase'</span>, <span class="string">'Door'</span>]);</div><div class="line"></div><div class="line">$merged-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['Desk', 'Chair', 'Bookcase', 'Door']</span></div></pre></td></tr></table></figure>
<p><code>min()</code></p>
<p><code>min</code>方法会返回集合中给定键的最小值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$min = collect([[<span class="string">'foo'</span> =&gt; <span class="number">10</span>], [<span class="string">'foo'</span> =&gt; <span class="number">20</span>]])-&gt;min(<span class="string">'foo'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 10</span></div><div class="line"></div><div class="line">$min = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])-&gt;min();</div><div class="line"></div><div class="line"><span class="comment">// 1</span></div></pre></td></tr></table></figure>
<p><code>only()</code></p>
<p><code>only</code> 方法返回集合中的项，并修改项目中的键值只包含选定的键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'product_id'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'price'</span> =&gt; <span class="number">100</span>, <span class="string">'discount'</span> =&gt; <span class="keyword">false</span>]);</div><div class="line"></div><div class="line">$filtered = $collection-&gt;only([<span class="string">'product_id'</span>, <span class="string">'name'</span>]);</div><div class="line"></div><div class="line">$filtered-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['product_id' =&gt; 1, 'name' =&gt; 'Desk']</span></div></pre></td></tr></table></figure>
<p><code>pluck()</code></p>
<p><code>pluck</code> 方法将根据给定的键检索集合中所有项的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  [<span class="string">'product_id'</span> =&gt; <span class="string">'prod-100'</span>, <span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>],</div><div class="line">  [<span class="string">'product_id'</span> =&gt; <span class="string">'prod-200'</span>, <span class="string">'name'</span> =&gt; <span class="string">'Chair'</span>],</div><div class="line">]);</div><div class="line"></div><div class="line">$plucked = $collection-&gt;pluck(<span class="string">'name'</span>);</div><div class="line"></div><div class="line">$plucked-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['Desk', 'Chair']</span></div></pre></td></tr></table></figure>
<p>你也可以指定将结果如何键化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$plucked = $collection-&gt;pluck(<span class="string">'name'</span>, <span class="string">'product_id'</span>);</div><div class="line"></div><div class="line">$plucked-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['prod-100' =&gt; 'Desk', 'prod-200' =&gt; 'Chair']</span></div></pre></td></tr></table></figure>
<p><code>pop()</code></p>
<p><code>pop</code> 方法将从集合中剔除最后一个元素：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$collection-&gt;pop();</div><div class="line"></div><div class="line"><span class="comment">// 5</span></div><div class="line"></div><div class="line">$collection-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [1, 2, 3, 4]</span></div></pre></td></tr></table></figure>
<p><code>prepend()</code></p>
<p><code>prepend</code> 方法将在集合的起始端添加项目：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$collection-&gt;prepend(<span class="number">0</span>);</div><div class="line"></div><div class="line">$collection-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [0, 1, 2, 3, 4, 5]</span></div></pre></td></tr></table></figure>
<p>你也可以传递第二个参数作为前置项目的键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'one'</span> =&gt; <span class="number">1</span>, <span class="string">'two'</span> =&gt; <span class="number">2</span>]);</div><div class="line"></div><div class="line">$collection-&gt;prepend(<span class="number">0</span>, <span class="string">'zero'</span>);</div><div class="line"></div><div class="line">$collection-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['zero' =&gt; 0, 'one' =&gt; 1, 'two' =&gt; 2]</span></div></pre></td></tr></table></figure>
<p><code>pull()</code></p>
<p><code>pull</code> 方法从集合中返回给定键的同时将其从集合中剔除：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'product_id'</span> =&gt; <span class="string">'prod-100'</span>, <span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>]);</div><div class="line"></div><div class="line">$collection-&gt;pull(<span class="string">'name'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 'Desk'</span></div><div class="line"></div><div class="line">$collection-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['product_id' =&gt; 'prod-100']</span></div></pre></td></tr></table></figure>
<p><code>push()</code></p>
<p><code>push</code> 方法将向集合中添加给定元素到末尾：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]);</div><div class="line"></div><div class="line">$collection-&gt;push(<span class="number">5</span>);</div><div class="line"></div><div class="line">$collection-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [1, 2, 3, 4, 5]</span></div></pre></td></tr></table></figure>
<p><code>put()</code></p>
<p><code>put</code> 方法在集合中设置给定的键和值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'product_id'</span> =&gt; <span class="number">1</span>, <span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>]);</div><div class="line"></div><div class="line">$collection-&gt;put(<span class="string">'price'</span>, <span class="number">100</span>);</div><div class="line"></div><div class="line">$collection-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// ['product_id' =&gt; 1, 'name' =&gt; 'Desk', 'price' =&gt; 100]</span></div></pre></td></tr></table></figure>
<p><code>random()</code></p>
<p><code>random</code> 方法随机的从集合中返回元素：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$collection-&gt;random();</div><div class="line"></div><div class="line"><span class="comment">// 4 - (ertrieved randomly)</span></div></pre></td></tr></table></figure>
<p>你也可以传递一个整型值到 <code>random</code>。如果整型值大于 <code>1</code>。则相应个数的随机项将会被返回：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$random = $collection-&gt;random(<span class="number">3</span>);</div><div class="line"></div><div class="line">$random-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [2, 4, 5] - (retrieved randomly)</span></div></pre></td></tr></table></figure>
<p><code>reduce()</code></p>
<p><code>reduce</code> 方法将会缩小集合收集单个值。它会通过迭代的方式将其值传递给随后的迭代器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</div><div class="line"></div><div class="line">$total = $collection-&gt;reduce(<span class="function"><span class="keyword">function</span> <span class="params">($carry, $item)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $carry + $item; </div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 6</span></div></pre></td></tr></table></figure>
<p> 上面的 <code>$carry</code> 在第一个迭代器中将会是 <code>null</code>；你也可以指定一个起始值到第二个参数：</p>
 <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$collection-&gt;reduce(<span class="function"><span class="keyword">function</span> <span class="params">($carry, $item)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $carry + $item;</div><div class="line">&#125;, <span class="number">4</span>);</div><div class="line"></div><div class="line"><span class="comment">// 10</span></div></pre></td></tr></table></figure>
<p> <code>reject()</code></p>
<p> <code>reject</code> 方法使用给定的回调从集合中返回过滤的值。你需要在回调中返回 <code>true</code> 来让其从结果中移除：</p>
 <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]);</div><div class="line"></div><div class="line">$filtered = $collection=&gt;reject(<span class="function"><span class="keyword">function</span> <span class="params">($value, $key)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $value &gt; <span class="number">2</span>;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">$filtered-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [1, 2]</span></div></pre></td></tr></table></figure>
<p> <code>reverse()</code></p>
<p> <code>reverse</code> 方法会逆序排列集合中的项目：</p>
 <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$reversed = $collection-&gt;reverse();</div><div class="line"></div><div class="line">$reversed-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [5, 4, 3, 2, 1]</span></div></pre></td></tr></table></figure>
<p> <code>search()</code></p>
<p> <code>search</code> 方法根据给定的值搜索集合中的项，如果找到则返回该项的键，如果未找到则返回 <code>false</code>:</p>
 <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>]);</div><div class="line"></div><div class="line">$collection-&gt;search(<span class="number">4</span>);</div><div class="line"></div><div class="line"><span class="comment">// 1</span></div></pre></td></tr></table></figure>
<p>搜索使用的是疏松的比较，如果需要进行严格比较，你应该传递 <code>true</code> 作为第二个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$collection-&gt;search(<span class="string">'4'</span>, <span class="keyword">true</span>);</div><div class="line"></div><div class="line"><span class="comment">// false</span></div></pre></td></tr></table></figure>
<p>另外，你也可以传递一个回调作为搜索的结果判断依据，在回调中首个返回真值的项目将会被检索到：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$collection-&gt;search(<span class="function"><span class="keyword">function</span> <span class="params">($item, $key)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $item &gt; <span class="number">5</span>; </div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 2</span></div></pre></td></tr></table></figure>
<p><code>shift()</code></p>
<p><code>shift</code> 方法会从集合中返回首个元素的同时从集合中剔除：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$collection-&gt;shift();</div><div class="line"></div><div class="line"><span class="comment">// 1</span></div><div class="line"></div><div class="line">$collection-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [2, 3, 4, 5]</span></div></pre></td></tr></table></figure>
<p><code>shuffle()</code></p>
<p><code>shuffle</code> 方法随机打乱集合中项目的顺序：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collect = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$shuffled = $collection-&gt;shuffle();</div><div class="line"></div><div class="line">$shuffled-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [3, 2, 5, 1, 4] // (generated randomly)</span></div></pre></td></tr></table></figure>
<p><code>slice()</code></p>
<p><code>slice</code> 方法根据给定的索引返回集合中的一小片：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]);</div><div class="line"></div><div class="line">$slice = $collection-&gt;slice(<span class="number">4</span>);</div><div class="line"></div><div class="line">$slice-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [5, 6, 7, 8, 9, 10]</span></div></pre></td></tr></table></figure>
<p>如果你想要限制返回的切片的大小，你可以传递期望的大小到第二个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$slice = $collection-&gt;slice(<span class="number">4</span>, <span class="number">2</span>);</div><div class="line"></div><div class="line">$slice-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [5, 6]</span></div></pre></td></tr></table></figure>
<p>返回的切片将会有一个新的数字索引键。如果你想要保留原数组的键，你需要传递 <code>true</code> 到第三个参数。</p>
<p><code>sort()</code></p>
<p><code>sort</code> 方法将对集合进行排序：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">5</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>]);</div><div class="line"></div><div class="line">$sorted = $collection-&gt;sort();</div><div class="line"></div><div class="line">$sorted-&gt;values()-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [1, 2, 3 ,4 ,5]</span></div></pre></td></tr></table></figure>
<p>被排序的集合会保留原始的数组键。上面的例子中我们使用了 <code>values</code> 方法来重置了键到连续的数字索引。</p>
<p>对于嵌套的数组或者对象的排序，请参照 <code>sortBy</code> 和 <code>sortByDesc</code> 方法。</p>
<p>如果你的排序需要更多的逻辑支持，你可以传递一个回调到 <code>sort</code> 方法。你可以参考 PHP 文档的 <a href="http://php.net/manual/en/function.usort.php#refsect1-function.usort-parameters" target="_blank" rel="external">usort</a>, 集合的 <code>sort</code> 方法就是在基于该方法的。</p>
<p><code>sortBy()</code></p>
<p><code>sortBy</code> 方法根据给定的键进行集合排序：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'price'</span> =&gt; <span class="number">200</span>],</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Chair'</span>, <span class="string">'price'</span> =&gt; <span class="number">100</span>],</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Bookcase'</span>, <span class="string">'price'</span> =&gt; <span class="number">150</span>],</div><div class="line">]);</div><div class="line"></div><div class="line">$sorted = $collection-&gt;sortBy(<span class="string">'price'</span>);</div><div class="line"></div><div class="line">$sorted-&gt;values()-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">  [</span></div><div class="line"><span class="comment">    ['name' =&gt; 'Chair', 'price' =&gt; 100],</span></div><div class="line"><span class="comment">    ['name' =&gt; 'Bookcase', 'price' =&gt; 150],</span></div><div class="line"><span class="comment">    ['name' =&gt; 'Desk', 'price' =&gt; 200],</span></div><div class="line"><span class="comment">  ]</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<p>被排序的集合会保留原始的数组键。上面的例子中我们使用了 <code>values</code> 方法来重置了键到连续的数字索引。</p>
<p>你也可以传递你自己的回调作为排序的逻辑依靠：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'colors'</span> =&gt; [<span class="string">'Black'</span>, <span class="string">'Mahogany'</span>]],</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Chair'</span>, <span class="string">'colors'</span> =&gt; [<span class="string">'Black'</span>]],</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Bookcase'</span>, <span class="string">'colors'</span> =&gt; [<span class="string">'Red'</span>, <span class="string">'Beige'</span>, <span class="string">'Brown'</span>]],</div><div class="line">]);</div><div class="line"></div><div class="line">$sorted = $collection-&gt;sortBy(<span class="function"><span class="keyword">function</span> <span class="params">($product, $key)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> count($product[<span class="string">'colors'</span>]);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">$sorted-&gt;values()-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">  [</span></div><div class="line"><span class="comment">    ['name' =&gt; 'Chair', 'colors' =&gt; ['Black']],</span></div><div class="line"><span class="comment">    ['name' =&gt; 'Desk', 'colors' =&gt; ['Black', 'Mahogany']],</span></div><div class="line"><span class="comment">    ['name' =&gt; 'Bookcase', 'colors' =&gt; ['Red', 'Beige', 'Brown']],</span></div><div class="line"><span class="comment">  ]</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<p><code>sortByDesc()</code></p>
<p>该方法与 <code>sortBy</code> 方法有相同的运作方式，但是它是以集合中相反的顺序进行排序。</p>
<p><code>splice()</code></p>
<p><code>splice</code> 方法根据指定的索引来从集合中剔除一片:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$chunk = $collection-&gt;splice(<span class="number">2</span>);</div><div class="line"></div><div class="line">$chunk-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [3, 4, 5]</span></div><div class="line"></div><div class="line">$collection-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [1, 2]</span></div></pre></td></tr></table></figure>
<p>你也可以传递第二个参数到方法来限制切片的大小：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$chunk = $collection-&gt;splice(<span class="number">2</span>, <span class="number">1</span>);</div><div class="line"></div><div class="line">$chunk-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [3]</span></div><div class="line"></div><div class="line">$collection-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [1, 2, 4, 5]</span></div></pre></td></tr></table></figure>
<p>另外，你可以传递第三个参数来作为从原集合中剔除元素的补偿：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$chunk = $collection-&gt;splice(<span class="number">2</span>, <span class="number">1</span>, [<span class="number">10</span>, <span class="number">11</span>]);</div><div class="line"></div><div class="line">$chunk-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [3]</span></div><div class="line"></div><div class="line">$collection-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [1, 2, 10, 11, 4, 5]</span></div></pre></td></tr></table></figure>
<p><code>sum()</code></p>
<p><code>sum</code> 方法返回集合中所有项的和：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])-&gt;sum();</div><div class="line"></div><div class="line"><span class="comment">// 15</span></div></pre></td></tr></table></figure>
<p>如果集合中包含的是嵌套的数组或者对象。你可以传递键来决定需要求和的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'JavaScript: The Good Parts'</span>, <span class="string">'pages'</span> =&gt; <span class="number">176</span>],</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'JavaScript: The Definitive Guide'</span>, <span class="string">'pages'</span> =&gt; <span class="number">1096</span>],</div><div class="line">]);</div><div class="line"></div><div class="line">$collection-&gt;sum(<span class="string">'pages'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 1272</span></div></pre></td></tr></table></figure>
<p>另外，你也可以传递一个回调来决定你所需要进行求和的值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Chair'</span>, <span class="string">'colors'</span> =&gt; [<span class="string">'Black'</span>]],</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'colors'</span> =&gt; [<span class="string">'Black'</span>, <span class="string">'Mahogany'</span>]],</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Bookcase'</span>, <span class="string">'colors'</span> =&gt; [<span class="string">'Red'</span>, <span class="string">'Beige'</span>, <span class="string">'Brown'</span>]],</div><div class="line">]);</div><div class="line"></div><div class="line">$collection-&gt;sum(<span class="function"><span class="keyword">function</span> <span class="params">($product)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> count($product(<span class="string">'colors'</span>)) </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>take()</code></p>
<p><code>take</code> 方法从集合中返回给定数值的项目：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$chunk = $collection-&gt;take(<span class="number">3</span>);</div><div class="line"></div><div class="line">$chunk-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [0, 1, 2]</span></div></pre></td></tr></table></figure>
<p>你也可以传递一个负值到方法，它将从集合的结尾开始返回：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$chunk = $collection-&gt;take(<span class="number">-2</span>);</div><div class="line"></div><div class="line">$chunk-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [4, 5]</span></div></pre></td></tr></table></figure>
<p><code>toArray()</code></p>
<p><code>toArray</code> 方法会将集合退化为原生的 PHP 数组。如果集合的值列是 Eloquent 模型。模型也会被转化为数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'price'</span> =&gt; <span class="number">200</span>]);</div><div class="line"></div><div class="line">$collection-&gt;toArray();</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">  [</span></div><div class="line"><span class="comment">    ['name' =&gt; 'Desk', 'price' =&gt; 200],</span></div><div class="line"><span class="comment">  ]</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<blockquote>
<p>注意：<code>toArray</code> 也会转化所有的嵌套的对象到数组。如果你希望得到底层的原始数组，你可以使用 <code>all</code> 方法。</p>
</blockquote>
<p><code>toJson()</code> </p>
<p><code>toJson</code> 方法转化集合到 JSON：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'name'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'price'</span> =&gt; <span class="number">200</span>]);</div><div class="line"></div><div class="line">$collection-&gt;toJson();</div><div class="line"></div><div class="line"><span class="comment">// '&#123;"name":"Desk","price":200&#125;'</span></div></pre></td></tr></table></figure>
<p><code>transform()</code></p>
<p><code>transform</code> 通过一个回调函数迭代处理集合中的项目。集合中的项目会在被迭代的结果所替换：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]);</div><div class="line"></div><div class="line">$collection-&gt;transform(<span class="function"><span class="keyword">function</span> <span class="params">($item, $key)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $item * <span class="number">2</span>; </div><div class="line">&#125;);</div><div class="line"></div><div class="line">$collection-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [2, 4, 6, 8, 10]</span></div></pre></td></tr></table></figure>
<blockquote>
<p>注意：不像其他的集合方法，<code>transform</code> 会修改原始的集合自身。如果你希望创建一个新的集合来替代，请使用 <code>map</code> 方法。</p>
</blockquote>
<p><code>union()</code></p>
<p><code>union</code> 方法添加给定的数组到集合。如果给定的数组中包含的键在集合中已经存在，那么集合中的键将会被保留：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span> =&gt; [<span class="string">'a'</span>], <span class="number">2</span> =&gt; [<span class="string">'b'</span>]]);</div><div class="line"></div><div class="line">$union = $collection-&gt;union([<span class="number">3</span> =&gt; [<span class="string">'c'</span>], <span class="number">1</span> =&gt; [<span class="string">'b'</span>]]);</div><div class="line"></div><div class="line">$union-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [1 =&gt; ['a'], 2 =&gt; ['b'], 3 =&gt; ['c']]</span></div></pre></td></tr></table></figure>
<p><code>unique()</code></p>
<p><code>unique</code> 方法将返回所有在集合中具有独特性（去重）的项目：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">2</span>]);</div><div class="line"></div><div class="line">$unique = $collection-&gt;unique();</div><div class="line"></div><div class="line">$unique-&gt;values()-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [1, 2, 3, 4]</span></div></pre></td></tr></table></figure>
<p>返回的集合中保留了原始的数组键，上面的例子用使用了 <code>values</code> 方法来重置键到连续的数组索引。</p>
<p>当对嵌套的数组或者对象进行运算时，你应该制定一个键来进行唯一性的判定：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'iPhone 6'</span>, <span class="string">'brand'</span> =&gt; <span class="string">'Apple'</span>, <span class="string">'type'</span> =&gt; <span class="string">'phone'</span>],</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'iPhone 5'</span>, <span class="string">'brand'</span> =&gt; <span class="string">'Apple'</span>, <span class="string">'type'</span> =&gt; <span class="string">'phone'</span>],</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Apple Watch'</span>, <span class="string">'brand'</span> =&gt; <span class="string">'Apple'</span>, <span class="string">'type'</span> =&gt; <span class="string">'watch'</span>],</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Galaxy S6'</span>, <span class="string">'brand'</span> =&gt; <span class="string">'Samsung'</span>, <span class="string">'type'</span> =&gt; <span class="string">'phone'</span>],</div><div class="line">  [<span class="string">'name'</span> =&gt; <span class="string">'Galaxy Gear'</span>, <span class="string">'brand'</span> =&gt; <span class="string">'Samsung'</span>, <span class="string">'type'</span> =&gt; <span class="string">'watch'</span>],</div><div class="line">]);</div><div class="line"></div><div class="line">$unique = $collection-&gt;unique(<span class="string">'brand'</span>);</div><div class="line"></div><div class="line">$unique-&gt;values()-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">  [</span></div><div class="line"><span class="comment">    ['name' =&gt; 'iPhone 6', 'brand' =&gt; 'Apple', 'type' =&gt; 'phone'],</span></div><div class="line"><span class="comment">    ['name' =&gt; 'Galaxy S6', 'brand' =&gt; 'Samsung', 'type' =&gt; 'phone']</span></div><div class="line"><span class="comment">  ]</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<p>你也可以传递自己的回调到方法来进行判定：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$unique = $collection-&gt;unique(<span class="function"><span class="keyword">function</span> <span class="params">($item)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> $item[<span class="string">'brand'</span>].$item(<span class="string">'type'</span>); </div><div class="line">&#125;);</div><div class="line"></div><div class="line">$unique-&gt;values()-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">    [</span></div><div class="line"><span class="comment">        ['name' =&gt; 'iPhone 6', 'brand' =&gt; 'Apple', 'type' =&gt; 'phone'],</span></div><div class="line"><span class="comment">        ['name' =&gt; 'Apple Watch', 'brand' =&gt; 'Apple', 'type' =&gt; 'watch'],</span></div><div class="line"><span class="comment">        ['name' =&gt; 'Galaxy S6', 'brand' =&gt; 'Samsung', 'type' =&gt; 'phone'],</span></div><div class="line"><span class="comment">        ['name' =&gt; 'Galaxy Gear', 'brand' =&gt; 'Samsung', 'type' =&gt; 'watch'],</span></div><div class="line"><span class="comment">    ]</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<p><code>values()</code></p>
<p><code>values</code> 方法返回一个键经过重置成连续整型索引的新集合：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  <span class="number">10</span> =&gt; [<span class="string">'product'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'price'</span> =&gt; <span class="number">200</span>],</div><div class="line">  <span class="number">11</span> =&gt; [<span class="string">'product'</span> =&gt; <span class="string">'Desl'</span>, <span class="string">'price'</span> =&gt; <span class="number">200</span>],</div><div class="line">]);</div><div class="line"></div><div class="line">$values = $collection-&gt;values();</div><div class="line"></div><div class="line">$values-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">  [</span></div><div class="line"><span class="comment">    0 =&gt; ['product' =&gt; 'Desk', 'price' =&gt; 200],</span></div><div class="line"><span class="comment">    1 =&gt; ['product' =&gt; 'Desk', 'price' =&gt; 200],</span></div><div class="line"><span class="comment">  ]</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<p><code>where()</code></p>
<p><code>where</code> 方法根据指定的键值对来进行集合的过滤：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  [<span class="string">'product'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'price'</span> =&gt; <span class="number">200</span>],</div><div class="line">  [<span class="string">'product'</span> =&gt; <span class="string">'Chair'</span>, <span class="string">'price'</span> =&gt; <span class="number">100</span>],</div><div class="line">  [<span class="string">'product'</span> =&gt; <span class="string">'Bookcase'</span>, <span class="string">'price'</span> =&gt; <span class="number">150</span>],</div><div class="line">  [<span class="string">'product'</span> =&gt; <span class="string">'Door'</span>, <span class="string">'price'</span> =&gt; <span class="number">100</span>],</div><div class="line">]);</div><div class="line"></div><div class="line">$filtered = $collection-&gt;where(<span class="string">'price'</span>, <span class="number">100</span>);</div><div class="line"></div><div class="line">$filtered-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">  [</span></div><div class="line"><span class="comment">    ['product' =&gt; 'Chair', 'price' =&gt; 100],</span></div><div class="line"><span class="comment">    ['product' =&gt; 'Door', 'price' =&gt; 100],</span></div><div class="line"><span class="comment">  ]</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<p><code>where</code> 方法会使用严格的比较模式。你可以使用 <code>whereLoose</code> 方法来使用疏松的比较模式。</p>
<p><code>whereLoose()</code></p>
<p><code>whereLoose</code></p>
<p>该方法与 <code>where</code> 方法的运作相同，只是其比较值的方式是疏松模式。</p>
<p><code>whereIn()</code></p>
<p><code>whereIn</code> 方法根据给定的键值对中的值组来对集合中的项目进行过滤：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$collection = collect([</div><div class="line">  [<span class="string">'product'</span> =&gt; <span class="string">'Desk'</span>, <span class="string">'price'</span> =&gt; <span class="number">200</span>],</div><div class="line">  [<span class="string">'product'</span> =&gt; <span class="string">'Chair'</span>, <span class="string">'price'</span> =&gt; <span class="number">100</span>],</div><div class="line">  [<span class="string">'product'</span> =&gt; <span class="string">'Bookcase'</span>, <span class="string">'price'</span> =&gt; <span class="number">150</span>],</div><div class="line">  [<span class="string">'product'</span> =&gt; <span class="string">'Door'</span>, <span class="string">'price'</span> =&gt; <span class="number">100</span>],</div><div class="line">]);</div><div class="line"></div><div class="line">$filtered = $collection-&gt;whereIn(<span class="string">'price'</span>, [<span class="number">150</span>, <span class="number">200</span>]);</div><div class="line"></div><div class="line">$filtered-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">  [</span></div><div class="line"><span class="comment">    ['product' =&gt; 'Bookcase', 'price' =&gt; 150],</span></div><div class="line"><span class="comment">    ['product' =&gt; 'Desk', 'price' =&gt; 200],</span></div><div class="line"><span class="comment">  ]</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
<p><code>whereIn</code> 方法使用的是严格的比较模式，如果你需要使用疏松的比较模式请使用 <code>whereInLoose</code> 方法。</p>
<p><code>whereInLoose()</code> </p>
<p>该方法与 <code>whereIn</code> 方法的运作相同，只是其使用的是疏松的比较模式。</p>
<p><code>zip()</code></p>
<p><code>zip</code> 方法会根据相应的索引将给定的数组中的值与集合中项目的值进行合并：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$collection = collect([<span class="string">'Chair'</span>, <span class="string">'Desk'</span>]);</div><div class="line"></div><div class="line">$zipped = $collection-&gt;zip([<span class="number">100</span>, <span class="number">200</span>]);</div><div class="line"></div><div class="line">$zipped-&gt;all();</div><div class="line"></div><div class="line"><span class="comment">// [['Chair', 100], ['Desk', 200]]</span></div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/02/laravel-from-scratch-cache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/02/laravel-from-scratch-cache/" itemprop="url">laravel 基础教程 —— 缓存</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-06-02T15:51:28+08:00">
                2016-06-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h1><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Laravel 对多种缓存系统提供了统一的 API。缓存的配置文件存放在 <code>config/cache.php</code>。你可以在这个文件中指定整个应用默认使用何种缓存驱动。Laravel 支持当前主流的缓存系统如 Memcached 和 Redis。</p>
<p>缓存的配置文件也包含了一些额外的配置选项，这些选项在文件中都有文档注释，你应该确保自己已经读了这些选项注释。默认的，Laravel 配置使用 <code>file</code> 缓存驱动，该驱动会在文件系统中存储序列化的缓存对象。对于大型应用，建议使用内存级的缓存，如 Memcached 或者 APC。你甚至可以在 laravel 中配置多种缓存配置到相同的驱动。</p>
<h3 id="缓存先决条件"><a href="#缓存先决条件" class="headerlink" title="缓存先决条件"></a>缓存先决条件</h3><p><strong>数据库</strong></p>
<p>当使用 <code>database</code> 缓存驱动时，你需要建立一个表来包含这些缓存项。你可以根据下面的 <code>Schema</code> 定义来建立表文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Schema::create(<span class="string">'cache'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;string(<span class="string">'key'</span>)-&gt;unique();</div><div class="line">  $table-&gt;text(<span class="string">'value'</span>);</div><div class="line">  $table-&gt;integer(<span class="string">'expiration'</span>); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>你也可以通过使用 <code>php artisan cache:table</code> Artisan 命令来生成正确的缓存表结构迁移。</p>
<p><strong>Memcached</strong> </p>
<p>使用 Memcached 缓存需要安装 <a href="http://pecl.php.net/package/memcached" target="_blank" rel="external">Memcached PECL package</a>。</p>
<p>默认的配置基于 <a href="http://php.net/manual/en/memcached.addserver.php" target="_blank" rel="external">Memcached::addServer</a> 使用 TCP/IP：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="string">'memcached'</span> =&gt; [</div><div class="line">  [</div><div class="line">    <span class="string">'host'</span> =&gt; <span class="string">'127.0.0.1'</span>,</div><div class="line">    <span class="string">'port'</span> =&gt; <span class="number">11211</span>,</div><div class="line">    <span class="string">'weight'</span> =&gt; <span class="number">100</span></div><div class="line">  ]</div><div class="line">],</div></pre></td></tr></table></figure>
<p>你也可以使用 UNIX socket 路径来设置 <code>host</code>。如果你这么做，你需要设置 <code>port</code> 为 <code>0</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="string">'memcached'</span> =&gt; [</div><div class="line">  [</div><div class="line">    <span class="string">'host'</span> =&gt; <span class="string">'/var/run/memcached/memcached.sock'</span>,</div><div class="line">    <span class="string">'port'</span> =&gt; <span class="number">0</span>,</div><div class="line">    <span class="string">'weight'</span> =&gt; <span class="number">100</span></div><div class="line">  ],</div><div class="line">],</div></pre></td></tr></table></figure>
<p><strong>Redis</strong></p>
<p>在你使用 Redis 缓存之前，你需要先通过 Composer 安装 <code>predis/predis</code>。<br>关于更多的 Redis 配置信息，你可以参考 <a href="https://laravel.com/docs/5.2/redis#configuration" target="_blank" rel="external">Laravel documentation page</a>。</p>
<h2 id="缓存使用"><a href="#缓存使用" class="headerlink" title="缓存使用"></a>缓存使用</h2><h3 id="获取缓存实例"><a href="#获取缓存实例" class="headerlink" title="获取缓存实例"></a>获取缓存实例</h3><p><code>Illuminate\Contracts\Cache\Factory</code> 和 <code>Illuminate\Contracts\Cache\Repository</code> 契约提供对 Laravel 缓存服务的访问。<code>Factory</code> 契约提供了应用中所有缓存驱动的定义。<code>Repository</code> 契约通常是一个基于你的 <code>cache</code> 配置文件所使用的默认缓存驱动的实现。</p>
<p>事实上，你也可以使用 <code>Cache</code> 假面，在这篇文档中，我们都是使用 <code>Cache</code> 假面进行举例。<code>Cache</code> 假面提供了一种方便简洁的方式来访问 Laravel 底层缓存契约的实现。</p>
<p>例如，让我们引入 <code>Cache</code> 假面到控制器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Cache</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Show a list of all users of the application.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $value = Cache::get(<span class="string">'key'</span>);</div><div class="line"></div><div class="line">     <span class="comment">//</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>访问多种缓存存储</strong></p>
<p>你可以通过 <code>Cache</code> 假面的 <code>store</code> 方法来访问多种缓存存储。传递到 <code>store</code> 方法的 key 应该与你的 <code>cache</code> 配置文件中的 <code>stores</code> 配置项的列表之一相匹配：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$value = Cache::store(<span class="string">'file'</span>)-&gt;get(<span class="string">'foo'</span>);</div><div class="line"></div><div class="line">Cache::store(<span class="string">'redis'</span>)-&gt;put(<span class="string">'bar'</span>, <span class="string">'baz'</span>, <span class="number">10</span>);</div></pre></td></tr></table></figure>
<h3 id="获取缓存项"><a href="#获取缓存项" class="headerlink" title="获取缓存项"></a>获取缓存项</h3><p>你可以通过使用 <code>Cache</code> 假面的 <code>get</code> 方法来从缓存中获取相关项的值。如果该项在缓存中并不存在，则返回 <code>null</code> 。如果你需要，你也可以传递第二个参数到 <code>get</code> 方法，这个参数所传递的值会在缓存中项不存在时被返回:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$value = Cache::get(<span class="string">'key'</span>);</div><div class="line"></div><div class="line">$value = Cache::get(<span class="string">'key'</span>, <span class="string">'default'</span>);</div></pre></td></tr></table></figure>
<p>你甚至可以传递 <code>Closure</code> 作为默认值。如果缓存的项不存在，<code>Closure</code> 所返回的值将被做为默认值。传递闭包的方式可以使你从数据库或者其他外部服务中延迟获取默认值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$value = Cache::get(<span class="string">'key'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> DB::table(...)-&gt;get(); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>检查项是否存在</strong></p>
<p>你可以使用 <code>has</code> 方法来检查缓存中是否存在该项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Cache::has(<span class="string">'key'</span>)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>递增/递减项中的值</strong></p>
<p>你可以使用 <code>increment</code> 和 <code>decrement</code> 方法来调整缓存项目中的整型值。这两个方法都可以接受一个数组作为第二个参数来进行相应的数值调整：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Cache::increment(<span class="string">'key'</span>);</div><div class="line"></div><div class="line">Cache::increment(<span class="string">'key'</span>, $amount);</div><div class="line"></div><div class="line">Cache::decrement(<span class="string">'key'</span>);</div><div class="line"></div><div class="line">Cache::decrement(<span class="string">'key'</span>, $amount);</div></pre></td></tr></table></figure>
<p><strong>检索或更新缓存中的项</strong></p>
<p>有时候，你可能希望从缓存中检索出一个项目，但是当该项不存在的时候，你也想存储一个默认值到该项。比如，你希望从缓存中检索出一个用户。但是他并不存在，所以你需要从数据库中获取到他，然后添加到缓存中。你可以使用 <code>Cache::remember</code> 方法来做到这些：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$value = Cache::remember(<span class="string">'users'</span>, $minutes, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> DB::table(<span class="string">'users'</span>)-&gt;get(); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>如果缓存中没有检索到该项，传递到 <code>remeber</code> 方法中的闭包将会被执行并且其执行结果将会在缓存中进行替换。</p>
<p>你也可以合并 <code>remember</code> 和 <code>forever</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$value = Cache::rememberForever(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> DB::table(<span class="string">'users'</span>)-&gt;get(); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><strong>检索并删除</strong></p>
<p>如果你需要检索一个项目，并在检索到的同时从缓存中删除该项，你可以使用 <code>pull</code> 方法。就像 <code>get</code> 方法一样，如果未检索到该项，将会返回 <code>null</code> :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$value = Cache::pull(<span class="string">'key'</span>);</div></pre></td></tr></table></figure>
<h3 id="存储项目到缓存"><a href="#存储项目到缓存" class="headerlink" title="存储项目到缓存"></a>存储项目到缓存</h3><p>你可以使用 <code>Cache</code> 假面的 <code>put</code> 方法来存储项目到缓存中。当你存储一个项到缓存中时，你需要指定一个该项需要被缓存的分钟值:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Cache::put(<span class="string">'key'</span>, <span class="string">'value'</span>, $minutes);</div></pre></td></tr></table></figure>
<p>除了传递一个数值作为缓存过期的分钟值，你也可以通过传递一个 PHP <code>DateTime</code> 实例来设置缓存的失效时间：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$expiresAt = Carbon::now()-&gt;addMinutes(<span class="number">10</span>);</div><div class="line"></div><div class="line">Cache::put(<span class="string">'key'</span>, <span class="string">'value'</span>, $expiresAt);</div></pre></td></tr></table></figure>
<p><code>add</code> 方法只会在相应的项在缓存中不存在时才会被添加进缓存。该方法会在项目被添加到缓存后返回 <code>true</code>。否则返回 <code>false</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Cache::add(<span class="string">'key'</span>, <span class="string">'value'</span>, $minutes);</div></pre></td></tr></table></figure>
<p><code>forever</code> 方法可以用来将项目永久的添加进缓存。该值只有手动的使用 <code>forget</code> 方法才能被移除：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Cache::forever(<span class="string">'key'</span>, <span class="string">'value'</span>);</div></pre></td></tr></table></figure>
<h3 id="从缓存中移除项目"><a href="#从缓存中移除项目" class="headerlink" title="从缓存中移除项目"></a>从缓存中移除项目</h3><p>你可以使用 <code>Cache</code> 假面的 <code>forget</code> 方法来从缓存中移除某项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Cache::forget(<span class="string">'key'</span>);</div></pre></td></tr></table></figure>
<p>你可以使用 <code>flush</code> 方法来擦除所有的缓存：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Cache::flush();</div></pre></td></tr></table></figure>
<p>擦除缓存并不会根据前缀来进行智能擦除，它会移除所有的缓存。所以如果你的应用和其他的应用共享缓存，你应该谨慎的使用该方法。</p>
<h2 id="缓存标签"><a href="#缓存标签" class="headerlink" title="缓存标签"></a>缓存标签</h2><blockquote>
<p>注意： 缓存标签并不支持 <code>file</code> 或者 <code>database</code> 缓存驱动。另外，对于将多种标签标记为永久存储的驱动，性能最好的是能够提供自动清除过期记录的驱动，比如 <code>memcached</code>。</p>
</blockquote>
<h3 id="存储标记了的项目到缓存"><a href="#存储标记了的项目到缓存" class="headerlink" title="存储标记了的项目到缓存"></a>存储标记了的项目到缓存</h3><p>缓存标签允许你将相关的项目进行关联标记。并且允许一次性清除所有给定标签的缓存项。你可以通过有序的标签数组来访问被标记的缓存项目。比如，让我们访问被标记的项目并使用 <code>put</code> 方法来设置缓存值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Cache::tags([<span class="string">'people'</span>, <span class="string">'artists'</span>])-&gt;put(<span class="string">'John'</span>, $john, $minutes);</div><div class="line"></div><div class="line">Cache::tags([<span class="string">'people'</span>, <span class="string">'authors'</span>])-&gt;put(<span class="string">'Anne'</span>, $anne, $minutes);</div></pre></td></tr></table></figure>
<p>事实上，你并没有被限制只使用 <code>put</code> 方法。你可以在标签中使用任意的缓存存储方法。</p>
<h3 id="访问被标记的缓存项"><a href="#访问被标记的缓存项" class="headerlink" title="访问被标记的缓存项"></a>访问被标记的缓存项</h3><p>为了访问被标记了的缓存项，你需要传递相应的有序列表到 <code>tags</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$john = Cache::tags([<span class="string">'people'</span>, <span class="string">'artists'</span>])-&gt;get(<span class="string">'John'</span>);</div><div class="line"></div><div class="line">$anne = Cache::tags([<span class="string">'people'</span>, <span class="string">'authors'</span>])-&gt;get(<span class="string">'Anne'</span>);</div></pre></td></tr></table></figure>
<p>你可以一次性的擦除分配的标记或者标记列表中的所有项。比如，你可以使用 <code>flush</code> 方法来删除所有的 <code>people</code> 和 <code>authors</code> 标签和两者组成的有序列标签里的所有缓存项。所以，<code>Anne</code> 和 <code>John</code> 都会被从缓存中移除：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Cache::tags([<span class="string">'people'</span>, <span class="string">'authors'</span>])-&gt;flush();</div></pre></td></tr></table></figure>
<p>下面的语句将会作为上面语句的对照，将只会从缓存中删除 <code>authors</code> 标签的项目，所以 <code>Anne</code> 会被删除，而 <code>John</code> 被保留：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Cache::tags(<span class="string">'authors'</span>)-&gt;flush();</div></pre></td></tr></table></figure>
<h2 id="添加自定义的缓存驱动"><a href="#添加自定义的缓存驱动" class="headerlink" title="添加自定义的缓存驱动"></a>添加自定义的缓存驱动</h2><p>为了在自定义的缓存驱动中继承 laravel 的缓存。我们需要使用 <code>Cache</code> 假面的 <code>extend</code> 方法，该方法被用来绑定自定义缓存到底层管理中。通常这些都是在服务提供者中完成。</p>
<p>比如，注册一个新的缓存驱动并命名为 ‘mongo’:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Cache</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Extensions</span>\<span class="title">MongoStore</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CacheServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Perform post-registration booting of services.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     Cache::extend(<span class="string">'mongo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> Cache::repository(<span class="keyword">new</span> MongoStore);</div><div class="line">     &#125;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Register bindings in the container.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="comment">//</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第一个被传递到 <code>extend</code> 方法中的参数应该是驱动的名称。这个名称应该和你的 <code>config/cache.php</code> 配置文件中的 <code>driver</code> 选项一致。而第二个参数是一个闭包，该闭包应该返回一个 <code>Illuminate\Cache\Repository</code> 的实现。在闭包中将会被传递一个 <code>$app</code> 实例，这个实例是 laravel 中的服务容器的实例。</p>
<p><code>Cache::extend</code> 方法的调用应该在 <code>App\Providers\AppServiceProvider</code> 的 <code>boot</code> 方法中完成。或者你可以创建自己的服务提供者来存储这个扩展。但是不要忘记在 <code>config/app.php</code> 文件中进行注册。</p>
<p>为了创建我们自己的缓存驱动，我们首先需要实现 <code>Illuminate\Constracts\Cache\Store</code> 契约的接口。所以，我们的 MongoDB 缓存实现应该看起来像这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Extensions</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MongoStore</span> <span class="keyword">implements</span> \<span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Cache</span>\<span class="title">Store</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">put</span><span class="params">($key, $value, $minutes)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">increment</span><span class="params">($key, $value = <span class="number">1</span>)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decrement</span><span class="params">($key, $value = <span class="number">1</span>)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">forever</span><span class="params">($key, $value)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">forget</span><span class="params">($key)</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">flush</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getPrefix</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们仅仅需要使用 MongoDB 连接来实现这些方法。一旦我们的实现完成，我们就可以完成自己的缓存驱动的注册：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Cache::extend(<span class="string">'mongo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> Cache::repository(<span class="keyword">new</span> MongoStore); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>然后在 <code>config/cache.php</code> 配置文件中更新驱动为的名称 <code>driver</code> 为你的扩展的名称。</p>
<p>如果你在为自定义的缓存文件应该存放在哪里而疑惑，你可以考虑将其发布到 Packagist！或者，你可以在 <code>app</code> 目录中创建一个 <code>Extensions</code> 命名空间。事实上，你应该谨记，laravel 并不死板的限制你的目录结构，你应该可以根据自己的习惯自由的管理你的应用目录结构。</p>
<h2 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h2><p>如果你想在任何缓存被操作时执行额外的代码，你可能需要监听缓存的触发事件。通常的你应该存放这些事件监听器到你的 <code>EventServiceProvider</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * The event listener mappings for the application.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">protected</span> $listen = [</div><div class="line">  <span class="string">'Illuminate\Cache\Events\CacheHit'</span> =&gt; [</div><div class="line">    <span class="string">'App\Listeners\LogCacheHit'</span>,</div><div class="line">  ],</div><div class="line">  <span class="string">'Illuminate\Cache\Events\CacheMissed'</span> =&gt; [</div><div class="line">    <span class="string">'App\Listeners\LogCacheMissed'</span>,</div><div class="line">  ],</div><div class="line">  <span class="string">'Illuminate\Cache\Events\KeyForgotten'</span> =&gt; [</div><div class="line">    <span class="string">'App\Listeners\LogKeyForgotten'</span>,</div><div class="line">  ],</div><div class="line">  <span class="string">'Illuminate\Cache\Events\KeyWritten'</span> =&gt; [</div><div class="line">    <span class="string">'App\Listeners\LogKeyWritten'</span>,</div><div class="line">  ],</div><div class="line"> ];</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/05/27/laravel-from-scratch-billing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/27/laravel-from-scratch-billing/" itemprop="url">laravel 基础教程 —— 计费</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-05-27T16:28:28+08:00">
                2016-05-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="laravel-会计员（Cashier）"><a href="#laravel-会计员（Cashier）" class="headerlink" title="laravel 会计员（Cashier）"></a>laravel 会计员（Cashier）</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Laravel Cashier 提供了一种表现流利的接口来支持 <a href="https://stripe.com/" target="_blank" rel="external">Stripe</a> 和 <a href="https://braintreepayments.com/" target="_blank" rel="external">Braintree</a> 的计费服务。它封装了许多你畏惧编写的认购计费样板。除了基本的认购管理，Cashier 还可以处理优惠券、服务升级、服务替换、认购份额、取消并保留期限内可用、甚至是生成 PDF 类型的发票。</p>
<h2 id="Stripe-配置"><a href="#Stripe-配置" class="headerlink" title="Stripe 配置"></a>Stripe 配置</h2><p><strong>Composer</strong></p>
<p>首先，添加 Strpe 的 Cashier 包到你的 <code>composer.json</code> 文件，然后运行 <code>composer update</code> 命令：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"laravel/cashier"</span>: <span class="string">"~6.0"</span></div></pre></td></tr></table></figure>
<p><strong>服务提供者</strong></p>
<p>然后在 <code>app</code> 配置文件中注册 <code>Laravel\Cashier\CashierServiceProvider</code> 服务提供者。</p>
<p><strong>数据库迁移</strong></p>
<p>在使用 Cashier 之前，我们也需要去准备一下数据库。我们需要在 <code>users</code> 表中添加几列，并且创建一个新的 <code>subscriptions</code> 表来保留客户的认购：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;string(<span class="string">'stripe_id'</span>)-&gt;nullable();</div><div class="line">  $table-&gt;string(<span class="string">'card_brand'</span>)-&gt;nullable();</div><div class="line">  $table-&gt;string(<span class="string">'card_lost_four'</span>)-&gt;nullable();</div><div class="line">  $table-&gt;timestamp(<span class="string">'trial_ends_at'</span>)-&gt;nullable();</div><div class="line">&#125;);</div><div class="line"></div><div class="line">Schema::create(<span class="string">'subscriptions'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;increments(<span class="string">'id'</span>);</div><div class="line">  $table-&gt;integer(<span class="string">'user_id'</span>) ;</div><div class="line">  $table-&gt;string(<span class="string">'name'</span>);</div><div class="line">  $table-&gt;string(<span class="string">'stripe_id'</span>);</div><div class="line">  $table-&gt;string(<span class="string">'stripe_plan'</span>);</div><div class="line">  $table-&gt;integer(<span class="string">'quantity'</span>);</div><div class="line">  $table-&gt;timestamp(<span class="string">'trial_ends_at'</span>)-&gt;nullable();</div><div class="line">  $table-&gt;timestamp(<span class="string">'ends_at'</span>)-&gt;nullable();</div><div class="line">  $table-&gt;timestamps();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>一旦迁移表创建完毕，你可以通过 artisan 命令 <code>migrate</code> 进行迁移操作。</p>
<p><strong>模型起步</strong></p>
<p>接着，你需要在你的模型定义中添加 <code>Billable</code> trait:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Cashier</span>\<span class="title">Billable</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span> </span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">use</span> <span class="title">Billable</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>提供秘钥</strong></p>
<p>然后你需要在 <code>services.php</code> 配置文件中对你的 Stripe 进行配置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="string">'stripe'</span> =&gt; [</div><div class="line">  <span class="string">'model'</span> =&gt; App\User::class,</div><div class="line">  <span class="string">'secret'</span> =&gt; env(<span class="string">'SIRIPE_SECRET'</span>),</div><div class="line">];</div></pre></td></tr></table></figure>
<h2 id="Braintree-配置"><a href="#Braintree-配置" class="headerlink" title="Braintree 配置"></a>Braintree 配置</h2><p><strong>注意事项</strong></p>
<p>对于大多数的操作，Stripe 和 Braintree 在 Cashier 中的方法实现是相同的，两种服务都提供了对使用信用卡进行认购的计费支持。但是 Braintree 也支持通过 PayPal 的支付方式。Braintree 也相应的缺乏一些 Stripe 所支持的特性。你需要根据自身的需求去对比选择使用 Stripe 还是 Braintree。</p>
<ul>
<li>Braintree 支持 PayPal 支付，而 Stripe 不支持。</li>
<li>Braintree 在认购时不支持 <code>increment</code> 和 <code>decrement</code>，这是 Braintree 自身的限制，而不是 Cashier 的局限性。</li>
<li>Braintree 不支持百分比的折扣。这是 Braintree 自身的限制，而不是 Cashier 所限制的。</li>
</ul>
<p><strong>Composer</strong></p>
<p>首先，你需要在你的 <code>composer.json</code> 文件中进行添加 <code>Cashier</code> 的文件包并使用 <code>composer update</code> 命令进行安装：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"laravel/cashier-braintree"</span>: <span class="string">"~1.0"</span></div></pre></td></tr></table></figure>
<p><strong>服务提供者</strong></p>
<p>接着，注册 <code>laravel\Cashier\CashierServiceProvider</code> 服务提供者到你的 <code>app</code> 配置文件。</p>
<p><strong>安排信用优惠</strong></p>
<p>在你使用 Braintree 的 Cashier 之前，你需要先在你的 Braintree 控制面板中定义一个 <code>plan-credit</code> 折扣。这个折扣会被用于正确的按比例从年度改为按月计费或者从月到年计费。你可以在控制面板中定义这个折扣为任意你所希望的值，Cashier 会在我们使用优惠时进行正确的结算。</p>
<p><strong>数据库迁移</strong></p>
<p>在使用 Cashier 之前，我们也需要预先构建好数据库。我们需要在 <code>users</code> 表中添加几列并且创建一个 <code>subscriptions</code> 表来处理所有的用户认购：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;string(<span class="string">'braintree_id'</span>)-&gt;nullable();</div><div class="line">  $table-&gt;string(<span class="string">'paypal_email'</span>)-&gt;nullable();</div><div class="line">  $table-&gt;string(<span class="string">'card_brand'</span>)-&gt;nullable();</div><div class="line">  $table-&gt;string(<span class="string">'card_last_four'</span>)-&gt;nullable();</div><div class="line">  $table-&gt;timestamp(<span class="string">'trial_ends_at'</span>)-&gt;nullable(); </div><div class="line">&#125;);</div><div class="line"></div><div class="line">Schema::create(<span class="string">'subscriptions'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($table)</span> </span>&#123;</div><div class="line">  $table-&gt;increments(<span class="string">'id'</span>);</div><div class="line">  $table-&gt;integer(<span class="string">'user_id'</span>);</div><div class="line">  $table-&gt;string(<span class="string">'name'</span>);</div><div class="line">  $table-&gt;string(<span class="string">'braintree_id'</span>);</div><div class="line">  $table-&gt;string(<span class="string">'braintree_plan'</span>);</div><div class="line">  $table-&gt;integer(<span class="string">'quantity'</span>);</div><div class="line">  $table-&gt;timestamp(<span class="string">'trial_ends_at'</span>)-&gt;nullable();</div><div class="line">  $table-&gt;timestamp(<span class="string">'ends_at'</span>)-&gt;nullable();</div><div class="line">  $table-&gt;timestamps();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>一旦迁移的表结构构建完成，你就可以通过 artisan 命令 <code>migrate</code> 运行迁移操作。</p>
<p><strong>模型起步</strong></p>
<p>接着，在你的模型中添加 <code>Billable</code> trait:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Cashier</span>\<span class="title">Billable</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">use</span> <span class="title">Billable</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>提供配置</strong></p>
<p>然后，你需要在你的 <code>services.php</code> 配置文件中进行相关配置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="string">'braintree'</span> =&gt; [</div><div class="line">  <span class="string">'model'</span> =&gt; App\User::class,</div><div class="line">  <span class="string">'environment'</span> =&gt; env(<span class="string">'BRAINTREE_ENV'</span>),</div><div class="line">  <span class="string">'merchant_id'</span> =&gt; env(<span class="string">'BRAINTREE_MERCHANT_ID'</span>),</div><div class="line">  <span class="string">'public_key'</span> =&gt; env(<span class="string">'BRAINTREE_PUBLIC_KEY'</span>),</div><div class="line">  <span class="string">'private_key'</span> =&gt; env(<span class="string">'BRAINTREE_PRIVATE_KEY'</span>),</div><div class="line">];</div></pre></td></tr></table></figure>
<p>你还需要在你的 <code>AppServiceProvider</code> 服务提供者的 <code>boot</code> 方法中运行下面的 Braintree SDK 的方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Braintree_Configuration::environment(env(<span class="string">'BRAINTREE_ENV'</span>));</div><div class="line">Braintree_Configuration::merchantId(env(<span class="string">'BRAINTREE_MERCHANT_ID'</span>));</div><div class="line">Braintree_Configuration::publicKey(env(<span class="string">'BRAINTREE_PUBLIC_KEY'</span>));</div><div class="line">Braintree_Configuration::privateKey(env(<span class="string">'BRAINTREE_PRIVATE_KEY'</span>));</div></pre></td></tr></table></figure>
<h2 id="订阅-认购"><a href="#订阅-认购" class="headerlink" title="订阅/认购"></a>订阅/认购</h2><h3 id="创建一个认购"><a href="#创建一个认购" class="headerlink" title="创建一个认购"></a>创建一个认购</h3><p>为了创建一个认购，你首先需要先从 billable 模型中提取一个实例，通常情况下它是 <code>App\User</code> 的一个实例。一旦你拥有了一个模型的实例，你就可以使用 <code>newSubscription</code> 方法来创建一个该模型的认购:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$user-&gt;newSubscription(<span class="string">'main'</span>, <span class="string">'monthly'</span>)-&gt;create($creditCardToken);</div></pre></td></tr></table></figure>
<p>传递到 <code>newSubscription</code> 方法的第一个参数应该是认购的名称。如果你的应用仅仅只提供一种单一功能的订阅，你或许可以定义为 <code>main</code> 或者 <code>primary</code>。而第二个参数则是用户需要认购的 Stripe / Braintree 的付费计划。这个值应该和你的 Stripe 或者 Braintree 中的计划标识相对应。</p>
<p><code>create</code> 方法会自动的创建一个认购，并且同客户的 ID 和 其他账单相关的信息更新到数据库。</p>
<p><strong>其他用户详细信息</strong></p>
<p>如果你需要指定添加一些额外的用户信息，你可以在 <code>create</code> 方法中传递第二个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user-&gt;newSubscription(<span class="string">'main'</span>, <span class="string">'monthly'</span>)-&gt;create($creditCardToken, [</div><div class="line">  <span class="string">'email'</span> =&gt; $email,</div><div class="line">]);</div></pre></td></tr></table></figure>
<p> 你可以查看 <a href="https://stripe.com/docs/api#create_customer" target="_blank" rel="external">Stripe</a> 和 <a href="https://developers.braintreepayments.com/reference/request/customer/create/php" target="_blank" rel="external">Braintree</a> 的文档来获取其所支持的额外字段。</p>
<p><strong>优惠</strong></p>
<p>如果你需要在创建一个认购时使用优惠，你可以使用 <code>withCoupon</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user-&gt;newSubscription(<span class="string">'main'</span>, <span class="string">'monthly'</span>)</div><div class="line">     -&gt;withCoupon(<span class="string">'code'</span>)</div><div class="line">     -&gt;create($creditCardToken);</div></pre></td></tr></table></figure>
<h3 id="检查认购状态"><a href="#检查认购状态" class="headerlink" title="检查认购状态"></a>检查认购状态</h3><p>一旦订阅了你的应用，你可以通过各种简单方便的方法来检查他们的认购状态。首先，你可以通过 <code>subscribed</code> 方法来检查用户是否激活了认购，即使用户是在试用期中，该方法也会返回 <code>true</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($user-&gt;subscribed(<span class="string">'main'</span>)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过 <code>subscribed</code> 方法，我们可以创建一个极好的路由中间件，用来过滤只有处于订阅状态的用户可以访问路由或者控制器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span> </span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">if</span> ($request-&gt;user() &amp;&amp; ! $request-&gt;user()-&gt;subscribed(<span class="string">'main'</span>)) &#123;</div><div class="line">    <span class="comment">// This user is not a paying customer...</span></div><div class="line">    <span class="keyword">return</span> redirect(<span class="string">'billing'</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> $next($request);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你需要判断用户是不是还在试用期之中，你可以使用 <code>onTrial</code> 方法，该方法通常是用来向用户提醒其还在试用期之中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($user-&gt;subscription(<span class="string">'main'</span>)-&gt;onTrial()) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>subscribedToPlan</code> 方法用来判断用户是否订阅了所给定的 Stripe / Braintree 计划。比如，我们需要判断用户的 <code>main</code> 认购是不是通过 <code>monthly</code> 计划来进行付费的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($user-&gt;subscribedToPlan(<span class="string">'monthly'</span>, <span class="string">'main'</span>)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>取消认购状态</strong></p>
<p>你可以通过 <code>cancelled</code> 方法来判断用户是否曾经进行过认购，但是却在使用的过程中取消了继续付费订阅:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($user-&gt;subscription(<span class="string">'main'</span>)-&gt;cancelled()) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>或许，你需要判断一个用户取消了持续订阅，但是他的订阅期还未过期。比如，一个用户在 3 月 5 号取消了持续订阅，但是他的上次付费服务还可以继续使用到 3 月 10 号。他还在其可用期内。你应该注意只要是在可用期内，不论是否取消了持续订阅或者还是在试用期内，<code>subscribed</code> 方法都会返回 <code>true</code> :</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($user-&gt;subscription(<span class="string">'main'</span>)-&gt;onGracePeriod()) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="改变付费计划"><a href="#改变付费计划" class="headerlink" title="改变付费计划"></a>改变付费计划</h3><p>在用户认购了你的应用之后，有时候或许他们想要变更付费的计划。你可以使用 <code>swap</code> 方法来变更到一个新的认购计划。比如，我们可以非常简单的切换当前用户到 <code>premium</code> 认购：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = App\User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$user-&gt;subscription(<span class="string">'main'</span>)-&gt;swap(<span class="string">'provider-plan-id'</span>);</div></pre></td></tr></table></figure>
<p>如果用户还处于试用期之中，那么即使切换付费计划，他们的试用期也是会被保持。还有，如果之前认购的份数存在，相应的认购的飞鼠也会被保持：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$user-&gt;subscription(<span class="string">'main'</span>)-&gt;swap(<span class="string">'provider-plan-id'</span>);</div></pre></td></tr></table></figure></p>
<p>如果你想要在切换付费方案的同时取消之前的试用期，你可以使用 <code>skipTrial</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user-&gt;subscription(<span class="string">'main'</span>)</div><div class="line">     -&gt;skipTrial()</div><div class="line">     -&gt;swap(<span class="string">'provider-plan-id'</span>);</div></pre></td></tr></table></figure>
<h3 id="认购份额"><a href="#认购份额" class="headerlink" title="认购份额"></a>认购份额</h3><blockquote>
<p>注意：认购份额只支持 Stripe 版本的 Cashier。Braintree 并没有 Stripe 份额的概念。</p>
</blockquote>
<p>有时候认购时受份额影响的。比如，你的应用可能是按照每用户每月 $10 来进行计费的。要轻松的递增或递减认购的数量，你可以使用 <code>incrementQuantity</code> 和 <code>decrementQuantity</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$user = User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$user-&gt;subscription(<span class="string">'main'</span>)-&gt;incrementQuantity();</div><div class="line"></div><div class="line"><span class="comment">// Add five to the subscription's current quantity...</span></div><div class="line">$user-&gt;subscription(<span class="string">'main'</span>)-&gt;incrementQuantity(<span class="number">5</span>);</div><div class="line"></div><div class="line">$user-&gt;subscription(<span class="string">'main'</span>)-&gt;decrementQuantity();</div><div class="line"></div><div class="line"><span class="comment">// Subtract five to the subscription's current quantity...</span></div><div class="line"></div><div class="line">$user-&gt;subscription(<span class="string">'main'</span>)-&gt;decrementQuantity(<span class="number">5</span>)</div></pre></td></tr></table></figure>
<p>另外，你也可以通过使用 <code>updateQuantity</code> 放法来设置一个指定的份额：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$user-&gt;subscription(<span class="string">'main'</span>)-&gt;updateQuantity(<span class="number">10</span>);</div></pre></td></tr></table></figure>
<p>关于更多的认购份额信息，请查看 <a href="https://stripe.com/docs/guides/subscriptions#setting-quantities" target="_blank" rel="external">Strpe documentation</a>。</p>
<h3 id="认购税率"><a href="#认购税率" class="headerlink" title="认购税率"></a>认购税率</h3><p>在 Cashier 中，可以非常简单的提供 <code>tax_percent</code> 值到 Stripe / Braintree。为了指定用户支付认购时的税率百分比，你需要实现 <code>taxPercentage</code> 方法到你的 billable 模型中，并且在该方法中返回一个 0 - 100 的值，该值不应该多于 2 个小数:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">taxPercentage</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="number">20</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这使你可以应用在多种模型间计算不同的税率,这意味着你可以跨越多个国家的用户群来设置结算税率。</p>
<h3 id="取消订阅"><a href="#取消订阅" class="headerlink" title="取消订阅"></a>取消订阅</h3><p>你可以简单的调用 <code>cancel</code> 方法来取消用户订阅：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$user-&gt;subscription(<span class="string">'main'</span>)-&gt;cancel();</div></pre></td></tr></table></figure>
<p>当认购被取消时，Cashier 会自动的设置 <code>ends_at</code> 列到数据库中。该列会被用来了解当调用 <code>subscribed</code> 方法时何时应该返回 <code>false</code>。比如，如果用户在 3 月 1 号取消了认购，但是上一次认购期应该是在 3 月 5 号结束，所以， <code>subscribed</code> 方法会持续返回 <code>true</code> 直到 3 月 5 号。</p>
<p>你可以通过 <code>onGracePeriod</code> 方法来判断一个已经取消订阅的用户是否还在其可用期内：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($user-&gt;subscription(<span class="string">'main'</span>)-&gt;onGracePeriod()) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="恢复订阅"><a href="#恢复订阅" class="headerlink" title="恢复订阅"></a>恢复订阅</h3><p>如果用户取消了其订阅，并且想要恢复订阅，那么你可以使用 <code>resume</code> 方法。用户必须是在其可用期内才可以恢复订阅：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$user-&gt;subscription(<span class="string">'main'</span>)-&gt;resume();</div></pre></td></tr></table></figure>
<p>如果用户取消了订阅，并在其可用期内恢复了订阅，那么认购不会立即进行计费支付。订阅只是被重新激活，其付费周期还是基于原先的计费周期。</p>
<h2 id="试用"><a href="#试用" class="headerlink" title="试用"></a>试用</h2><h3 id="提供试用并记录信用卡信息"><a href="#提供试用并记录信用卡信息" class="headerlink" title="提供试用并记录信用卡信息"></a>提供试用并记录信用卡信息</h3><p>如果你想要在提供试用期的同时还收集支付方式的信息。你应该在你创建用户认购时使用 <code>trialDays</code> 方法:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$user = User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$user-&gt;newSubscription(<span class="string">'main'</span>, <span class="string">'monthly'</span>)</div><div class="line">     -&gt;trialDays(<span class="number">10</span>)</div><div class="line">     -&gt;create($creditCardToken);</div></pre></td></tr></table></figure>
<p>该方法会设置一个试用结束日期到数据库的认购记录中。并且会通知 Stripe / Braintree 暂不计费，直到超过了该日期才开始进行计费。</p>
<blockquote>
<p>注意：如果你的客户并没有在试用期结束之前取消订阅，那么他们会在试用期结束时自动扣费，所以你应该在试用期结束前那天进行用户通知。</p>
</blockquote>
<p>你可以通过用户实例的 <code>onTrial</code> 方法或者认购实例的 <code>onTrial</code> 方法来判断用户是否在试用期：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($user-&gt;onTrial(<span class="string">'main'</span>)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> ($user-&gt;subscription(<span class="string">'main'</span>)-&gt;onTrial()) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="提供试用的同时不记录支付信息"><a href="#提供试用的同时不记录支付信息" class="headerlink" title="提供试用的同时不记录支付信息"></a>提供试用的同时不记录支付信息</h3><p>如果你想要在提供试用期的同时而不收集用户的支付方法信息，你可以简单的设置 <code>trial_ends_at</code> 列到你的用户记录中。你应该在该列中设置你所期望的试用结束的日期。比如，这一般是用户注册过程中的典型做法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$user = User::create([</div><div class="line">  <span class="comment">// Populate other user properties...</span></div><div class="line">  <span class="string">'trial_ends_at'</span> =&gt; Carbon::now()-&gt;addDays(<span class="number">10</span>),</div><div class="line">]);</div></pre></td></tr></table></figure>
<p>Cashier 会认为这中类型的试用是一种通用的试用期，因为这个日期并不会被关联到任何已有的订阅中。如果当前日期并没有超过 <code>trial_ends_at</code> 所设置的值，在 <code>User</code> 实例中的 <code>onTrial</code> 方法将会返回为 <code>true</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($user-&gt;onTrial()) &#123;</div><div class="line">  <span class="comment">// User is within their trial period...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你也可以通过 <code>onGenericTrial</code> 方法来判断用户是否还没有进行任何认购，并且还在通用期内：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($user-&gt;onGenericTrial()) &#123;</div><div class="line">  <span class="comment">// User is within their 'generic' trial period...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一旦你准备好去创建一个真实的认购到用户，你通常应该使用 <code>newSubscription</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user = User::find(<span class="number">1</span>);</div><div class="line"></div><div class="line">$user-&gt;newSubscription(<span class="string">'main'</span>, <span class="string">'monthly'</span>)-&gt;create($creditCardToken);</div></pre></td></tr></table></figure>
<h2 id="处理-Stripe-Webhooks"><a href="#处理-Stripe-Webhooks" class="headerlink" title="处理 Stripe Webhooks"></a>处理 Stripe Webhooks</h2><h3 id="失败的认购"><a href="#失败的认购" class="headerlink" title="失败的认购"></a>失败的认购</h3><p>如果用户的信用卡过期了怎么办？不用担心，Cashier 为你提供了便捷的取消用户订阅的 Webhook 控制器。你只需要将控制器添加到路由就可以了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Route::post(</div><div class="line">  <span class="string">'stripe/webhook'</span>,</div><div class="line">  <span class="string">'\Laravel\Cashier\Http\Controllers\WebhookController@handleWebhook'</span></div><div class="line">);</div></pre></td></tr></table></figure>
<p>就那么简单！失败的支付会在这个控制器中捕获和处理。这个控制器会在 Stripe 确定用户的订阅支付失败时（通常是在三次支付失败）取消用户的订阅。不要忘记在你的 Stripe 控制面板中配置 webhook 的 URI。</p>
<p>因为 Stripe webhooks 需要穿过 laravel 的 CSRF 中间件，所以你应该将你的路由抽离出 <code>web</code> 中间件组，或者在你的 <code>VerifyCsrfToken</code> 中间件中添加排除的 URI：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $except = [</div><div class="line">  <span class="string">'stripe/*'</span>,</div><div class="line">];</div></pre></td></tr></table></figure>
<h3 id="其他-Webhooks"><a href="#其他-Webhooks" class="headerlink" title="其他 Webhooks"></a>其他 Webhooks</h3><p>如果你想要处理额外的 Stripe webhook 事件，你可以简单的继承 Webhook 控制器。你所继承的控制器名中的方法名称应该与 Cashier 的预期约定想对应。特别的，方法名称应该有 <code>handle</code> 前缀，并且以大写驼峰的方式命名你所期望捕获的 Stripe webhook 事件名称。比如，你想要处理 <code>invoice.payment_succeeded</code> webhook, 那么你应该在控制器中添加 <code>handleInvociePaymentSucceeded</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Cashier</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">WebhookController</span> <span class="title">as</span> <span class="title">BaseController</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebhookController</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Handle a Stripe webhook.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> array $payload</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleInvoicePaymentSucceeded</span><span class="params">($payload)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="comment">// Handle The Event</span></div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">`</div></pre></td></tr></table></figure>
<h2 id="处理-Braintree-Webhooks"><a href="#处理-Braintree-Webhooks" class="headerlink" title="处理 Braintree Webhooks"></a>处理 Braintree Webhooks</h2><h3 id="失败的订阅"><a href="#失败的订阅" class="headerlink" title="失败的订阅"></a>失败的订阅</h3><p>如果用户的信用卡过期了怎么办？不用担心，Cashier 为你提供了便捷的取消用户订阅的 Webhook 控制器。你只需要将控制器添加到路由就可以了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Route::post(</div><div class="line">  <span class="string">'braintree/webhook'</span>,</div><div class="line">  <span class="string">'\Laravel\Cashier\Http\Controllers\WebhookController@handleWebhook'</span></div><div class="line">);</div></pre></td></tr></table></figure>
<p>就那么简单！失败的支付会在这个控制器中捕获和处理。这个控制器会在 Braintree 确定用户的订阅支付失败时（通常是在三次支付失败）取消用户的订阅。不要忘记在你的 Braintree 控制面板中配置 webhook 的 URI。</p>
<p>因为 Stripe webhooks 需要穿过 laravel 的 CSRF 中间件，所以你应该将你的路由抽离出 <code>web</code> 中间件组，或者在你的 <code>VerifyCsrfToken</code> 中间件中添加排除的 URI：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $except = [</div><div class="line">  <span class="string">'braintree/*'</span>,</div><div class="line">];</div></pre></td></tr></table></figure>
<h3 id="其他-Webhooks-1"><a href="#其他-Webhooks-1" class="headerlink" title="其他 Webhooks"></a>其他 Webhooks</h3><p>如果你想要处理额外的 Braintree webhook 事件，你可以简单的继承 Webhook 控制器。你所继承的控制器名中的方法名称应该与 Cashier 的预期约定想对应。特别的，方法名称应该有 <code>handle</code> 前缀，并且以大写驼峰的方式命名你所期望捕获的 Stripe webhook 事件名称。比如，你想要处理 <code>dispute_opened</code> webhook, 那么你应该在控制器中添加 <code>handleDisputeOpened</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Braintree</span>\<span class="title">WebhookNotification</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Cashier</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">WebhookController</span> <span class="title">as</span> <span class="title">BaseController</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebhookController</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Handle a Braintree webhook.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> WebhookNotification $webhook</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleDisputeOpened</span><span class="params">(WebhookNotification $notification)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="comment">// Handle The Event</span></div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line">`</div></pre></td></tr></table></figure>
<h2 id="一次性付费"><a href="#一次性付费" class="headerlink" title="一次性付费"></a>一次性付费</h2><h3 id="简单的付费"><a href="#简单的付费" class="headerlink" title="简单的付费"></a>简单的付费</h3><blockquote>
<p>注意：在使用 Stripe 时，<code>charge</code> 方法接收的金额可以是相应货币的最小单位。而 Braintree，你应该传递美元到 <code>charge</code> 方法：</p>
</blockquote>
<p>如果你想要对订阅的用户施行一次性付费，你可以使用 <code>charge</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Stripe Accepts Charges In Cents...</span></div><div class="line">$user-&gt;charge(<span class="number">100</span>);</div><div class="line"></div><div class="line"><span class="comment">// Braintree Accepts Charges In Dollars...</span></div><div class="line">$user-&gt;charge(<span class="number">1</span>);</div></pre></td></tr></table></figure>
<p><code>charge</code> 方法也可以接收一个数组作为其第二个参数，这个参数将传递给底层的 Stripe / Braintree 用于支付账单的创建：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user-&gt;charge(<span class="number">100</span>, [</div><div class="line">  <span class="string">'custom_option'</span> =&gt; $value,</div><div class="line">]);</div></pre></td></tr></table></figure>
<p>当支付失败时，<code>charge</code> 方法将会抛出一个异常，如果支付成功则完整的 Stripe / Braintree 响应将会被返回：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  $response = $user-&gt;charge(<span class="number">100</span>);</div><div class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="支付并提供发票"><a href="#支付并提供发票" class="headerlink" title="支付并提供发票"></a>支付并提供发票</h3><p>有时候，你可能需要做一次性的支付，并且也要生成一个发票给用户。你可以使用 <code>invoiceFor</code> 方法来生成发票并提供一个 PDF 的收据给用户：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Stripe Accepts Charges In Cents...</span></div><div class="line">$user-&gt;invoiceFor(<span class="string">'One Time Fee'</span>, <span class="number">500</span>);</div><div class="line"></div><div class="line"><span class="comment">// Braintree Accepts Charges In Dollars...</span></div><div class="line">$user-&gt;invoiceFor(<span class="string">'One Time Fee'</span>, <span class="number">5</span>);</div></pre></td></tr></table></figure>
<p>开具发票会立即向用户的信用卡进行收费。<code>invoiceFor</code> 方法也接收一个数组作为第三个参数，用于传递给底层的 Stripe / Braintree 支付账单创建时使用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$user-&gt;invoiceFor(<span class="string">'One Time Fee'</span>, <span class="number">500</span>, [</div><div class="line">  <span class="string">'custom-option'</span> =&gt; $value,</div><div class="line">]);</div></pre></td></tr></table></figure>
<blockquote>
<p>注意：<code>invoiceFor</code> 方法会创建 Stripe 发票，这将重新尝试失败的计费。如果你不希望开具发票的同时尝试失败的支付，你需要使用 Stripe API 在他们首次失败时就关闭这个支付。</p>
</blockquote>
<h2 id="发票"><a href="#发票" class="headerlink" title="发票"></a>发票</h2><p>你可以通过使用 <code>invoices</code> 方法来检索一个可计费模型的发票数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$invoices = $user-&gt;invoices();</div></pre></td></tr></table></figure>
<p>当你为客户列出其发票时，你可以使用 invoice 帮助方法来显示相应的发票详情。比如，你想要在表格中列出所有的发票，从而允许用户方便的下载：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;table&gt;</div><div class="line">  @<span class="keyword">foreach</span> ($invoices <span class="keyword">as</span> $invoice) </div><div class="line">    &lt;tr&gt;</div><div class="line">      &lt;td&gt;&#123;&#123; $invoice-&gt;date()-&gt;toFormattedDateString() &#125;&#125;&lt;/td&gt;</div><div class="line">      &lt;td&gt;&#123;&#123; $invoice-&gt;total() &#125;&#125;&lt;/td&gt;</div><div class="line">      &lt;td&gt;&lt;a href=<span class="string">""</span>/user/invoice/&#123;&#123; $invoice-&gt;id &#125;&#125;<span class="string">"&gt;Download&lt;/a&gt;&lt;/td&gt;</span></div><div class="line"><span class="string">    &lt;/tr&gt;</span></div><div class="line"><span class="string">  @endforeach</span></div><div class="line"><span class="string">&lt;/table&gt;</span></div></pre></td></tr></table></figure>
<p><strong>生成 PDF 类型的发票</strong></p>
<p>你需要安装 <code>dompdf</code> PHP 类库来生成 PDF:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">composer <span class="keyword">require</span> dompdf/dompdf</div></pre></td></tr></table></figure>
<p>在路由或者控制器中，使用 <code>downloadInvoice</code> 方法来生成一个供下载的 PDF 类型的发票。该方法会自动的生成正确的下载响应到浏览器中:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'user/invoice/&#123;invoice&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($invoiceId)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> Auth::user()-&gt;downloadInvoice($invoiceId, [</div><div class="line">    <span class="string">'vendor'</span> =&gt; <span class="string">'Your Company'</span>,</div><div class="line">    <span class="string">'product'</span> =&gt; <span class="string">'Your Product'</span>,</div><div class="line">  ]); </div><div class="line">&#125;);</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/05/27/laravel-from-scratch-artisan-console/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/27/laravel-from-scratch-artisan-console/" itemprop="url">laravel 基础教程 —— Artisan 命令</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-05-27T09:07:43+08:00">
                2016-05-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Artisan-控制台"><a href="#Artisan-控制台" class="headerlink" title="Artisan 控制台"></a>Artisan 控制台</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Artisan 是 laravel 自带的命令行工具接口的名称。它为应用的开发提供了多种有用的命令工具。Artisan 的底层驱动是强大的 Symfony 控制台组件。你可以使用 <code>list</code> 命令来查看可用的 Artisan 命令：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan <span class="keyword">list</span></div></pre></td></tr></table></figure>
<p>所有的命令都提供了帮助文档，你可以在相应的命令前使用 <code>help</code> 来查看相关命令的选项和参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan help migrate</div></pre></td></tr></table></figure>
<h2 id="编写命令"><a href="#编写命令" class="headerlink" title="编写命令"></a>编写命令</h2><p>除了 Artisan 自带的命令之外，laravel 也允许你自行定义自己的命令工具，你可以将自定义的命令工具存放到 <code>app/Console/Commands</code> 目录下，你当然也可以存放在其他任何想要存放的目录，只要你所存放的位置能基于 <code>composer.json</code> 的设置进行自动加载就行。</p>
<p>你可以使用 <code>make:console</code> Artisan 命令，来进行新命令工具的生成，这个命令会生成一个命令的样本来帮助你开始：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan make:console SendEmails</div></pre></td></tr></table></figure>
<p>上面的命令会生成一个 <code>SendEmails</code> 类，并存放在 <code>app/Console/Commands/SendEmails.php</code>，当你构建命令时，你可以使用 <code>--command</code> 参数来设置命令工具所对应的名称。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan make:console SendEmails --command=emails:send</div></pre></td></tr></table></figure>
<h3 id="命令结构"><a href="#命令结构" class="headerlink" title="命令结构"></a>命令结构</h3><p>一旦你的命令被生成，你需要在其中填充 <code>signature</code> 和 <code>description</code> 属性。这些内容会在你使用 <code>list</code> 命令时在屏幕上显示。</p>
<p>当你的命令被执行时，会触发 <code>handle</code> 方法，你可以在这个方法里编写相应的命令逻辑。让我们来看一个命令示例。</p>
<p>你应该知道我们可以在命令类的构造函数中进行依赖的注入。laravel 服务容器会自动的注入所有在构造函数中使用类型提示的依赖。为了使代码有更好的重用性，保持控制台命令的轻量，让它们推迟到应用服务来完成具体的任务是一种很好的实践。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Console</span>\<span class="title">Commands</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">DripEmailer</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Command</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendEmails</span> <span class="keyword">extends</span> <span class="title">Command</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The name and signature of the console command.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> $signature = <span class="string">'email:send &#123;user&#125;'</span>;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * The console command descritpion</span></div><div class="line"><span class="comment">    * </span></div><div class="line"><span class="comment">    * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">protected</span> $description = <span class="string">'Send drip e-mails to a user'</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * The drip e-mail service.</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@var</span> DripEmailer</span></div><div class="line"><span class="comment">     */</span></div><div class="line">     <span class="keyword">protected</span> $drip;</div><div class="line"></div><div class="line">     <span class="comment">/**</span></div><div class="line"><span class="comment">      * Create a new command instance.</span></div><div class="line"><span class="comment">      *</span></div><div class="line"><span class="comment">      * <span class="doctag">@param</span> DripEmailer $drip</span></div><div class="line"><span class="comment">      * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">      */</span></div><div class="line">      <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(DripEmailer $drip)</span></span></div><div class="line"><span class="function">      </span>&#123;</div><div class="line">        <span class="keyword">parent</span>::__construct();</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;drip = $drip;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">/**</span></div><div class="line"><span class="comment">       * Execute the console command.</span></div><div class="line"><span class="comment">       * </span></div><div class="line"><span class="comment">       * <span class="doctag">@return</span> mixed</span></div><div class="line"><span class="comment">       */</span></div><div class="line">       <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">()</span></span></div><div class="line"><span class="function">       </span>&#123;</div><div class="line">         <span class="keyword">$this</span>-&gt;drip-&gt;send(User::find(<span class="keyword">$this</span>-&gt;argument(<span class="string">'user'</span>)));</div><div class="line">       &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="命令-I-O"><a href="#命令-I-O" class="headerlink" title="命令 I/O"></a>命令 I/O</h2><h3 id="定义期望的输入"><a href="#定义期望的输入" class="headerlink" title="定义期望的输入"></a>定义期望的输入</h3><p>当我们编写命令行工具时，通常都是通过用户输入的参数或者选项来收集输入。laravel 使这一切变的非常简单。你可以使用 <code>signature</code> 属性在你的命令中定义你所期望得到的输入名称。<code>signature</code> 属性允许你使用一行富有表现力类路由的语法来定义命令行中的名称，参数和选项。</p>
<p>所有用户所提供的参数和选项都被包裹在大括号内。在下面的示例中，命令行工具定义了一个必须的参数：<code>user</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * The name and signature of the console command.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">protected</span> $signature = <span class="string">'email:send &#123;user&#125;'</span></div></pre></td></tr></table></figure>
<p>你也可以使参数可选，或者为一个可选的参数定义一个默认值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Optional argument...</span></div><div class="line">email:send &#123;user?&#125;</div><div class="line"></div><div class="line"><span class="comment">// Optional argument with default value...</span></div><div class="line">email:send &#123;user=foo&#125;</div></pre></td></tr></table></figure>
<p>选项和参数一样，它们也是用户的一种输入。但是它们在命令行被指定时会使用 <code>--</code> 作为前缀。我们可以像下面这样在 signature 中定义选项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * The name and signature of the console command.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">protected</span> $signature = <span class="string">'email:send &#123;user&#125; &#123;--queeue&#125;'</span>;</div></pre></td></tr></table></figure>
<p>在这个示例中，<code>--queue</code> 可以在使用 Artisan 命令时被指定。如果指定了 <code>--queque</code>，那么这个选项的值将会为 <code>true</code>。否则选项的值将为 <code>false</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan emial:send <span class="number">1</span> --queue</div></pre></td></tr></table></figure>
<p>你也可以通过在选项后面添加 <code>=</code> 号来表明这个选项是需要通过用户输入的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * The name and signature of the console command.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">protected</span> $signature = <span class="string">'email:send &#123;user&#125; &#123;--queue=&#125;'</span>;</div></pre></td></tr></table></figure>
<p>在这个例子中，用户传递一个值到选项像下面这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan email:send <span class="number">1</span> --queue=<span class="keyword">default</span></div></pre></td></tr></table></figure>
<p>你也可以分配一个默认值到选项：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">email:send &#123;user&#125; &#123;--queue=<span class="keyword">default</span>&#125;</div></pre></td></tr></table></figure>
<p>你也可以为选项定义一个简写，你需要使用 <code>|</code> 来分割简写与选项名称，并将简写像下面的示例一样前置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">email:send &#123;user&#125; &#123;--Q|queue&#125;</div></pre></td></tr></table></figure>
<p>如果你想要定义参数或选项期望得到的是输入数组，你可以使用 <code>*</code> 通配符：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">email:send &#123;user*&#125;</div><div class="line">email:send &#123;user&#125; &#123;--id=*&#125;</div></pre></td></tr></table></figure>
<p><strong>输入说明</strong></p>
<p>你也可以分配描述信息到选项或者参数中，你需要使用 <code>:</code> 来进行分割描述和选项或参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * The name and signature of the console command.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">protected</span> $signature = <span class="string">'email:send</span></div><div class="line"><span class="string">                         &#123;user: The ID of the user&#125;</span></div><div class="line"><span class="string">                         &#123;--queue= : Whether the job should be queued&#125;'</span>;</div></pre></td></tr></table></figure>
<h3 id="检索输入"><a href="#检索输入" class="headerlink" title="检索输入"></a>检索输入</h3><p>当你的命令工具存在时，你明显会需要访问命令行中所期望得到的参数或选项的值。你可以使用 <code>argument</code> 和 <code>option</code> 方法来得到：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Execute the console command.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   $userId = <span class="keyword">$this</span>-&gt;argument(<span class="string">'user'</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>你可以通过调用不带参数的 <code>argument</code> 方法来获取所有参数所组成的数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$arguments = <span class="keyword">$this</span>-&gt;argument();</div></pre></td></tr></table></figure>
<p>选项可以非常简单的类似参数一样的通过 <code>option</code> 方法进行检索。选项可以像参数那样当调用无参数的 <code>option</code> 方法时返回所有选项所组成的数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Retrieve a specific option...</span></div><div class="line">$queueName = <span class="keyword">$this</span>-&gt;option(<span class="string">'queue'</span>);</div><div class="line"></div><div class="line"><span class="comment">// Retrieve all options...</span></div><div class="line">$options = <span class="keyword">$this</span>-&gt;option();</div></pre></td></tr></table></figure>
<p>如果相应的参数或选项没有被检索到，会返回 <code>null</code>。</p>
<h3 id="为输入进行提示"><a href="#为输入进行提示" class="headerlink" title="为输入进行提示"></a>为输入进行提示</h3><p>除了显示输出之外，你可能也需要在执行你的命令行工具的过程中向用户索求额外的输入。你可以使用 <code>ask</code> 方法来进行提示用户输入，这个方法将接收用户的输入并返回输入的内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Execute the console command.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   $name = <span class="keyword">$this</span>-&gt;ask(<span class="string">'What is your name?'</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p><code>secret</code> 方法与 <code>ask</code> 方法非常相似，只是用户在控制台中输入的内容并不是可见的。这个方法通常是询问用户密码相关时使用的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$password = <span class="keyword">$this</span>-&gt;secret(<span class="string">'What is the password?'</span>);</div></pre></td></tr></table></figure>
<p><strong>要求确认</strong></p>
<p>如果你只是需要用户的确认，你可以使用 <code>confirm</code> 方法。默认的，该方法返回 <code>false</code>. 但是如果用户在响应中输入了 <code>y</code>，该方法将返回 <code>true</code>.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;confirm(<span class="string">'Do you wish to continue? [y|N]'</span>)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>给用户一个选择</strong></p>
<p><code>anticipate</code> 方法可以用来对可选的内容进行自动完成的提示。这里只是对用户有可能选择的内容进行自动完成提示，并非强制要求用户仅选择可选的内容:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$name = <span class="keyword">$this</span>-&gt;anticipate(<span class="string">'What is your name?'</span>, [<span class="string">'Taylor'</span>, <span class="string">'Dayle'</span>]);</div></pre></td></tr></table></figure>
<p>如果你需要给用户预置选项你可以使用 <code>choice</code> 方法。用户必须选中选项中的索引，用户选中相应的索引的答案的值将会被返回。你可以设置一个默认的索引值，这个索引值将在用户没有做出任何选择时返回：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$name = <span class="keyword">$this</span>-&gt;choice(<span class="string">'What is your name?'</span>, [<span class="string">'Taylor'</span>, <span class="string">'Dayle'</span>], $default);</div></pre></td></tr></table></figure>
<h3 id="编写输出"><a href="#编写输出" class="headerlink" title="编写输出"></a>编写输出</h3><p>你可以使用 <code>line</code>，<code>info</code>，<code>comment</code>，<code>question</code> 和 <code>error</code> 方法发送输出到控制台。这些方法会使用相应的 ANSI 颜色来表明相应的目的。</p>
<p>你可以使用 <code>info</code> 方法来向用户显示一个信息消息。通常，这条消息在控制台中是一个绿色的文本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Execute the console command.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">$this</span>-&gt;info(<span class="string">'Display this on the screen'</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>你可以使用 <code>error</code> 方法来显示一个错误消息。错误消息通常都是红色的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;error(<span class="string">'Something went wrong!'</span>);</div></pre></td></tr></table></figure>
<p> 你可以使用 <code>line</code> 方法来显示一个原生的控制台输出。<code>line</code> 方法并没有对消息设置任何的独特颜色信息：</p>
 <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;line(<span class="string">'Display thie on the screen'</span>);</div></pre></td></tr></table></figure>
<p> <strong>表格布局</strong></p>
<p> 你可以使用 <code>table</code> 方法来简单的对多行或多列的数据进行格式化布局。你只需要向方法中传递头部和行信息到方法中就可以了。宽度和高度将会自动的通过所给定的数据进行计算：</p>
 <figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$headers = [<span class="string">'Name'</span>, <span class="string">'Email'</span>];</div><div class="line"></div><div class="line">$users = App\User::all([<span class="string">'name'</span>, <span class="string">'email'</span>])-&gt;toArray();</div><div class="line"></div><div class="line"><span class="keyword">$this</span>-&gt;table($headers, $users);</div></pre></td></tr></table></figure>
<p> <strong>进度条</strong></p>
<p>对于一些耗时的任务来说，有一个进度提示是非常有用的。如果使用输出对象，我们就可以开始，推进和停止进度条。你需要在你开始进度条之前定义步长。然后根据进行的每一步来推进进度条：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$user = App\User::all();</div><div class="line"></div><div class="line">$bar = <span class="keyword">$this</span>-&gt;output-&gt;createProgressBar(count($users));</div><div class="line"></div><div class="line"><span class="keyword">foreach</span> ($users <span class="keyword">as</span> $user) &#123;</div><div class="line">  <span class="keyword">$this</span>-&gt;performTask($user);</div><div class="line"></div><div class="line">  $bar-&gt;advance();</div><div class="line">&#125;</div><div class="line">$bar-&gt;finish();</div></pre></td></tr></table></figure>
<p>你可以通过查看 <a href="http://symfony.com/doc/2.7/components/console/helpers/progressbar.html" target="_blank" rel="external">Symfony Progress Bar component documentation</a> 来获取更多的选项信息。</p>
<h2 id="注册命令行"><a href="#注册命令行" class="headerlink" title="注册命令行"></a>注册命令行</h2><p>一旦你完成了命令行的编写，你还需要注册其在 Artisan 命令中可用。这些需要在 <code>app/Console/Kernel.php</code> 文件中完成。</p>
<p>在这个文件中，你会发现 <code>commands</code> 属性，它是一个命令行类的列表。当 Artisan 启动时，所有在这个列表中的命令都会通过服务容器解析到 Arisan:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $commands = [</div><div class="line">  Commands\SendEmails::class</div><div class="line">];</div></pre></td></tr></table></figure>
<h2 id="通过代码调用命令"><a href="#通过代码调用命令" class="headerlink" title="通过代码调用命令"></a>通过代码调用命令</h2><p>有时候你可能希望在控制台之外执行 Artisan 命令。比如，你希望在控制器的路由中触发 Artisan 命令。你可以使用 <code>Artisan</code> 假面的 <code>call</code> 方法来完成这些。<code>call</code> 方法接收一个命令名称，和一个包含所有参数和选项所组成的数组，命令执行完成之后会返回一个退出代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'/foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  $exitCode = Artisan::call(<span class="string">'email:send'</span>, [</div><div class="line">    <span class="string">'user'</span> =&gt; <span class="number">1</span>, <span class="string">'--queue'</span> =&gt; <span class="string">'default'</span></div><div class="line">  ]); </div><div class="line"></div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>通过使用 <code>Artisan</code> 假面的 <code>queue</code> 方法，你甚至可以队列化 <code>Artisan</code> 命令，在后台进程中队列工人会按序的帮你执行完成命令：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'/foo'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  Artisan::queue(<span class="string">'email:send'</span>, [</div><div class="line">    <span class="string">'user'</span> =&gt; <span class="number">1</span>, <span class="string">'--queue'</span> =&gt; <span class="string">'default'</span></div><div class="line">  ]);</div><div class="line"></div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>如果你需要强制指定一个不接受字符串值的选项的值为一个字符串，就像 <code>migrate:refresh</code> 命令，你可以使用 <code>--force</code> 标识并传递一个布尔值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$exitCode = Artisan::call(<span class="string">'migrate:refresh'</span>, [</div><div class="line">  <span class="string">'--force'</span> =&gt; <span class="keyword">true</span>,</div><div class="line">]);</div></pre></td></tr></table></figure>
<h3 id="在命令行中调用另外的命令"><a href="#在命令行中调用另外的命令" class="headerlink" title="在命令行中调用另外的命令"></a>在命令行中调用另外的命令</h3><p>有时候，你可能希望在命令行工具中调用另外一个已经存在的 Artisan 命令。你可以使用 <code>call</code> 方法来完成这些。<code>call</code> 方法接收命令的名称和一个包含所有参数和选项的数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Execute the console command.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   <span class="keyword">$this</span>-&gt;call(<span class="string">'email:send'</span>, [</div><div class="line">    <span class="string">'user'</span> =&gt; <span class="number">1</span>, <span class="string">'--queue'</span> =&gt; <span class="string">'default'</span></div><div class="line">   ]);</div><div class="line"></div><div class="line">   <span class="comment">//</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>如果你希望调用另外一个控制台命令而不希望它有任何的输出，你可以使用 <code>callSilent</code> 方法，<code>callSilent</code> 方法具有 <code>call</code> 方法相同的调用方式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;callSilent(<span class="string">'email:send'</span>, [</div><div class="line">  <span class="string">'user'</span> =&gt; <span class="number">1</span>, <span class="string">'--queue'</span> =&gt; <span class="string">'default'</span></div><div class="line">]);</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/05/25/laravel-from-scratch-authorization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/25/laravel-from-scratch-authorization/" itemprop="url">laravel 基础教程 —— 授权</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-05-25T16:33:12+08:00">
                2016-05-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>laravel 除了提供开箱即用的授权服务，还提供了许多简单的方式来管理授权逻辑和资源的访问控制。这些各式的方法和帮助函数便于你管理你的授权逻辑。我们将在本章中对其进行一一的解读。</p>
<h2 id="定义能力"><a href="#定义能力" class="headerlink" title="定义能力"></a>定义能力</h2><p>判断一个用户是否具有执行给定动作的能力的最简单的方式就是使用 <code>Illuminate\Auth\Access\Gate</code> 类去定义相应的能力。laravel 所提供的 <code>AuthServiceProvider</code> 类是定义这些能力的推荐位置。让我们来看个示例，我们定义一个 <code>update-post</code> 的能力，这个能力接收一个当前 <code>User</code> 和一个 <code>Post</code> 模型。在这个能力中，我们需要判断用户的 <code>id</code> 与 post 的 <code>user_id</code> 是否匹配：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>\<span class="title">Access</span>\<span class="title">Gate</span> <span class="title">as</span> <span class="title">GateContract</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Support</span>\<span class="title">Providers</span>\<span class="title">AuthServiceProvider</span> <span class="title">as</span> <span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Register any application authentication / authorization services.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> \Illuminate\Contracts\Auth\Access\Gate $gate</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">(GateContract $gate)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">$this</span>-&gt;registerPolicies($gate);</div><div class="line"></div><div class="line">     $gate-&gt;define(<span class="string">'update-post'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($user, $post)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> $user-&gt;id === $post-&gt;user_id;</div><div class="line">     &#125;);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意上面的示例中我们并没有检查所给定的 <code>$user</code> 是否为 <code>NULL</code>。这是因为当给定的用户没有经过认证或者用户没有经过 <code>forUser</code> 方法指定，<code>Gate</code> 类会自动的为所有的能力返回 <code>false</code>。</p>
<p><strong>基于类的能力</strong></p>
<p>除了使用 <code>Closures</code> 的方式作为授权检查的回调来注册能力，你还可以通过传递类中的方法来进行能力的注册，当需要的时候，类会通过服务容器来解析：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$gate-&gt;define(<span class="string">'update-post'</span>, <span class="string">'Class@method'</span>);</div></pre></td></tr></table></figure>
<p><strong>授权检查拦截器</strong></p>
<p>有时候，你可能需要向某些特殊用户发放所有能力的通行证，这个时候，你可以使用 <code>before</code> 方法来定义一个回调，它会在所有的授权检查之前运行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$gate-&gt;before(<span class="function"><span class="keyword">function</span> <span class="params">($user, $ability)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> ($user-&gt;isSuperAdmin()) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>如果 <code>before</code> 的回调函数返回一个非空的结果，那么该结果将作为检查的结果。</p>
<p>你也可以使用 <code>after</code> 方法来定义一个在每个能力授权检查之后执行的回调函数，但是，你不能在这个回调函数内修改检查的结果：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$gate-&gt;after(<span class="function"><span class="keyword">function</span> <span class="params">($user, $ability, $result, $arguments)</span> </span>&#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="检查能力"><a href="#检查能力" class="headerlink" title="检查能力"></a>检查能力</h2><h3 id="通过-Gate-假面"><a href="#通过-Gate-假面" class="headerlink" title="通过 Gate 假面"></a>通过 Gate 假面</h3><p>一旦一个能力被定义完成，我们就可以通过多种方式来进行能力的检查。首先，我们可以使用 <code>Gate</code> 假面的 <code>check</code>，<code>allows</code>，或者 <code>denies</code> 方法。所有的这些方法都会接收能力的名称，并且会把额外的参数传递给相应能力的回调函数中。你并不需要传递当前的用户到这些方法中，<code>Gate</code> 会自动的前置当前用户到参数中并传递给能力的回调函数。所以当我们检查早前定义的 <code>update-post</code> 能力时，我们只需要传递 <code>Post</code> 的实例到 <code>denies</code> 方法中就可以了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Gate</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Update the given post.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($id)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $post = Post::findOrFail($id);</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (Gate::denies(<span class="string">'update-post'</span>, $post)) &#123;</div><div class="line">        abort(<span class="number">403</span>);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// Update Post ...</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，<code>allows</code> 方法与 <code>denies</code> 相反，如果动作被授权通过则返回 <code>true</code>. <code>check</code> 方法就是 <code>allows</code> 方法的别名。</p>
<p><strong>对指定的用户检查能力</strong></p>
<p>如果你想要使用 <code>Gate</code> 假面来检查非当前经授权通过用户的其他用户是否具备相应的能力，你可以使用 <code>forUser</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Gate::forUser($user)-&gt;allows(<span class="string">'update-post'</span>, $post)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>传递多个参数</strong></p>
<p>当然，能力的回调函数可以接收多个参数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Gate:define(<span class="string">'delete-comment'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($user, $post, $comment)</span> </span>&#123;</div><div class="line">  <span class="comment">// </span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>如果你的能力需要接收多个参数，你可以简单的通过 <code>Gate</code> 假面的方法进行传递一个经多个参数所组成的数组：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Gate::allows(<span class="string">'delete-comment'</span>, [$post, $comment])) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="通过用户模型检查能力"><a href="#通过用户模型检查能力" class="headerlink" title="通过用户模型检查能力"></a>通过用户模型检查能力</h3><p>事实上，你可以通过 <code>User</code> 模型的实例来检查用户的能力。默认的 laravel 的 <code>App\User</code> 模型使用了 <code>Authorizable</code> trait，这个性状包含两个方法：<code>can</code> 和 <code>cannot</code>。这两个方法和 <code>Gate</code> 假面的 <code>allows</code> 和 <code>denies</code> 方法的用法相同。我们还使用上面曾使用过的例子，修改成如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Update the given post.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> \Illuminate\Http\Request $request</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(Request $request, $id)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $post = Post::findOrFail($id);</div><div class="line"></div><div class="line">     <span class="keyword">if</span> ($request-&gt;user()-&gt;cannot(<span class="string">'update-post'</span>, $post)) &#123;</div><div class="line">       abort(<span class="number">403</span>);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// Update Post...</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，<code>can</code> 方法与 <code>cannot</code> 的相反：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($request-&gt;user()-&gt;can(<span class="string">'update-post'</span>, $post)) &#123;</div><div class="line">  <span class="comment">// Update Post...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="在-Blade-模板中检查能力"><a href="#在-Blade-模板中检查能力" class="headerlink" title="在 Blade 模板中检查能力"></a>在 Blade 模板中检查能力</h3><p>为了方便，laravel 提供了 <code>@can</code> Blade 指令来快速的检查当前授权的用户是否具有指定的能力。比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;a href=<span class="string">"/post/&#123;&#123; $post-&gt;id &#125;&#125;"</span>&gt;View Post&lt;/a&gt;</div><div class="line"></div><div class="line">@can(<span class="string">'update-post'</span>, $post)</div><div class="line">  &lt;a href=<span class="string">"/post/&#123;&#123; $post-&gt;id &#125;&#125;/edit"</span>&gt;Edit Post&lt;/a&gt;</div><div class="line">@endcan</div></pre></td></tr></table></figure>
<p>你也可以通过 <code>@else</code> 指令来配合 <code>@can</code> 指令：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@can(<span class="string">'update-post'</span>, $post)</div><div class="line">  &lt;!-- The Current User Can Update The Post --&gt;</div><div class="line">@<span class="keyword">else</span></div><div class="line">  &lt;!-- The Current User Can<span class="string">'t Update The Post --&gt;</span></div><div class="line"><span class="string">@endcan</span></div></pre></td></tr></table></figure>
<h3 id="在表单请求中检查能力"><a href="#在表单请求中检查能力" class="headerlink" title="在表单请求中检查能力"></a>在表单请求中检查能力</h3><p>你也可以通过使用表单请求（继承自 Request，用于表单验证的请求类）中自定义的 <code>authoriza</code> 方法来验证 <code>Gate</code> 假面中定义的能力：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Determine if the user is authorized to make this request.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> bool</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authorize</span><span class="params">()</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   $postId = <span class="keyword">$this</span>-&gt;route(<span class="string">'post'</span>);</div><div class="line"></div><div class="line">   <span class="keyword">return</span> Cate::allows(<span class="string">'update'</span>, Post::findOrFail($postId));</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="策略（Policies）"><a href="#策略（Policies）" class="headerlink" title="策略（Policies）"></a>策略（Policies）</h2><h3 id="创建策略"><a href="#创建策略" class="headerlink" title="创建策略"></a>创建策略</h3><p>为了不让你把所有的授权逻辑全部放进 <code>AuthServiceProvider</code> 从而使应用增长为一个庞大而笨重的应用。 laravel 允许你通过 <code>Policy</code> 类来分离你的授权逻辑。策略类其实就是一个包含授权逻辑组的原生 PHP 类。</p>
<p>首先，让我们来生成一个策略来管理我们的 <code>Post</code> 的授权。你可以通过 <code>make:policy</code> 命令来生成一个策略。所生成的策略会存放在 <code>app/Policies</code> 目录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan make:policy PostPolicy</div></pre></td></tr></table></figure>
<p><strong>注册策略</strong></p>
<p>一旦策略存在，我们还需要在 <code>Gate</code> 类中进行注册。在 <code>AuthServiceProvider</code> 中包含了一个 <code>policies</code> 属性，该属性存放所有实体与策略间的映射。所以，我们需要将 <code>Post</code> 模型的策略指定到 <code>PostPolice</code> 类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Policies</span>\<span class="title">PostPolicy</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Support</span>\<span class="title">Providers</span>\<span class="title">AuthServiceProvider</span> <span class="title">as</span> <span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * The policy mappings for the application.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> $policies = [</div><div class="line">     Post::class =&gt; PostPolicy::class,</div><div class="line">   ];</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Register any application authentication / authorization services.</span></div><div class="line"><span class="comment">    * </span></div><div class="line"><span class="comment">    * <span class="doctag">@param</span> \Illuminate\Contracts\Auth\Access\Gate $gate</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">(GateContract $gate)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="keyword">$this</span>-&gt;registerPolicies($gate); </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="编写策略"><a href="#编写策略" class="headerlink" title="编写策略"></a>编写策略</h3><p>一旦策略被生成和注册后，我们就可以为所有能力的授权添加验证方法。例如，让我们在 <code>PostPolicy</code> 类中定义一个 <code>update</code> 方法，用来验证所给定的用户是否具有 <code>update</code> <code>Post</code> 的能力：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Policies</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Uesr</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostPolicy</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Determine if the given post can be updated by the user.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> \App\User $user</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> \App\Post $post</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> bool</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(User $user, Post $post)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">return</span> $user-&gt;id === $post-&gt;user_id;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可以继续在策略中添加其他所需进行授权验证的方法。比如，你可以继续为验证 <code>Post</code> 的各种动作而定义 <code>show</code>，<code>destroy</code>，或者 <code>addComment</code> 方法。</p>
<blockquote>
<p>注意：所有的策略类都是通过服务容器解析而来。这意味着你可以使用类型提示来在策略类的构造函数中进行依赖注入所需要的依赖。</p>
</blockquote>
<p><strong>拦截所有检查</strong></p>
<p>有时候，你可能需要发放给指定用户具有所有能力的通行证，这时候，你可以在策略类中定义 <code>before</code> 方法。该方法会在策略中其他所有方法被执行前运行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">before</span><span class="params">($user, $ability)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">if</span> ($user-&gt;isSuperAdmin()) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果 <code>before</code> 方法返回一个非空值，那么其结果将会用来作为授权验证的结果的判断依据。</p>
<h3 id="检查策略"><a href="#检查策略" class="headerlink" title="检查策略"></a>检查策略</h3><p>策略类的方法和基于授权回调的方法一样通过相同的方式作为 <code>Closure</code> 被调用。你可以使用 <code>Gate</code> 假面，<code>User</code> 模型，<code>@can</code> Blade 指令或者 <code>policy</code> helper 来进行授权的检查。</p>
<p><strong>通过 Gate 假面</strong></p>
<p><code>Gate</code> 会通过检查传递给方法中参数的类型来确定应该使用哪一种策略。所以，如果我们传递 <code>Post</code> 实例到 <code>denies</code> 方法，<code>Gate</code> 将会自动的使用相对应的 <code>PostPolicy</code> 来进行授权验证：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Gate</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Update the given post.</span></div><div class="line"><span class="comment">   * </span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($id)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $post = Post::findOrFail($id);</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (Gate::denies(<span class="string">'update'</span>, $post)) &#123;</div><div class="line">       abort(<span class="number">403</span>);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// Update Post...</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>通过用户的模型</strong></p>
<p><code>User</code> 模型中的 <code>can</code> 和 <code>cannot</code> 方法也会在所给定参数可用时自动匹配相应的策略。这些方法提供了一种便利的方式去验证任意用户实例是否具有所给定的能力:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ($user-&gt;can(<span class="string">'update'</span>, $post)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> ($user-&gt;cannot(<span class="string">'update'</span>, $post)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>通过 Blade 模板</strong></p>
<p>就像我们所期望的，<code>@can</code> Blade 指令会在所给定参数可用时自动匹配相应的策略：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@can(&apos;update&apos;, $post)</div><div class="line">  &lt;!-- The Current User Can update The Post --&gt;</div><div class="line">@endcan</div></pre></td></tr></table></figure>
<p><strong>通过策略 Helper</strong></p>
<p>全局帮助方法 <code>policy</code> 可以通过所给定的类解析相应的 <code>Policy</code> 类。例如，我们可以传递一个 <code>Post</code> 实例到 <code>policy</code> 帮助方法，该方法会返回相应的 <code>PostPolicy</code> 类：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (policy($post)-&gt;update($user, $post)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="控制器授权"><a href="#控制器授权" class="headerlink" title="控制器授权"></a>控制器授权</h2><p>默认的，在 laravel 中基于 <code>Ap\Http\Controllers\Controller</code> 的类都引入了 <code>AuthorizesRequests</code> trait（性状）。该性状提供了 <code>authorize</code> 方法来快速的验证所给定的动作是否有执行的能力，如果不具备相应的能力会抛出一个 <code>HttpException</code> 。</p>
<p><code>authorize</code> 方法共享了其它授权方法的签证方式，如 <code>Gate::allows</code> 和 <code>$user-&gt;can()</code>。那么，让我们来使用 <code>authorize</code> 方法快速的鉴别一个请求是否具有更新 <code>Post</code> 的能力：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Post</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Update the given post.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($id)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $post = Post::findOrFail($id);</div><div class="line"></div><div class="line">     <span class="keyword">$this</span>-&gt;authorize(<span class="string">'update'</span>, $post);</div><div class="line"></div><div class="line">     <span class="comment">// Update Post...</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果这个动作通过了授权，控制器将继续执行下面的逻辑。否则会自动的抛出一个 <code>HttpException</code> 错误，这个错误会生成一个 <code>403 Not Authorized</code> 的 Http 响应。就如你所看到的， <code>authorize</code> 方法是一个非常方便的方法，它的方便之处就在于只使用一条语句执行了授权的验证或抛出异常。</p>
<p><code>AuthorizeRequests</code> trait 也提供了 <code>authorizeForUser</code> 方法来进行非当前用户的用户与给定能力的鉴权：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">$this</span>-&gt;authorizeForUser($user, <span class="string">'update'</span>, $post);</div></pre></td></tr></table></figure>
<p><strong>自动的确定策略方法</strong></p>
<p>通常的，策略类中的方法是与控制器中的方法相对应的。比如在上面的 <code>update</code> 方法中，控制器的方法和策略的方法使用了相同的命名： <code>update</code>。</p>
<p>由于这个原因，laravel 允许你通过简单的传递一个实例参数到 <code>authorize</code> 方法，在能力的鉴定中，laravel 会根据当前方法的命名自动的确定策略方法的调用。在上面的例子中，由于 <code>authorize</code> 方法是在控制器中的 <code>update</code> 方法中调用的，所以 <code>PostPolicy</code> 中的 <code>update</code> 将会被调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Update the given post.</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment"> * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($id)</span></span></div><div class="line"><span class="function"> </span>&#123;</div><div class="line">   $post = Post::findOrFail($id);</div><div class="line"></div><div class="line">   <span class="keyword">$this</span>-&gt;authorize($post);</div><div class="line"></div><div class="line">   <span class="comment">// Update Post...</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/05/21/laravel-from-scratch-authentication/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/21/laravel-from-scratch-authentication/" itemprop="url">laravel 基础教程 —— 认证</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-05-21T13:56:19+08:00">
                2016-05-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>laravel 使实施认证的变得非常简单，事实上，它提供了非常全面的配置项以适应应用的业务。认证的配置文件存放在 <code>config/auth.php</code> 目录，这里的每个选项都提供了完善的注释文档，你可以从这里调整认证服务的行为。</p>
<p>在 laravel 中，认证服务的核心是由 <code>guards（守卫）</code> 和 <code>providers（供应商）</code> 组成。守卫定义了从请求中验证用户的方式，比如说，laravel 自带了 <code>session</code> 守卫和 <code>token</code> 守卫，<code>session</code> 守卫是从所存储的会话及 cookies 中去认证请求中的用户的，而 <code>token</code> 守卫则是从请求中的 <code>API token</code> 进行用户认证的。</p>
<p>供应商则定义了从持久化存储中获取用户的方式。laravel 自身提供了 <code>Eloquent</code> 和  <code>database</code> 查询构造器两种检索方式。当然，你也可以添加额外的供应商去做这些。</p>
<p>如果这听起来有些混乱，请不要担心。大多数的应用程序是根本不需要修改认证服务的默认配置信息的。</p>
<h2 id="数据库注意事项"><a href="#数据库注意事项" class="headerlink" title="数据库注意事项"></a>数据库注意事项</h2><p>默认的，laravel 在 <code>app</code> 目录下包含了 <code>App\User</code> Eloquent 模型。该模型使用了默认的 Eloquent 认证驱动。如果你的应用不是使用 Eloquent 驱动，你可以使用 <code>database</code> 认证驱动，<code>database</code> 认证驱动是基于 laravel 的查询构造器的。</p>
<p>当你为 <code>App\User</code> 模型去构建数据库表结构时，你应该确认密码应该保持最少 60 个字符的长度，默认的 255 是一个比较好的选择。</p>
<p>另外，你需要确保 <code>users</code> 表中包含了一个可以为 null 的字符串列 <code>remember_token</code>，它应该具有 100 个字符的长度。这个字段是用来存储用户保持长期登录的 token 值的。你可以在迁移中使用 <code>$table-&gt;rememberToken()</code> 来快速的添加该列。</p>
<h2 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h2><p>laravel 装载了两个用来进行认证的控制器，它们存储在 <code>App\Http\Controllers\Auth</code> 命名空间下。<code>AuthController</code> 用来处理用户注册及认证的逻辑，而 <code>PasswordController</code> 包含了用户找回密码的相关逻辑。它们每个控制器都是通过引入 trait 来包含他们所需要的方法。对于大多数应用来说，你是完全没有必要去修改这些控制器的。</p>
<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><p>laravel 提供了一个快速的方法来生成认证的路由和视图的脚手架，你可以使用 artisan 命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan make:auth</div></pre></td></tr></table></figure>
<p>在一个新的应用中，这个命令会用来进行安装注册和登录的视图，也会注入所有的认证相关的路由。<code>HomeController</code> 也会被生成。这个控制器提供了 post 登录请求的处理方法。你也可以根据自己的需求删除或修改这个控制器。</p>
<h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><p>就如上面所提到的，<code>php artisan make:auth</code> 命令会创建所有认证相关的视图，并且保存在 <code>resources/views/auth</code> 目录下。</p>
<p><code>make:auth</code> 命令也会创建 <code>resoucres/views/layouts</code> 目录，并在该目录下为应用创建了一个基本的布局。所有的这些视图都是使用了 Bootstrap CSS 框架，你可以根据自身的需求去定制化修改。</p>
<h3 id="进行认证"><a href="#进行认证" class="headerlink" title="进行认证"></a>进行认证</h3><p>现在你已经具有了认证相关的控制器、路由和视图，你的应用已经具备了注册和认证的能力。你可以通过浏览器访问你的应用，认证控制器已经包含了所有的认证用户和存储用户到数据库的方法（通过 traits）。</p>
<h4 id="自定义重定向地址"><a href="#自定义重定向地址" class="headerlink" title="自定义重定向地址"></a>自定义重定向地址</h4><p>当用户通过认证后会被重定向到 <code>/</code> URL。你可以通过在 <code>AuthController</code> 控制器中定义 <code>redirectTo</code> 属性来修改重定向地址：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $rediredtTo = <span class="string">'/home'</span>;</div></pre></td></tr></table></figure>
<p>当用户没有认证成功，它会重定向回登录地址。</p>
<h4 id="自定义守卫"><a href="#自定义守卫" class="headerlink" title="自定义守卫"></a>自定义守卫</h4><p>你也可以定制化 <code>guard</code> 用来验证用户。你需要在 <code>AuthController</code> 中定义 <code>guard</code> 属性。它的值应该是与你的 <code>auth.php</code> 配置中的某一个 <code>guards</code> 值相匹配的:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $guard = <span class="string">'admin'</span>;</div></pre></td></tr></table></figure>
<h4 id="自定义-验证-存储"><a href="#自定义-验证-存储" class="headerlink" title="自定义 验证/存储"></a>自定义 验证/存储</h4><p>你可能会想要在用户注册时存储一些其他必要的表单字段，进而将新增用户的信息存储到数据库中，这个时候你就需要修改 <code>AuthController</code> 类了，这个类主管用户的创建和表单的验证。</p>
<p>在 <code>AuthController</code> 类中使用 <code>validate</code> 方法来验证验证表单与验证规则的匹配程度。你可以根据自身的需要来修改这个方法。</p>
<p>在 <code>AuthController</code> 类中使用 <code>create</code> 方法用来在数据库中新增一条用户的记录。这里使用了 Eloquent ORM。你可以根据自身的需求修改这个方法。</p>
<h3 id="获取已认证的用户"><a href="#获取已认证的用户" class="headerlink" title="获取已认证的用户"></a>获取已认证的用户</h3><p>你可以通过 <code>Auth</code> 假面来访问已经认证的用户:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$user = Auth::user();</div></pre></td></tr></table></figure>
<p>另外，一旦用户经过验证，你可以通过 <code>Illuminate\Http\Request</code> 的实例来访问经过认证后的用户。你应该记得，类型提示的类会被自动的注入到你的控制器方法中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProfileController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Update the user's profile</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> Request $request</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">updateProfile</span><span class="params">(Request $request)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">if</span> ($request-&gt;user()) &#123;</div><div class="line">       <span class="comment">// $request-&gt;user() returns an instance of the authenticated user...</span></div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="判断当前用户是否已被认证"><a href="#判断当前用户是否已被认证" class="headerlink" title="判断当前用户是否已被认证"></a>判断当前用户是否已被认证</h4><p>你可以通过 <code>Auth</code> 假面的 <code>check</code> 方法来判断当前用户是否已经被认证。如果该用户已经被认证则会返回 <code>true</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Auth::check()) &#123;</div><div class="line">  <span class="comment">// The user is logged in...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你应该使用中间件来过滤未被认证的用户访问某些路由或控制器。</p>
<h3 id="保护路由"><a href="#保护路由" class="headerlink" title="保护路由"></a>保护路由</h3><p>路由中间件可以被用来限制只有已经被认证的用户才能访问所给定的路由。laravel 自带了 <code>auth</code> 中间件，该中间件被定义在 <code>app\Http\Middleware\Authenticate.php</code> 文件中。你只需要在定义路由时附加上该中间件就可以了:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Using A Route Closure...</span></div><div class="line"></div><div class="line">Route::get(<span class="string">'profile'</span>, [<span class="string">'middleware'</span> =&gt; <span class="string">'auth'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">// Only authenticated users may enter... </span></div><div class="line">&#125;]);</div><div class="line"></div><div class="line"><span class="comment">// Using A Controller...</span></div><div class="line"></div><div class="line">Route::get(<span class="string">'profile'</span>, [</div><div class="line">  <span class="string">'middleware'</span> =&gt; <span class="string">'auth'</span>,</div><div class="line">  <span class="string">'uses'</span> =&gt; <span class="string">'ProfileController@show'</span></div><div class="line">]);</div></pre></td></tr></table></figure>
<p>当然，如果你使用控制器来注册路由，你可以在控制器的构造函数中使用 <code>middleware</code> 方法来附加中间件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">  <span class="keyword">$this</span>-&gt;middleware(<span class="string">'auth'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="指定守卫"><a href="#指定守卫" class="headerlink" title="指定守卫"></a>指定守卫</h4><p>当你附加 <code>auth</code> 中间件到路由时，你也可以指定选择哪个守卫去提供认证:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'profile'</span>, [</div><div class="line">  <span class="string">'middleware'</span> =&gt; <span class="string">'auth:api'</span>,</div><div class="line">  <span class="string">'uses'</span> =&gt; <span class="string">'ProfileController@show'</span></div><div class="line">]);</div></pre></td></tr></table></figure>
<p>所指定的守卫应该与配置文件 <code>auth.php</code> 中的 <code>guards</code> 数组键之一相匹配。</p>
<h3 id="认证节流"><a href="#认证节流" class="headerlink" title="认证节流"></a>认证节流</h3><p>如果你使用了 laravel 內建的 <code>AuthController</code> 类，那么 <code>Illuminate\Foundation\Auth\ThrottlesLogins</code> trait 可以被用来限制用户尝试登陆的次数。默认的，当用户进行登陆数次失败时，其将会在一分钟内无法进行登陆。节流是根据用户的 username / e-mail 和 IP 地址来判定的:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Auth</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Validator</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Auth</span>\<span class="title">ThrottlesLogins</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Auth</span>\<span class="title">AuthenticatesAndRegistersUsers</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="keyword">use</span> <span class="title">AuthenticatesAndRegistersUsers</span>, <span class="title">ThrottlesLogins</span>;</div><div class="line"></div><div class="line">  <span class="comment">// Rest of AuthController class...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="手动进行用户认证"><a href="#手动进行用户认证" class="headerlink" title="手动进行用户认证"></a>手动进行用户认证</h2><p>当然，你没有必要一定使用 laravel 內建的认证控制器。如果你选择删除这些认证控制器，那么你需要直接的使用 laravel 认证类来管理用户的认证。别担心，这当然不在话下。</p>
<p>我们将通过 <code>Auth</code> 假面来访问 laravel 的认证服务，所以，我们要确保在类文件的顶部引入 <code>Auth</code> 假面。接着，让我们查看一下 <code>attempt</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Handle an authentication attempt.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authenticate</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">if</span> (Auth::attempt([<span class="string">'email'</span> =&gt; $email, <span class="string">'password'</span> =&gt; $password])) &#123;</div><div class="line">       <span class="comment">// Authentication passed... </span></div><div class="line">       <span class="keyword">return</span> redirect()-&gt;intended(<span class="string">'dashboard'</span>);</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>attempt</code> 方法接收一个键值对数组来作为第一个参数。数组中的值用来在数据库中查找相匹配的用户。所以，在上面的例子中，会返回匹配到 <code>email</code> 列为 <code>$email</code> 的用户。如果用户被找到，存储在数据库中的哈希后的密码会和数组中经过哈希加密的 <code>password</code> 值进行匹配。如果两个哈希后的值匹配成功的话，就会开启一个该用户已经认证的会话。</p>
<p>如果认证成功，则 <code>attempt</code> 方法会返回 <code>true</code>。否则返回 <code>false</code>。</p>
<p><code>intended</code> 方法用来返回给重定向器用户在登录前所想要前往的 URL 地址，该方法也接收一个参数作为所请求地址不可用时的备用地址。</p>
<h3 id="指定额外的认证信息"><a href="#指定额外的认证信息" class="headerlink" title="指定额外的认证信息"></a>指定额外的认证信息</h3><p>如果你需要，你也可以增加一些额外条件做认证查询，比如，你需要验证被标记为 ‘active’ 的用户：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Auht::attempt([<span class="string">'email'</span> =&gt; $email, <span class="string">'password'</span> =&gt; $password, <span class="string">'active'</span> =&gt; <span class="number">1</span>])) &#123;</div><div class="line">  <span class="comment">// The user is active, not suspended, and exists.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意，在上面的例子中 <code>email</code> 并不是必备的选项，这仅仅只是作为一个示例。你可以使用任何进行用户认证的凭证来映射数据库中的字段。</p>
</blockquote>
<h3 id="访问指定的守卫实例"><a href="#访问指定的守卫实例" class="headerlink" title="访问指定的守卫实例"></a>访问指定的守卫实例</h3><p>你可以使用 <code>Auth</code> 假面的 <code>guard</code> 方法来获取你所需要的守卫实例。这使你可以在同一个应用中管理多种认证模型或用户表，并实现独立的认证。</p>
<p><code>guard</code> 方法中所传递的守卫名称应该与配置文件 <code>auth.php</code> 中 guards 之一相匹配:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Auth::guard(<span class="string">'admin'</span>)-&gt;attempt($credentials)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="登出"><a href="#登出" class="headerlink" title="登出"></a>登出</h3><p>你可以使用 <code>Auth</code> 假面的 <code>logout</code> 方法来进行用户的退出，该方法将清除用户认证的会话信息:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Auth::logout();</div></pre></td></tr></table></figure>
<h3 id="记住用户"><a href="#记住用户" class="headerlink" title="记住用户"></a>记住用户</h3><p>如果你想要在你的应用中提供 <code>记住我</code> 的功能，你只需要在 <code>attempt</code> 方法中传递一个布尔值作为第二个参数，这将保持用户的认证信息直到用户手动的退出登录。当然，这要求你的用户表中必须包含 <code>remember_token</code> 列:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Auth::attempt([<span class="string">'email'</span> =&gt; $email, <span class="string">'password'</span> =&gt; $password], $remember)) &#123;</div><div class="line">  <span class="comment">// The user is being remembered...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你作为被记住的用户登录的，那么你可以使用 <code>viaRemember</code> 方法来判断用户的认证是不是通过 <code>记住我</code> 的 cookie:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Auth::viaRemember()) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="其它认证方法"><a href="#其它认证方法" class="headerlink" title="其它认证方法"></a>其它认证方法</h3><h4 id="通过用户实例进行认证"><a href="#通过用户实例进行认证" class="headerlink" title="通过用户实例进行认证"></a>通过用户实例进行认证</h4><p>如果你需要在应用中记录一个已经存在的用户实例，你可以使用 <code>login</code> 方法。所给定的参数必须是实现了 <code>Illuminate\Contracts\Auth\Authenticatable</code> 契约的一个实例。当然，在 laravel 中 <code>App\User</code> 模型已经实现了这个接口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Auth::login($user);</div></pre></td></tr></table></figure>
<p>当然，你也可以指定守卫实例:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Auth::guard(<span class="string">'admin'</span>)-&gt;login($user);</div></pre></td></tr></table></figure>
<h4 id="通过用户ID直接认证"><a href="#通过用户ID直接认证" class="headerlink" title="通过用户ID直接认证"></a>通过用户ID直接认证</h4><p>你可以使用 <code>loginUseingId</code> 方法来通过 ID 记录用户的信息，该方法简单的接收一个需要进行认证的用户的主键：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Auth::loginUsingId(<span class="number">1</span>);</div></pre></td></tr></table></figure>
<h4 id="仅认证用户一次"><a href="#仅认证用户一次" class="headerlink" title="仅认证用户一次"></a>仅认证用户一次</h4><p><code>once</code> 方法只在当前请求中进行用户认证。不会存储会话或 cookies。这对构建无状态的 API 很有帮助。<code>once</code> 方法和 <code>attempt</code> 具有相同的签证方式:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Auth::once($credentials)) &#123;</div><div class="line">  <span class="comment">//</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="基于-HTTP-的认证"><a href="#基于-HTTP-的认证" class="headerlink" title="基于 HTTP 的认证"></a>基于 HTTP 的认证</h2><p>基于 HTTP 的认证提供了快速的用户认证机制而不用设立专门的登录页面。为了开始，你应该附加 <code>auth.basic</code> 中间件到你的路由。laravel 中內建了 <code>auth.basic</code> 中间件，所以你不需要去定义它:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'profile'</span>, [<span class="string">'middleware'</span> =&gt; <span class="string">'auth.basic'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">// Only authenticated users may enter... </span></div><div class="line">&#125;]);</div></pre></td></tr></table></figure>
<p>一旦该中间件被附加到路由中，你每次访问该路由时都会被提示要求认证信息。默认的，<code>auth.basic</code> 中间件使用 <code>email</code> 列作为用户记录的用户名。</p>
<h3 id="FastCGI-提示"><a href="#FastCGI-提示" class="headerlink" title="FastCGI 提示"></a>FastCGI 提示</h3><p>如果你使用 PHP FastCGI，基于 HTTP 的认证可能无法正常工作。你可以尝试在 <code>.htaccess</code> 文件中添加如下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">RewriteCond %&#123;HTTP:Authorization&#125; ^(.+)$</div><div class="line">RewriteRule .* - [E=HTTP_AUTHORIZATION:%&#123;HTTP:Authorization&#125;]</div></pre></td></tr></table></figure>
<h3 id="无状态的-HTTP-基本认证"><a href="#无状态的-HTTP-基本认证" class="headerlink" title="无状态的 HTTP 基本认证"></a>无状态的 HTTP 基本认证</h3><p>你也可以在使用 HTTP 基本认证时不使用 session 保存用户的身份到 cookie。这在基于 API 的认证尤其有效。为了做到这些，你可以定义一个中间件，然后调用 <code>onceBasic</code> 方法。如果 <code>onceBasic</code> 方法没有返回响应，那么请求将被进一步传递到应用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Auth</span>\<span class="title">Middleware</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthenticateOnceWithBasicAuth</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Handle on incoming request.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> \Illuminate\Http\Request $request</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> \Closure $next</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> mixed</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">($request, Closure $next)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">return</span> Auth::onceBasic() ?: $next($request);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着，在路由中附加中间件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Route::get(<span class="string">'api/user'</span>, [<span class="string">'middleware'</span> =&gt; <span class="string">'auth.basic.once'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">// Only authenticated users may enter... </span></div><div class="line">&#125;]);</div></pre></td></tr></table></figure>
<p>当然，你还需要在 kernel.php 核心中注册该中间件。</p>
<h2 id="密码重置"><a href="#密码重置" class="headerlink" title="密码重置"></a>密码重置</h2><h3 id="数据库注意事项-1"><a href="#数据库注意事项-1" class="headerlink" title="数据库注意事项"></a>数据库注意事项</h3><p>大多数的应用都提供了一种用户重置其忘记密码的方式。laravel 提供了一种便利的方式来发送密码提示和提供密码重置，这样你就不需要被迫在每个应用都实现一次这种机制。</p>
<p>为了方便开始，请确定你的 <code>App\User</code> 模型实现了 <code>Illuminate\Contracts\Auth\CanResetPassword</code> 契约，laravel 中自带的 <code>App\User</code> 模型中已经实现了这个借口，并且使用了 <code>Illuminate\Auth\Passwords\CanResetPassword</code> trait。</p>
<p><strong>通过迁移生成密码重置表</strong></p>
<p>接着，必须要创建一个用来存储重置密码的 token 的表。laravel 已经提供了这种表的迁移，并且存放在 <code>database/migrations</code> 目录下，所以，你只需要执行迁移命令：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan migrate</div></pre></td></tr></table></figure>
<h3 id="路由-1"><a href="#路由-1" class="headerlink" title="路由"></a>路由</h3><p>laravel 自带的 <code>Auth\PasswordController</code> 控制器包含了所有重置密码所需的逻辑。所有提供密码重置的路由都可以通过 <code>make:auth</code> Artisan 命令来生成:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php artisan make:auth</div></pre></td></tr></table></figure>
<h3 id="视图-1"><a href="#视图-1" class="headerlink" title="视图"></a>视图</h3><p>当 <code>make:auth</code> 命令被执行时，laravel 会生成所有密码重置所需要的视图。这些视图将被存放在 <code>resources/views/auth/passwords</code> 目录中，你可以根据自己的需求去修改。</p>
<h3 id="重置密码之后"><a href="#重置密码之后" class="headerlink" title="重置密码之后"></a>重置密码之后</h3><p>一旦你生成了所有重置密码所需要的路由和视图之后，你就可以通过在浏览器访问 <code>/password/reset</code> 路由来进行密码重置。<code>PasswordController</code> 已经包含了发送重置密码的链接邮件及更新密码到数据库的功能。</p>
<p>当密码被重置之后，用户会自动登录并且被重定向到 <code>/home</code>。你可以在 <code>PasswordController</code> 中定义 <code>redirectTo</code> 属性来定制化重定向地址:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $redirectTo = <span class="string">'/dashboard'</span>;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意，默认的，密码重置的 token 有效期只有一个小时，你可以在 <code>config/auth.php</code> 配置文件中修改 <code>expire</code> 选项。</p>
</blockquote>
<h3 id="定制"><a href="#定制" class="headerlink" title="定制"></a>定制</h3><p><strong>定制化认证守卫</strong></p>
<p>在 <code>auth.php</code> 配置文件中，你可以配置多种 “guards”，用于对各种用户表执行认证动作。你可以在 <code>PasswordController</code> 中使用 <code>$guard</code> 属性来选择守卫:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * The authentication guard that should be used.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">protected</span> $guard = <span class="string">'admins'</span>;</div></pre></td></tr></table></figure>
<p><strong>定制化密码经纪人</strong></p>
<p>在 <code>auth.php</code> 配置文件中，你可以配置多种密码“brokers”，用于对多种用户表进行密码重置。你可以通过在 <code>PasswordController</code> 中添加 <code>$broker</code> 属性来选择:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * The password broker that should be used.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@var</span> string</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">protected</span> $broker = <span class="string">'admins'</span>;</div></pre></td></tr></table></figure>
<h2 id="添加自定义的守卫"><a href="#添加自定义的守卫" class="headerlink" title="添加自定义的守卫"></a>添加自定义的守卫</h2><p>你可以在服务容器中使用 <code>Auth</code> 假面的 <code>extend</code> 方法来定义自己的认证守卫:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">Auth</span>\<span class="title">JwtGuard</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Perform post-registration booting of services.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     Auth::extend(<span class="string">'jwt'</span>, <span class="function"><span class="keyword">function</span><span class="params">($app, $name, array $config)</span> </span>&#123;</div><div class="line">       <span class="comment">// Return an instance of Illuminate\Contracts\Auth\Guard...</span></div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> JwtGuard(Auth::createUserProvider($config[<span class="string">'provider'</span>]));</div><div class="line">     &#125;);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line"><span class="comment">    * Register bindings in the container.</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">    */</span></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">      <span class="comment">//</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你应该能从上面的示例中看到，你应该在 <code>extend</code> 方法中返回一个 <code>Illuminate\Contracts\Auth\Guard</code> 的实现。为了定制化守卫你需要实现这个接口所包含的方法。</p>
<p>一旦你的守卫被定义，你就可以在 <code>auth.php</code> 配置文件的 <code>guards</code> 选项中进行配置：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="string">'guards'</span> =&gt; [</div><div class="line">  <span class="string">'api'</span> =&gt; [</div><div class="line">    <span class="string">'driver'</span> =&gt; <span class="string">'jwt'</span>,</div><div class="line">    <span class="string">'provider'</span> =&gt; <span class="string">'users'</span></div><div class="line">  ],</div><div class="line">];</div></pre></td></tr></table></figure>
<h2 id="添加自定义的用户提供者"><a href="#添加自定义的用户提供者" class="headerlink" title="添加自定义的用户提供者"></a>添加自定义的用户提供者</h2><p>如果你并没有使用传统的关系数据库来存储你的用户，那么你需要提供你自己的用户提供者来扩展 laravel。你可以通过使用 <code>Auth</code> 假面的 <code>provider</code> 方法来定义自己的用户提供者。你应该在服务提供者中调用该方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Extensions</span>\<span class="title">RiakUserProvider</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Perform post-registration booting of services.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></div><div class="line"><span class="function">  </span>&#123;</div><div class="line">    Auth::provider(<span class="string">'riak'</span>, <span class="function"><span class="keyword">function</span><span class="params">($app, array $config)</span> </span>&#123;</div><div class="line">      <span class="comment">// Return an instance of Illuminate\Contracts\Auth\UserProvider...</span></div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> RiakUserProvider($app[<span class="string">'riak.connection'</span>]);</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Rigster bindings in the container.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="comment">//</span></div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在你使用 <code>provider</code> 方法注册完成提供者之后，你需要在 <code>config/auth.php</code> 配置文件中切换你的用户提供者为新注册的提供者:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">'providers'</span> =&gt; [</div><div class="line">  <span class="string">'users'</span> =&gt; [</div><div class="line">    <span class="string">'driver'</span> =&gt; <span class="string">'riak'</span>,</div><div class="line">  ],</div><div class="line">],</div></pre></td></tr></table></figure>
<p>然后，你需要在 <code>guards</code> 选项中使用该提供者：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="string">'guards'</span> =&gt; [</div><div class="line">  <span class="string">'web'</span> =&gt; [</div><div class="line">    <span class="string">'driver'</span> =&gt; <span class="string">'session'</span>,</div><div class="line">    <span class="string">'provider'</span> =&gt; <span class="string">'users'</span>,</div><div class="line">  ],</div><div class="line">],</div></pre></td></tr></table></figure>
<h3 id="用户提供者契约"><a href="#用户提供者契约" class="headerlink" title="用户提供者契约"></a>用户提供者契约</h3><p><code>Illuminate\Contracts\Auth\UserProvider</code> 的实现仅仅只是管理如何从持续存储系统中获取一个 <code>Illuminate\Contracts\Auth\Authenticatable</code> 的实现。如 MySQL，Riak，等等。这个两个接口实现了 laravel 的持续认证机制而不需要考虑用户数据是存放在哪里了或者存放的是什么类型。</p>
<p>让我们来看一下 <code>Illuminate\Contracts\Auth\UserProvider</code> 契约：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UserProvider</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">retrieveById</span><span class="params">($identifier)</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">retrieveByToken</span><span class="params">($identifier, $token)</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">updateRememberToken</span><span class="params">(Authenticatable $user, $token)</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">retrieveByCredentials</span><span class="params">(array $credentials)</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validateCredentials</span><span class="params">(Authenticatable $user, array $credentials)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>retrieveById</code> 方法用来接收一个键来返回一个用户，如 MySQL 数据库中自增的主键 ID。被匹配的 ID 应该返回一个 <code>Authenticatable</code> 的实现。</p>
<p><code>retrieveByToken</code> 方法接收用于识别用户身份的唯一标识 <code>$identifier</code> 和 <code>remember_token</code> 所存储“记住我”的 <code>$token</code>。就如上面的方法一样，该方法应该返回一个 <code>Authenticatable</code> 的实现。</p>
<p><code>updateRememberToken</code> 方法使用新的 <code>$token</code> 来更新用户的 <code>remember_token</code> 字段。这个新的字段可以是用户登录成功并且设置了 <code>记住我</code> 而分配的，也可以是用户登出之后分配的 null。</p>
<p><code>retrieveByCredentials</code> 方法接收一个数组凭证，它会在用户尝试登录时将凭证传递给 <code>Auth::attemp</code> 方法。该方法会询问底层持续存储设备凭证的匹配情况，一般该方法会使用 <code>where</code> 条件语句来进行查询 <code>$credentials[&#39;username&#39;]</code> 类似的匹配状况。这个方法应该返回一个 <code>UserInterface</code> 的实现。<strong>不要在这个方法里做密码验证或者认证</strong>。</p>
<p><code>validateCredentials</code> 方法应该比较所给定的用户和凭证的匹配情况。比如，这个方法或许会比较 <code>$user-getAuthPassword()</code> 和 <code>Hash::make</code> 后的 <code>$credentials[&#39;password&#39;]</code>。这个方法应该只做用户和凭证间的效验和返回比较情况的布尔值。</p>
<h3 id="可认证的（Authenticatable）契约"><a href="#可认证的（Authenticatable）契约" class="headerlink" title="可认证的（Authenticatable）契约"></a>可认证的（Authenticatable）契约</h3><p>刚才我们探讨了 <code>UserProvider</code> 中的所有方法，现在让我们来看一看 <code>Authenticatable</code> 契约，你应该记得，提供者应该从 <code>retrieveById</code> 和 <code>retrieveByCredentials</code> 方法中返回该契约接口的实现：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Auth</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Authenticatable</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAuthIdentifierName</span><span class="params">()</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAuthIdentifier</span><span class="params">()</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAuthPassword</span><span class="params">()</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRememberToken</span><span class="params">()</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setRememberToken</span><span class="params">($value)</span></span>;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRememberTokenName</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个接口相对来说非常简单。<code>getAuthIdentifierName</code> 方法应该返回用户的主键字段的名称。<code>getAuthIdentifier</code> 方法应该返回用户的主键。在 MySQL 中，这个主键一般为自增长的主键值。<code>getAuthPassword</code> 应该返回用户的经哈希后的密码。这个接口使认证系统可以在任何用户类中运行而不用管你使用的是什么 ORM 或者其它存储抽象层。默认的，laravel 在 <code>app</code> 目录下包含了 <code>User</code> 类，该类就实现了这个契约。所以你可以参照这个类的实现方式。</p>
<h2 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h2><p>laravel 在认证进程中提供了各种各样的事件。你可以在你的 <code>EventServiceProvider</code> 中附加监听这些事件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * The event listener mappings for the application.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@var</span> array</span></div><div class="line"><span class="comment"> */</span></div><div class="line"> <span class="keyword">protected</span> $listen = [</div><div class="line">  <span class="string">'Illuminate\Auth\Events\Attempting'</span> =&gt; [</div><div class="line">    <span class="string">'App\Listeners\LogAuthenticationAttempt'</span>,</div><div class="line">  ],</div><div class="line"></div><div class="line">  <span class="string">'Illuminate\Auth\Events\Login'</span> =&gt; [</div><div class="line">    <span class="string">'App\Listeners\LogSuccessfulLogin'</span>,</div><div class="line">  ],</div><div class="line"></div><div class="line">  <span class="string">'Illuminate\Auth\Events\logout'</span> =&gt; [</div><div class="line">    <span class="string">'App\Listeners\logSuccessfulLogout'</span>,</div><div class="line">  ],</div><div class="line"></div><div class="line">  <span class="string">'Illuminate\Auth\Events\Lockout'</span> =&gt; [</div><div class="line">    <span class="string">'App\Listeners\LogLockout'</span>,</div><div class="line">  ],</div><div class="line"> ];</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/05/18/laravel-from-scratch-facades/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Dearmadman">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Team.dearmadman.com">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/18/laravel-from-scratch-facades/" itemprop="url">laravel 基础教程 —— 假面</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-05-18T21:39:07+08:00">
                2016-05-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="假面（Facades）"><a href="#假面（Facades）" class="headerlink" title="假面（Facades）"></a>假面（Facades）</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>假面提供了一种类似‘静态’接口的方式来从服务容器中提取可用类的方法。laravel 自身附带了许多的假面，你可能在还不知道它的时候就已经使用过它了。laravel 的假面服务就好像是一个从服务容器中取出底层类的代理（你带上我的面具，你就可以使用我的方法了），它提供了一种简洁语法的同时保持了比传统静态方法更高的可测试性和灵活性。</p>
<h2 id="使用假面"><a href="#使用假面" class="headerlink" title="使用假面"></a>使用假面</h2><p>在 laravel 中，假面是一种能够访问服务容器中对象的类。而使这项工作能够运行的就是 <code>Facade</code> 类。laravel 中的假面或者任何你所自定义的假面都必须要继承 <code>Illuminate\Support\Facades\Facade</code> 类。</p>
<p>一个假面类仅仅只需要去实现一个单一的 <code>getFacadeAccessor</code> 方法就可以了。而 <code>getFacadeAccessor</code> 方法的任务就是定义需要从服务容器中返回什么对象。<code>Facade</code> 基类使用了 <code>__callStatic()</code> 魔术方法让假面来延迟访问容器中相应的对象。</p>
<p>在下面的例子中，使用了 laravel 缓存系统的一个方法调用。如果只是匆匆的看一眼，你很可能会觉得这是在调用缓存类的静态方法 <code>get</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Cache</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Show the profile for the given user.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@param</span> int $id</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> Response</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">showProfile</span><span class="params">($id)</span></span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     $user = Cache::get(<span class="string">'user'</span> . $id);</div><div class="line"></div><div class="line">     <span class="keyword">return</span> view(<span class="string">'profile'</span>, [<span class="string">'user'</span> =&gt; $user]);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你应该注意到我们在文件的顶部引入的是 <code>Cache</code> 假面。这个假面服务相当于访问 <code>Illuminate\Contracts\Cache\Factory</code> 接口底层实现的代理。所有使用假面调用的方法都会在 laravel 缓存服务的底层实现进行传递调用。</p>
<p>如果我们看一下 <code>Illuminate\Support\Facades\Cache</code> 类，你会发现这里并没有静态方法 <code>get</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span> <span class="keyword">extends</span> <span class="title">Facade</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">  <span class="comment">/**</span></div><div class="line"><span class="comment">   * Get the registered name of the component.</span></div><div class="line"><span class="comment">   *</span></div><div class="line"><span class="comment">   * <span class="doctag">@return</span> string</span></div><div class="line"><span class="comment">   */</span></div><div class="line">   <span class="keyword">protected</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFacadeAccessor</span><span class="params">()</span> </span></div><div class="line"><span class="function">   </span>&#123;</div><div class="line">     <span class="keyword">return</span> <span class="string">'cache'</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>事实上，<code>Cache</code> 假面继承自基类 <code>Facade</code> 并且定义了 <code>getFacadeAccessor()</code> 方法。这个方法的主要任务就是从服务容器中返回所绑定名称的对象。当用户调用任何 <code>Cache</code> 假面的静态方法时，laravel 从服务容器中返回绑定了 <code>cache</code> 为名称的对象，并且使用这个对象调用所请求的方法。</p>
<h2 id="假面类参考"><a href="#假面类参考" class="headerlink" title="假面类参考"></a>假面类参考</h2><p>在下面的表格中你会找到所有的假面及其所对应的底层实现类。这是一个可以迅速挖掘给定假面 API 的有用工具。在服务容器中所给的绑定键也包括在其中。</p>
<table>
<thead>
<tr>
<th>Facade</th>
<th>Class</th>
<th>Service Container Binding</th>
</tr>
</thead>
<tbody>
<tr>
<td>App</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Foundation/Application.html" target="_blank" rel="external">Illuminate\Foundation\Application</a></td>
<td>app</td>
</tr>
<tr>
<td>Artisan</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Contracts/Console/Kernel.html" target="_blank" rel="external">Illuminate\Contracts\Console\Kernel</a></td>
<td>artisan</td>
</tr>
<tr>
<td>Auth</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Auth/AuthManager.html" target="_blank" rel="external">Illuminate\Auth\AuthManager</a></td>
<td>auth</td>
</tr>
<tr>
<td>Blade</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/View/Compilers/BladeCompiler.html" target="_blank" rel="external">Illuminate\View\Compilers\BladeCompiler</a></td>
<td>blade.compiler</td>
</tr>
<tr>
<td>Bus</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Contracts/Bus/Dispatcher.html" target="_blank" rel="external">Illuminate\Contracts\Bus\Dispatcher</a></td>
<td></td>
</tr>
<tr>
<td>Cache</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Cache/Repository.html" target="_blank" rel="external">Illuminathe\Cache\Repository</a></td>
<td>cache</td>
</tr>
<tr>
<td>Config</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Config/Repository.html" target="_blank" rel="external">Illuminate\Config\Repository</a></td>
<td>config</td>
</tr>
<tr>
<td>Cookie</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Cookie/CookieJar.html" target="_blank" rel="external">Illuminate\Cookie\CookieJar</a></td>
<td>cookie</td>
</tr>
<tr>
<td>Crypt</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Encryption/Encrypter.html" target="_blank" rel="external">Illuminate\Encryption\Encrypter</a></td>
<td>encrypter</td>
</tr>
<tr>
<td>DB</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Database/DatabaseManager.html" target="_blank" rel="external">Illuminate\Database\DatabaseManager</a></td>
<td>db</td>
</tr>
<tr>
<td>DB (Instance)</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Database/Connection.html" target="_blank" rel="external">Illuminate\Database\Connection</a></td>
<td></td>
</tr>
<tr>
<td>Event</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Events/Dispatcher.html" target="_blank" rel="external">Illuminate\Events\Dispatcher</a></td>
<td>events</td>
</tr>
<tr>
<td>File</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Filesystem/Filesystem.html" target="_blank" rel="external">Illuminate\Filesystem\Filesystem</a></td>
<td>files</td>
</tr>
<tr>
<td>Gate</td>
<td><a href="http://laravel.com/api/5.1/Illuminate/Contracts/Auth/Access/Gate.html" target="_blank" rel="external">Illuminate\Contracts\Auth\Access\Gate</a></td>
<td></td>
</tr>
<tr>
<td>Hash</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Contracts/Hashing/Hasher.html" target="_blank" rel="external">Illuminate\Contracts\Hashing\Hasher</a></td>
<td>hash</td>
</tr>
<tr>
<td>Lang</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Translation/Translator.html" target="_blank" rel="external">Illuminate\Translation\Translator</a></td>
<td>translator</td>
</tr>
<tr>
<td>Log</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Log/Writer.html" target="_blank" rel="external">Illuminate\Log\Writer</a></td>
<td>log</td>
</tr>
<tr>
<td>Mail</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Mail/Mailer.html" target="_blank" rel="external">Illuminate\Mail\Mailer</a></td>
<td>mailer</td>
</tr>
<tr>
<td>Password</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Auth/Passwords/PasswordBroker.html" target="_blank" rel="external">Illuminate\Auth\Passwords\PasswordBroker</a></td>
<td>auth.password</td>
</tr>
<tr>
<td>Queue</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Queue/QueueManager.html" target="_blank" rel="external">Illuminate\Queue\QueueManager</a></td>
<td>queue</td>
</tr>
<tr>
<td>Queue (Instance)</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Contracts/Queue/Queue.html" target="_blank" rel="external">Illuminate\Contracts\Queue\Queue</a></td>
<td>queue</td>
</tr>
<tr>
<td>Queue (Base Class)</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Queue/Queue.html" target="_blank" rel="external">Illuminate\Queue\Queue</a></td>
<td></td>
</tr>
<tr>
<td>Redirect</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Routing/Redirector.html" target="_blank" rel="external">Illuminate\Routing\Redirector </a></td>
<td>redirect</td>
</tr>
<tr>
<td>Redis</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Redis/Database.html" target="_blank" rel="external">Illuminate\Redis\Database</a></td>
<td>redis</td>
</tr>
<tr>
<td>Request</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Http/Request.html" target="_blank" rel="external">Illuminate\Http\Request</a></td>
<td>request</td>
</tr>
<tr>
<td>Response</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Contracts/Routing/ResponseFactory.html" target="_blank" rel="external">Illuminate\Contracts\Routing\ResponseFactory</a></td>
<td></td>
</tr>
<tr>
<td>Route</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Routing/Router.html" target="_blank" rel="external">Illuminate\Routing\Router</a></td>
<td>router</td>
</tr>
<tr>
<td>Schema</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Database/Schema/Blueprint.html" target="_blank" rel="external">Illuminate\Database\Schema\Blueprint</a></td>
<td></td>
</tr>
<tr>
<td>Session</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Session/SessionManager.html" target="_blank" rel="external">Illuminate\Session\SessionManager </a></td>
<td>session</td>
</tr>
<tr>
<td>Session (Instance)</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Session/Store.html" target="_blank" rel="external">Illuminate\Session\Store </a></td>
<td></td>
</tr>
<tr>
<td>Storage</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Contracts/Filesystem/Factory.html" target="_blank" rel="external">Illuminate\Contracts\Filesystem\Factory</a></td>
<td>filesystem</td>
</tr>
<tr>
<td>URL</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Routing/UrlGenerator.html" target="_blank" rel="external">Illuminate\Routing\UrlGenerator</a></td>
<td>url</td>
</tr>
<tr>
<td>Validator</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Validation/Factory.html" target="_blank" rel="external">Illuminate\Validation\Factory</a></td>
<td>validator</td>
</tr>
<tr>
<td>Validator (Instance)</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/Validation/Validator.html" target="_blank" rel="external">Illuminate\Validation\Validator</a></td>
<td></td>
</tr>
<tr>
<td>View</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/View/Factory.html" target="_blank" rel="external">Illuminate\View\Factory</a></td>
<td>view</td>
</tr>
<tr>
<td>View (Instance)</td>
<td><a href="http://laravel.com/api/5.2/Illuminate/View/View.html" target="_blank" rel="external">Illuminate\View\View</a></td>
<td></td>
</tr>
</tbody>
</table>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Dearmadman</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">100</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Dearmadman</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
