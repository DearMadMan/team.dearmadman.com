title: laravel 基础教程 —— 请求生命周期
date: 2016-05-15 13:29:38
tags: [php, laravel]
---

# 简介

在现实中，如果你明白了你所使用工具的工作原理，你就会在使用的时候非常的自信。开发应用并没有什么不同，当你弄懂了这些开发工具功能，你就会在使用时得心应手。

这份文档会深层次的带你浏览 laravel 框架是如何工作的。通过对框架更全面的了解，一切都会显得不再那么神秘，你会更加自信的去构建应用。

如果你并不能理解该文档的所有内容，请不要伤心。你需要先试着掌握一些基本的概念，你的知识体系会随着对文档的探索而增长。

## 生命周期概述

### 第一件事

laravel 应用中的所有请求的入口都是 `pulic/index.php` 文件，所有的请求都会被导向该文件。 `index.php` 文件中并没有存储太多的代码，相反，它只是用于装载框架的其余部分的起始点。

`index.php` 文件会加载 Composer 生成的自动加载器配置信息，然后从 `bootstrap/app.php` 文件中加载 laravel 应用的实例，Laravel 的第一个动作就是创建一个服务容器的实例。

### HTTP / Console 内核

根据请求进入应用程序的类型，请求将会被分配到 HTTP 内核 或 Console 内核处理。这两个内核都会作为所有请求流经过的中心处理器。现在，让我们只聚焦在 HTTP 内核上，它被存储在 `app/Http/Kernel.php` 文件中。

HTTP 内核继承自 `Illuminate\Foundation\Http\Kernel` 类，这个类定义了一个 `bootstrappers` 的数组，这些类会在请求被处理前运行。这些 `bootstrappers` 执行错误处理，日志，检测当前应用环境的配置和提供一些其它在请求被处理前执行的任务。

HTTP 内核也定义了一些 HTTP 中间件，所有请求在被处理前都会经过这些中间件。这些中间件包括了读写 HTTP Session 的中间件，判断当前站点是否是维护状态的中间件，验证 CSRF Token 的中间件，等等。

HTTP 内核的 `handle` 方法非常的简单：接收一个 `Request` 返回一个 `Response`。你可以把这个核心想象成一个黑盒子，左边 HTTP 请求进去，右边返回 HTTP 响应。

### 服务提供者

启动内核中最重要的一步就是为你的应用加载服务提供者。所有的服务提供者都在 `config/app.php` 文件的 `providers` 数组中进行配置。首先，所有经过配置的提供者都会执行其自身的 `register` 方法，然后当所有提供者都完成注册之后，才会陆续的触发 `boot` 方法。

服务提供者主要负责启动框架中的各个组件，比如数据库组件、队列、验证和路由组件。因为框架中的各种核心功能都是从这里被提供的，所以服务提供者是整个框架启动中最重要的一环。

### 分发请求

一旦应用启动完成并且所有的服务提供者都完成注册，`Request` 将会移交到路由器进行分发。路由器将会分发该请求到路由或者控制器中，同时也会经过路由特定的中间件。

## 聚焦服务提供者

服务提供者是 laravel 应用能够成功启动的最关键的部分。首先创建应用的实例，然后注册服务提供者，再然后处理已经启动成功应用的请求。整个请求流程就是这么简单。

能够深刻理解 laravel 是如何通过服务提供者进行启动和构建应用是非常有价值的。当然你的应用中默认的服务提供者都被存储在 `app/Providers` 目录中。

默认的，`AppServiceProvider` 是一个空的类，这里是你在应用中添加自己的启动项和做服务容器绑定的好去处。当然，在大型应用中，你可以自行的创建一些服务提供者，以使每一个提供者都具有单一的职责。